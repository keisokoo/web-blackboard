!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.createBlackboard=e():t.createBlackboard=e()}(this,(()=>(()=>{"use strict";var t={6745:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Animation=void 0;const n=i(4417),r=i(8588),s=n.glob.performance&&n.glob.performance.now?function(){return n.glob.performance.now()}:function(){return(new Date).getTime()};class a{constructor(t,e){this.id=a.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:s(),frameRate:0},this.func=t,this.setLayers(e)}setLayers(t){let e=[];return t&&(e=Array.isArray(t)?t:[t]),this.layers=e,this}getLayers(){return this.layers}addLayer(t){const e=this.layers,i=e.length;for(let n=0;n<i;n++)if(e[n]._id===t._id)return!1;return this.layers.push(t),!0}isRunning(){const t=a.animations,e=t.length;for(let i=0;i<e;i++)if(t[i].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=s(),a._addAnimation(this),this}stop(){return a._removeAnimation(this),this}_updateFrameObject(t){this.frame.timeDiff=t-this.frame.lastTime,this.frame.lastTime=t,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(t){this.animations.push(t),this._handleAnimation()}static _removeAnimation(t){const e=t.id,i=this.animations,n=i.length;for(let t=0;t<n;t++)if(i[t].id===e){this.animations.splice(t,1);break}}static _runFrames(){const t={},e=this.animations;for(let i=0;i<e.length;i++){const n=e[i],r=n.layers,a=n.func;n._updateFrameObject(s());const o=r.length;let c;if(c=!a||!1!==a.call(n,n.frame),c)for(let e=0;e<o;e++){const i=r[e];void 0!==i._id&&(t[i._id]=i)}}for(let e in t)t.hasOwnProperty(e)&&t[e].batchDraw()}static _animationLoop(){const t=a;t.animations.length?(t._runFrames(),r.Util.requestAnimFrame(t._animationLoop)):t.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,r.Util.requestAnimFrame(this._animationLoop))}}e.Animation=a,a.animations=[],a.animIdCounter=0,a.animRunning=!1},4135:(t,e)=>{function i(t,e,i){const r=n(1,i,t),s=n(1,i,e),a=r*r+s*s;return Math.sqrt(a)}Object.defineProperty(e,"__esModule",{value:!0}),e.t2length=e.getQuadraticArcLength=e.getCubicArcLength=e.binomialCoefficients=e.cValues=e.tValues=void 0,e.tValues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],e.cValues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],e.binomialCoefficients=[[1],[1,1],[1,2,1],[1,3,3,1]],e.getCubicArcLength=(t,n,r)=>{let s,a,o;s=r/2,a=0;for(let r=0;r<20;r++)o=s*e.tValues[20][r]+s,a+=e.cValues[20][r]*i(t,n,o);return s*a},e.getQuadraticArcLength=(t,e,i)=>{void 0===i&&(i=1);const n=t[0]-2*t[1]+t[2],r=e[0]-2*e[1]+e[2],s=2*t[1]-2*t[0],a=2*e[1]-2*e[0],o=4*(n*n+r*r),c=4*(n*s+r*a),d=s*s+a*a;if(0===o)return i*Math.sqrt(Math.pow(t[2]-t[0],2)+Math.pow(e[2]-e[0],2));const h=c/(2*o),l=i+h,u=d/o-h*h,p=l*l+u>0?Math.sqrt(l*l+u):0,m=h*h+u>0?Math.sqrt(h*h+u):0,f=h+Math.sqrt(h*h+u)!==0?u*Math.log(Math.abs((l+p)/(h+m))):0;return Math.sqrt(o)/2*(l*p-h*m+f)};const n=(t,i,r)=>{const s=r.length-1;let a,o;if(0===s)return 0;if(0===t){o=0;for(let t=0;t<=s;t++)o+=e.binomialCoefficients[s][t]*Math.pow(1-i,s-t)*Math.pow(i,t)*r[t];return o}a=new Array(s);for(let t=0;t<s;t++)a[t]=s*(r[t+1]-r[t]);return n(t-1,i,a)};e.t2length=(t,e,i)=>{let n=1,r=t/e,s=(t-i(r))/e,a=0;for(;n>.001;){const o=i(r+s),c=Math.abs(t-o)/e;if(c<n)n=c,r+=s;else{const a=i(r-s),o=Math.abs(t-a)/e;o<n?(n=o,r-=s):s/=2}if(a++,a>500)break}return r}},4842:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.HitCanvas=e.SceneCanvas=e.Canvas=void 0;const n=i(8588),r=i(3442),s=i(4417),a=i(1455),o=i(3774);var c;class d{constructor(t){this.pixelRatio=1,this.width=0,this.height=0,this.isCache=!1;var e=(t||{}).pixelRatio||s.Konva.pixelRatio||function(){if(c)return c;var t=n.Util.createCanvasElement(),e=t.getContext("2d");return c=(s.Konva._global.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1),n.Util.releaseCanvas(t),c}();this.pixelRatio=e,this._canvas=n.Util.createCanvasElement(),this._canvas.style.padding="0",this._canvas.style.margin="0",this._canvas.style.border="0",this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top="0",this._canvas.style.left="0"}getContext(){return this.context}getPixelRatio(){return this.pixelRatio}setPixelRatio(t){var e=this.pixelRatio;this.pixelRatio=t,this.setSize(this.getWidth()/e,this.getHeight()/e)}setWidth(t){this.width=this._canvas.width=t*this.pixelRatio,this._canvas.style.width=t+"px";var e=this.pixelRatio;this.getContext()._context.scale(e,e)}setHeight(t){this.height=this._canvas.height=t*this.pixelRatio,this._canvas.style.height=t+"px";var e=this.pixelRatio;this.getContext()._context.scale(e,e)}getWidth(){return this.width}getHeight(){return this.height}setSize(t,e){this.setWidth(t||0),this.setHeight(e||0)}toDataURL(t,e){try{return this._canvas.toDataURL(t,e)}catch(t){try{return this._canvas.toDataURL()}catch(t){return n.Util.error("Unable to get data URL. "+t.message+" For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html."),""}}}}e.Canvas=d,a.Factory.addGetterSetter(d,"pixelRatio",void 0,(0,o.getNumberValidator)()),e.SceneCanvas=class extends d{constructor(t={width:0,height:0,willReadFrequently:!1}){super(t),this.context=new r.SceneContext(this,{willReadFrequently:t.willReadFrequently}),this.setSize(t.width,t.height)}},e.HitCanvas=class extends d{constructor(t={width:0,height:0}){super(t),this.hitCanvas=!0,this.context=new r.HitContext(this),this.setSize(t.width,t.height)}}},8783:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Container=void 0;const n=i(1455),r=i(7939),s=i(3774);class a extends r.Node{constructor(){super(...arguments),this.children=[]}getChildren(t){if(!t)return this.children||[];const e=this.children||[];var i=[];return e.forEach((function(e){t(e)&&i.push(e)})),i}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach((t=>{t.parent=null,t.index=0,t.remove()})),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach((t=>{t.parent=null,t.index=0,t.destroy()})),this.children=[],this._requestDraw(),this}add(...t){if(0===t.length)return this;if(t.length>1){for(var e=0;e<t.length;e++)this.add(t[e]);return this}const i=t[0];return i.getParent()?(i.moveTo(this),this):(this._validateAdd(i),i.index=this.getChildren().length,i.parent=this,i._clearCaches(),this.getChildren().push(i),this._fire("add",{child:i}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(t){return this._generalFind(t,!1)}findOne(t){var e=this._generalFind(t,!0);return e.length>0?e[0]:void 0}_generalFind(t,e){var i=[];return this._descendants((n=>{const r=n._isMatch(t);return r&&i.push(n),!(!r||!e)})),i}_descendants(t){let e=!1;const i=this.getChildren();for(const n of i){if(e=t(n),e)return!0;if(n.hasChildren()&&(e=n._descendants(t),e))return!0}return!1}toObject(){var t=r.Node.prototype.toObject.call(this);return t.children=[],this.getChildren().forEach((e=>{t.children.push(e.toObject())})),t}isAncestorOf(t){for(var e=t.getParent();e;){if(e._id===this._id)return!0;e=e.getParent()}return!1}clone(t){var e=r.Node.prototype.clone.call(this,t);return this.getChildren().forEach((function(t){e.add(t.clone())})),e}getAllIntersections(t){var e=[];return this.find("Shape").forEach((i=>{i.isVisible()&&i.intersects(t)&&e.push(i)})),e}_clearSelfAndDescendantCache(t){var e;super._clearSelfAndDescendantCache(t),this.isCached()||null===(e=this.children)||void 0===e||e.forEach((function(e){e._clearSelfAndDescendantCache(t)}))}_setChildrenIndices(){var t;null===(t=this.children)||void 0===t||t.forEach((function(t,e){t.index=e})),this._requestDraw()}drawScene(t,e){var i=this.getLayer(),n=t||i&&i.getCanvas(),r=n&&n.getContext(),s=this._getCanvasCache(),a=s&&s.scene,o=n&&n.isCache;if(!this.isVisible()&&!o)return this;if(a){r.save();var c=this.getAbsoluteTransform(e).getMatrix();r.transform(c[0],c[1],c[2],c[3],c[4],c[5]),this._drawCachedSceneCanvas(r),r.restore()}else this._drawChildren("drawScene",n,e);return this}drawHit(t,e){if(!this.shouldDrawHit(e))return this;var i=this.getLayer(),n=t||i&&i.hitCanvas,r=n&&n.getContext(),s=this._getCanvasCache();if(s&&s.hit){r.save();var a=this.getAbsoluteTransform(e).getMatrix();r.transform(a[0],a[1],a[2],a[3],a[4],a[5]),this._drawCachedHitCanvas(r),r.restore()}else this._drawChildren("drawHit",n,e);return this}_drawChildren(t,e,i){var n,r=e&&e.getContext(),s=this.clipWidth(),a=this.clipHeight(),o=this.clipFunc(),c=s&&a||o;const d=i===this;if(c){r.save();var h=this.getAbsoluteTransform(i),l=h.getMatrix();let t;if(r.transform(l[0],l[1],l[2],l[3],l[4],l[5]),r.beginPath(),o)t=o.call(this,r,this);else{var u=this.clipX(),p=this.clipY();r.rect(u,p,s,a)}r.clip.apply(r,t),l=h.copy().invert().getMatrix(),r.transform(l[0],l[1],l[2],l[3],l[4],l[5])}var m=!d&&"source-over"!==this.globalCompositeOperation()&&"drawScene"===t;m&&(r.save(),r._applyGlobalCompositeOperation(this)),null===(n=this.children)||void 0===n||n.forEach((function(n){n[t](e,i)})),m&&r.restore(),c&&r.restore()}getClientRect(t={}){var e,i,n,r,s,a,o=t.skipTransform,c=t.relativeTo,d=this;null===(e=this.children)||void 0===e||e.forEach((function(e){if(e.visible()){var a=e.getClientRect({relativeTo:d,skipShadow:t.skipShadow,skipStroke:t.skipStroke});0===a.width&&0===a.height||(void 0===i?(i=a.x,n=a.y,r=a.x+a.width,s=a.y+a.height):(i=Math.min(i,a.x),n=Math.min(n,a.y),r=Math.max(r,a.x+a.width),s=Math.max(s,a.y+a.height)))}}));for(var h=this.find("Shape"),l=!1,u=0;u<h.length;u++)if(h[u]._isVisible(this)){l=!0;break}return a=l&&void 0!==i?{x:i,y:n,width:r-i,height:s-n}:{x:0,y:0,width:0,height:0},o?a:this._transformedRect(a,c)}}e.Container=a,n.Factory.addComponentsGetterSetter(a,"clip",["x","y","width","height"]),n.Factory.addGetterSetter(a,"clipX",void 0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(a,"clipY",void 0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(a,"clipWidth",void 0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(a,"clipHeight",void 0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(a,"clipFunc")},3442:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.HitContext=e.SceneContext=e.Context=void 0;const n=i(8588),r=i(4417);var s=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","ellipse","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"];class a{constructor(t){this.canvas=t,r.Konva.enableTrace&&(this.traceArr=[],this._enableTrace())}fillShape(t){t.fillEnabled()&&this._fill(t)}_fill(t){}strokeShape(t){t.hasStroke()&&this._stroke(t)}_stroke(t){}fillStrokeShape(t){t.attrs.fillAfterStrokeEnabled?(this.strokeShape(t),this.fillShape(t)):(this.fillShape(t),this.strokeShape(t))}getTrace(t,e){var i,r,s,a,o=this.traceArr,c=o.length,d="";for(i=0;i<c;i++)(s=(r=o[i]).method)?(a=r.args,d+=s,t?d+="()":n.Util._isArray(a[0])?d+="(["+a.join(",")+"])":(e&&(a=a.map((t=>"number"==typeof t?Math.floor(t):t))),d+="("+a.join(",")+")")):(d+=r.property,t||(d+="="+r.val)),d+=";";return d}clearTrace(){this.traceArr=[]}_trace(t){var e=this.traceArr;e.push(t),e.length>=100&&e.shift()}reset(){var t=this.getCanvas().getPixelRatio();this.setTransform(1*t,0,0,1*t,0,0)}getCanvas(){return this.canvas}clear(t){var e=this.getCanvas();t?this.clearRect(t.x||0,t.y||0,t.width||0,t.height||0):this.clearRect(0,0,e.getWidth()/e.pixelRatio,e.getHeight()/e.pixelRatio)}_applyLineCap(t){const e=t.attrs.lineCap;e&&this.setAttr("lineCap",e)}_applyOpacity(t){var e=t.getAbsoluteOpacity();1!==e&&this.setAttr("globalAlpha",e)}_applyLineJoin(t){const e=t.attrs.lineJoin;e&&this.setAttr("lineJoin",e)}setAttr(t,e){this._context[t]=e}arc(t,e,i,n,r,s){this._context.arc(t,e,i,n,r,s)}arcTo(t,e,i,n,r){this._context.arcTo(t,e,i,n,r)}beginPath(){this._context.beginPath()}bezierCurveTo(t,e,i,n,r,s){this._context.bezierCurveTo(t,e,i,n,r,s)}clearRect(t,e,i,n){this._context.clearRect(t,e,i,n)}clip(...t){this._context.clip.apply(this._context,t)}closePath(){this._context.closePath()}createImageData(t,e){var i=arguments;return 2===i.length?this._context.createImageData(t,e):1===i.length?this._context.createImageData(t):void 0}createLinearGradient(t,e,i,n){return this._context.createLinearGradient(t,e,i,n)}createPattern(t,e){return this._context.createPattern(t,e)}createRadialGradient(t,e,i,n,r,s){return this._context.createRadialGradient(t,e,i,n,r,s)}drawImage(t,e,i,n,r,s,a,o,c){var d=arguments,h=this._context;3===d.length?h.drawImage(t,e,i):5===d.length?h.drawImage(t,e,i,n,r):9===d.length&&h.drawImage(t,e,i,n,r,s,a,o,c)}ellipse(t,e,i,n,r,s,a,o){this._context.ellipse(t,e,i,n,r,s,a,o)}isPointInPath(t,e,i,n){return i?this._context.isPointInPath(i,t,e,n):this._context.isPointInPath(t,e,n)}fill(...t){this._context.fill.apply(this._context,t)}fillRect(t,e,i,n){this._context.fillRect(t,e,i,n)}strokeRect(t,e,i,n){this._context.strokeRect(t,e,i,n)}fillText(t,e,i,n){n?this._context.fillText(t,e,i,n):this._context.fillText(t,e,i)}measureText(t){return this._context.measureText(t)}getImageData(t,e,i,n){return this._context.getImageData(t,e,i,n)}lineTo(t,e){this._context.lineTo(t,e)}moveTo(t,e){this._context.moveTo(t,e)}rect(t,e,i,n){this._context.rect(t,e,i,n)}putImageData(t,e,i){this._context.putImageData(t,e,i)}quadraticCurveTo(t,e,i,n){this._context.quadraticCurveTo(t,e,i,n)}restore(){this._context.restore()}rotate(t){this._context.rotate(t)}save(){this._context.save()}scale(t,e){this._context.scale(t,e)}setLineDash(t){this._context.setLineDash?this._context.setLineDash(t):"mozDash"in this._context?this._context.mozDash=t:"webkitLineDash"in this._context&&(this._context.webkitLineDash=t)}getLineDash(){return this._context.getLineDash()}setTransform(t,e,i,n,r,s){this._context.setTransform(t,e,i,n,r,s)}stroke(t){t?this._context.stroke(t):this._context.stroke()}strokeText(t,e,i,n){this._context.strokeText(t,e,i,n)}transform(t,e,i,n,r,s){this._context.transform(t,e,i,n,r,s)}translate(t,e){this._context.translate(t,e)}_enableTrace(){var t,e,i=this,r=s.length,a=this.setAttr,o=function(t){var r,s=i[t];i[t]=function(){return e=function(t){var e,i,r=[],s=t.length,a=n.Util;for(e=0;e<s;e++)i=t[e],a._isNumber(i)?i=Math.round(1e3*i)/1e3:a._isString(i)||(i+=""),r.push(i);return r}(Array.prototype.slice.call(arguments,0)),r=s.apply(i,arguments),i._trace({method:t,args:e}),r}};for(t=0;t<r;t++)o(s[t]);i.setAttr=function(){a.apply(i,arguments);var t=arguments[0],e=arguments[1];"shadowOffsetX"!==t&&"shadowOffsetY"!==t&&"shadowBlur"!==t||(e/=this.canvas.getPixelRatio()),i._trace({property:t,val:e})}}_applyGlobalCompositeOperation(t){const e=t.attrs.globalCompositeOperation;!e||"source-over"===e||this.setAttr("globalCompositeOperation",e)}}e.Context=a,["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","letterSpacing","lineCap","lineDashOffset","lineJoin","lineWidth","miterLimit","direction","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation","imageSmoothingEnabled"].forEach((function(t){Object.defineProperty(a.prototype,t,{get(){return this._context[t]},set(e){this._context[t]=e}})})),e.SceneContext=class extends a{constructor(t,{willReadFrequently:e=!1}={}){super(t),this._context=t._canvas.getContext("2d",{willReadFrequently:e})}_fillColor(t){var e=t.fill();this.setAttr("fillStyle",e),t._fillFunc(this)}_fillPattern(t){this.setAttr("fillStyle",t._getFillPattern()),t._fillFunc(this)}_fillLinearGradient(t){var e=t._getLinearGradient();e&&(this.setAttr("fillStyle",e),t._fillFunc(this))}_fillRadialGradient(t){const e=t._getRadialGradient();e&&(this.setAttr("fillStyle",e),t._fillFunc(this))}_fill(t){const e=t.fill(),i=t.getFillPriority();if(e&&"color"===i)return void this._fillColor(t);const n=t.getFillPatternImage();if(n&&"pattern"===i)return void this._fillPattern(t);const r=t.getFillLinearGradientColorStops();if(r&&"linear-gradient"===i)return void this._fillLinearGradient(t);const s=t.getFillRadialGradientColorStops();s&&"radial-gradient"===i?this._fillRadialGradient(t):e?this._fillColor(t):n?this._fillPattern(t):r?this._fillLinearGradient(t):s&&this._fillRadialGradient(t)}_strokeLinearGradient(t){const e=t.getStrokeLinearGradientStartPoint(),i=t.getStrokeLinearGradientEndPoint(),n=t.getStrokeLinearGradientColorStops(),r=this.createLinearGradient(e.x,e.y,i.x,i.y);if(n){for(var s=0;s<n.length;s+=2)r.addColorStop(n[s],n[s+1]);this.setAttr("strokeStyle",r)}}_stroke(t){var e=t.dash(),i=t.getStrokeScaleEnabled();if(t.hasStroke()){if(!i){this.save();var n=this.getCanvas().getPixelRatio();this.setTransform(n,0,0,n,0,0)}this._applyLineCap(t),e&&t.dashEnabled()&&(this.setLineDash(e),this.setAttr("lineDashOffset",t.dashOffset())),this.setAttr("lineWidth",t.strokeWidth()),t.getShadowForStrokeEnabled()||this.setAttr("shadowColor","rgba(0,0,0,0)"),t.getStrokeLinearGradientColorStops()?this._strokeLinearGradient(t):this.setAttr("strokeStyle",t.stroke()),t._strokeFunc(this),i||this.restore()}}_applyShadow(t){var e,i,n,r=null!==(e=t.getShadowRGBA())&&void 0!==e?e:"black",s=null!==(i=t.getShadowBlur())&&void 0!==i?i:5,a=null!==(n=t.getShadowOffset())&&void 0!==n?n:{x:0,y:0},o=t.getAbsoluteScale(),c=this.canvas.getPixelRatio(),d=o.x*c,h=o.y*c;this.setAttr("shadowColor",r),this.setAttr("shadowBlur",s*Math.min(Math.abs(d),Math.abs(h))),this.setAttr("shadowOffsetX",a.x*d),this.setAttr("shadowOffsetY",a.y*h)}},e.HitContext=class extends a{constructor(t){super(t),this._context=t._canvas.getContext("2d",{willReadFrequently:!0})}_fill(t){this.save(),this.setAttr("fillStyle",t.colorKey),t._fillFuncHit(this),this.restore()}strokeShape(t){t.hasHitStroke()&&this._stroke(t)}_stroke(t){if(t.hasHitStroke()){const r=t.getStrokeScaleEnabled();if(!r){this.save();var e=this.getCanvas().getPixelRatio();this.setTransform(e,0,0,e,0,0)}this._applyLineCap(t);var i=t.hitStrokeWidth(),n="auto"===i?t.strokeWidth():i;this.setAttr("lineWidth",n),this.setAttr("strokeStyle",t.colorKey),t._strokeFuncHit(this),r||this.restore()}}}},210:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.DD=void 0;const n=i(4417),r=i(8588);e.DD={get isDragging(){var t=!1;return e.DD._dragElements.forEach((e=>{"dragging"===e.dragStatus&&(t=!0)})),t},justDragged:!1,get node(){var t;return e.DD._dragElements.forEach((e=>{t=e.node})),t},_dragElements:new Map,_drag(t){const i=[];e.DD._dragElements.forEach(((e,n)=>{const{node:s}=e,a=s.getStage();a.setPointersPositions(t),void 0===e.pointerId&&(e.pointerId=r.Util._getFirstPointerId(t));const o=a._changedPointerPositions.find((t=>t.id===e.pointerId));if(o){if("dragging"!==e.dragStatus){var c=s.dragDistance();if(Math.max(Math.abs(o.x-e.startPointerPos.x),Math.abs(o.y-e.startPointerPos.y))<c)return;if(s.startDrag({evt:t}),!s.isDragging())return}s._setDragPosition(t,e),i.push(s)}})),i.forEach((e=>{e.fire("dragmove",{type:"dragmove",target:e,evt:t},!0)}))},_endDragBefore(t){const i=[];e.DD._dragElements.forEach((r=>{const{node:s}=r,a=s.getStage();if(t&&a.setPointersPositions(t),!a._changedPointerPositions.find((t=>t.id===r.pointerId)))return;"dragging"!==r.dragStatus&&"stopped"!==r.dragStatus||(e.DD.justDragged=!0,n.Konva._mouseListenClick=!1,n.Konva._touchListenClick=!1,n.Konva._pointerListenClick=!1,r.dragStatus="stopped");const o=r.node.getLayer()||r.node instanceof n.Konva.Stage&&r.node;o&&-1===i.indexOf(o)&&i.push(o)})),i.forEach((t=>{t.draw()}))},_endDragAfter(t){e.DD._dragElements.forEach(((i,n)=>{"stopped"===i.dragStatus&&i.node.fire("dragend",{type:"dragend",target:i.node,evt:t},!0),"dragging"!==i.dragStatus&&e.DD._dragElements.delete(n)}))}},n.Konva.isBrowser&&(window.addEventListener("mouseup",e.DD._endDragBefore,!0),window.addEventListener("touchend",e.DD._endDragBefore,!0),window.addEventListener("mousemove",e.DD._drag),window.addEventListener("touchmove",e.DD._drag),window.addEventListener("mouseup",e.DD._endDragAfter,!1),window.addEventListener("touchend",e.DD._endDragAfter,!1))},1455:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Factory=void 0;const n=i(8588),r=i(3774);var s="get",a="set";e.Factory={addGetterSetter(t,i,n,r,s){e.Factory.addGetter(t,i,n),e.Factory.addSetter(t,i,r,s),e.Factory.addOverloadedGetterSetter(t,i)},addGetter(t,e,i){var r=s+n.Util._capitalize(e);t.prototype[r]=t.prototype[r]||function(){var t=this.attrs[e];return void 0===t?i:t}},addSetter(t,i,r,s){var o=a+n.Util._capitalize(i);t.prototype[o]||e.Factory.overWriteSetter(t,i,r,s)},overWriteSetter(t,e,i,r){var s=a+n.Util._capitalize(e);t.prototype[s]=function(t){return i&&null!=t&&(t=i.call(this,t,e)),this._setAttr(e,t),r&&r.call(this),this}},addComponentsGetterSetter(t,i,o,c,d){var h,l,u=o.length,p=n.Util._capitalize,m=s+p(i),f=a+p(i);t.prototype[m]=function(){var t={};for(h=0;h<u;h++)t[l=o[h]]=this.getAttr(i+p(l));return t};var g=(0,r.getComponentValidator)(o);t.prototype[f]=function(t){var e,n=this.attrs[i];for(e in c&&(t=c.call(this,t)),g&&g.call(this,t,i),t)t.hasOwnProperty(e)&&this._setAttr(i+p(e),t[e]);return t||o.forEach((t=>{this._setAttr(i+p(t),void 0)})),this._fireChangeEvent(i,n,t),d&&d.call(this),this},e.Factory.addOverloadedGetterSetter(t,i)},addOverloadedGetterSetter(t,e){var i=n.Util._capitalize(e),r=a+i,o=s+i;t.prototype[e]=function(){return arguments.length?(this[r](arguments[0]),this):this[o]()}},addDeprecatedGetterSetter(t,i,r,a){n.Util.error("Adding deprecated "+i);var o=s+n.Util._capitalize(i),c=i+" property is deprecated and will be removed soon. Look at Konva change log for more information.";t.prototype[o]=function(){n.Util.error(c);var t=this.attrs[i];return void 0===t?r:t},e.Factory.addSetter(t,i,a,(function(){n.Util.error(c)})),e.Factory.addOverloadedGetterSetter(t,i)},backCompat(t,e){n.Util.each(e,(function(e,i){var r=t.prototype[i],o=s+n.Util._capitalize(e),c=a+n.Util._capitalize(e);function d(){r.apply(this,arguments),n.Util.error('"'+e+'" method is deprecated and will be removed soon. Use ""'+i+'" instead.')}t.prototype[e]=d,t.prototype[o]=d,t.prototype[c]=d}))},afterSetFilter(){this._filterUpToDate=!1}}},3980:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.FastLayer=void 0;const n=i(8588),r=i(4415),s=i(4417);class a extends r.Layer{constructor(t){super(t),this.listening(!1),n.Util.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.')}}e.FastLayer=a,a.prototype.nodeType="FastLayer",(0,s._registerNode)(a)},4417:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e._registerNode=e.Konva=e.glob=void 0;const n=Math.PI/180;e.glob=void 0!==i.g?i.g:"undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope?self:{},e.Konva={_global:e.glob,version:"9.2.3",isBrowser:"undefined"!=typeof window&&("[object Window]"==={}.toString.call(window)||"[object global]"==={}.toString.call(window)),isUnminified:/param/.test(function(t){}.toString()),dblClickWindow:400,getAngle:t=>e.Konva.angleDeg?t*n:t,enableTrace:!1,pointerEventsEnabled:!0,autoDrawEnabled:!0,hitOnDragEnabled:!1,capturePointerEventsEnabled:!1,_mouseListenClick:!1,_touchListenClick:!1,_pointerListenClick:!1,_mouseInDblClickWindow:!1,_touchInDblClickWindow:!1,_pointerInDblClickWindow:!1,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,pixelRatio:"undefined"!=typeof window&&window.devicePixelRatio||1,dragDistance:3,angleDeg:!0,showWarnings:!0,dragButtons:[0,1],isDragging:()=>e.Konva.DD.isDragging,isDragReady:()=>!!e.Konva.DD.node,releaseCanvasOnDestroy:!0,document:e.glob.document,_injectGlobal(t){e.glob.Konva=t}},e._registerNode=t=>{e.Konva[t.prototype.getClassName()]=t},e.Konva._injectGlobal(e.Konva)},8985:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Group=void 0;const n=i(8588),r=i(8783),s=i(4417);class a extends r.Container{_validateAdd(t){var e=t.getType();"Group"!==e&&"Shape"!==e&&n.Util.throw("You may only add groups and shapes to groups.")}}e.Group=a,a.prototype.nodeType="Group",(0,s._registerNode)(a)},4415:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Layer=void 0;const n=i(8588),r=i(8783),s=i(7939),a=i(1455),o=i(4842),c=i(3774),d=i(7955),h=i(4417);var l=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],u=l.length;class p extends r.Container{constructor(t){super(t),this.canvas=new o.SceneCanvas,this.hitCanvas=new o.HitCanvas({pixelRatio:1}),this._waitingForDraw=!1,this.on("visibleChange.konva",this._checkVisibility),this._checkVisibility(),this.on("imageSmoothingEnabledChange.konva",this._setSmoothEnabled),this._setSmoothEnabled()}createPNGStream(){return this.canvas._canvas.createPNGStream()}getCanvas(){return this.canvas}getNativeCanvasElement(){return this.canvas._canvas}getHitCanvas(){return this.hitCanvas}getContext(){return this.getCanvas().getContext()}clear(t){return this.getContext().clear(t),this.getHitCanvas().getContext().clear(t),this}setZIndex(t){super.setZIndex(t);var e=this.getStage();return e&&e.content&&(e.content.removeChild(this.getNativeCanvasElement()),t<e.children.length-1?e.content.insertBefore(this.getNativeCanvasElement(),e.children[t+1].getCanvas()._canvas):e.content.appendChild(this.getNativeCanvasElement())),this}moveToTop(){s.Node.prototype.moveToTop.call(this);var t=this.getStage();return t&&t.content&&(t.content.removeChild(this.getNativeCanvasElement()),t.content.appendChild(this.getNativeCanvasElement())),!0}moveUp(){if(!s.Node.prototype.moveUp.call(this))return!1;var t=this.getStage();return!(!t||!t.content||(t.content.removeChild(this.getNativeCanvasElement()),this.index<t.children.length-1?t.content.insertBefore(this.getNativeCanvasElement(),t.children[this.index+1].getCanvas()._canvas):t.content.appendChild(this.getNativeCanvasElement()),0))}moveDown(){if(s.Node.prototype.moveDown.call(this)){var t=this.getStage();if(t){var e=t.children;t.content&&(t.content.removeChild(this.getNativeCanvasElement()),t.content.insertBefore(this.getNativeCanvasElement(),e[this.index+1].getCanvas()._canvas))}return!0}return!1}moveToBottom(){if(s.Node.prototype.moveToBottom.call(this)){var t=this.getStage();if(t){var e=t.children;t.content&&(t.content.removeChild(this.getNativeCanvasElement()),t.content.insertBefore(this.getNativeCanvasElement(),e[1].getCanvas()._canvas))}return!0}return!1}getLayer(){return this}remove(){var t=this.getNativeCanvasElement();return s.Node.prototype.remove.call(this),t&&t.parentNode&&n.Util._isInDocument(t)&&t.parentNode.removeChild(t),this}getStage(){return this.parent}setSize({width:t,height:e}){return this.canvas.setSize(t,e),this.hitCanvas.setSize(t,e),this._setSmoothEnabled(),this}_validateAdd(t){var e=t.getType();"Group"!==e&&"Shape"!==e&&n.Util.throw("You may only add groups and shapes to a layer.")}_toKonvaCanvas(t){return(t=t||{}).width=t.width||this.getWidth(),t.height=t.height||this.getHeight(),t.x=void 0!==t.x?t.x:this.x(),t.y=void 0!==t.y?t.y:this.y(),s.Node.prototype._toKonvaCanvas.call(this,t)}_checkVisibility(){const t=this.visible();this.canvas._canvas.style.display=t?"block":"none"}_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled()}getWidth(){if(this.parent)return this.parent.width()}setWidth(){n.Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.')}getHeight(){if(this.parent)return this.parent.height()}setHeight(){n.Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}batchDraw(){return this._waitingForDraw||(this._waitingForDraw=!0,n.Util.requestAnimFrame((()=>{this.draw(),this._waitingForDraw=!1}))),this}getIntersection(t){if(!this.isListening()||!this.isVisible())return null;for(var e=1,i=!1;;){for(let n=0;n<u;n++){const r=l[n],s=this._getIntersection({x:t.x+r.x*e,y:t.y+r.y*e}),a=s.shape;if(a)return a;if(i=!!s.antialiased,!s.antialiased)break}if(!i)return null;e+=1}}_getIntersection(t){const e=this.hitCanvas.pixelRatio,i=this.hitCanvas.context.getImageData(Math.round(t.x*e),Math.round(t.y*e),1,1).data,r=i[3];if(255===r){const t=n.Util._rgbToHex(i[0],i[1],i[2]),e=d.shapes["#"+t];return e?{shape:e}:{antialiased:!0}}return r>0?{antialiased:!0}:{}}drawScene(t,e){var i=this.getLayer(),n=t||i&&i.getCanvas();return this._fire("beforeDraw",{node:this}),this.clearBeforeDraw()&&n.getContext().clear(),r.Container.prototype.drawScene.call(this,n,e),this._fire("draw",{node:this}),this}drawHit(t,e){var i=this.getLayer(),n=t||i&&i.hitCanvas;return i&&i.clearBeforeDraw()&&i.getHitCanvas().getContext().clear(),r.Container.prototype.drawHit.call(this,n,e),this}enableHitGraph(){return this.hitGraphEnabled(!0),this}disableHitGraph(){return this.hitGraphEnabled(!1),this}setHitGraphEnabled(t){n.Util.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening(t)}getHitGraphEnabled(t){return n.Util.warn("hitGraphEnabled method is deprecated. Please use layer.listening() instead."),this.listening()}toggleHitCanvas(){if(this.parent&&this.parent.content){var t=this.parent;this.hitCanvas._canvas.parentNode?t.content.removeChild(this.hitCanvas._canvas):t.content.appendChild(this.hitCanvas._canvas)}}destroy(){return n.Util.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas),super.destroy()}}e.Layer=p,p.prototype.nodeType="Layer",(0,h._registerNode)(p),a.Factory.addGetterSetter(p,"imageSmoothingEnabled",!0),a.Factory.addGetterSetter(p,"clearBeforeDraw",!0),a.Factory.addGetterSetter(p,"hitGraphEnabled",!0,(0,c.getBooleanValidator)())},7939:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Node=void 0;const n=i(8588),r=i(1455),s=i(4842),a=i(4417),o=i(210),c=i(3774);var d="absoluteOpacity",h="allEventListeners",l="absoluteTransform",u="absoluteScale",p="canvas",m="listening",f="mouseenter",g="mouseleave",v="Shape",y=" ",b="stage",k="transform",S="visible",T=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(y);let w=1;class C{constructor(t){this._id=w++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(t),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(t){t!==k&&t!==l||!this._cache.get(t)?t?this._cache.delete(t):this._cache.clear():this._cache.get(t).dirty=!0}_getCache(t,e){var i=this._cache.get(t);return(void 0===i||(t===k||t===l)&&!0===i.dirty)&&(i=e.call(this),this._cache.set(t,i)),i}_calculate(t,e,i){if(!this._attachedDepsListeners.get(t)){const i=e.map((t=>t+"Change.konva")).join(y);this.on(i,(()=>{this._clearCache(t)})),this._attachedDepsListeners.set(t,!0)}return this._getCache(t,i)}_getCanvasCache(){return this._cache.get(p)}_clearSelfAndDescendantCache(t){this._clearCache(t),t===l&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(p)){const{scene:t,filter:e,hit:i}=this._cache.get(p);n.Util.releaseCanvas(t,e,i),this._cache.delete(p)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(t){var e=t||{},i={};void 0!==e.x&&void 0!==e.y&&void 0!==e.width&&void 0!==e.height||(i=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()||void 0}));var r=Math.ceil(e.width||i.width),a=Math.ceil(e.height||i.height),o=e.pixelRatio,c=void 0===e.x?Math.floor(i.x):e.x,h=void 0===e.y?Math.floor(i.y):e.y,l=e.offset||0,m=e.drawBorder||!1,f=e.hitCanvasPixelRatio||1;if(r&&a){r+=2*l+1,a+=2*l+1,c-=l,h-=l;var g=new s.SceneCanvas({pixelRatio:o,width:r,height:a}),v=new s.SceneCanvas({pixelRatio:o,width:0,height:0,willReadFrequently:!0}),y=new s.HitCanvas({pixelRatio:f,width:r,height:a}),b=g.getContext(),k=y.getContext();return y.isCache=!0,g.isCache=!0,this._cache.delete(p),this._filterUpToDate=!1,!1===e.imageSmoothingEnabled&&(g.getContext()._context.imageSmoothingEnabled=!1,v.getContext()._context.imageSmoothingEnabled=!1),b.save(),k.save(),b.translate(-c,-h),k.translate(-c,-h),this._isUnderCache=!0,this._clearSelfAndDescendantCache(d),this._clearSelfAndDescendantCache(u),this.drawScene(g,this),this.drawHit(y,this),this._isUnderCache=!1,b.restore(),k.restore(),m&&(b.save(),b.beginPath(),b.rect(0,0,r,a),b.closePath(),b.setAttr("strokeStyle","red"),b.setAttr("lineWidth",5),b.stroke(),b.restore()),this._cache.set(p,{scene:g,filter:v,hit:y,x:c,y:h}),this._requestDraw(),this}n.Util.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.")}isCached(){return this._cache.has(p)}getClientRect(t){throw new Error('abstract "getClientRect" method call')}_transformedRect(t,e){var i=[{x:t.x,y:t.y},{x:t.x+t.width,y:t.y},{x:t.x+t.width,y:t.y+t.height},{x:t.x,y:t.y+t.height}],n=1/0,r=1/0,s=-1/0,a=-1/0,o=this.getAbsoluteTransform(e);return i.forEach((function(t){var e=o.point(t);void 0===n&&(n=s=e.x,r=a=e.y),n=Math.min(n,e.x),r=Math.min(r,e.y),s=Math.max(s,e.x),a=Math.max(a,e.y)})),{x:n,y:r,width:s-n,height:a-r}}_drawCachedSceneCanvas(t){t.save(),t._applyOpacity(this),t._applyGlobalCompositeOperation(this);const e=this._getCanvasCache();t.translate(e.x,e.y);var i=this._getCachedSceneCanvas(),n=i.pixelRatio;t.drawImage(i._canvas,0,0,i.width/n,i.height/n),t.restore()}_drawCachedHitCanvas(t){var e=this._getCanvasCache(),i=e.hit;t.save(),t.translate(e.x,e.y),t.drawImage(i._canvas,0,0,i.width/i.pixelRatio,i.height/i.pixelRatio),t.restore()}_getCachedSceneCanvas(){var t,e,i,r,s=this.filters(),a=this._getCanvasCache(),o=a.scene,c=a.filter,d=c.getContext();if(s){if(!this._filterUpToDate){var h=o.pixelRatio;c.setSize(o.width/o.pixelRatio,o.height/o.pixelRatio);try{for(t=s.length,d.clear(),d.drawImage(o._canvas,0,0,o.getWidth()/h,o.getHeight()/h),e=d.getImageData(0,0,c.getWidth(),c.getHeight()),i=0;i<t;i++)"function"==typeof(r=s[i])?(r.call(this,e),d.putImageData(e,0,0)):n.Util.error("Filter should be type of function, but got "+typeof r+" instead. Please check correct filters")}catch(t){n.Util.error("Unable to apply filter. "+t.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}this._filterUpToDate=!0}return c}return o}on(t,e){if(this._cache&&this._cache.delete(h),3===arguments.length)return this._delegate.apply(this,arguments);var i,n,r,s,a=t.split(y),o=a.length;for(i=0;i<o;i++)r=(n=a[i].split("."))[0],s=n[1]||"",this.eventListeners[r]||(this.eventListeners[r]=[]),this.eventListeners[r].push({name:s,handler:e});return this}off(t,e){var i,n,r,s,a,o=(t||"").split(y),c=o.length;if(this._cache&&this._cache.delete(h),!t)for(n in this.eventListeners)this._off(n);for(i=0;i<c;i++)if(s=(r=o[i].split("."))[0],a=r[1],s)this.eventListeners[s]&&this._off(s,a,e);else for(n in this.eventListeners)this._off(n,a,e);return this}dispatchEvent(t){var e={target:this,type:t.type,evt:t};return this.fire(t.type,e),this}addEventListener(t,e){return this.on(t,(function(t){e.call(this,t.evt)})),this}removeEventListener(t){return this.off(t),this}_delegate(t,e,i){var r=this;this.on(t,(function(t){for(var s=t.target.findAncestors(e,!0,r),a=0;a<s.length;a++)(t=n.Util.cloneObject(t)).currentTarget=s[a],i.call(s[a],t)}))}remove(){return this.isDragging()&&this.stopDrag(),o.DD._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(l),this._clearSelfAndDescendantCache(d),this._clearSelfAndDescendantCache(u),this._clearSelfAndDescendantCache(b),this._clearSelfAndDescendantCache(S),this._clearSelfAndDescendantCache(m)}_remove(){this._clearCaches();var t=this.getParent();t&&t.children&&(t.children.splice(this.index,1),t._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(t){var e="get"+n.Util._capitalize(t);return n.Util._isFunction(this[e])?this[e]():this.attrs[t]}getAncestors(){for(var t=this.getParent(),e=[];t;)e.push(t),t=t.getParent();return e}getAttrs(){return this.attrs||{}}setAttrs(t){return this._batchTransformChanges((()=>{var e,i;if(!t)return this;for(e in t)"children"!==e&&(i="set"+n.Util._capitalize(e),n.Util._isFunction(this[i])?this[i](t[e]):this._setAttr(e,t[e]))})),this}isListening(){return this._getCache(m,this._isListening)}_isListening(t){if(!this.listening())return!1;const e=this.getParent();return!e||e===t||this===t||e._isListening(t)}isVisible(){return this._getCache(S,this._isVisible)}_isVisible(t){if(!this.visible())return!1;const e=this.getParent();return!e||e===t||this===t||e._isVisible(t)}shouldDrawHit(t,e=!1){if(t)return this._isVisible(t)&&this._isListening(t);var i=this.getLayer(),n=!1;o.DD._dragElements.forEach((t=>{"dragging"===t.dragStatus&&("Stage"===t.node.nodeType||t.node.getLayer()===i)&&(n=!0)}));var r=!e&&!a.Konva.hitOnDragEnabled&&n;return this.isListening()&&this.isVisible()&&!r}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){var t,e,i,n,r=this.getDepth(),s=this,a=0;const o=this.getStage();return"Stage"!==s.nodeType&&o&&function o(c){for(t=[],e=c.length,i=0;i<e;i++)n=c[i],a++,n.nodeType!==v&&(t=t.concat(n.getChildren().slice())),n._id===s._id&&(i=e);t.length>0&&t[0].getDepth()<=r&&o(t)}(o.getChildren()),a}getDepth(){for(var t=0,e=this.parent;e;)t++,e=e.parent;return t}_batchTransformChanges(t){this._batchingTransformChange=!0,t(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(k),this._clearSelfAndDescendantCache(l)),this._needClearTransformCache=!1}setPosition(t){return this._batchTransformChanges((()=>{this.x(t.x),this.y(t.y)})),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){const t=this.getStage();if(!t)return null;var e=t.getPointerPosition();if(!e)return null;var i=this.getAbsoluteTransform().copy();return i.invert(),i.point(e)}getAbsolutePosition(t){let e=!1,i=this.parent;for(;i;){if(i.isCached()){e=!0;break}i=i.parent}e&&!t&&(t=!0);var r=this.getAbsoluteTransform(t).getMatrix(),s=new n.Transform,a=this.offset();return s.m=r.slice(),s.translate(a.x,a.y),s.getTranslation()}setAbsolutePosition(t){const{x:e,y:i,...n}=this._clearTransform();this.attrs.x=e,this.attrs.y=i,this._clearCache(k);var r=this._getAbsoluteTransform().copy();return r.invert(),r.translate(t.x,t.y),t={x:this.attrs.x+r.getTranslation().x,y:this.attrs.y+r.getTranslation().y},this._setTransform(n),this.setPosition({x:t.x,y:t.y}),this._clearCache(k),this._clearSelfAndDescendantCache(l),this}_setTransform(t){var e;for(e in t)this.attrs[e]=t[e]}_clearTransform(){var t={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,t}move(t){var e=t.x,i=t.y,n=this.x(),r=this.y();return void 0!==e&&(n+=e),void 0!==i&&(r+=i),this.setPosition({x:n,y:r}),this}_eachAncestorReverse(t,e){var i,n,r=[],s=this.getParent();if(!e||e._id!==this._id){for(r.unshift(this);s&&(!e||s._id!==e._id);)r.unshift(s),s=s.parent;for(i=r.length,n=0;n<i;n++)t(r[n])}}rotate(t){return this.rotation(this.rotation()+t),this}moveToTop(){if(!this.parent)return n.Util.warn("Node has no parent. moveToTop function is ignored."),!1;var t=this.index;return t<this.parent.getChildren().length-1&&(this.parent.children.splice(t,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0)}moveUp(){if(!this.parent)return n.Util.warn("Node has no parent. moveUp function is ignored."),!1;var t=this.index;return t<this.parent.getChildren().length-1&&(this.parent.children.splice(t,1),this.parent.children.splice(t+1,0,this),this.parent._setChildrenIndices(),!0)}moveDown(){if(!this.parent)return n.Util.warn("Node has no parent. moveDown function is ignored."),!1;var t=this.index;return t>0&&(this.parent.children.splice(t,1),this.parent.children.splice(t-1,0,this),this.parent._setChildrenIndices(),!0)}moveToBottom(){if(!this.parent)return n.Util.warn("Node has no parent. moveToBottom function is ignored."),!1;var t=this.index;return t>0&&(this.parent.children.splice(t,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0)}setZIndex(t){if(!this.parent)return n.Util.warn("Node has no parent. zIndex parameter is ignored."),this;(t<0||t>=this.parent.children.length)&&n.Util.warn("Unexpected value "+t+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");var e=this.index;return this.parent.children.splice(e,1),this.parent.children.splice(t,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(d,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){var t=this.opacity(),e=this.getParent();return e&&!e._isUnderCache&&(t*=e.getAbsoluteOpacity()),t}moveTo(t){return this.getParent()!==t&&(this._remove(),t.add(this)),this}toObject(){var t,e,i,r,s={},a=this.getAttrs();for(t in s.attrs={},a)e=a[t],n.Util.isObject(e)&&!n.Util._isPlainObject(e)&&!n.Util._isArray(e)||(i="function"==typeof this[t]&&this[t],delete a[t],r=i?i.call(this):null,a[t]=e,r!==e&&(s.attrs[t]=e));return s.className=this.getClassName(),n.Util._prepareToStringify(s)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(t,e,i){var n=[];e&&this._isMatch(t)&&n.push(this);for(var r=this.parent;r;){if(r===i)return n;r._isMatch(t)&&n.push(r),r=r.parent}return n}isAncestorOf(t){return!1}findAncestor(t,e,i){return this.findAncestors(t,e,i)[0]}_isMatch(t){if(!t)return!1;if("function"==typeof t)return t(this);var e,i,r=t.replace(/ /g,"").split(","),s=r.length;for(e=0;e<s;e++)if(i=r[e],n.Util.isValidSelector(i)||(n.Util.warn('Selector "'+i+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),n.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),n.Util.warn("Konva is awesome, right?")),"#"===i.charAt(0)){if(this.id()===i.slice(1))return!0}else if("."===i.charAt(0)){if(this.hasName(i.slice(1)))return!0}else if(this.className===i||this.nodeType===i)return!0;return!1}getLayer(){var t=this.getParent();return t?t.getLayer():null}getStage(){return this._getCache(b,this._getStage)}_getStage(){var t=this.getParent();return t?t.getStage():null}fire(t,e={},i){return e.target=e.target||this,i?this._fireAndBubble(t,e):this._fire(t,e),this}getAbsoluteTransform(t){return t?this._getAbsoluteTransform(t):this._getCache(l,this._getAbsoluteTransform)}_getAbsoluteTransform(t){var e;if(t)return e=new n.Transform,this._eachAncestorReverse((function(t){var i=t.transformsEnabled();"all"===i?e.multiply(t.getTransform()):"position"===i&&e.translate(t.x()-t.offsetX(),t.y()-t.offsetY())}),t),e;e=this._cache.get(l)||new n.Transform,this.parent?this.parent.getAbsoluteTransform().copyInto(e):e.reset();var i=this.transformsEnabled();if("all"===i)e.multiply(this.getTransform());else if("position"===i){const t=this.attrs.x||0,i=this.attrs.y||0,n=this.attrs.offsetX||0,r=this.attrs.offsetY||0;e.translate(t-n,i-r)}return e.dirty=!1,e}getAbsoluteScale(t){for(var e=this;e;)e._isUnderCache&&(t=e),e=e.getParent();const i=this.getAbsoluteTransform(t).decompose();return{x:i.scaleX,y:i.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(k,this._getTransform)}_getTransform(){var t,e,i=this._cache.get(k)||new n.Transform;i.reset();var r=this.x(),s=this.y(),o=a.Konva.getAngle(this.rotation()),c=null!==(t=this.attrs.scaleX)&&void 0!==t?t:1,d=null!==(e=this.attrs.scaleY)&&void 0!==e?e:1,h=this.attrs.skewX||0,l=this.attrs.skewY||0,u=this.attrs.offsetX||0,p=this.attrs.offsetY||0;return 0===r&&0===s||i.translate(r,s),0!==o&&i.rotate(o),0===h&&0===l||i.skew(h,l),1===c&&1===d||i.scale(c,d),0===u&&0===p||i.translate(-1*u,-1*p),i.dirty=!1,i}clone(t){var e,i,r,s,a,o=n.Util.cloneObject(this.attrs);for(e in t)o[e]=t[e];var c=new this.constructor(o);for(e in this.eventListeners)for(r=(i=this.eventListeners[e]).length,s=0;s<r;s++)(a=i[s]).name.indexOf("konva")<0&&(c.eventListeners[e]||(c.eventListeners[e]=[]),c.eventListeners[e].push(a));return c}_toKonvaCanvas(t){t=t||{};var e=this.getClientRect(),i=this.getStage(),n=void 0!==t.x?t.x:Math.floor(e.x),r=void 0!==t.y?t.y:Math.floor(e.y),a=t.pixelRatio||1,o=new s.SceneCanvas({width:t.width||Math.ceil(e.width)||(i?i.width():0),height:t.height||Math.ceil(e.height)||(i?i.height():0),pixelRatio:a}),c=o.getContext();return!1===t.imageSmoothingEnabled&&(c._context.imageSmoothingEnabled=!1),c.save(),(n||r)&&c.translate(-1*n,-1*r),this.drawScene(o),c.restore(),o}toCanvas(t){return this._toKonvaCanvas(t)._canvas}toDataURL(t){var e=(t=t||{}).mimeType||null,i=t.quality||null,n=this._toKonvaCanvas(t).toDataURL(e,i);return t.callback&&t.callback(n),n}toImage(t){return new Promise(((e,i)=>{try{const i=null==t?void 0:t.callback;i&&delete t.callback,n.Util._urlToImage(this.toDataURL(t),(function(t){e(t),null==i||i(t)}))}catch(t){i(t)}}))}toBlob(t){return new Promise(((e,i)=>{try{const i=null==t?void 0:t.callback;i&&delete t.callback,this.toCanvas(t).toBlob((t=>{e(t),null==i||i(t)}))}catch(t){i(t)}}))}setSize(t){return this.width(t.width),this.height(t.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return void 0!==this.attrs.dragDistance?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():a.Konva.dragDistance}_off(t,e,i){var n,r,s,a=this.eventListeners[t];for(n=0;n<a.length;n++)if(r=a[n].name,s=a[n].handler,!("konva"===r&&"konva"!==e||e&&r!==e||i&&i!==s)){if(a.splice(n,1),0===a.length){delete this.eventListeners[t];break}n--}}_fireChangeEvent(t,e,i){this._fire(t+"Change",{oldVal:e,newVal:i})}addName(t){if(!this.hasName(t)){var e=this.name(),i=e?e+" "+t:t;this.name(i)}return this}hasName(t){if(!t)return!1;const e=this.name();return!!e&&-1!==(e||"").split(/\s/g).indexOf(t)}removeName(t){var e=(this.name()||"").split(/\s/g),i=e.indexOf(t);return-1!==i&&(e.splice(i,1),this.name(e.join(" "))),this}setAttr(t,e){var i=this["set"+n.Util._capitalize(t)];return n.Util._isFunction(i)?i.call(this,e):this._setAttr(t,e),this}_requestDraw(){if(a.Konva.autoDrawEnabled){const t=this.getLayer()||this.getStage();null==t||t.batchDraw()}}_setAttr(t,e){var i=this.attrs[t];(i!==e||n.Util.isObject(e))&&(null==e?delete this.attrs[t]:this.attrs[t]=e,this._shouldFireChangeEvents&&this._fireChangeEvent(t,i,e),this._requestDraw())}_setComponentAttr(t,e,i){var n;void 0!==i&&((n=this.attrs[t])||(this.attrs[t]=this.getAttr(t)),this.attrs[t][e]=i,this._fireChangeEvent(t,n,i))}_fireAndBubble(t,e,i){if(e&&this.nodeType===v&&(e.target=this),t!==f&&t!==g||!(i&&(this===i||this.isAncestorOf&&this.isAncestorOf(i))||"Stage"===this.nodeType&&!i)){this._fire(t,e);var n=(t===f||t===g)&&i&&i.isAncestorOf&&i.isAncestorOf(this)&&!i.isAncestorOf(this.parent);(e&&!e.cancelBubble||!e)&&this.parent&&this.parent.isListening()&&!n&&(i&&i.parent?this._fireAndBubble.call(this.parent,t,e,i):this._fireAndBubble.call(this.parent,t,e))}}_getProtoListeners(t){var e,i,n;const r=null!==(e=this._cache.get(h))&&void 0!==e?e:{};let s=null==r?void 0:r[t];if(void 0===s){s=[];let e=Object.getPrototypeOf(this);for(;e;){const r=null!==(n=null===(i=e.eventListeners)||void 0===i?void 0:i[t])&&void 0!==n?n:[];s.push(...r),e=Object.getPrototypeOf(e)}r[t]=s,this._cache.set(h,r)}return s}_fire(t,e){(e=e||{}).currentTarget=this,e.type=t;const i=this._getProtoListeners(t);if(i)for(var n=0;n<i.length;n++)i[n].handler.call(this,e);const r=this.eventListeners[t];if(r)for(n=0;n<r.length;n++)r[n].handler.call(this,e)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(t){var e=t?t.pointerId:void 0,i=this.getStage(),n=this.getAbsolutePosition();if(i){var r=i._getPointerById(e)||i._changedPointerPositions[0]||n;o.DD._dragElements.set(this._id,{node:this,startPointerPos:r,offset:{x:r.x-n.x,y:r.y-n.y},dragStatus:"ready",pointerId:e})}}startDrag(t,e=!0){o.DD._dragElements.has(this._id)||this._createDragElement(t),o.DD._dragElements.get(this._id).dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:t&&t.evt},e)}_setDragPosition(t,e){const i=this.getStage()._getPointerById(e.pointerId);if(i){var r={x:i.x-e.offset.x,y:i.y-e.offset.y},s=this.dragBoundFunc();if(void 0!==s){const e=s.call(this,r,t);e?r=e:n.Util.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}this._lastPos&&this._lastPos.x===r.x&&this._lastPos.y===r.y||(this.setAbsolutePosition(r),this._requestDraw()),this._lastPos=r}}stopDrag(t){const e=o.DD._dragElements.get(this._id);e&&(e.dragStatus="stopped"),o.DD._endDragBefore(t),o.DD._endDragAfter(t)}setDraggable(t){this._setAttr("draggable",t),this._dragChange()}isDragging(){const t=o.DD._dragElements.get(this._id);return!!t&&"dragging"===t.dragStatus}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",(function(t){if((void 0===t.evt.button||a.Konva.dragButtons.indexOf(t.evt.button)>=0)&&!this.isDragging()){var e=!1;o.DD._dragElements.forEach((t=>{this.isAncestorOf(t.node)&&(e=!0)})),e||this._createDragElement(t)}}))}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const t=o.DD._dragElements.get(this._id),e=t&&"dragging"===t.dragStatus,i=t&&"ready"===t.dragStatus;e?this.stopDrag():i&&o.DD._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(t={x:0,y:0}){const e=this.getStage();if(!e)return!1;const i={x:-t.x,y:-t.y,width:e.width()+2*t.x,height:e.height()+2*t.y};return n.Util.haveIntersection(i,this.getClientRect())}static create(t,e){return n.Util._isString(t)&&(t=JSON.parse(t)),this._createNode(t,e)}static _createNode(t,e){var i,r,s,o=C.prototype.getClassName.call(t),c=t.children;if(e&&(t.attrs.container=e),a.Konva[o]||(n.Util.warn('Can not find a node with class name "'+o+'". Fallback to "Shape".'),o="Shape"),i=new(0,a.Konva[o])(t.attrs),c)for(r=c.length,s=0;s<r;s++)i.add(C._createNode(c[s]));return i}}e.Node=C,C.prototype.nodeType="Node",C.prototype._attrsAffectingSize=[],C.prototype.eventListeners={},C.prototype.on.call(C.prototype,T,(function(){this._batchingTransformChange?this._needClearTransformCache=!0:(this._clearCache(k),this._clearSelfAndDescendantCache(l))})),C.prototype.on.call(C.prototype,"visibleChange.konva",(function(){this._clearSelfAndDescendantCache(S)})),C.prototype.on.call(C.prototype,"listeningChange.konva",(function(){this._clearSelfAndDescendantCache(m)})),C.prototype.on.call(C.prototype,"opacityChange.konva",(function(){this._clearSelfAndDescendantCache(d)}));const _=r.Factory.addGetterSetter;_(C,"zIndex"),_(C,"absolutePosition"),_(C,"position"),_(C,"x",0,(0,c.getNumberValidator)()),_(C,"y",0,(0,c.getNumberValidator)()),_(C,"globalCompositeOperation","source-over",(0,c.getStringValidator)()),_(C,"opacity",1,(0,c.getNumberValidator)()),_(C,"name","",(0,c.getStringValidator)()),_(C,"id","",(0,c.getStringValidator)()),_(C,"rotation",0,(0,c.getNumberValidator)()),r.Factory.addComponentsGetterSetter(C,"scale",["x","y"]),_(C,"scaleX",1,(0,c.getNumberValidator)()),_(C,"scaleY",1,(0,c.getNumberValidator)()),r.Factory.addComponentsGetterSetter(C,"skew",["x","y"]),_(C,"skewX",0,(0,c.getNumberValidator)()),_(C,"skewY",0,(0,c.getNumberValidator)()),r.Factory.addComponentsGetterSetter(C,"offset",["x","y"]),_(C,"offsetX",0,(0,c.getNumberValidator)()),_(C,"offsetY",0,(0,c.getNumberValidator)()),_(C,"dragDistance",null,(0,c.getNumberValidator)()),_(C,"width",0,(0,c.getNumberValidator)()),_(C,"height",0,(0,c.getNumberValidator)()),_(C,"listening",!0,(0,c.getBooleanValidator)()),_(C,"preventDefault",!0,(0,c.getBooleanValidator)()),_(C,"filters",null,(function(t){return this._filterUpToDate=!1,t})),_(C,"visible",!0,(0,c.getBooleanValidator)()),_(C,"transformsEnabled","all",(0,c.getStringValidator)()),_(C,"size"),_(C,"dragBoundFunc"),_(C,"draggable",!1,(0,c.getBooleanValidator)()),r.Factory.backCompat(C,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"})},8479:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.releaseCapture=e.setPointerCapture=e.hasPointerCapture=e.createEvent=e.getCapturedShape=void 0;const n=i(4417),r=new Map,s=void 0!==n.Konva._global.PointerEvent;function a(t){return{evt:t,pointerId:t.pointerId}}function o(t,e){const i=r.get(t);if(!i)return;const n=i.getStage();n&&n.content,r.delete(t),s&&i._fire("lostpointercapture",a(new PointerEvent("lostpointercapture")))}e.getCapturedShape=function(t){return r.get(t)},e.createEvent=a,e.hasPointerCapture=function(t,e){return r.get(t)===e},e.setPointerCapture=function(t,e){o(t),e.getStage()&&(r.set(t,e),s&&e._fire("gotpointercapture",a(new PointerEvent("gotpointercapture"))))},e.releaseCapture=o},7955:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Shape=e.shapes=void 0;const n=i(4417),r=i(8588),s=i(1455),a=i(7939),o=i(3774),c=i(4417),d=i(8479);var h="hasShadow",l="shadowRGBA",u="patternImage",p="linearGradient",m="radialGradient";let f;function g(){return f||(f=r.Util.createCanvasElement().getContext("2d"),f)}e.shapes={};class v extends a.Node{constructor(t){let i;for(super(t);i=r.Util.getRandomColor(),!i||i in e.shapes;);this.colorKey=i,e.shapes[i]=this}getContext(){return r.Util.warn("shape.getContext() method is deprecated. Please do not use it."),this.getLayer().getContext()}getCanvas(){return r.Util.warn("shape.getCanvas() method is deprecated. Please do not use it."),this.getLayer().getCanvas()}getSceneFunc(){return this.attrs.sceneFunc||this._sceneFunc}getHitFunc(){return this.attrs.hitFunc||this._hitFunc}hasShadow(){return this._getCache(h,this._hasShadow)}_hasShadow(){return this.shadowEnabled()&&0!==this.shadowOpacity()&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY())}_getFillPattern(){return this._getCache(u,this.__getFillPattern)}__getFillPattern(){if(this.fillPatternImage()){const t=g().createPattern(this.fillPatternImage(),this.fillPatternRepeat()||"repeat");if(t&&t.setTransform){const e=new r.Transform;e.translate(this.fillPatternX(),this.fillPatternY()),e.rotate(n.Konva.getAngle(this.fillPatternRotation())),e.scale(this.fillPatternScaleX(),this.fillPatternScaleY()),e.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const i=e.getMatrix(),s="undefined"==typeof DOMMatrix?{a:i[0],b:i[1],c:i[2],d:i[3],e:i[4],f:i[5]}:new DOMMatrix(i);t.setTransform(s)}return t}}_getLinearGradient(){return this._getCache(p,this.__getLinearGradient)}__getLinearGradient(){var t=this.fillLinearGradientColorStops();if(t){for(var e=g(),i=this.fillLinearGradientStartPoint(),n=this.fillLinearGradientEndPoint(),r=e.createLinearGradient(i.x,i.y,n.x,n.y),s=0;s<t.length;s+=2)r.addColorStop(t[s],t[s+1]);return r}}_getRadialGradient(){return this._getCache(m,this.__getRadialGradient)}__getRadialGradient(){var t=this.fillRadialGradientColorStops();if(t){for(var e=g(),i=this.fillRadialGradientStartPoint(),n=this.fillRadialGradientEndPoint(),r=e.createRadialGradient(i.x,i.y,this.fillRadialGradientStartRadius(),n.x,n.y,this.fillRadialGradientEndRadius()),s=0;s<t.length;s+=2)r.addColorStop(t[s],t[s+1]);return r}}getShadowRGBA(){return this._getCache(l,this._getShadowRGBA)}_getShadowRGBA(){if(this.hasShadow()){var t=r.Util.colorToRGBA(this.shadowColor());return t?"rgba("+t.r+","+t.g+","+t.b+","+t.a*(this.shadowOpacity()||1)+")":void 0}}hasFill(){return this._calculate("hasFill",["fillEnabled","fill","fillPatternImage","fillLinearGradientColorStops","fillRadialGradientColorStops"],(()=>this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops())))}hasStroke(){return this._calculate("hasStroke",["strokeEnabled","strokeWidth","stroke","strokeLinearGradientColorStops"],(()=>this.strokeEnabled()&&this.strokeWidth()&&!(!this.stroke()&&!this.strokeLinearGradientColorStops())))}hasHitStroke(){const t=this.hitStrokeWidth();return"auto"===t?this.hasStroke():this.strokeEnabled()&&!!t}intersects(t){var e=this.getStage();if(!e)return!1;const i=e.bufferHitCanvas;return i.getContext().clear(),this.drawHit(i,void 0,!0),i.context.getImageData(Math.round(t.x),Math.round(t.y),1,1).data[3]>0}destroy(){return a.Node.prototype.destroy.call(this),delete e.shapes[this.colorKey],delete this.colorKey,this}_useBufferCanvas(t){var e;if(!this.getStage())return!1;if(null!==(e=this.attrs.perfectDrawEnabled)&&void 0!==e&&!e)return!1;const i=t||this.hasFill(),n=this.hasStroke(),r=1!==this.getAbsoluteOpacity();if(i&&n&&r)return!0;const s=this.hasShadow(),a=this.shadowForStrokeEnabled();return!!(i&&n&&s&&a)}setStrokeHitEnabled(t){r.Util.warn("strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead."),t?this.hitStrokeWidth("auto"):this.hitStrokeWidth(0)}getStrokeHitEnabled(){return 0!==this.hitStrokeWidth()}getSelfRect(){var t=this.size();return{x:this._centroid?-t.width/2:0,y:this._centroid?-t.height/2:0,width:t.width,height:t.height}}getClientRect(t={}){const e=t.skipTransform,i=t.relativeTo,n=this.getSelfRect(),r=!t.skipStroke&&this.hasStroke()&&this.strokeWidth()||0,s=n.width+r,a=n.height+r,o=!t.skipShadow&&this.hasShadow(),c=o?this.shadowOffsetX():0,d=o?this.shadowOffsetY():0,h=s+Math.abs(c),l=a+Math.abs(d),u=o&&this.shadowBlur()||0,p={width:h+2*u,height:l+2*u,x:-(r/2+u)+Math.min(c,0)+n.x,y:-(r/2+u)+Math.min(d,0)+n.y};return e?p:this._transformedRect(p,i)}drawScene(t,e){var i,n,r=this.getLayer(),s=t||r.getCanvas(),a=s.getContext(),o=this._getCanvasCache(),c=this.getSceneFunc(),d=this.hasShadow(),h=s.isCache,l=e===this;if(!this.isVisible()&&!l)return this;if(o){a.save();var u=this.getAbsoluteTransform(e).getMatrix();return a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),this._drawCachedSceneCanvas(a),a.restore(),this}if(!c)return this;if(a.save(),this._useBufferCanvas()&&!h){(n=(i=this.getStage().bufferCanvas).getContext()).clear(),n.save(),n._applyLineJoin(this);var p=this.getAbsoluteTransform(e).getMatrix();n.transform(p[0],p[1],p[2],p[3],p[4],p[5]),c.call(this,n,this),n.restore();var m=i.pixelRatio;d&&a._applyShadow(this),a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(i._canvas,0,0,i.width/m,i.height/m)}else a._applyLineJoin(this),l||(p=this.getAbsoluteTransform(e).getMatrix(),a.transform(p[0],p[1],p[2],p[3],p[4],p[5]),a._applyOpacity(this),a._applyGlobalCompositeOperation(this)),d&&a._applyShadow(this),c.call(this,a,this);return a.restore(),this}drawHit(t,e,i=!1){if(!this.shouldDrawHit(e,i))return this;var n=this.getLayer(),s=t||n.hitCanvas,a=s&&s.getContext(),o=this.hitFunc()||this.sceneFunc(),c=this._getCanvasCache(),d=c&&c.hit;if(this.colorKey||r.Util.warn("Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()"),d){a.save();var h=this.getAbsoluteTransform(e).getMatrix();return a.transform(h[0],h[1],h[2],h[3],h[4],h[5]),this._drawCachedHitCanvas(a),a.restore(),this}if(!o)return this;if(a.save(),a._applyLineJoin(this),this!==e){var l=this.getAbsoluteTransform(e).getMatrix();a.transform(l[0],l[1],l[2],l[3],l[4],l[5])}return o.call(this,a,this),a.restore(),this}drawHitFromCache(t=0){var e,i,n,s,a,o=this._getCanvasCache(),c=this._getCachedSceneCanvas(),d=o.hit,h=d.getContext(),l=d.getWidth(),u=d.getHeight();h.clear(),h.drawImage(c._canvas,0,0,l,u);try{for(n=(i=(e=h.getImageData(0,0,l,u)).data).length,s=r.Util._hexToRgb(this.colorKey),a=0;a<n;a+=4)i[a+3]>t?(i[a]=s.r,i[a+1]=s.g,i[a+2]=s.b,i[a+3]=255):i[a+3]=0;h.putImageData(e,0,0)}catch(t){r.Util.error("Unable to draw hit graph from cached scene canvas. "+t.message)}return this}hasPointerCapture(t){return d.hasPointerCapture(t,this)}setPointerCapture(t){d.setPointerCapture(t,this)}releaseCapture(t){d.releaseCapture(t,this)}}e.Shape=v,v.prototype._fillFunc=function(t){const e=this.attrs.fillRule;e?t.fill(e):t.fill()},v.prototype._strokeFunc=function(t){t.stroke()},v.prototype._fillFuncHit=function(t){t.fill()},v.prototype._strokeFuncHit=function(t){t.stroke()},v.prototype._centroid=!1,v.prototype.nodeType="Shape",(0,c._registerNode)(v),v.prototype.eventListeners={},v.prototype.on.call(v.prototype,"shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",(function(){this._clearCache(h)})),v.prototype.on.call(v.prototype,"shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",(function(){this._clearCache(l)})),v.prototype.on.call(v.prototype,"fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva",(function(){this._clearCache(u)})),v.prototype.on.call(v.prototype,"fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva",(function(){this._clearCache(p)})),v.prototype.on.call(v.prototype,"fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva",(function(){this._clearCache(m)})),s.Factory.addGetterSetter(v,"stroke",void 0,(0,o.getStringOrGradientValidator)()),s.Factory.addGetterSetter(v,"strokeWidth",2,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillAfterStrokeEnabled",!1),s.Factory.addGetterSetter(v,"hitStrokeWidth","auto",(0,o.getNumberOrAutoValidator)()),s.Factory.addGetterSetter(v,"strokeHitEnabled",!0,(0,o.getBooleanValidator)()),s.Factory.addGetterSetter(v,"perfectDrawEnabled",!0,(0,o.getBooleanValidator)()),s.Factory.addGetterSetter(v,"shadowForStrokeEnabled",!0,(0,o.getBooleanValidator)()),s.Factory.addGetterSetter(v,"lineJoin"),s.Factory.addGetterSetter(v,"lineCap"),s.Factory.addGetterSetter(v,"sceneFunc"),s.Factory.addGetterSetter(v,"hitFunc"),s.Factory.addGetterSetter(v,"dash"),s.Factory.addGetterSetter(v,"dashOffset",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"shadowColor",void 0,(0,o.getStringValidator)()),s.Factory.addGetterSetter(v,"shadowBlur",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"shadowOpacity",1,(0,o.getNumberValidator)()),s.Factory.addComponentsGetterSetter(v,"shadowOffset",["x","y"]),s.Factory.addGetterSetter(v,"shadowOffsetX",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"shadowOffsetY",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillPatternImage"),s.Factory.addGetterSetter(v,"fill",void 0,(0,o.getStringOrGradientValidator)()),s.Factory.addGetterSetter(v,"fillPatternX",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillPatternY",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillLinearGradientColorStops"),s.Factory.addGetterSetter(v,"strokeLinearGradientColorStops"),s.Factory.addGetterSetter(v,"fillRadialGradientStartRadius",0),s.Factory.addGetterSetter(v,"fillRadialGradientEndRadius",0),s.Factory.addGetterSetter(v,"fillRadialGradientColorStops"),s.Factory.addGetterSetter(v,"fillPatternRepeat","repeat"),s.Factory.addGetterSetter(v,"fillEnabled",!0),s.Factory.addGetterSetter(v,"strokeEnabled",!0),s.Factory.addGetterSetter(v,"shadowEnabled",!0),s.Factory.addGetterSetter(v,"dashEnabled",!0),s.Factory.addGetterSetter(v,"strokeScaleEnabled",!0),s.Factory.addGetterSetter(v,"fillPriority","color"),s.Factory.addComponentsGetterSetter(v,"fillPatternOffset",["x","y"]),s.Factory.addGetterSetter(v,"fillPatternOffsetX",0,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillPatternOffsetY",0,(0,o.getNumberValidator)()),s.Factory.addComponentsGetterSetter(v,"fillPatternScale",["x","y"]),s.Factory.addGetterSetter(v,"fillPatternScaleX",1,(0,o.getNumberValidator)()),s.Factory.addGetterSetter(v,"fillPatternScaleY",1,(0,o.getNumberValidator)()),s.Factory.addComponentsGetterSetter(v,"fillLinearGradientStartPoint",["x","y"]),s.Factory.addComponentsGetterSetter(v,"strokeLinearGradientStartPoint",["x","y"]),s.Factory.addGetterSetter(v,"fillLinearGradientStartPointX",0),s.Factory.addGetterSetter(v,"strokeLinearGradientStartPointX",0),s.Factory.addGetterSetter(v,"fillLinearGradientStartPointY",0),s.Factory.addGetterSetter(v,"strokeLinearGradientStartPointY",0),s.Factory.addComponentsGetterSetter(v,"fillLinearGradientEndPoint",["x","y"]),s.Factory.addComponentsGetterSetter(v,"strokeLinearGradientEndPoint",["x","y"]),s.Factory.addGetterSetter(v,"fillLinearGradientEndPointX",0),s.Factory.addGetterSetter(v,"strokeLinearGradientEndPointX",0),s.Factory.addGetterSetter(v,"fillLinearGradientEndPointY",0),s.Factory.addGetterSetter(v,"strokeLinearGradientEndPointY",0),s.Factory.addComponentsGetterSetter(v,"fillRadialGradientStartPoint",["x","y"]),s.Factory.addGetterSetter(v,"fillRadialGradientStartPointX",0),s.Factory.addGetterSetter(v,"fillRadialGradientStartPointY",0),s.Factory.addComponentsGetterSetter(v,"fillRadialGradientEndPoint",["x","y"]),s.Factory.addGetterSetter(v,"fillRadialGradientEndPointX",0),s.Factory.addGetterSetter(v,"fillRadialGradientEndPointY",0),s.Factory.addGetterSetter(v,"fillPatternRotation",0),s.Factory.addGetterSetter(v,"fillRule",void 0,(0,o.getStringValidator)()),s.Factory.backCompat(v,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"})},8342:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Stage=e.stages=void 0;const n=i(8588),r=i(1455),s=i(8783),a=i(4417),o=i(4842),c=i(210),d=i(4417),h=i(8479);var l="mouseleave",u="mouseover",p="mouseenter",m="mousemove",f="mousedown",g="mouseup",v="pointermove",y="pointerdown",b="pointerup",k="pointercancel",S="pointerout",T="pointerleave",w="pointerover",C="pointerenter",_="contextmenu",P="touchstart",E="touchend",x="touchmove",R="touchcancel",I="wheel",D=[[p,"_pointerenter"],[f,"_pointerdown"],[m,"_pointermove"],[g,"_pointerup"],[l,"_pointerleave"],[P,"_pointerdown"],[x,"_pointermove"],[E,"_pointerup"],[R,"_pointercancel"],[u,"_pointerover"],[I,"_wheel"],[_,"_contextmenu"],[y,"_pointerdown"],[v,"_pointermove"],[b,"_pointerup"],[k,"_pointercancel"],["lostpointercapture","_lostpointercapture"]];const M={mouse:{[S]:"mouseout",[T]:l,[w]:u,[C]:p,[v]:m,[y]:f,[b]:g,[k]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[S]:"touchout",[T]:"touchleave",[w]:"touchover",[C]:"touchenter",[v]:x,[y]:P,[b]:E,[k]:R,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[S]:S,[T]:T,[w]:w,[C]:C,[v]:v,[y]:y,[b]:b,[k]:k,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},A=t=>t.indexOf("pointer")>=0?"pointer":t.indexOf("touch")>=0?"touch":"mouse",N=t=>{const e=A(t);return"pointer"===e?a.Konva.pointerEventsEnabled&&M.pointer:"touch"===e?M.touch:"mouse"===e?M.mouse:void 0};function L(t={}){return(t.clipFunc||t.clipWidth||t.clipHeight)&&n.Util.warn("Stage does not support clipping. Please use clip for Layers or Groups."),t}e.stages=[];class O extends s.Container{constructor(t){super(L(t)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),e.stages.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",(()=>{L(this.attrs)})),this._checkVisibility()}_validateAdd(t){const e="Layer"===t.getType(),i="FastLayer"===t.getType();e||i||n.Util.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const t=this.visible()?"":"none";this.content.style.display=t}setContainer(t){if("string"==typeof t){if("."===t.charAt(0)){var e=t.slice(1);t=document.getElementsByClassName(e)[0]}else{var i;i="#"!==t.charAt(0)?t:t.slice(1),t=document.getElementById(i)}if(!t)throw"Can not find container in document with id "+i}return this._setAttr("container",t),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),t.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){var t,e=this.children,i=e.length;for(t=0;t<i;t++)e[t].clear();return this}clone(t){return t||(t={}),t.container="undefined"!=typeof document&&document.createElement("div"),s.Container.prototype.clone.call(this,t)}destroy(){super.destroy();var t=this.content;t&&n.Util._isInDocument(t)&&this.container().removeChild(t);var i=e.stages.indexOf(this);return i>-1&&e.stages.splice(i,1),n.Util.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const t=this._pointerPositions[0]||this._changedPointerPositions[0];return t?{x:t.x,y:t.y}:(n.Util.warn("Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);"),null)}_getPointerById(t){return this._pointerPositions.find((e=>e.id===t))}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(t){(t=t||{}).x=t.x||0,t.y=t.y||0,t.width=t.width||this.width(),t.height=t.height||this.height();var e=new o.SceneCanvas({width:t.width,height:t.height,pixelRatio:t.pixelRatio||1}),i=e.getContext()._context,n=this.children;return(t.x||t.y)&&i.translate(-1*t.x,-1*t.y),n.forEach((function(e){if(e.isVisible()){var n=e._toKonvaCanvas(t);i.drawImage(n._canvas,t.x,t.y,n.getWidth()/n.getPixelRatio(),n.getHeight()/n.getPixelRatio())}})),e}getIntersection(t){if(!t)return null;var e,i=this.children;for(e=i.length-1;e>=0;e--){const n=i[e].getIntersection(t);if(n)return n}return null}_resizeDOM(){var t=this.width(),e=this.height();this.content&&(this.content.style.width=t+"px",this.content.style.height=e+"px"),this.bufferCanvas.setSize(t,e),this.bufferHitCanvas.setSize(t,e),this.children.forEach((i=>{i.setSize({width:t,height:e}),i.draw()}))}add(t,...e){if(arguments.length>1){for(var i=0;i<arguments.length;i++)this.add(arguments[i]);return this}super.add(t);var r=this.children.length;return r>5&&n.Util.warn("The stage has "+r+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),t.setSize({width:this.width(),height:this.height()}),t.draw(),a.Konva.isBrowser&&this.content.appendChild(t.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(t){return h.hasPointerCapture(t,this)}setPointerCapture(t){h.setPointerCapture(t,this)}releaseCapture(t){h.releaseCapture(t,this)}getLayers(){return this.children}_bindContentEvents(){a.Konva.isBrowser&&D.forEach((([t,e])=>{this.content.addEventListener(t,(t=>{this[e](t)}),{passive:!1})}))}_pointerenter(t){this.setPointersPositions(t);const e=N(t.type);e&&this._fire(e.pointerenter,{evt:t,target:this,currentTarget:this})}_pointerover(t){this.setPointersPositions(t);const e=N(t.type);e&&this._fire(e.pointerover,{evt:t,target:this,currentTarget:this})}_getTargetShape(t){let e=this[t+"targetShape"];return e&&!e.getStage()&&(e=null),e}_pointerleave(t){const e=N(t.type),i=A(t.type);if(e){this.setPointersPositions(t);var n=this._getTargetShape(i),r=!c.DD.isDragging||a.Konva.hitOnDragEnabled;n&&r?(n._fireAndBubble(e.pointerout,{evt:t}),n._fireAndBubble(e.pointerleave,{evt:t}),this._fire(e.pointerleave,{evt:t,target:this,currentTarget:this}),this[i+"targetShape"]=null):r&&(this._fire(e.pointerleave,{evt:t,target:this,currentTarget:this}),this._fire(e.pointerout,{evt:t,target:this,currentTarget:this})),this.pointerPos=null,this._pointerPositions=[]}}_pointerdown(t){const e=N(t.type),i=A(t.type);if(e){this.setPointersPositions(t);var n=!1;this._changedPointerPositions.forEach((r=>{var s=this.getIntersection(r);if(c.DD.justDragged=!1,a.Konva["_"+i+"ListenClick"]=!0,!s||!s.isListening())return;a.Konva.capturePointerEventsEnabled&&s.setPointerCapture(r.id),this[i+"ClickStartShape"]=s,s._fireAndBubble(e.pointerdown,{evt:t,pointerId:r.id}),n=!0;const o=t.type.indexOf("touch")>=0;s.preventDefault()&&t.cancelable&&o&&t.preventDefault()})),n||this._fire(e.pointerdown,{evt:t,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}}_pointermove(t){const e=N(t.type),i=A(t.type);if(!e)return;if(c.DD.isDragging&&c.DD.node.preventDefault()&&t.cancelable&&t.preventDefault(),this.setPointersPositions(t),c.DD.isDragging&&!a.Konva.hitOnDragEnabled)return;var n={};let r=!1;var s=this._getTargetShape(i);this._changedPointerPositions.forEach((a=>{const o=h.getCapturedShape(a.id)||this.getIntersection(a),c=a.id,d={evt:t,pointerId:c};var l=s!==o;if(l&&s&&(s._fireAndBubble(e.pointerout,{...d},o),s._fireAndBubble(e.pointerleave,{...d},o)),o){if(n[o._id])return;n[o._id]=!0}o&&o.isListening()?(r=!0,l&&(o._fireAndBubble(e.pointerover,{...d},s),o._fireAndBubble(e.pointerenter,{...d},s),this[i+"targetShape"]=o),o._fireAndBubble(e.pointermove,{...d})):s&&(this._fire(e.pointerover,{evt:t,target:this,currentTarget:this,pointerId:c}),this[i+"targetShape"]=null)})),r||this._fire(e.pointermove,{evt:t,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(t){const e=N(t.type),i=A(t.type);if(!e)return;this.setPointersPositions(t);const n=this[i+"ClickStartShape"],r=this[i+"ClickEndShape"];var s={};let o=!1;this._changedPointerPositions.forEach((d=>{const l=h.getCapturedShape(d.id)||this.getIntersection(d);if(l){if(l.releaseCapture(d.id),s[l._id])return;s[l._id]=!0}const u=d.id,p={evt:t,pointerId:u};let m=!1;a.Konva["_"+i+"InDblClickWindow"]?(m=!0,clearTimeout(this[i+"DblTimeout"])):c.DD.justDragged||(a.Konva["_"+i+"InDblClickWindow"]=!0,clearTimeout(this[i+"DblTimeout"])),this[i+"DblTimeout"]=setTimeout((function(){a.Konva["_"+i+"InDblClickWindow"]=!1}),a.Konva.dblClickWindow),l&&l.isListening()?(o=!0,this[i+"ClickEndShape"]=l,l._fireAndBubble(e.pointerup,{...p}),a.Konva["_"+i+"ListenClick"]&&n&&n===l&&(l._fireAndBubble(e.pointerclick,{...p}),m&&r&&r===l&&l._fireAndBubble(e.pointerdblclick,{...p}))):(this[i+"ClickEndShape"]=null,a.Konva["_"+i+"ListenClick"]&&this._fire(e.pointerclick,{evt:t,target:this,currentTarget:this,pointerId:u}),m&&this._fire(e.pointerdblclick,{evt:t,target:this,currentTarget:this,pointerId:u}))})),o||this._fire(e.pointerup,{evt:t,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),a.Konva["_"+i+"ListenClick"]=!1,t.cancelable&&"touch"!==i&&t.preventDefault()}_contextmenu(t){this.setPointersPositions(t);var e=this.getIntersection(this.getPointerPosition());e&&e.isListening()?e._fireAndBubble(_,{evt:t}):this._fire(_,{evt:t,target:this,currentTarget:this})}_wheel(t){this.setPointersPositions(t);var e=this.getIntersection(this.getPointerPosition());e&&e.isListening()?e._fireAndBubble(I,{evt:t}):this._fire(I,{evt:t,target:this,currentTarget:this})}_pointercancel(t){this.setPointersPositions(t);const e=h.getCapturedShape(t.pointerId)||this.getIntersection(this.getPointerPosition());e&&e._fireAndBubble(b,h.createEvent(t)),h.releaseCapture(t.pointerId)}_lostpointercapture(t){h.releaseCapture(t.pointerId)}setPointersPositions(t){var e=this._getContentPosition(),i=null,r=null;void 0!==(t=t||window.event).touches?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(t.touches,(t=>{this._pointerPositions.push({id:t.identifier,x:(t.clientX-e.left)/e.scaleX,y:(t.clientY-e.top)/e.scaleY})})),Array.prototype.forEach.call(t.changedTouches||t.touches,(t=>{this._changedPointerPositions.push({id:t.identifier,x:(t.clientX-e.left)/e.scaleX,y:(t.clientY-e.top)/e.scaleY})}))):(i=(t.clientX-e.left)/e.scaleX,r=(t.clientY-e.top)/e.scaleY,this.pointerPos={x:i,y:r},this._pointerPositions=[{x:i,y:r,id:n.Util._getFirstPointerId(t)}],this._changedPointerPositions=[{x:i,y:r,id:n.Util._getFirstPointerId(t)}])}_setPointerPosition(t){n.Util.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(t)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};var t=this.content.getBoundingClientRect();return{top:t.top,left:t.left,scaleX:t.width/this.content.clientWidth||1,scaleY:t.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new o.SceneCanvas({width:this.width(),height:this.height()}),this.bufferHitCanvas=new o.HitCanvas({pixelRatio:1,width:this.width(),height:this.height()}),a.Konva.isBrowser){var t=this.container();if(!t)throw"Stage has no container. A container is required.";t.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),t.appendChild(this.content),this._resizeDOM()}}cache(){return n.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach((function(t){t.batchDraw()})),this}}e.Stage=O,O.prototype.nodeType="Stage",(0,d._registerNode)(O),r.Factory.addGetterSetter(O,"container")},8017:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Easings=e.Tween=void 0;const n=i(8588),r=i(6745),s=i(7939),a=i(4417);var o={node:1,duration:1,easing:1,onFinish:1,yoyo:1},c=0,d=["fill","stroke","shadowColor"];class h{constructor(t,e,i,n,r,s,a){this.prop=t,this.propFunc=e,this.begin=n,this._pos=n,this.duration=s,this._change=0,this.prevPos=0,this.yoyo=a,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=i,this._change=r-this.begin,this.pause()}fire(t){var e=this[t];e&&e()}setTime(t){t>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():t<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=t,this.update())}getTime(){return this._time}setPosition(t){this.prevPos=this._pos,this.propFunc(t),this._pos=t}getPosition(t){return void 0===t&&(t=this._time),this.func(t,this.begin,this._change,this.duration)}play(){this.state=2,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=3,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(t){this.pause(),this._time=t,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){var t=this.getTimer()-this._startTime;2===this.state?this.setTime(t):3===this.state&&this.setTime(this.duration-t)}pause(){this.state=1,this.fire("onPause")}getTimer(){return(new Date).getTime()}}class l{constructor(t){var i,s,d=this,u=t.node,p=u._id,m=t.easing||e.Easings.Linear,f=!!t.yoyo;i=void 0===t.duration?.3:0===t.duration?.001:t.duration,this.node=u,this._id=c++;var g=u.getLayer()||(u instanceof a.Konva.Stage?u.getLayers():null);for(s in g||n.Util.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new r.Animation((function(){d.tween.onEnterFrame()}),g),this.tween=new h(s,(function(t){d._tweenFunc(t)}),m,0,1,1e3*i,f),this._addListeners(),l.attrs[p]||(l.attrs[p]={}),l.attrs[p][this._id]||(l.attrs[p][this._id]={}),l.tweens[p]||(l.tweens[p]={}),t)void 0===o[s]&&this._addAttr(s,t[s]);this.reset(),this.onFinish=t.onFinish,this.onReset=t.onReset,this.onUpdate=t.onUpdate}_addAttr(t,e){var i,r,s,a,o,c,h,u,p=this.node,m=p._id;if((s=l.tweens[m][t])&&delete l.attrs[m][s][t],i=p.getAttr(t),n.Util._isArray(e))if(r=[],o=Math.max(e.length,i.length),"points"===t&&e.length!==i.length&&(e.length>i.length?(h=i,i=n.Util._prepareArrayForTween(i,e,p.closed())):(c=e,e=n.Util._prepareArrayForTween(e,i,p.closed()))),0===t.indexOf("fill"))for(a=0;a<o;a++)if(a%2==0)r.push(e[a]-i[a]);else{var f=n.Util.colorToRGBA(i[a]);u=n.Util.colorToRGBA(e[a]),i[a]=f,r.push({r:u.r-f.r,g:u.g-f.g,b:u.b-f.b,a:u.a-f.a})}else for(a=0;a<o;a++)r.push(e[a]-i[a]);else-1!==d.indexOf(t)?(i=n.Util.colorToRGBA(i),r={r:(u=n.Util.colorToRGBA(e)).r-i.r,g:u.g-i.g,b:u.b-i.b,a:u.a-i.a}):r=e-i;l.attrs[m][this._id][t]={start:i,diff:r,end:e,trueEnd:c,trueStart:h},l.tweens[m][t]=this._id}_tweenFunc(t){var e,i,r,s,a,o,c,h,u=this.node,p=l.attrs[u._id][this._id];for(e in p){if(r=(i=p[e]).start,s=i.diff,h=i.end,n.Util._isArray(r))if(a=[],c=Math.max(r.length,h.length),0===e.indexOf("fill"))for(o=0;o<c;o++)o%2==0?a.push((r[o]||0)+s[o]*t):a.push("rgba("+Math.round(r[o].r+s[o].r*t)+","+Math.round(r[o].g+s[o].g*t)+","+Math.round(r[o].b+s[o].b*t)+","+(r[o].a+s[o].a*t)+")");else for(o=0;o<c;o++)a.push((r[o]||0)+s[o]*t);else a=-1!==d.indexOf(e)?"rgba("+Math.round(r.r+s.r*t)+","+Math.round(r.g+s.g*t)+","+Math.round(r.b+s.b*t)+","+(r.a+s.a*t)+")":r+s*t;u.setAttr(e,a)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{var t=this.node,e=l.attrs[t._id][this._id];e.points&&e.points.trueEnd&&t.setAttr("points",e.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{var t=this.node,e=l.attrs[t._id][this._id];e.points&&e.points.trueStart&&t.points(e.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(t){return this.tween.seek(1e3*t),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){var t,e=this.node._id,i=this._id,n=l.tweens[e];for(t in this.pause(),n)delete l.tweens[e][t];delete l.attrs[e][i]}}e.Tween=l,l.attrs={},l.tweens={},s.Node.prototype.to=function(t){var e=t.onFinish;t.node=this,t.onFinish=function(){this.destroy(),e&&e()},new l(t).play()},e.Easings={BackEaseIn(t,e,i,n){var r=1.70158;return i*(t/=n)*t*((r+1)*t-r)+e},BackEaseOut(t,e,i,n){var r=1.70158;return i*((t=t/n-1)*t*((r+1)*t+r)+1)+e},BackEaseInOut(t,e,i,n){var r=1.70158;return(t/=n/2)<1?i/2*(t*t*((1+(r*=1.525))*t-r))+e:i/2*((t-=2)*t*((1+(r*=1.525))*t+r)+2)+e},ElasticEaseIn(t,e,i,n,r,s){var a=0;return 0===t?e:1==(t/=n)?e+i:(s||(s=.3*n),!r||r<Math.abs(i)?(r=i,a=s/4):a=s/(2*Math.PI)*Math.asin(i/r),-r*Math.pow(2,10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/s)+e)},ElasticEaseOut(t,e,i,n,r,s){var a=0;return 0===t?e:1==(t/=n)?e+i:(s||(s=.3*n),!r||r<Math.abs(i)?(r=i,a=s/4):a=s/(2*Math.PI)*Math.asin(i/r),r*Math.pow(2,-10*t)*Math.sin((t*n-a)*(2*Math.PI)/s)+i+e)},ElasticEaseInOut(t,e,i,n,r,s){var a=0;return 0===t?e:2==(t/=n/2)?e+i:(s||(s=n*(.3*1.5)),!r||r<Math.abs(i)?(r=i,a=s/4):a=s/(2*Math.PI)*Math.asin(i/r),t<1?r*Math.pow(2,10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/s)*-.5+e:r*Math.pow(2,-10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/s)*.5+i+e)},BounceEaseOut:(t,e,i,n)=>(t/=n)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e,BounceEaseIn:(t,i,n,r)=>n-e.Easings.BounceEaseOut(r-t,0,n,r)+i,BounceEaseInOut:(t,i,n,r)=>t<r/2?.5*e.Easings.BounceEaseIn(2*t,0,n,r)+i:.5*e.Easings.BounceEaseOut(2*t-r,0,n,r)+.5*n+i,EaseIn:(t,e,i,n)=>i*(t/=n)*t+e,EaseOut:(t,e,i,n)=>-i*(t/=n)*(t-2)+e,EaseInOut:(t,e,i,n)=>(t/=n/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e,StrongEaseIn:(t,e,i,n)=>i*(t/=n)*t*t*t*t+e,StrongEaseOut:(t,e,i,n)=>i*((t=t/n-1)*t*t*t*t+1)+e,StrongEaseInOut:(t,e,i,n)=>(t/=n/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e,Linear:(t,e,i,n)=>i*t/n+e}},8588:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Util=e.Transform=void 0;const n=i(4417);class r{constructor(t=[1,0,0,1,0,0]){this.dirty=!1,this.m=t&&t.slice()||[1,0,0,1,0,0]}reset(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=1,this.m[4]=0,this.m[5]=0}copy(){return new r(this.m)}copyInto(t){t.m[0]=this.m[0],t.m[1]=this.m[1],t.m[2]=this.m[2],t.m[3]=this.m[3],t.m[4]=this.m[4],t.m[5]=this.m[5]}point(t){var e=this.m;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}}translate(t,e){return this.m[4]+=this.m[0]*t+this.m[2]*e,this.m[5]+=this.m[1]*t+this.m[3]*e,this}scale(t,e){return this.m[0]*=t,this.m[1]*=t,this.m[2]*=e,this.m[3]*=e,this}rotate(t){var e=Math.cos(t),i=Math.sin(t),n=this.m[0]*e+this.m[2]*i,r=this.m[1]*e+this.m[3]*i,s=this.m[0]*-i+this.m[2]*e,a=this.m[1]*-i+this.m[3]*e;return this.m[0]=n,this.m[1]=r,this.m[2]=s,this.m[3]=a,this}getTranslation(){return{x:this.m[4],y:this.m[5]}}skew(t,e){var i=this.m[0]+this.m[2]*e,n=this.m[1]+this.m[3]*e,r=this.m[2]+this.m[0]*t,s=this.m[3]+this.m[1]*t;return this.m[0]=i,this.m[1]=n,this.m[2]=r,this.m[3]=s,this}multiply(t){var e=this.m[0]*t.m[0]+this.m[2]*t.m[1],i=this.m[1]*t.m[0]+this.m[3]*t.m[1],n=this.m[0]*t.m[2]+this.m[2]*t.m[3],r=this.m[1]*t.m[2]+this.m[3]*t.m[3],s=this.m[0]*t.m[4]+this.m[2]*t.m[5]+this.m[4],a=this.m[1]*t.m[4]+this.m[3]*t.m[5]+this.m[5];return this.m[0]=e,this.m[1]=i,this.m[2]=n,this.m[3]=r,this.m[4]=s,this.m[5]=a,this}invert(){var t=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),e=this.m[3]*t,i=-this.m[1]*t,n=-this.m[2]*t,r=this.m[0]*t,s=t*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),a=t*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=e,this.m[1]=i,this.m[2]=n,this.m[3]=r,this.m[4]=s,this.m[5]=a,this}getMatrix(){return this.m}decompose(){var t=this.m[0],i=this.m[1],n=this.m[2],r=this.m[3],s=t*r-i*n;let a={x:this.m[4],y:this.m[5],rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0};if(0!=t||0!=i){var o=Math.sqrt(t*t+i*i);a.rotation=i>0?Math.acos(t/o):-Math.acos(t/o),a.scaleX=o,a.scaleY=s/o,a.skewX=(t*n+i*r)/s,a.skewY=0}else if(0!=n||0!=r){var c=Math.sqrt(n*n+r*r);a.rotation=Math.PI/2-(r>0?Math.acos(-n/c):-Math.acos(n/c)),a.scaleX=s/c,a.scaleY=c,a.skewX=0,a.skewY=(t*n+i*r)/s}return a.rotation=e.Util._getRotation(a.rotation),a}}e.Transform=r;var s=Math.PI/180,a=180/Math.PI,o="Konva error: ",c={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},d=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/,h=[];const l="undefined"!=typeof requestAnimationFrame&&requestAnimationFrame||function(t){setTimeout(t,60)};e.Util={_isElement:t=>!(!t||1!=t.nodeType),_isFunction:t=>!!(t&&t.constructor&&t.call&&t.apply),_isPlainObject:t=>!!t&&t.constructor===Object,_isArray:t=>"[object Array]"===Object.prototype.toString.call(t),_isNumber:t=>"[object Number]"===Object.prototype.toString.call(t)&&!isNaN(t)&&isFinite(t),_isString:t=>"[object String]"===Object.prototype.toString.call(t),_isBoolean:t=>"[object Boolean]"===Object.prototype.toString.call(t),isObject:t=>t instanceof Object,isValidSelector(t){if("string"!=typeof t)return!1;var e=t[0];return"#"===e||"."===e||e===e.toUpperCase()},_sign:t=>0===t||t>0?1:-1,requestAnimFrame(t){h.push(t),1===h.length&&l((function(){const t=h;h=[],t.forEach((function(t){t()}))}))},createCanvasElement(){var t=document.createElement("canvas");try{t.style=t.style||{}}catch(t){}return t},createImageElement:()=>document.createElement("img"),_isInDocument(t){for(;t=t.parentNode;)if(t==document)return!0;return!1},_urlToImage(t,i){var n=e.Util.createImageElement();n.onload=function(){i(n)},n.src=t},_rgbToHex:(t,e,i)=>((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1),_hexToRgb(t){t=t.replace("#","");var e=parseInt(t,16);return{r:e>>16&255,g:e>>8&255,b:255&e}},getRandomColor(){for(var t=(16777215*Math.random()<<0).toString(16);t.length<6;)t="0"+t;return"#"+t},getRGB(t){var e;return t in c?{r:(e=c[t])[0],g:e[1],b:e[2]}:"#"===t[0]?this._hexToRgb(t.substring(1)):"rgb("===t.substr(0,4)?(e=d.exec(t.replace(/ /g,"")),{r:parseInt(e[1],10),g:parseInt(e[2],10),b:parseInt(e[3],10)}):{r:0,g:0,b:0}},colorToRGBA:t=>(t=t||"black",e.Util._namedColorToRBA(t)||e.Util._hex3ColorToRGBA(t)||e.Util._hex4ColorToRGBA(t)||e.Util._hex6ColorToRGBA(t)||e.Util._hex8ColorToRGBA(t)||e.Util._rgbColorToRGBA(t)||e.Util._rgbaColorToRGBA(t)||e.Util._hslColorToRGBA(t)),_namedColorToRBA(t){var e=c[t.toLowerCase()];return e?{r:e[0],g:e[1],b:e[2],a:1}:null},_rgbColorToRGBA(t){if(0===t.indexOf("rgb(")){var e=(t=t.match(/rgb\(([^)]+)\)/)[1]).split(/ *, */).map(Number);return{r:e[0],g:e[1],b:e[2],a:1}}},_rgbaColorToRGBA(t){if(0===t.indexOf("rgba(")){var e=(t=t.match(/rgba\(([^)]+)\)/)[1]).split(/ *, */).map(((t,e)=>"%"===t.slice(-1)?3===e?parseInt(t)/100:parseInt(t)/100*255:Number(t)));return{r:e[0],g:e[1],b:e[2],a:e[3]}}},_hex8ColorToRGBA(t){if("#"===t[0]&&9===t.length)return{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16),a:parseInt(t.slice(7,9),16)/255}},_hex6ColorToRGBA(t){if("#"===t[0]&&7===t.length)return{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16),a:1}},_hex4ColorToRGBA(t){if("#"===t[0]&&5===t.length)return{r:parseInt(t[1]+t[1],16),g:parseInt(t[2]+t[2],16),b:parseInt(t[3]+t[3],16),a:parseInt(t[4]+t[4],16)/255}},_hex3ColorToRGBA(t){if("#"===t[0]&&4===t.length)return{r:parseInt(t[1]+t[1],16),g:parseInt(t[2]+t[2],16),b:parseInt(t[3]+t[3],16),a:1}},_hslColorToRGBA(t){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(t)){const[e,...i]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(t),n=Number(i[0])/360,r=Number(i[1])/100,s=Number(i[2])/100;let a,o,c;if(0===r)return c=255*s,{r:Math.round(c),g:Math.round(c),b:Math.round(c),a:1};a=s<.5?s*(1+r):s+r-s*r;const d=2*s-a,h=[0,0,0];for(let t=0;t<3;t++)o=n+1/3*-(t-1),o<0&&o++,o>1&&o--,c=6*o<1?d+6*(a-d)*o:2*o<1?a:3*o<2?d+(a-d)*(2/3-o)*6:d,h[t]=255*c;return{r:Math.round(h[0]),g:Math.round(h[1]),b:Math.round(h[2]),a:1}}},haveIntersection:(t,e)=>!(e.x>t.x+t.width||e.x+e.width<t.x||e.y>t.y+t.height||e.y+e.height<t.y),cloneObject(t){var e={};for(var i in t)this._isPlainObject(t[i])?e[i]=this.cloneObject(t[i]):this._isArray(t[i])?e[i]=this.cloneArray(t[i]):e[i]=t[i];return e},cloneArray:t=>t.slice(0),degToRad:t=>t*s,radToDeg:t=>t*a,_degToRad:t=>(e.Util.warn("Util._degToRad is removed. Please use public Util.degToRad instead."),e.Util.degToRad(t)),_radToDeg:t=>(e.Util.warn("Util._radToDeg is removed. Please use public Util.radToDeg instead."),e.Util.radToDeg(t)),_getRotation:t=>n.Konva.angleDeg?e.Util.radToDeg(t):t,_capitalize:t=>t.charAt(0).toUpperCase()+t.slice(1),throw(t){throw new Error(o+t)},error(t){console.error(o+t)},warn(t){n.Konva.showWarnings&&console.warn("Konva warning: "+t)},each(t,e){for(var i in t)e(i,t[i])},_inRange:(t,e,i)=>e<=t&&t<i,_getProjectionToSegment(t,e,i,n,r,s){var a,o,c,d=(t-i)*(t-i)+(e-n)*(e-n);if(0==d)a=t,o=e,c=(r-i)*(r-i)+(s-n)*(s-n);else{var h=((r-t)*(i-t)+(s-e)*(n-e))/d;h<0?(a=t,o=e,c=(t-r)*(t-r)+(e-s)*(e-s)):h>1?(a=i,o=n,c=(i-r)*(i-r)+(n-s)*(n-s)):c=((a=t+h*(i-t))-r)*(a-r)+((o=e+h*(n-e))-s)*(o-s)}return[a,o,c]},_getProjectionToLine(t,i,n){var r=e.Util.cloneObject(t),s=Number.MAX_VALUE;return i.forEach((function(a,o){if(n||o!==i.length-1){var c=i[(o+1)%i.length],d=e.Util._getProjectionToSegment(a.x,a.y,c.x,c.y,t.x,t.y),h=d[0],l=d[1],u=d[2];u<s&&(r.x=h,r.y=l,s=u)}})),r},_prepareArrayForTween(t,i,n){var r,s=[],a=[];if(t.length>i.length){var o=i;i=t,t=o}for(r=0;r<t.length;r+=2)s.push({x:t[r],y:t[r+1]});for(r=0;r<i.length;r+=2)a.push({x:i[r],y:i[r+1]});var c=[];return a.forEach((function(t){var i=e.Util._getProjectionToLine(t,s,n);c.push(i.x),c.push(i.y)})),c},_prepareToStringify(t){var i;for(var n in t.visitedByCircularReferenceRemoval=!0,t)if(t.hasOwnProperty(n)&&t[n]&&"object"==typeof t[n])if(i=Object.getOwnPropertyDescriptor(t,n),t[n].visitedByCircularReferenceRemoval||e.Util._isElement(t[n])){if(!i.configurable)return null;delete t[n]}else if(null===e.Util._prepareToStringify(t[n])){if(!i.configurable)return null;delete t[n]}return delete t.visitedByCircularReferenceRemoval,t},_assign(t,e){for(var i in e)t[i]=e[i];return t},_getFirstPointerId:t=>t.touches?t.changedTouches[0].identifier:t.pointerId||999,releaseCanvas(...t){n.Konva.releaseCanvasOnDestroy&&t.forEach((t=>{t.width=0,t.height=0}))},drawRoundedRectPath(t,e,i,n){let r=0,s=0,a=0,o=0;"number"==typeof n?r=s=a=o=Math.min(n,e/2,i/2):(r=Math.min(n[0]||0,e/2,i/2),s=Math.min(n[1]||0,e/2,i/2),o=Math.min(n[2]||0,e/2,i/2),a=Math.min(n[3]||0,e/2,i/2)),t.moveTo(r,0),t.lineTo(e-s,0),t.arc(e-s,s,s,3*Math.PI/2,0,!1),t.lineTo(e,i-o),t.arc(e-o,i-o,o,0,Math.PI/2,!1),t.lineTo(a,i),t.arc(a,i-a,a,Math.PI/2,Math.PI,!1),t.lineTo(0,r),t.arc(r,r,r,Math.PI,3*Math.PI/2,!1)}}},3774:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.getComponentValidator=e.getBooleanValidator=e.getNumberArrayValidator=e.getFunctionValidator=e.getStringOrGradientValidator=e.getStringValidator=e.getNumberOrAutoValidator=e.getNumberOrArrayOfNumbersValidator=e.getNumberValidator=e.alphaComponent=e.RGBComponent=void 0;const n=i(4417),r=i(8588);function s(t){return r.Util._isString(t)?'"'+t+'"':"[object Number]"===Object.prototype.toString.call(t)||r.Util._isBoolean(t)?t:Object.prototype.toString.call(t)}e.RGBComponent=function(t){return t>255?255:t<0?0:Math.round(t)},e.alphaComponent=function(t){return t>1?1:t<1e-4?1e-4:t},e.getNumberValidator=function(){if(n.Konva.isUnminified)return function(t,e){return r.Util._isNumber(t)||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a number.'),t}},e.getNumberOrArrayOfNumbersValidator=function(t){if(n.Konva.isUnminified)return function(e,i){let n=r.Util._isNumber(e),a=r.Util._isArray(e)&&e.length==t;return n||a||r.Util.warn(s(e)+' is a not valid value for "'+i+'" attribute. The value should be a number or Array<number>('+t+")"),e}},e.getNumberOrAutoValidator=function(){if(n.Konva.isUnminified)return function(t,e){return r.Util._isNumber(t)||"auto"===t||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a number or "auto".'),t}},e.getStringValidator=function(){if(n.Konva.isUnminified)return function(t,e){return r.Util._isString(t)||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a string.'),t}},e.getStringOrGradientValidator=function(){if(n.Konva.isUnminified)return function(t,e){const i=r.Util._isString(t),n="[object CanvasGradient]"===Object.prototype.toString.call(t)||t&&t.addColorStop;return i||n||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a string or a native gradient.'),t}},e.getFunctionValidator=function(){if(n.Konva.isUnminified)return function(t,e){return r.Util._isFunction(t)||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a function.'),t}},e.getNumberArrayValidator=function(){if(n.Konva.isUnminified)return function(t,e){const i=Int8Array?Object.getPrototypeOf(Int8Array):null;return i&&t instanceof i||(r.Util._isArray(t)?t.forEach((function(t){r.Util._isNumber(t)||r.Util.warn('"'+e+'" attribute has non numeric element '+t+". Make sure that all elements are numbers.")})):r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a array of numbers.')),t}},e.getBooleanValidator=function(){if(n.Konva.isUnminified)return function(t,e){return!0===t||!1===t||r.Util.warn(s(t)+' is a not valid value for "'+e+'" attribute. The value should be a boolean.'),t}},e.getComponentValidator=function(t){if(n.Konva.isUnminified)return function(e,i){return null==e||r.Util.isObject(e)||r.Util.warn(s(e)+' is a not valid value for "'+i+'" attribute. The value should be an object with properties '+t),e}}},3986:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Konva=void 0;const n=i(4417),r=i(8588),s=i(7939),a=i(8783),o=i(8342),c=i(4415),d=i(3980),h=i(8985),l=i(210),u=i(7955),p=i(6745),m=i(8017),f=i(3442),g=i(4842);e.Konva=r.Util._assign(n.Konva,{Util:r.Util,Transform:r.Transform,Node:s.Node,Container:a.Container,Stage:o.Stage,stages:o.stages,Layer:c.Layer,FastLayer:d.FastLayer,Group:h.Group,DD:l.DD,Shape:u.Shape,shapes:u.shapes,Animation:p.Animation,Tween:m.Tween,Easings:m.Easings,Context:f.Context,Canvas:g.Canvas}),e.default=e.Konva},2076:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Konva=void 0;const n=i(3986),r=i(119),s=i(2064),a=i(7643),o=i(535),c=i(1298),d=i(6067),h=i(7149),l=i(7339),u=i(5244),p=i(1785),m=i(657),f=i(8986),g=i(1964),v=i(3787),y=i(2831),b=i(9516),k=i(9846),S=i(2527),T=i(6672),w=i(5309),C=i(1695),_=i(9621),P=i(1179),E=i(7194),x=i(3925),R=i(5751),I=i(6588),D=i(3565),M=i(5929),A=i(7233),N=i(8590),L=i(8280),O=i(3438),U=i(6703),F=i(1665),B=i(1863);e.Konva=n.Konva.Util._assign(n.Konva,{Arc:r.Arc,Arrow:s.Arrow,Circle:a.Circle,Ellipse:o.Ellipse,Image:c.Image,Label:d.Label,Tag:d.Tag,Line:h.Line,Path:l.Path,Rect:u.Rect,RegularPolygon:p.RegularPolygon,Ring:m.Ring,Sprite:f.Sprite,Star:g.Star,Text:v.Text,TextPath:y.TextPath,Transformer:b.Transformer,Wedge:k.Wedge,Filters:{Blur:S.Blur,Brighten:T.Brighten,Contrast:w.Contrast,Emboss:C.Emboss,Enhance:_.Enhance,Grayscale:P.Grayscale,HSL:E.HSL,HSV:x.HSV,Invert:R.Invert,Kaleidoscope:I.Kaleidoscope,Mask:D.Mask,Noise:M.Noise,Pixelate:A.Pixelate,Posterize:N.Posterize,RGB:L.RGB,RGBA:O.RGBA,Sepia:U.Sepia,Solarize:F.Solarize,Threshold:B.Threshold}})},2527:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Blur=void 0;const n=i(1455),r=i(7939),s=i(3774);function a(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var o=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];e.Blur=function(t){var e=Math.round(this.blurRadius());e>0&&function(t,e){var i,n,r,s,d,h,l,u,p,m,f,g,v,y,b,k,S,T,w,C,_,P,E,x,R=t.data,I=t.width,D=t.height,M=e+e+1,A=I-1,N=D-1,L=e+1,O=L*(L+1)/2,U=new a,F=null,B=U,G=null,V=null,j=o[e],J=c[e];for(r=1;r<M;r++)B=B.next=new a,r===L&&(F=B);for(B.next=U,l=h=0,n=0;n<D;n++){for(k=S=T=w=u=p=m=f=0,g=L*(C=R[h]),v=L*(_=R[h+1]),y=L*(P=R[h+2]),b=L*(E=R[h+3]),u+=O*C,p+=O*_,m+=O*P,f+=O*E,B=U,r=0;r<L;r++)B.r=C,B.g=_,B.b=P,B.a=E,B=B.next;for(r=1;r<L;r++)s=h+((A<r?A:r)<<2),u+=(B.r=C=R[s])*(x=L-r),p+=(B.g=_=R[s+1])*x,m+=(B.b=P=R[s+2])*x,f+=(B.a=E=R[s+3])*x,k+=C,S+=_,T+=P,w+=E,B=B.next;for(G=U,V=F,i=0;i<I;i++)R[h+3]=E=f*j>>J,0!==E?(E=255/E,R[h]=(u*j>>J)*E,R[h+1]=(p*j>>J)*E,R[h+2]=(m*j>>J)*E):R[h]=R[h+1]=R[h+2]=0,u-=g,p-=v,m-=y,f-=b,g-=G.r,v-=G.g,y-=G.b,b-=G.a,s=l+((s=i+e+1)<A?s:A)<<2,u+=k+=G.r=R[s],p+=S+=G.g=R[s+1],m+=T+=G.b=R[s+2],f+=w+=G.a=R[s+3],G=G.next,g+=C=V.r,v+=_=V.g,y+=P=V.b,b+=E=V.a,k-=C,S-=_,T-=P,w-=E,V=V.next,h+=4;l+=I}for(i=0;i<I;i++){for(S=T=w=k=p=m=f=u=0,g=L*(C=R[h=i<<2]),v=L*(_=R[h+1]),y=L*(P=R[h+2]),b=L*(E=R[h+3]),u+=O*C,p+=O*_,m+=O*P,f+=O*E,B=U,r=0;r<L;r++)B.r=C,B.g=_,B.b=P,B.a=E,B=B.next;for(d=I,r=1;r<=e;r++)h=d+i<<2,u+=(B.r=C=R[h])*(x=L-r),p+=(B.g=_=R[h+1])*x,m+=(B.b=P=R[h+2])*x,f+=(B.a=E=R[h+3])*x,k+=C,S+=_,T+=P,w+=E,B=B.next,r<N&&(d+=I);for(h=i,G=U,V=F,n=0;n<D;n++)R[3+(s=h<<2)]=E=f*j>>J,E>0?(E=255/E,R[s]=(u*j>>J)*E,R[s+1]=(p*j>>J)*E,R[s+2]=(m*j>>J)*E):R[s]=R[s+1]=R[s+2]=0,u-=g,p-=v,m-=y,f-=b,g-=G.r,v-=G.g,y-=G.b,b-=G.a,s=i+((s=n+L)<N?s:N)*I<<2,u+=k+=G.r=R[s],p+=S+=G.g=R[s+1],m+=T+=G.b=R[s+2],f+=w+=G.a=R[s+3],G=G.next,g+=C=V.r,v+=_=V.g,y+=P=V.b,b+=E=V.a,k-=C,S-=_,T-=P,w-=E,V=V.next,h+=I}}(t,e)},n.Factory.addGetterSetter(r.Node,"blurRadius",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},6672:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Brighten=void 0;const n=i(1455),r=i(7939),s=i(3774);e.Brighten=function(t){var e,i=255*this.brightness(),n=t.data,r=n.length;for(e=0;e<r;e+=4)n[e]+=i,n[e+1]+=i,n[e+2]+=i},n.Factory.addGetterSetter(r.Node,"brightness",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},5309:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Contrast=void 0;const n=i(1455),r=i(7939),s=i(3774);e.Contrast=function(t){var e,i=Math.pow((this.contrast()+100)/100,2),n=t.data,r=n.length,s=150,a=150,o=150;for(e=0;e<r;e+=4)s=n[e],a=n[e+1],o=n[e+2],s/=255,s-=.5,s*=i,s+=.5,a/=255,a-=.5,a*=i,a+=.5,o/=255,o-=.5,o*=i,o+=.5,s=(s*=255)<0?0:s>255?255:s,a=(a*=255)<0?0:a>255?255:a,o=(o*=255)<0?0:o>255?255:o,n[e]=s,n[e+1]=a,n[e+2]=o},n.Factory.addGetterSetter(r.Node,"contrast",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},1695:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Emboss=void 0;const n=i(1455),r=i(7939),s=i(8588),a=i(3774);e.Emboss=function(t){var e=10*this.embossStrength(),i=255*this.embossWhiteLevel(),n=this.embossDirection(),r=this.embossBlend(),a=0,o=0,c=t.data,d=t.width,h=t.height,l=4*d,u=h;switch(n){case"top-left":a=-1,o=-1;break;case"top":a=-1,o=0;break;case"top-right":a=-1,o=1;break;case"right":a=0,o=1;break;case"bottom-right":a=1,o=1;break;case"bottom":a=1,o=0;break;case"bottom-left":a=1,o=-1;break;case"left":a=0,o=-1;break;default:s.Util.error("Unknown emboss direction: "+n)}do{var p=(u-1)*l,m=a;u+m<1&&(m=0),u+m>h&&(m=0);var f=(u-1+m)*d*4,g=d;do{var v=p+4*(g-1),y=o;g+y<1&&(y=0),g+y>d&&(y=0);var b=f+4*(g-1+y),k=c[v]-c[b],S=c[v+1]-c[b+1],T=c[v+2]-c[b+2],w=k,C=w>0?w:-w;if((S>0?S:-S)>C&&(w=S),(T>0?T:-T)>C&&(w=T),w*=e,r){var _=c[v]+w,P=c[v+1]+w,E=c[v+2]+w;c[v]=_>255?255:_<0?0:_,c[v+1]=P>255?255:P<0?0:P,c[v+2]=E>255?255:E<0?0:E}else{var x=i-w;x<0?x=0:x>255&&(x=255),c[v]=c[v+1]=c[v+2]=x}}while(--g)}while(--u)},n.Factory.addGetterSetter(r.Node,"embossStrength",.5,(0,a.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"embossWhiteLevel",.5,(0,a.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"embossDirection","top-left",null,n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"embossBlend",!1,null,n.Factory.afterSetFilter)},9621:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Enhance=void 0;const n=i(1455),r=i(7939),s=i(3774);function a(t,e,i,n,r){var s=i-e,a=r-n;return 0===s?n+a/2:0===a?n:a*((t-e)/s)+n}e.Enhance=function(t){var e,i,n,r,s=t.data,o=s.length,c=s[0],d=c,h=s[1],l=h,u=s[2],p=u,m=this.enhance();if(0!==m){for(r=0;r<o;r+=4)(e=s[r+0])<c?c=e:e>d&&(d=e),(i=s[r+1])<h?h=i:i>l&&(l=i),(n=s[r+2])<u?u=n:n>p&&(p=n);var f,g,v,y,b,k,S,T,w;for(d===c&&(d=255,c=0),l===h&&(l=255,h=0),p===u&&(p=255,u=0),m>0?(g=d+m*(255-d),v=c-m*(c-0),b=l+m*(255-l),k=h-m*(h-0),T=p+m*(255-p),w=u-m*(u-0)):(g=d+m*(d-(f=.5*(d+c))),v=c+m*(c-f),b=l+m*(l-(y=.5*(l+h))),k=h+m*(h-y),T=p+m*(p-(S=.5*(p+u))),w=u+m*(u-S)),r=0;r<o;r+=4)s[r+0]=a(s[r+0],c,d,v,g),s[r+1]=a(s[r+1],h,l,k,b),s[r+2]=a(s[r+2],u,p,w,T)}},n.Factory.addGetterSetter(r.Node,"enhance",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},1179:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Grayscale=void 0,e.Grayscale=function(t){var e,i,n=t.data,r=n.length;for(e=0;e<r;e+=4)i=.34*n[e]+.5*n[e+1]+.16*n[e+2],n[e]=i,n[e+1]=i,n[e+2]=i}},7194:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.HSL=void 0;const n=i(1455),r=i(7939),s=i(3774);n.Factory.addGetterSetter(r.Node,"hue",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"saturation",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"luminance",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter),e.HSL=function(t){var e,i,n,r,s,a=t.data,o=a.length,c=Math.pow(2,this.saturation()),d=Math.abs(this.hue()+360)%360,h=127*this.luminance(),l=1*c*Math.cos(d*Math.PI/180),u=1*c*Math.sin(d*Math.PI/180),p=.299+.701*l+.167*u,m=.587-.587*l+.33*u,f=.114-.114*l-.497*u,g=.299-.299*l-.328*u,v=.587+.413*l+.035*u,y=.114-.114*l+.293*u,b=.299-.3*l+1.25*u,k=.587-.586*l-1.05*u,S=.114+.886*l-.2*u;for(e=0;e<o;e+=4)i=a[e+0],n=a[e+1],r=a[e+2],s=a[e+3],a[e+0]=p*i+m*n+f*r+h,a[e+1]=g*i+v*n+y*r+h,a[e+2]=b*i+k*n+S*r+h,a[e+3]=s}},3925:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.HSV=void 0;const n=i(1455),r=i(7939),s=i(3774);e.HSV=function(t){var e,i,n,r,s,a=t.data,o=a.length,c=Math.pow(2,this.value()),d=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,l=c*d*Math.cos(h*Math.PI/180),u=c*d*Math.sin(h*Math.PI/180),p=.299*c+.701*l+.167*u,m=.587*c-.587*l+.33*u,f=.114*c-.114*l-.497*u,g=.299*c-.299*l-.328*u,v=.587*c+.413*l+.035*u,y=.114*c-.114*l+.293*u,b=.299*c-.3*l+1.25*u,k=.587*c-.586*l-1.05*u,S=.114*c+.886*l-.2*u;for(e=0;e<o;e+=4)i=a[e+0],n=a[e+1],r=a[e+2],s=a[e+3],a[e+0]=p*i+m*n+f*r,a[e+1]=g*i+v*n+y*r,a[e+2]=b*i+k*n+S*r,a[e+3]=s},n.Factory.addGetterSetter(r.Node,"hue",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"saturation",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"value",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},5751:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Invert=void 0,e.Invert=function(t){var e,i=t.data,n=i.length;for(e=0;e<n;e+=4)i[e]=255-i[e],i[e+1]=255-i[e+1],i[e+2]=255-i[e+2]}},6588:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Kaleidoscope=void 0;const n=i(1455),r=i(7939),s=i(8588),a=i(3774);e.Kaleidoscope=function(t){var e,i,n,r,a,o,c,d,h,l=t.width,u=t.height,p=Math.round(this.kaleidoscopePower()),m=Math.round(this.kaleidoscopeAngle()),f=Math.floor(l*(m%360)/360);if(!(p<1)){var g=s.Util.createCanvasElement();g.width=l,g.height=u;var v=g.getContext("2d").getImageData(0,0,l,u);s.Util.releaseCanvas(g),function(t,e,i){var n,r,s,a,o=t.data,c=e.data,d=t.width,h=t.height,l=i.polarCenterX||d/2,u=i.polarCenterY||h/2,p=0,m=0,f=0,g=0,v=Math.sqrt(l*l+u*u);r=d-l,s=h-u,v=(a=Math.sqrt(r*r+s*s))>v?a:v;var y,b,k,S,T=h,w=d,C=360/w*Math.PI/180;for(b=0;b<w;b+=1)for(k=Math.sin(b*C),S=Math.cos(b*C),y=0;y<T;y+=1)r=Math.floor(l+v*y/T*S),p=o[0+(n=4*((s=Math.floor(u+v*y/T*k))*d+r))],m=o[n+1],f=o[n+2],g=o[n+3],c[0+(n=4*(b+y*d))]=p,c[n+1]=m,c[n+2]=f,c[n+3]=g}(t,v,{polarCenterX:l/2,polarCenterY:u/2});for(var y=l/Math.pow(2,p);y<=8;)y*=2,p-=1;var b=y=Math.ceil(y),k=0,S=b,T=1;for(f+y>l&&(k=b,S=0,T=-1),i=0;i<u;i+=1)for(e=k;e!==S;e+=T)d=4*(l*i+Math.round(e+f)%l),r=v.data[d+0],a=v.data[d+1],o=v.data[d+2],c=v.data[d+3],h=4*(l*i+e),v.data[h+0]=r,v.data[h+1]=a,v.data[h+2]=o,v.data[h+3]=c;for(i=0;i<u;i+=1)for(b=Math.floor(y),n=0;n<p;n+=1){for(e=0;e<b+1;e+=1)d=4*(l*i+e),r=v.data[d+0],a=v.data[d+1],o=v.data[d+2],c=v.data[d+3],h=4*(l*i+2*b-e-1),v.data[h+0]=r,v.data[h+1]=a,v.data[h+2]=o,v.data[h+3]=c;b*=2}!function(t,e,i){var n,r,s,a,o,c,d=t.data,h=e.data,l=t.width,u=t.height,p=i.polarCenterX||l/2,m=i.polarCenterY||u/2,f=0,g=0,v=0,y=0,b=Math.sqrt(p*p+m*m);r=l-p,s=u-m,b=(c=Math.sqrt(r*r+s*s))>b?c:b;var k,S,T,w=u,C=l,_=i.polarRotation||0;for(r=0;r<l;r+=1)for(s=0;s<u;s+=1)a=r-p,o=s-m,k=Math.sqrt(a*a+o*o)*w/b,S=(S=(180*Math.atan2(o,a)/Math.PI+360+_)%360)*C/360,T=Math.floor(S),f=d[0+(n=4*(Math.floor(k)*l+T))],g=d[n+1],v=d[n+2],y=d[n+3],h[0+(n=4*(s*l+r))]=f,h[n+1]=g,h[n+2]=v,h[n+3]=y}(v,t,{polarRotation:0})}},n.Factory.addGetterSetter(r.Node,"kaleidoscopePower",2,(0,a.getNumberValidator)(),n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"kaleidoscopeAngle",0,(0,a.getNumberValidator)(),n.Factory.afterSetFilter)},3565:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Mask=void 0;const n=i(1455),r=i(7939),s=i(3774);function a(t,e,i){var n=4*(i*t.width+e),r=[];return r.push(t.data[n++],t.data[n++],t.data[n++],t.data[n++]),r}function o(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))}e.Mask=function(t){var e=function(t,e){var i=a(t,0,0),n=a(t,t.width-1,0),r=a(t,0,t.height-1),s=a(t,t.width-1,t.height-1),c=e||10;if(o(i,n)<c&&o(n,s)<c&&o(s,r)<c&&o(r,i)<c){for(var d=function(t){for(var e=[0,0,0],i=0;i<t.length;i++)e[0]+=t[i][0],e[1]+=t[i][1],e[2]+=t[i][2];return e[0]/=t.length,e[1]/=t.length,e[2]/=t.length,e}([n,i,s,r]),h=[],l=0;l<t.width*t.height;l++){var u=o(d,[t.data[4*l],t.data[4*l+1],t.data[4*l+2]]);h[l]=u<c?0:255}return h}}(t,this.threshold());return e&&function(t,e){for(var i=0;i<t.width*t.height;i++)t.data[4*i+3]=e[i]}(t,e=function(t,e,i){for(var n=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],r=Math.round(Math.sqrt(n.length)),s=Math.floor(r/2),a=[],o=0;o<i;o++)for(var c=0;c<e;c++){for(var d=o*e+c,h=0,l=0;l<r;l++)for(var u=0;u<r;u++){var p=o+l-s,m=c+u-s;if(p>=0&&p<i&&m>=0&&m<e){var f=n[l*r+u];h+=t[p*e+m]*f}}a[d]=h}return a}(e=function(t,e,i){for(var n=[1,1,1,1,1,1,1,1,1],r=Math.round(Math.sqrt(n.length)),s=Math.floor(r/2),a=[],o=0;o<i;o++)for(var c=0;c<e;c++){for(var d=o*e+c,h=0,l=0;l<r;l++)for(var u=0;u<r;u++){var p=o+l-s,m=c+u-s;if(p>=0&&p<i&&m>=0&&m<e){var f=n[l*r+u];h+=t[p*e+m]*f}}a[d]=h>=1020?255:0}return a}(e=function(t,e,i){for(var n=[1,1,1,1,0,1,1,1,1],r=Math.round(Math.sqrt(n.length)),s=Math.floor(r/2),a=[],o=0;o<i;o++)for(var c=0;c<e;c++){for(var d=o*e+c,h=0,l=0;l<r;l++)for(var u=0;u<r;u++){var p=o+l-s,m=c+u-s;if(p>=0&&p<i&&m>=0&&m<e){var f=n[l*r+u];h+=t[p*e+m]*f}}a[d]=2040===h?255:0}return a}(e,t.width,t.height),t.width,t.height),t.width,t.height)),t},n.Factory.addGetterSetter(r.Node,"threshold",0,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},5929:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Noise=void 0;const n=i(1455),r=i(7939),s=i(3774);e.Noise=function(t){var e,i=255*this.noise(),n=t.data,r=n.length,s=i/2;for(e=0;e<r;e+=4)n[e+0]+=s-2*s*Math.random(),n[e+1]+=s-2*s*Math.random(),n[e+2]+=s-2*s*Math.random()},n.Factory.addGetterSetter(r.Node,"noise",.2,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},7233:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Pixelate=void 0;const n=i(1455),r=i(8588),s=i(7939),a=i(3774);e.Pixelate=function(t){var e,i,n,s,a,o,c,d,h,l,u,p,m,f,g=Math.ceil(this.pixelSize()),v=t.width,y=t.height,b=Math.ceil(v/g),k=Math.ceil(y/g),S=t.data;if(g<=0)r.Util.error("pixelSize value can not be <= 0");else for(p=0;p<b;p+=1)for(m=0;m<k;m+=1){for(s=0,a=0,o=0,c=0,h=(d=p*g)+g,u=(l=m*g)+g,f=0,e=d;e<h;e+=1)if(!(e>=v))for(i=l;i<u;i+=1)i>=y||(s+=S[0+(n=4*(v*i+e))],a+=S[n+1],o+=S[n+2],c+=S[n+3],f+=1);for(s/=f,a/=f,o/=f,c/=f,e=d;e<h;e+=1)if(!(e>=v))for(i=l;i<u;i+=1)i>=y||(S[0+(n=4*(v*i+e))]=s,S[n+1]=a,S[n+2]=o,S[n+3]=c)}},n.Factory.addGetterSetter(s.Node,"pixelSize",8,(0,a.getNumberValidator)(),n.Factory.afterSetFilter)},8590:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Posterize=void 0;const n=i(1455),r=i(7939),s=i(3774);e.Posterize=function(t){var e,i=Math.round(254*this.levels())+1,n=t.data,r=n.length,s=255/i;for(e=0;e<r;e+=1)n[e]=Math.floor(n[e]/s)*s},n.Factory.addGetterSetter(r.Node,"levels",.5,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},8280:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RGB=void 0;const n=i(1455),r=i(7939),s=i(3774);e.RGB=function(t){var e,i,n=t.data,r=n.length,s=this.red(),a=this.green(),o=this.blue();for(e=0;e<r;e+=4)i=(.34*n[e]+.5*n[e+1]+.16*n[e+2])/255,n[e]=i*s,n[e+1]=i*a,n[e+2]=i*o,n[e+3]=n[e+3]},n.Factory.addGetterSetter(r.Node,"red",0,(function(t){return this._filterUpToDate=!1,t>255?255:t<0?0:Math.round(t)})),n.Factory.addGetterSetter(r.Node,"green",0,(function(t){return this._filterUpToDate=!1,t>255?255:t<0?0:Math.round(t)})),n.Factory.addGetterSetter(r.Node,"blue",0,s.RGBComponent,n.Factory.afterSetFilter)},3438:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RGBA=void 0;const n=i(1455),r=i(7939),s=i(3774);e.RGBA=function(t){var e,i,n=t.data,r=n.length,s=this.red(),a=this.green(),o=this.blue(),c=this.alpha();for(e=0;e<r;e+=4)i=1-c,n[e]=s*c+n[e]*i,n[e+1]=a*c+n[e+1]*i,n[e+2]=o*c+n[e+2]*i},n.Factory.addGetterSetter(r.Node,"red",0,(function(t){return this._filterUpToDate=!1,t>255?255:t<0?0:Math.round(t)})),n.Factory.addGetterSetter(r.Node,"green",0,(function(t){return this._filterUpToDate=!1,t>255?255:t<0?0:Math.round(t)})),n.Factory.addGetterSetter(r.Node,"blue",0,s.RGBComponent,n.Factory.afterSetFilter),n.Factory.addGetterSetter(r.Node,"alpha",1,(function(t){return this._filterUpToDate=!1,t>1?1:t<0?0:t}))},6703:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Sepia=void 0,e.Sepia=function(t){var e,i,n,r,s=t.data,a=s.length;for(e=0;e<a;e+=4)i=s[e+0],n=s[e+1],r=s[e+2],s[e+0]=Math.min(255,.393*i+.769*n+.189*r),s[e+1]=Math.min(255,.349*i+.686*n+.168*r),s[e+2]=Math.min(255,.272*i+.534*n+.131*r)}},1665:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Solarize=void 0,e.Solarize=function(t){var e=t.data,i=t.width,n=4*i,r=t.height;do{var s=(r-1)*n,a=i;do{var o=s+4*(a-1),c=e[o],d=e[o+1],h=e[o+2];c>127&&(c=255-c),d>127&&(d=255-d),h>127&&(h=255-h),e[o]=c,e[o+1]=d,e[o+2]=h}while(--a)}while(--r)}},1863:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Threshold=void 0;const n=i(1455),r=i(7939),s=i(3774);e.Threshold=function(t){var e,i=255*this.threshold(),n=t.data,r=n.length;for(e=0;e<r;e+=1)n[e]=n[e]<i?0:255},n.Factory.addGetterSetter(r.Node,"threshold",.5,(0,s.getNumberValidator)(),n.Factory.afterSetFilter)},185:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0});const n=i(2076);t.exports=n.Konva},119:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Arc=void 0;const n=i(1455),r=i(7955),s=i(4417),a=i(3774),o=i(4417);class c extends r.Shape{_sceneFunc(t){var e=s.Konva.getAngle(this.angle()),i=this.clockwise();t.beginPath(),t.arc(0,0,this.outerRadius(),0,e,i),t.arc(0,0,this.innerRadius(),e,0,!i),t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.outerRadius()}getHeight(){return 2*this.outerRadius()}setWidth(t){this.outerRadius(t/2)}setHeight(t){this.outerRadius(t/2)}getSelfRect(){const t=this.innerRadius(),e=this.outerRadius(),i=this.clockwise(),n=s.Konva.getAngle(i?360-this.angle():this.angle()),r=Math.cos(Math.min(n,Math.PI)),a=Math.sin(Math.min(Math.max(Math.PI,n),3*Math.PI/2)),o=Math.sin(Math.min(n,Math.PI/2)),c=r*(r>0?t:e),d=a*(a>0?t:e),h=o*(o>0?e:t);return{x:c,y:i?-1*h:d,width:1*e-c,height:h-d}}}e.Arc=c,c.prototype._centroid=!0,c.prototype.className="Arc",c.prototype._attrsAffectingSize=["innerRadius","outerRadius"],(0,o._registerNode)(c),n.Factory.addGetterSetter(c,"innerRadius",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"outerRadius",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"angle",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"clockwise",!1,(0,a.getBooleanValidator)())},2064:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Arrow=void 0;const n=i(1455),r=i(7149),s=i(3774),a=i(4417),o=i(7339);class c extends r.Line{_sceneFunc(t){super._sceneFunc(t);var e=2*Math.PI,i=this.points(),n=i,r=0!==this.tension()&&i.length>4;r&&(n=this.getTensionPoints());var s,a,c=this.pointerLength(),d=i.length;if(r){const t=[n[n.length-4],n[n.length-3],n[n.length-2],n[n.length-1],i[d-2],i[d-1]],e=o.Path.calcLength(n[n.length-4],n[n.length-3],"C",t),r=o.Path.getPointOnQuadraticBezier(Math.min(1,1-c/e),t[0],t[1],t[2],t[3],t[4],t[5]);s=i[d-2]-r.x,a=i[d-1]-r.y}else s=i[d-2]-i[d-4],a=i[d-1]-i[d-3];var h=(Math.atan2(a,s)+e)%e,l=this.pointerWidth();this.pointerAtEnding()&&(t.save(),t.beginPath(),t.translate(i[d-2],i[d-1]),t.rotate(h),t.moveTo(0,0),t.lineTo(-c,l/2),t.lineTo(-c,-l/2),t.closePath(),t.restore(),this.__fillStroke(t)),this.pointerAtBeginning()&&(t.save(),t.beginPath(),t.translate(i[0],i[1]),r?(s=(n[0]+n[2])/2-i[0],a=(n[1]+n[3])/2-i[1]):(s=i[2]-i[0],a=i[3]-i[1]),t.rotate((Math.atan2(-a,-s)+e)%e),t.moveTo(0,0),t.lineTo(-c,l/2),t.lineTo(-c,-l/2),t.closePath(),t.restore(),this.__fillStroke(t))}__fillStroke(t){var e=this.dashEnabled();e&&(this.attrs.dashEnabled=!1,t.setLineDash([])),t.fillStrokeShape(this),e&&(this.attrs.dashEnabled=!0)}getSelfRect(){const t=super.getSelfRect(),e=this.pointerWidth()/2;return{x:t.x-e,y:t.y-e,width:t.width+2*e,height:t.height+2*e}}}e.Arrow=c,c.prototype.className="Arrow",(0,a._registerNode)(c),n.Factory.addGetterSetter(c,"pointerLength",10,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(c,"pointerWidth",10,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(c,"pointerAtBeginning",!1),n.Factory.addGetterSetter(c,"pointerAtEnding",!0)},7643:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Circle=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);class o extends r.Shape{_sceneFunc(t){t.beginPath(),t.arc(0,0,this.attrs.radius||0,0,2*Math.PI,!1),t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.radius()}getHeight(){return 2*this.radius()}setWidth(t){this.radius()!==t/2&&this.radius(t/2)}setHeight(t){this.radius()!==t/2&&this.radius(t/2)}}e.Circle=o,o.prototype._centroid=!0,o.prototype.className="Circle",o.prototype._attrsAffectingSize=["radius"],(0,a._registerNode)(o),n.Factory.addGetterSetter(o,"radius",0,(0,s.getNumberValidator)())},535:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Ellipse=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);class o extends r.Shape{_sceneFunc(t){var e=this.radiusX(),i=this.radiusY();t.beginPath(),t.save(),e!==i&&t.scale(1,i/e),t.arc(0,0,e,0,2*Math.PI,!1),t.restore(),t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.radiusX()}getHeight(){return 2*this.radiusY()}setWidth(t){this.radiusX(t/2)}setHeight(t){this.radiusY(t/2)}}e.Ellipse=o,o.prototype.className="Ellipse",o.prototype._centroid=!0,o.prototype._attrsAffectingSize=["radiusX","radiusY"],(0,a._registerNode)(o),n.Factory.addComponentsGetterSetter(o,"radius",["x","y"]),n.Factory.addGetterSetter(o,"radiusX",0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(o,"radiusY",0,(0,s.getNumberValidator)())},1298:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Image=void 0;const n=i(8588),r=i(1455),s=i(7955),a=i(4417),o=i(3774);class c extends s.Shape{constructor(t){super(t),this.on("imageChange.konva",(()=>{this._setImageLoad()})),this._setImageLoad()}_setImageLoad(){const t=this.image();t&&t.complete||t&&4===t.readyState||t&&t.addEventListener&&t.addEventListener("load",(()=>{this._requestDraw()}))}_useBufferCanvas(){return super._useBufferCanvas(!0)}_sceneFunc(t){const e=this.getWidth(),i=this.getHeight(),r=this.cornerRadius(),s=this.attrs.image;let a;if(s){const t=this.attrs.cropWidth,n=this.attrs.cropHeight;a=t&&n?[s,this.cropX(),this.cropY(),t,n,0,0,e,i]:[s,0,0,e,i]}(this.hasFill()||this.hasStroke()||r)&&(t.beginPath(),r?n.Util.drawRoundedRectPath(t,e,i,r):t.rect(0,0,e,i),t.closePath(),t.fillStrokeShape(this)),s&&(r&&t.clip(),t.drawImage.apply(t,a))}_hitFunc(t){var e=this.width(),i=this.height(),r=this.cornerRadius();t.beginPath(),r?n.Util.drawRoundedRectPath(t,e,i,r):t.rect(0,0,e,i),t.closePath(),t.fillStrokeShape(this)}getWidth(){var t,e;return null!==(t=this.attrs.width)&&void 0!==t?t:null===(e=this.image())||void 0===e?void 0:e.width}getHeight(){var t,e;return null!==(t=this.attrs.height)&&void 0!==t?t:null===(e=this.image())||void 0===e?void 0:e.height}static fromURL(t,e,i=null){var r=n.Util.createImageElement();r.onload=function(){var t=new c({image:r});e(t)},r.onerror=i,r.crossOrigin="Anonymous",r.src=t}}e.Image=c,c.prototype.className="Image",(0,a._registerNode)(c),r.Factory.addGetterSetter(c,"cornerRadius",0,(0,o.getNumberOrArrayOfNumbersValidator)(4)),r.Factory.addGetterSetter(c,"image"),r.Factory.addComponentsGetterSetter(c,"crop",["x","y","width","height"]),r.Factory.addGetterSetter(c,"cropX",0,(0,o.getNumberValidator)()),r.Factory.addGetterSetter(c,"cropY",0,(0,o.getNumberValidator)()),r.Factory.addGetterSetter(c,"cropWidth",0,(0,o.getNumberValidator)()),r.Factory.addGetterSetter(c,"cropHeight",0,(0,o.getNumberValidator)())},6067:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Tag=e.Label=void 0;const n=i(1455),r=i(7955),s=i(8985),a=i(3774),o=i(4417);var c=["fontFamily","fontSize","fontStyle","padding","lineHeight","text","width","height","pointerDirection","pointerWidth","pointerHeight"],d="up",h="right",l="down",u="left",p=c.length;class m extends s.Group{constructor(t){super(t),this.on("add.konva",(function(t){this._addListeners(t.child),this._sync()}))}getText(){return this.find("Text")[0]}getTag(){return this.find("Tag")[0]}_addListeners(t){var e,i=this,n=function(){i._sync()};for(e=0;e<p;e++)t.on(c[e]+"Change.konva",n)}getWidth(){return this.getText().width()}getHeight(){return this.getText().height()}_sync(){var t,e,i,n,r,s,a,o=this.getText(),c=this.getTag();if(o&&c){switch(t=o.width(),e=o.height(),i=c.pointerDirection(),n=c.pointerWidth(),a=c.pointerHeight(),r=0,s=0,i){case d:r=t/2,s=-1*a;break;case h:r=t+n,s=e/2;break;case l:r=t/2,s=e+a;break;case u:r=-1*n,s=e/2}c.setAttrs({x:-1*r,y:-1*s,width:t,height:e}),o.setAttrs({x:-1*r,y:-1*s})}}}e.Label=m,m.prototype.className="Label",(0,o._registerNode)(m);class f extends r.Shape{_sceneFunc(t){var e=this.width(),i=this.height(),n=this.pointerDirection(),r=this.pointerWidth(),s=this.pointerHeight(),a=this.cornerRadius();let o=0,c=0,p=0,m=0;"number"==typeof a?o=c=p=m=Math.min(a,e/2,i/2):(o=Math.min(a[0]||0,e/2,i/2),c=Math.min(a[1]||0,e/2,i/2),m=Math.min(a[2]||0,e/2,i/2),p=Math.min(a[3]||0,e/2,i/2)),t.beginPath(),t.moveTo(o,0),n===d&&(t.lineTo((e-r)/2,0),t.lineTo(e/2,-1*s),t.lineTo((e+r)/2,0)),t.lineTo(e-c,0),t.arc(e-c,c,c,3*Math.PI/2,0,!1),n===h&&(t.lineTo(e,(i-s)/2),t.lineTo(e+r,i/2),t.lineTo(e,(i+s)/2)),t.lineTo(e,i-m),t.arc(e-m,i-m,m,0,Math.PI/2,!1),n===l&&(t.lineTo((e+r)/2,i),t.lineTo(e/2,i+s),t.lineTo((e-r)/2,i)),t.lineTo(p,i),t.arc(p,i-p,p,Math.PI/2,Math.PI,!1),n===u&&(t.lineTo(0,(i+s)/2),t.lineTo(-1*r,i/2),t.lineTo(0,(i-s)/2)),t.lineTo(0,o),t.arc(o,o,o,Math.PI,3*Math.PI/2,!1),t.closePath(),t.fillStrokeShape(this)}getSelfRect(){var t=0,e=0,i=this.pointerWidth(),n=this.pointerHeight(),r=this.pointerDirection(),s=this.width(),a=this.height();return r===d?(e-=n,a+=n):r===l?a+=n:r===u?(t-=1.5*i,s+=i):r===h&&(s+=1.5*i),{x:t,y:e,width:s,height:a}}}e.Tag=f,f.prototype.className="Tag",(0,o._registerNode)(f),n.Factory.addGetterSetter(f,"pointerDirection","none"),n.Factory.addGetterSetter(f,"pointerWidth",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(f,"pointerHeight",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(f,"cornerRadius",0,(0,a.getNumberOrArrayOfNumbersValidator)(4))},7149:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Line=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);function o(t,e,i,n,r,s,a){var o=Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2)),c=Math.sqrt(Math.pow(r-i,2)+Math.pow(s-n,2)),d=a*o/(o+c),h=a*c/(o+c);return[i-d*(r-t),n-d*(s-e),i+h*(r-t),n+h*(s-e)]}function c(t,e){var i,n,r=t.length,s=[];for(i=2;i<r-2;i+=2)n=o(t[i-2],t[i-1],t[i],t[i+1],t[i+2],t[i+3],e),isNaN(n[0])||(s.push(n[0]),s.push(n[1]),s.push(t[i]),s.push(t[i+1]),s.push(n[2]),s.push(n[3]));return s}class d extends r.Shape{constructor(t){super(t),this.on("pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva",(function(){this._clearCache("tensionPoints")}))}_sceneFunc(t){var e,i,n,r=this.points(),s=r.length,a=this.tension(),o=this.closed(),c=this.bezier();if(s){if(t.beginPath(),t.moveTo(r[0],r[1]),0!==a&&s>4){for(i=(e=this.getTensionPoints()).length,n=o?0:4,o||t.quadraticCurveTo(e[0],e[1],e[2],e[3]);n<i-2;)t.bezierCurveTo(e[n++],e[n++],e[n++],e[n++],e[n++],e[n++]);o||t.quadraticCurveTo(e[i-2],e[i-1],r[s-2],r[s-1])}else if(c)for(n=2;n<s;)t.bezierCurveTo(r[n++],r[n++],r[n++],r[n++],r[n++],r[n++]);else for(n=2;n<s;n+=2)t.lineTo(r[n],r[n+1]);o?(t.closePath(),t.fillStrokeShape(this)):t.strokeShape(this)}}getTensionPoints(){return this._getCache("tensionPoints",this._getTensionPoints)}_getTensionPoints(){return this.closed()?this._getTensionPointsClosed():c(this.points(),this.tension())}_getTensionPointsClosed(){var t=this.points(),e=t.length,i=this.tension(),n=o(t[e-2],t[e-1],t[0],t[1],t[2],t[3],i),r=o(t[e-4],t[e-3],t[e-2],t[e-1],t[0],t[1],i),s=c(t,i);return[n[2],n[3]].concat(s).concat([r[0],r[1],t[e-2],t[e-1],r[2],r[3],n[0],n[1],t[0],t[1]])}getWidth(){return this.getSelfRect().width}getHeight(){return this.getSelfRect().height}getSelfRect(){var t=this.points();if(t.length<4)return{x:t[0]||0,y:t[1]||0,width:0,height:0};for(var e,i,n=(t=0!==this.tension()?[t[0],t[1],...this._getTensionPoints(),t[t.length-2],t[t.length-1]]:this.points())[0],r=t[0],s=t[1],a=t[1],o=0;o<t.length/2;o++)e=t[2*o],i=t[2*o+1],n=Math.min(n,e),r=Math.max(r,e),s=Math.min(s,i),a=Math.max(a,i);return{x:n,y:s,width:r-n,height:a-s}}}e.Line=d,d.prototype.className="Line",d.prototype._attrsAffectingSize=["points","bezier","tension"],(0,a._registerNode)(d),n.Factory.addGetterSetter(d,"closed",!1),n.Factory.addGetterSetter(d,"bezier",!1),n.Factory.addGetterSetter(d,"tension",0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(d,"points",[],(0,s.getNumberArrayValidator)())},7339:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Path=void 0;const n=i(1455),r=i(7955),s=i(4417),a=i(4135);class o extends r.Shape{constructor(t){super(t),this.dataArray=[],this.pathLength=0,this._readDataAttribute(),this.on("dataChange.konva",(function(){this._readDataAttribute()}))}_readDataAttribute(){this.dataArray=o.parsePathData(this.data()),this.pathLength=o.getPathLength(this.dataArray)}_sceneFunc(t){var e=this.dataArray;t.beginPath();for(var i=!1,n=0;n<e.length;n++){var r=e[n].command,s=e[n].points;switch(r){case"L":t.lineTo(s[0],s[1]);break;case"M":t.moveTo(s[0],s[1]);break;case"C":t.bezierCurveTo(s[0],s[1],s[2],s[3],s[4],s[5]);break;case"Q":t.quadraticCurveTo(s[0],s[1],s[2],s[3]);break;case"A":var a=s[0],o=s[1],c=s[2],d=s[3],h=s[4],l=s[5],u=s[6],p=s[7],m=c>d?c:d,f=c>d?1:c/d,g=c>d?d/c:1;t.translate(a,o),t.rotate(u),t.scale(f,g),t.arc(0,0,m,h,h+l,1-p),t.scale(1/f,1/g),t.rotate(-u),t.translate(-a,-o);break;case"z":i=!0,t.closePath()}}i||this.hasFill()?t.fillStrokeShape(this):t.strokeShape(this)}getSelfRect(){var t=[];this.dataArray.forEach((function(e){if("A"===e.command){var i=e.points[4],n=e.points[5],r=e.points[4]+n,s=Math.PI/180;if(Math.abs(i-r)<s&&(s=Math.abs(i-r)),n<0)for(let n=i-s;n>r;n-=s){const i=o.getPointOnEllipticalArc(e.points[0],e.points[1],e.points[2],e.points[3],n,0);t.push(i.x,i.y)}else for(let n=i+s;n<r;n+=s){const i=o.getPointOnEllipticalArc(e.points[0],e.points[1],e.points[2],e.points[3],n,0);t.push(i.x,i.y)}}else if("C"===e.command)for(let i=0;i<=1;i+=.01){const n=o.getPointOnCubicBezier(i,e.start.x,e.start.y,e.points[0],e.points[1],e.points[2],e.points[3],e.points[4],e.points[5]);t.push(n.x,n.y)}else t=t.concat(e.points)}));for(var e,i,n=t[0],r=t[0],s=t[1],a=t[1],c=0;c<t.length/2;c++)e=t[2*c],i=t[2*c+1],isNaN(e)||(n=Math.min(n,e),r=Math.max(r,e)),isNaN(i)||(s=Math.min(s,i),a=Math.max(a,i));return{x:n,y:s,width:r-n,height:a-s}}getLength(){return this.pathLength}getPointAtLength(t){return o.getPointAtLengthOfDataArray(t,this.dataArray)}static getLineLength(t,e,i,n){return Math.sqrt((i-t)*(i-t)+(n-e)*(n-e))}static getPathLength(t){let e=0;for(var i=0;i<t.length;++i)e+=t[i].pathLength;return e}static getPointAtLengthOfDataArray(t,e){var i,n=0,r=e.length;if(!r)return null;for(;n<r&&t>e[n].pathLength;)t-=e[n].pathLength,++n;if(n===r)return{x:(i=e[n-1].points.slice(-2))[0],y:i[1]};if(t<.01)return{x:(i=e[n].points.slice(0,2))[0],y:i[1]};var s=e[n],c=s.points;switch(s.command){case"L":return o.getPointOnLine(t,s.start.x,s.start.y,c[0],c[1]);case"C":return o.getPointOnCubicBezier((0,a.t2length)(t,o.getPathLength(e),(t=>(0,a.getCubicArcLength)([s.start.x,c[0],c[2],c[4]],[s.start.y,c[1],c[3],c[5]],t))),s.start.x,s.start.y,c[0],c[1],c[2],c[3],c[4],c[5]);case"Q":return o.getPointOnQuadraticBezier((0,a.t2length)(t,o.getPathLength(e),(t=>(0,a.getQuadraticArcLength)([s.start.x,c[0],c[2]],[s.start.y,c[1],c[3]],t))),s.start.x,s.start.y,c[0],c[1],c[2],c[3]);case"A":var d=c[0],h=c[1],l=c[2],u=c[3],p=c[4],m=c[5],f=c[6];return p+=m*t/s.pathLength,o.getPointOnEllipticalArc(d,h,l,u,p,f)}return null}static getPointOnLine(t,e,i,n,r,s,a){void 0===s&&(s=e),void 0===a&&(a=i);var o=(r-i)/(n-e+1e-8),c=Math.sqrt(t*t/(1+o*o));n<e&&(c*=-1);var d,h=o*c;if(n===e)d={x:s,y:a+h};else if((a-i)/(s-e+1e-8)===o)d={x:s+c,y:a+h};else{var l,u,p=this.getLineLength(e,i,n,r),m=(s-e)*(n-e)+(a-i)*(r-i);l=e+(m/=p*p)*(n-e),u=i+m*(r-i);var f=this.getLineLength(s,a,l,u),g=Math.sqrt(t*t-f*f);c=Math.sqrt(g*g/(1+o*o)),n<e&&(c*=-1),d={x:l+c,y:u+(h=o*c)}}return d}static getPointOnCubicBezier(t,e,i,n,r,s,a,o,c){function d(t){return t*t*t}function h(t){return 3*t*t*(1-t)}function l(t){return 3*t*(1-t)*(1-t)}function u(t){return(1-t)*(1-t)*(1-t)}return{x:o*d(t)+s*h(t)+n*l(t)+e*u(t),y:c*d(t)+a*h(t)+r*l(t)+i*u(t)}}static getPointOnQuadraticBezier(t,e,i,n,r,s,a){function o(t){return t*t}function c(t){return 2*t*(1-t)}function d(t){return(1-t)*(1-t)}return{x:s*o(t)+n*c(t)+e*d(t),y:a*o(t)+r*c(t)+i*d(t)}}static getPointOnEllipticalArc(t,e,i,n,r,s){var a=Math.cos(s),o=Math.sin(s),c=i*Math.cos(r),d=n*Math.sin(r);return{x:t+(c*a-d*o),y:e+(c*o+d*a)}}static parsePathData(t){if(!t)return[];var e=t,i=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];e=e.replace(new RegExp(" ","g"),",");for(var n=0;n<i.length;n++)e=e.replace(new RegExp(i[n],"g"),"|"+i[n]);var r,s=e.split("|"),a=[],o=[],c=0,d=0,h=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;for(n=1;n<s.length;n++){var l=s[n],u=l.charAt(0);for(l=l.slice(1),o.length=0;r=h.exec(l);)o.push(r[0]);for(var p=[],m=0,f=o.length;m<f;m++)if("00"!==o[m]){var g=parseFloat(o[m]);isNaN(g)?p.push(0):p.push(g)}else p.push(0,0);for(;p.length>0&&!isNaN(p[0]);){var v,y,b,k,S,T,w,C,_,P,E="",x=[],R=c,I=d;switch(u){case"l":c+=p.shift(),d+=p.shift(),E="L",x.push(c,d);break;case"L":c=p.shift(),d=p.shift(),x.push(c,d);break;case"m":var D=p.shift(),M=p.shift();if(c+=D,d+=M,E="M",a.length>2&&"z"===a[a.length-1].command)for(var A=a.length-2;A>=0;A--)if("M"===a[A].command){c=a[A].points[0]+D,d=a[A].points[1]+M;break}x.push(c,d),u="l";break;case"M":c=p.shift(),d=p.shift(),E="M",x.push(c,d),u="L";break;case"h":c+=p.shift(),E="L",x.push(c,d);break;case"H":c=p.shift(),E="L",x.push(c,d);break;case"v":d+=p.shift(),E="L",x.push(c,d);break;case"V":d=p.shift(),E="L",x.push(c,d);break;case"C":x.push(p.shift(),p.shift(),p.shift(),p.shift()),c=p.shift(),d=p.shift(),x.push(c,d);break;case"c":x.push(c+p.shift(),d+p.shift(),c+p.shift(),d+p.shift()),c+=p.shift(),d+=p.shift(),E="C",x.push(c,d);break;case"S":y=c,b=d,"C"===(v=a[a.length-1]).command&&(y=c+(c-v.points[2]),b=d+(d-v.points[3])),x.push(y,b,p.shift(),p.shift()),c=p.shift(),d=p.shift(),E="C",x.push(c,d);break;case"s":y=c,b=d,"C"===(v=a[a.length-1]).command&&(y=c+(c-v.points[2]),b=d+(d-v.points[3])),x.push(y,b,c+p.shift(),d+p.shift()),c+=p.shift(),d+=p.shift(),E="C",x.push(c,d);break;case"Q":x.push(p.shift(),p.shift()),c=p.shift(),d=p.shift(),x.push(c,d);break;case"q":x.push(c+p.shift(),d+p.shift()),c+=p.shift(),d+=p.shift(),E="Q",x.push(c,d);break;case"T":y=c,b=d,"Q"===(v=a[a.length-1]).command&&(y=c+(c-v.points[0]),b=d+(d-v.points[1])),c=p.shift(),d=p.shift(),E="Q",x.push(y,b,c,d);break;case"t":y=c,b=d,"Q"===(v=a[a.length-1]).command&&(y=c+(c-v.points[0]),b=d+(d-v.points[1])),c+=p.shift(),d+=p.shift(),E="Q",x.push(y,b,c,d);break;case"A":k=p.shift(),S=p.shift(),T=p.shift(),w=p.shift(),C=p.shift(),_=c,P=d,c=p.shift(),d=p.shift(),E="A",x=this.convertEndpointToCenterParameterization(_,P,c,d,w,C,k,S,T);break;case"a":k=p.shift(),S=p.shift(),T=p.shift(),w=p.shift(),C=p.shift(),_=c,P=d,c+=p.shift(),d+=p.shift(),E="A",x=this.convertEndpointToCenterParameterization(_,P,c,d,w,C,k,S,T)}a.push({command:E||u,points:x,start:{x:R,y:I},pathLength:this.calcLength(R,I,E||u,x)})}"z"!==u&&"Z"!==u||a.push({command:"z",points:[],start:void 0,pathLength:0})}return a}static calcLength(t,e,i,n){var r,s,c,d,h=o;switch(i){case"L":return h.getLineLength(t,e,n[0],n[1]);case"C":return(0,a.getCubicArcLength)([t,n[0],n[2],n[4]],[e,n[1],n[3],n[5]],1);case"Q":return(0,a.getQuadraticArcLength)([t,n[0],n[2]],[e,n[1],n[3]],1);case"A":r=0;var l=n[4],u=n[5],p=n[4]+u,m=Math.PI/180;if(Math.abs(l-p)<m&&(m=Math.abs(l-p)),s=h.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],l,0),u<0)for(d=l-m;d>p;d-=m)c=h.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],d,0),r+=h.getLineLength(s.x,s.y,c.x,c.y),s=c;else for(d=l+m;d<p;d+=m)c=h.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],d,0),r+=h.getLineLength(s.x,s.y,c.x,c.y),s=c;return c=h.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],p,0),r+h.getLineLength(s.x,s.y,c.x,c.y)}return 0}static convertEndpointToCenterParameterization(t,e,i,n,r,s,a,o,c){var d=c*(Math.PI/180),h=Math.cos(d)*(t-i)/2+Math.sin(d)*(e-n)/2,l=-1*Math.sin(d)*(t-i)/2+Math.cos(d)*(e-n)/2,u=h*h/(a*a)+l*l/(o*o);u>1&&(a*=Math.sqrt(u),o*=Math.sqrt(u));var p=Math.sqrt((a*a*(o*o)-a*a*(l*l)-o*o*(h*h))/(a*a*(l*l)+o*o*(h*h)));r===s&&(p*=-1),isNaN(p)&&(p=0);var m=p*a*l/o,f=p*-o*h/a,g=(t+i)/2+Math.cos(d)*m-Math.sin(d)*f,v=(e+n)/2+Math.sin(d)*m+Math.cos(d)*f,y=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},b=function(t,e){return(t[0]*e[0]+t[1]*e[1])/(y(t)*y(e))},k=function(t,e){return(t[0]*e[1]<t[1]*e[0]?-1:1)*Math.acos(b(t,e))},S=k([1,0],[(h-m)/a,(l-f)/o]),T=[(h-m)/a,(l-f)/o],w=[(-1*h-m)/a,(-1*l-f)/o],C=k(T,w);return b(T,w)<=-1&&(C=Math.PI),b(T,w)>=1&&(C=0),0===s&&C>0&&(C-=2*Math.PI),1===s&&C<0&&(C+=2*Math.PI),[g,v,a,o,S,C,d,s]}}e.Path=o,o.prototype.className="Path",o.prototype._attrsAffectingSize=["data"],(0,s._registerNode)(o),n.Factory.addGetterSetter(o,"data")},5244:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Rect=void 0;const n=i(1455),r=i(7955),s=i(4417),a=i(8588),o=i(3774);class c extends r.Shape{_sceneFunc(t){var e=this.cornerRadius(),i=this.width(),n=this.height();t.beginPath(),e?a.Util.drawRoundedRectPath(t,i,n,e):t.rect(0,0,i,n),t.closePath(),t.fillStrokeShape(this)}}e.Rect=c,c.prototype.className="Rect",(0,s._registerNode)(c),n.Factory.addGetterSetter(c,"cornerRadius",0,(0,o.getNumberOrArrayOfNumbersValidator)(4))},1785:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RegularPolygon=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);class o extends r.Shape{_sceneFunc(t){const e=this._getPoints();t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var i=1;i<e.length;i++)t.lineTo(e[i].x,e[i].y);t.closePath(),t.fillStrokeShape(this)}_getPoints(){const t=this.attrs.sides,e=this.attrs.radius||0,i=[];for(var n=0;n<t;n++)i.push({x:e*Math.sin(2*n*Math.PI/t),y:-1*e*Math.cos(2*n*Math.PI/t)});return i}getSelfRect(){const t=this._getPoints();var e=t[0].x,i=t[0].y,n=t[0].x,r=t[0].y;return t.forEach((t=>{e=Math.min(e,t.x),i=Math.max(i,t.x),n=Math.min(n,t.y),r=Math.max(r,t.y)})),{x:e,y:n,width:i-e,height:r-n}}getWidth(){return 2*this.radius()}getHeight(){return 2*this.radius()}setWidth(t){this.radius(t/2)}setHeight(t){this.radius(t/2)}}e.RegularPolygon=o,o.prototype.className="RegularPolygon",o.prototype._centroid=!0,o.prototype._attrsAffectingSize=["radius"],(0,a._registerNode)(o),n.Factory.addGetterSetter(o,"radius",0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(o,"sides",0,(0,s.getNumberValidator)())},657:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Ring=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);var o=2*Math.PI;class c extends r.Shape{_sceneFunc(t){t.beginPath(),t.arc(0,0,this.innerRadius(),0,o,!1),t.moveTo(this.outerRadius(),0),t.arc(0,0,this.outerRadius(),o,0,!0),t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.outerRadius()}getHeight(){return 2*this.outerRadius()}setWidth(t){this.outerRadius(t/2)}setHeight(t){this.outerRadius(t/2)}}e.Ring=c,c.prototype.className="Ring",c.prototype._centroid=!0,c.prototype._attrsAffectingSize=["innerRadius","outerRadius"],(0,a._registerNode)(c),n.Factory.addGetterSetter(c,"innerRadius",0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(c,"outerRadius",0,(0,s.getNumberValidator)())},8986:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Sprite=void 0;const n=i(1455),r=i(7955),s=i(6745),a=i(3774),o=i(4417);class c extends r.Shape{constructor(t){super(t),this._updated=!0,this.anim=new s.Animation((()=>{var t=this._updated;return this._updated=!1,t})),this.on("animationChange.konva",(function(){this.frameIndex(0)})),this.on("frameIndexChange.konva",(function(){this._updated=!0})),this.on("frameRateChange.konva",(function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())}))}_sceneFunc(t){var e=this.animation(),i=this.frameIndex(),n=4*i,r=this.animations()[e],s=this.frameOffsets(),a=r[n+0],o=r[n+1],c=r[n+2],d=r[n+3],h=this.image();if((this.hasFill()||this.hasStroke())&&(t.beginPath(),t.rect(0,0,c,d),t.closePath(),t.fillStrokeShape(this)),h)if(s){var l=s[e],u=2*i;t.drawImage(h,a,o,c,d,l[u+0],l[u+1],c,d)}else t.drawImage(h,a,o,c,d,0,0,c,d)}_hitFunc(t){var e=this.animation(),i=this.frameIndex(),n=4*i,r=this.animations()[e],s=this.frameOffsets(),a=r[n+2],o=r[n+3];if(t.beginPath(),s){var c=s[e],d=2*i;t.rect(c[d+0],c[d+1],a,o)}else t.rect(0,0,a,o);t.closePath(),t.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){var t=this;this.interval=setInterval((function(){t._updateIndex()}),1e3/this.frameRate())}start(){if(!this.isRunning()){var t=this.getLayer();this.anim.setLayers(t),this._setInterval(),this.anim.start()}}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){var t=this.frameIndex(),e=this.animation();t<this.animations()[e].length/4-1?this.frameIndex(t+1):this.frameIndex(0)}}e.Sprite=c,c.prototype.className="Sprite",(0,o._registerNode)(c),n.Factory.addGetterSetter(c,"animation"),n.Factory.addGetterSetter(c,"animations"),n.Factory.addGetterSetter(c,"frameOffsets"),n.Factory.addGetterSetter(c,"image"),n.Factory.addGetterSetter(c,"frameIndex",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"frameRate",17,(0,a.getNumberValidator)()),n.Factory.backCompat(c,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"})},1964:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Star=void 0;const n=i(1455),r=i(7955),s=i(3774),a=i(4417);class o extends r.Shape{_sceneFunc(t){var e=this.innerRadius(),i=this.outerRadius(),n=this.numPoints();t.beginPath(),t.moveTo(0,0-i);for(var r=1;r<2*n;r++){var s=r%2==0?i:e,a=s*Math.sin(r*Math.PI/n),o=-1*s*Math.cos(r*Math.PI/n);t.lineTo(a,o)}t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.outerRadius()}getHeight(){return 2*this.outerRadius()}setWidth(t){this.outerRadius(t/2)}setHeight(t){this.outerRadius(t/2)}}e.Star=o,o.prototype.className="Star",o.prototype._centroid=!0,o.prototype._attrsAffectingSize=["innerRadius","outerRadius"],(0,a._registerNode)(o),n.Factory.addGetterSetter(o,"numPoints",5,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(o,"innerRadius",0,(0,s.getNumberValidator)()),n.Factory.addGetterSetter(o,"outerRadius",0,(0,s.getNumberValidator)())},3787:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Text=e.stringToArray=void 0;const n=i(8588),r=i(1455),s=i(7955),a=i(3774),o=i(4417);function c(t){return Array.from(t)}e.stringToArray=c;var d,h="auto",l="inherit",u="justify",p="left",m="middle",f="normal",g=" ",v="none",y=["direction","fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],b=y.length;function k(){return d||(d=n.Util.createCanvasElement().getContext("2d"))}class S extends s.Shape{constructor(t){super(function(t){return(t=t||{}).fillLinearGradientColorStops||t.fillRadialGradientColorStops||t.fillPatternImage||(t.fill=t.fill||"black"),t}(t)),this._partialTextX=0,this._partialTextY=0;for(var e=0;e<b;e++)this.on(y[e]+"Change.konva",this._setTextData);this._setTextData()}_sceneFunc(t){var e=this.textArr,i=e.length;if(this.text()){var n,r=this.padding(),s=this.fontSize(),a=this.lineHeight()*s,o=this.verticalAlign(),d=this.direction(),h=0,f=this.align(),g=this.getWidth(),v=this.letterSpacing(),y=this.fill(),b=this.textDecoration(),k=-1!==b.indexOf("underline"),S=-1!==b.indexOf("line-through"),T=0,w=(T=a/2,0),C=0;for("rtl"===(d=d===l?t.direction:d)&&t.setAttr("direction",d),t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",m),t.setAttr("textAlign",p),o===m?h=(this.getHeight()-i*a-2*r)/2:"bottom"===o&&(h=this.getHeight()-i*a-2*r),t.translate(r,h+r),n=0;n<i;n++){w=0,C=0;var _,P,E,x=e[n],R=x.text,I=x.width,D=x.lastInParagraph;if(t.save(),"right"===f?w+=g-I-2*r:"center"===f&&(w+=(g-I-2*r)/2),k){t.save(),t.beginPath(),t.moveTo(w,T+C+Math.round(s/2)),P=0==(_=R.split(" ").length-1),E=f!==u||D?I:g-2*r,t.lineTo(w+Math.round(E),T+C+Math.round(s/2)),t.lineWidth=s/15;const e=this._getLinearGradient();t.strokeStyle=e||y,t.stroke(),t.restore()}if(S){t.save(),t.beginPath(),t.moveTo(w,T+C),P=0==(_=R.split(" ").length-1),E=f===u&&D&&!P?g-2*r:I,t.lineTo(w+Math.round(E),T+C),t.lineWidth=s/15;const e=this._getLinearGradient();t.strokeStyle=e||y,t.stroke(),t.restore()}if("rtl"===d||0===v&&f!==u)0!==v&&t.setAttr("letterSpacing",`${v}px`),this._partialTextX=w,this._partialTextY=T+C,this._partialText=R,t.fillStrokeShape(this);else{_=R.split(" ").length-1;for(var M=c(R),A=0;A<M.length;A++){var N=M[A];" "!==N||D||f!==u||(w+=(g-2*r-I)/_),this._partialTextX=w,this._partialTextY=T+C,this._partialText=N,t.fillStrokeShape(this),w+=this.measureSize(N).width+v}}t.restore(),i>1&&(T+=a)}}}_hitFunc(t){var e=this.getWidth(),i=this.getHeight();t.beginPath(),t.rect(0,0,e,i),t.closePath(),t.fillStrokeShape(this)}setText(t){var e=n.Util._isString(t)?t:null==t?"":t+"";return this._setAttr("text",e),this}getWidth(){return this.attrs.width===h||void 0===this.attrs.width?this.getTextWidth()+2*this.padding():this.attrs.width}getHeight(){return this.attrs.height===h||void 0===this.attrs.height?this.fontSize()*this.textArr.length*this.lineHeight()+2*this.padding():this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return n.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(t){var e,i=k(),n=this.fontSize();return i.save(),i.font=this._getContextFont(),e=i.measureText(t),i.restore(),{width:e.width,height:n}}_getContextFont(){return this.fontStyle()+g+this.fontVariant()+g+(this.fontSize()+"px ")+this.fontFamily().split(",").map((t=>{const e=(t=t.trim()).indexOf(" ")>=0,i=t.indexOf('"')>=0||t.indexOf("'")>=0;return e&&!i&&(t=`"${t}"`),t})).join(", ")}_addTextLine(t){this.align()===u&&(t=t.trim());var e=this._getTextWidth(t);return this.textArr.push({text:t,width:e,lastInParagraph:!1})}_getTextWidth(t){var e=this.letterSpacing(),i=t.length;return k().measureText(t).width+(i?e*(i-1):0)}_setTextData(){var t=this.text().split("\n"),e=+this.fontSize(),i=0,n=this.lineHeight()*e,r=this.attrs.width,s=this.attrs.height,a=r!==h&&void 0!==r,o=s!==h&&void 0!==s,c=this.padding(),d=r-2*c,l=s-2*c,u=0,p=this.wrap(),m="char"!==p&&p!==v,f=this.ellipsis();this.textArr=[],k().font=this._getContextFont();for(var y=f?this._getTextWidth("…"):0,b=0,S=t.length;b<S;++b){var T=t[b],w=this._getTextWidth(T);if(a&&w>d)for(;T.length>0;){for(var C=0,_=T.length,P="",E=0;C<_;){var x=C+_>>>1,R=T.slice(0,x+1),I=this._getTextWidth(R)+y;I<=d?(C=x+1,P=R,E=I):_=x}if(!P)break;if(m){var D,M=T[P.length];(D=(M===g||"-"===M)&&E<=d?P.length:Math.max(P.lastIndexOf(g),P.lastIndexOf("-"))+1)>0&&(C=D,P=P.slice(0,C),E=this._getTextWidth(P))}if(P=P.trimRight(),this._addTextLine(P),i=Math.max(i,E),u+=n,this._shouldHandleEllipsis(u)){this._tryToAddEllipsisToLastLine();break}if((T=(T=T.slice(C)).trimLeft()).length>0&&(w=this._getTextWidth(T))<=d){this._addTextLine(T),u+=n,i=Math.max(i,w);break}}else this._addTextLine(T),u+=n,i=Math.max(i,w),this._shouldHandleEllipsis(u)&&b<S-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),o&&u+n>l)break}this.textHeight=e,this.textWidth=i}_shouldHandleEllipsis(t){var e=+this.fontSize(),i=this.lineHeight()*e,n=this.attrs.height,r=n!==h&&void 0!==n,s=n-2*this.padding();return!(this.wrap()!==v)||r&&t+i>s}_tryToAddEllipsisToLastLine(){var t=this.attrs.width,e=t!==h&&void 0!==t,i=t-2*this.padding(),n=this.ellipsis(),r=this.textArr[this.textArr.length-1];r&&n&&(e&&(this._getTextWidth(r.text+"…")<i||(r.text=r.text.slice(0,r.text.length-3))),this.textArr.splice(this.textArr.length-1,1),this._addTextLine(r.text+"…"))}getStrokeScaleEnabled(){return!0}_useBufferCanvas(){const t=-1!==this.textDecoration().indexOf("underline")||-1!==this.textDecoration().indexOf("line-through"),e=this.hasShadow();return!(!t||!e)||super._useBufferCanvas()}}e.Text=S,S.prototype._fillFunc=function(t){t.fillText(this._partialText,this._partialTextX,this._partialTextY)},S.prototype._strokeFunc=function(t){t.setAttr("miterLimit",2),t.strokeText(this._partialText,this._partialTextX,this._partialTextY)},S.prototype.className="Text",S.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"],(0,o._registerNode)(S),r.Factory.overWriteSetter(S,"width",(0,a.getNumberOrAutoValidator)()),r.Factory.overWriteSetter(S,"height",(0,a.getNumberOrAutoValidator)()),r.Factory.addGetterSetter(S,"direction",l),r.Factory.addGetterSetter(S,"fontFamily","Arial"),r.Factory.addGetterSetter(S,"fontSize",12,(0,a.getNumberValidator)()),r.Factory.addGetterSetter(S,"fontStyle",f),r.Factory.addGetterSetter(S,"fontVariant",f),r.Factory.addGetterSetter(S,"padding",0,(0,a.getNumberValidator)()),r.Factory.addGetterSetter(S,"align",p),r.Factory.addGetterSetter(S,"verticalAlign","top"),r.Factory.addGetterSetter(S,"lineHeight",1,(0,a.getNumberValidator)()),r.Factory.addGetterSetter(S,"wrap","word"),r.Factory.addGetterSetter(S,"ellipsis",!1,(0,a.getBooleanValidator)()),r.Factory.addGetterSetter(S,"letterSpacing",0,(0,a.getNumberValidator)()),r.Factory.addGetterSetter(S,"text","",(0,a.getStringValidator)()),r.Factory.addGetterSetter(S,"textDecoration","")},2831:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TextPath=void 0;const n=i(8588),r=i(1455),s=i(7955),a=i(7339),o=i(3787),c=i(3774),d=i(4417);var h="normal";function l(t){t.fillText(this.partialText,0,0)}function u(t){t.strokeText(this.partialText,0,0)}class p extends s.Shape{constructor(t){super(t),this.dummyCanvas=n.Util.createCanvasElement(),this.dataArray=[],this._readDataAttribute(),this.on("dataChange.konva",(function(){this._readDataAttribute(),this._setTextData()})),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_getTextPathLength(){return a.Path.getPathLength(this.dataArray)}_getPointAtLength(t){return this.attrs.data?t-1>this.pathLength?null:a.Path.getPointAtLengthOfDataArray(t,this.dataArray):null}_readDataAttribute(){this.dataArray=a.Path.parsePathData(this.attrs.data),this.pathLength=this._getTextPathLength()}_sceneFunc(t){t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",this.textBaseline()),t.setAttr("textAlign","left"),t.save();var e=this.textDecoration(),i=this.fill(),n=this.fontSize(),r=this.glyphInfo;"underline"===e&&t.beginPath();for(var s=0;s<r.length;s++){t.save();var a=r[s].p0;t.translate(a.x,a.y),t.rotate(r[s].rotation),this.partialText=r[s].text,t.fillStrokeShape(this),"underline"===e&&(0===s&&t.moveTo(0,n/2+1),t.lineTo(n,n/2+1)),t.restore()}"underline"===e&&(t.strokeStyle=i,t.lineWidth=n/20,t.stroke()),t.restore()}_hitFunc(t){t.beginPath();var e=this.glyphInfo;if(e.length>=1){var i=e[0].p0;t.moveTo(i.x,i.y)}for(var n=0;n<e.length;n++){var r=e[n].p1;t.lineTo(r.x,r.y)}t.setAttr("lineWidth",this.fontSize()),t.setAttr("strokeStyle",this.colorKey),t.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return n.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(t){return o.Text.prototype.setText.call(this,t)}_getContextFont(){return o.Text.prototype._getContextFont.call(this)}_getTextSize(t){var e=this.dummyCanvas.getContext("2d");e.save(),e.font=this._getContextFont();var i=e.measureText(t);return e.restore(),{width:i.width,height:parseInt(`${this.fontSize()}`,10)}}_setTextData(){const{width:t,height:e}=this._getTextSize(this.attrs.text);if(this.textWidth=t,this.textHeight=e,this.glyphInfo=[],!this.attrs.data)return null;const i=this.letterSpacing(),n=this.align(),r=this.kerningFunc(),s=Math.max(this.textWidth+((this.attrs.text||"").length-1)*i,0);let c=0;"center"===n&&(c=Math.max(0,this.pathLength/2-s/2)),"right"===n&&(c=Math.max(0,this.pathLength-s));const d=(0,o.stringToArray)(this.text());let h=c;for(var l=0;l<d.length;l++){const t=this._getPointAtLength(h);if(!t)return;let e=this._getTextSize(d[l]).width+i;if(" "===d[l]&&"justify"===n){const t=this.text().split(" ").length-1;e+=(this.pathLength-s)/t}const o=this._getPointAtLength(h+e);if(!o)return;const c=a.Path.getLineLength(t.x,t.y,o.x,o.y);let u=0;if(r)try{u=r(d[l-1],d[l])*this.fontSize()}catch(t){u=0}t.x+=u,o.x+=u,this.textWidth+=u;const p=a.Path.getPointOnLine(u+c/2,t.x,t.y,o.x,o.y),m=Math.atan2(o.y-t.y,o.x-t.x);this.glyphInfo.push({transposeX:p.x,transposeY:p.y,text:d[l],rotation:m,p0:t,p1:o}),h+=e}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};var t=[];this.glyphInfo.forEach((function(e){t.push(e.p0.x),t.push(e.p0.y),t.push(e.p1.x),t.push(e.p1.y)}));for(var e,i,n=t[0]||0,r=t[0]||0,s=t[1]||0,a=t[1]||0,o=0;o<t.length/2;o++)e=t[2*o],i=t[2*o+1],n=Math.min(n,e),r=Math.max(r,e),s=Math.min(s,i),a=Math.max(a,i);var c=this.fontSize();return{x:n-c/2,y:s-c/2,width:r-n+c,height:a-s+c}}destroy(){return n.Util.releaseCanvas(this.dummyCanvas),super.destroy()}}e.TextPath=p,p.prototype._fillFunc=l,p.prototype._strokeFunc=u,p.prototype._fillFuncHit=l,p.prototype._strokeFuncHit=u,p.prototype.className="TextPath",p.prototype._attrsAffectingSize=["text","fontSize","data"],(0,d._registerNode)(p),r.Factory.addGetterSetter(p,"data"),r.Factory.addGetterSetter(p,"fontFamily","Arial"),r.Factory.addGetterSetter(p,"fontSize",12,(0,c.getNumberValidator)()),r.Factory.addGetterSetter(p,"fontStyle",h),r.Factory.addGetterSetter(p,"align","left"),r.Factory.addGetterSetter(p,"letterSpacing",0,(0,c.getNumberValidator)()),r.Factory.addGetterSetter(p,"textBaseline","middle"),r.Factory.addGetterSetter(p,"fontVariant",h),r.Factory.addGetterSetter(p,"text",""),r.Factory.addGetterSetter(p,"textDecoration",null),r.Factory.addGetterSetter(p,"kerningFunc",null)},9516:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Transformer=void 0;const n=i(8588),r=i(1455),s=i(7939),a=i(7955),o=i(5244),c=i(8985),d=i(4417),h=i(3774),l=i(4417);var u="tr-konva",p=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange","anchorStyleFuncChange"].map((t=>t+`.${u}`)).join(" "),m="nodesRect",f=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange"],g={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135};const v="ontouchstart"in d.Konva._global;var y=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"];function b(t,e,i){const n=i.x+(t.x-i.x)*Math.cos(e)-(t.y-i.y)*Math.sin(e),r=i.y+(t.x-i.x)*Math.sin(e)+(t.y-i.y)*Math.cos(e);return{...t,rotation:t.rotation+e,x:n,y:r}}class k extends c.Group{constructor(t){super(t),this._movingAnchorName=null,this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(p,this.update),this.getNode()&&this.update()}attachTo(t){return this.setNode(t),this}setNode(t){return n.Util.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([t])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return u+this._id}setNodes(t=[]){this._nodes&&this._nodes.length&&this.detach();const e=t.filter((t=>!t.isAncestorOf(this)||(n.Util.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1)));return this._nodes=t=e,1===t.length&&this.useSingleNodeRotation()?this.rotation(t[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach((t=>{const e=()=>{1===this.nodes().length&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),this._transforming||this.isDragging()||this.update()},i=t._attrsAffectingSize.map((t=>t+"Change."+this._getEventNamespace())).join(" ");t.on(i,e),t.on(f.map((t=>t+`.${this._getEventNamespace()}`)).join(" "),e),t.on(`absoluteTransformChange.${this._getEventNamespace()}`,e),this._proxyDrag(t)})),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(t){let e;t.on(`dragstart.${this._getEventNamespace()}`,(i=>{e=t.getAbsolutePosition(),this.isDragging()||t===this.findOne(".back")||this.startDrag(i,!1)})),t.on(`dragmove.${this._getEventNamespace()}`,(i=>{if(!e)return;const n=t.getAbsolutePosition(),r=n.x-e.x,s=n.y-e.y;this.nodes().forEach((e=>{if(e===t)return;if(e.isDragging())return;const n=e.getAbsolutePosition();e.setAbsolutePosition({x:n.x+r,y:n.y+s}),e.startDrag(i)})),e=null}))}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach((t=>{t.off("."+this._getEventNamespace())})),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache(m),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache(m,this.__getNodeRect)}__getNodeShape(t,e=this.rotation(),i){var n=t.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),r=t.getAbsoluteScale(i),s=t.getAbsolutePosition(i),a=n.x*r.x-t.offsetX()*r.x,o=n.y*r.y-t.offsetY()*r.y;const c=(d.Konva.getAngle(t.getAbsoluteRotation())+2*Math.PI)%(2*Math.PI);return b({x:s.x+a*Math.cos(c)+o*Math.sin(-c),y:s.y+o*Math.cos(c)+a*Math.sin(c),width:n.width*r.x,height:n.height*r.y,rotation:c},-d.Konva.getAngle(e),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-1e8,y:-1e8,width:0,height:0,rotation:0};const t=[];this.nodes().map((e=>{const i=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()});var n=[{x:i.x,y:i.y},{x:i.x+i.width,y:i.y},{x:i.x+i.width,y:i.y+i.height},{x:i.x,y:i.y+i.height}],r=e.getAbsoluteTransform();n.forEach((function(e){var i=r.point(e);t.push(i)}))}));const e=new n.Transform;e.rotate(-d.Konva.getAngle(this.rotation()));var i=1/0,r=1/0,s=-1/0,a=-1/0;t.forEach((function(t){var n=e.point(t);void 0===i&&(i=s=n.x,r=a=n.y),i=Math.min(i,n.x),r=Math.min(r,n.y),s=Math.max(s,n.x),a=Math.max(a,n.y)})),e.invert();const o=e.point({x:i,y:r});return{x:o.x,y:o.y,width:s-i,height:a-r,rotation:d.Konva.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),y.forEach((t=>{this._createAnchor(t)})),this._createAnchor("rotater")}_createAnchor(t){var e=new o.Rect({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:t+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:v?10:"auto"}),i=this;e.on("mousedown touchstart",(function(t){i._handleMouseDown(t)})),e.on("dragstart",(t=>{e.stopDrag(),t.cancelBubble=!0})),e.on("dragend",(t=>{t.cancelBubble=!0})),e.on("mouseenter",(()=>{var i=d.Konva.getAngle(this.rotation()),r=this.rotateAnchorCursor(),s=function(t,e,i){if("rotater"===t)return i;e+=n.Util.degToRad(g[t]||0);var r=(n.Util.radToDeg(e)%360+360)%360;return n.Util._inRange(r,337.5,360)||n.Util._inRange(r,0,22.5)?"ns-resize":n.Util._inRange(r,22.5,67.5)?"nesw-resize":n.Util._inRange(r,67.5,112.5)?"ew-resize":n.Util._inRange(r,112.5,157.5)?"nwse-resize":n.Util._inRange(r,157.5,202.5)?"ns-resize":n.Util._inRange(r,202.5,247.5)?"nesw-resize":n.Util._inRange(r,247.5,292.5)?"ew-resize":n.Util._inRange(r,292.5,337.5)?"nwse-resize":(n.Util.error("Transformer has unknown angle for cursor detection: "+r),"pointer")}(t,i,r);e.getStage().content&&(e.getStage().content.style.cursor=s),this._cursorChange=!0})),e.on("mouseout",(()=>{e.getStage().content&&(e.getStage().content.style.cursor=""),this._cursorChange=!1})),this.add(e)}_createBack(){var t=new a.Shape({name:"back",width:0,height:0,draggable:!0,sceneFunc(t,e){var i=e.getParent(),r=i.padding();t.beginPath(),t.rect(-r,-r,e.width()+2*r,e.height()+2*r),t.moveTo(e.width()/2,-r),i.rotateEnabled()&&t.lineTo(e.width()/2,-i.rotateAnchorOffset()*n.Util._sign(e.height())-r),t.fillStrokeShape(e)},hitFunc:(t,e)=>{if(this.shouldOverdrawWholeArea()){var i=this.padding();t.beginPath(),t.rect(-i,-i,e.width()+2*i,e.height()+2*i),t.fillStrokeShape(e)}}});this.add(t),this._proxyDrag(t),t.on("dragstart",(t=>{t.cancelBubble=!0})),t.on("dragmove",(t=>{t.cancelBubble=!0})),t.on("dragend",(t=>{t.cancelBubble=!0})),this.on("dragmove",(t=>{this.update()}))}_handleMouseDown(t){this._movingAnchorName=t.target.name().split(" ")[0];var e=this._getNodeRect(),i=e.width,n=e.height,r=Math.sqrt(Math.pow(i,2)+Math.pow(n,2));this.sin=Math.abs(n/r),this.cos=Math.abs(i/r),"undefined"!=typeof window&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;var s=t.target.getAbsolutePosition(),a=t.target.getStage().getPointerPosition();this._anchorDragOffset={x:a.x-s.x,y:a.y-s.y},this._fire("transformstart",{evt:t.evt,target:this.getNode()}),this._nodes.forEach((e=>{e._fire("transformstart",{evt:t.evt,target:e})}))}_handleMouseMove(t){var e,i,n,r=this.findOne("."+this._movingAnchorName),s=r.getStage();s.setPointersPositions(t);const a=s.getPointerPosition();let o={x:a.x-this._anchorDragOffset.x,y:a.y-this._anchorDragOffset.y};const c=r.getAbsolutePosition();this.anchorDragBoundFunc()&&(o=this.anchorDragBoundFunc()(c,o,t)),r.setAbsolutePosition(o);const h=r.getAbsolutePosition();if(c.x!==h.x||c.y!==h.y)if("rotater"!==this._movingAnchorName){var l,u=this.shiftBehavior();l="inverted"===u?this.keepRatio()&&!t.shiftKey:"none"===u?this.keepRatio():this.keepRatio()||t.shiftKey;var p=this.centeredScaling()||t.altKey;if("top-left"===this._movingAnchorName){if(l){var m=p?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};n=Math.sqrt(Math.pow(m.x-r.x(),2)+Math.pow(m.y-r.y(),2));var f=this.findOne(".top-left").x()>m.x?-1:1,g=this.findOne(".top-left").y()>m.y?-1:1;e=n*this.cos*f,i=n*this.sin*g,this.findOne(".top-left").x(m.x-e),this.findOne(".top-left").y(m.y-i)}}else if("top-center"===this._movingAnchorName)this.findOne(".top-left").y(r.y());else if("top-right"===this._movingAnchorName){l&&(m=p?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()},n=Math.sqrt(Math.pow(r.x()-m.x,2)+Math.pow(m.y-r.y(),2)),f=this.findOne(".top-right").x()<m.x?-1:1,g=this.findOne(".top-right").y()>m.y?-1:1,e=n*this.cos*f,i=n*this.sin*g,this.findOne(".top-right").x(m.x+e),this.findOne(".top-right").y(m.y-i));var v=r.position();this.findOne(".top-left").y(v.y),this.findOne(".bottom-right").x(v.x)}else"middle-left"===this._movingAnchorName?this.findOne(".top-left").x(r.x()):"middle-right"===this._movingAnchorName?this.findOne(".bottom-right").x(r.x()):"bottom-left"===this._movingAnchorName?(l&&(m=p?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()},n=Math.sqrt(Math.pow(m.x-r.x(),2)+Math.pow(r.y()-m.y,2)),f=m.x<r.x()?-1:1,g=r.y()<m.y?-1:1,e=n*this.cos*f,i=n*this.sin*g,r.x(m.x-e),r.y(m.y+i)),v=r.position(),this.findOne(".top-left").x(v.x),this.findOne(".bottom-right").y(v.y)):"bottom-center"===this._movingAnchorName?this.findOne(".bottom-right").y(r.y()):"bottom-right"===this._movingAnchorName?l&&(m=p?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()},n=Math.sqrt(Math.pow(r.x()-m.x,2)+Math.pow(r.y()-m.y,2)),f=this.findOne(".bottom-right").x()<m.x?-1:1,g=this.findOne(".bottom-right").y()<m.y?-1:1,e=n*this.cos*f,i=n*this.sin*g,this.findOne(".bottom-right").x(m.x+e),this.findOne(".bottom-right").y(m.y+i)):console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));if(p=this.centeredScaling()||t.altKey){var y=this.findOne(".top-left"),k=this.findOne(".bottom-right"),S=y.x(),T=y.y(),w=this.getWidth()-k.x(),C=this.getHeight()-k.y();k.move({x:-S,y:-T}),y.move({x:w,y:C})}var _=this.findOne(".top-left").getAbsolutePosition();e=_.x,i=_.y;var P=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),E=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:e,y:i,width:P,height:E,rotation:d.Konva.getAngle(this.rotation())},t)}else{var x=this._getNodeRect();e=r.x()-x.width/2,i=-r.y()+x.height/2;let n=Math.atan2(-i,e)+Math.PI/2;x.height<0&&(n-=Math.PI);const s=d.Konva.getAngle(this.rotation())+n,a=d.Konva.getAngle(this.rotationSnapTolerance()),o=function(t,e){const i=function(t){return{x:t.x+t.width/2*Math.cos(t.rotation)+t.height/2*Math.sin(-t.rotation),y:t.y+t.height/2*Math.cos(t.rotation)+t.width/2*Math.sin(t.rotation)}}(t);return b(t,e,i)}(x,function(t,e,i){let n=e;for(let r=0;r<t.length;r++){const s=d.Konva.getAngle(t[r]),a=Math.abs(s-e)%(2*Math.PI);Math.min(a,2*Math.PI-a)<i&&(n=s)}return n}(this.rotationSnaps(),s,a)-x.rotation);this._fitNodesInto(o,t)}}_handleMouseUp(t){this._removeEvents(t)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(t){if(this._transforming){this._transforming=!1,"undefined"!=typeof window&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));var e=this.getNode();this._fire("transformend",{evt:t,target:e}),e&&this._nodes.forEach((e=>{e._fire("transformend",{evt:t,target:e})})),this._movingAnchorName=null}}_fitNodesInto(t,e){var i=this._getNodeRect();if(n.Util._inRange(t.width,2*-this.padding()-1,1))return void this.update();if(n.Util._inRange(t.height,2*-this.padding()-1,1))return void this.update();var r=new n.Transform;if(r.rotate(d.Konva.getAngle(this.rotation())),this._movingAnchorName&&t.width<0&&this._movingAnchorName.indexOf("left")>=0){const e=r.point({x:2*-this.padding(),y:0});t.x+=e.x,t.y+=e.y,t.width+=2*this.padding(),this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y}else if(this._movingAnchorName&&t.width<0&&this._movingAnchorName.indexOf("right")>=0){const e=r.point({x:2*this.padding(),y:0});this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.width+=2*this.padding()}if(this._movingAnchorName&&t.height<0&&this._movingAnchorName.indexOf("top")>=0){const e=r.point({x:0,y:2*-this.padding()});t.x+=e.x,t.y+=e.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.height+=2*this.padding()}else if(this._movingAnchorName&&t.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const e=r.point({x:0,y:2*this.padding()});this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.height+=2*this.padding()}if(this.boundBoxFunc()){const e=this.boundBoxFunc()(i,t);e?t=e:n.Util.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const s=1e7,a=new n.Transform;a.translate(i.x,i.y),a.rotate(i.rotation),a.scale(i.width/s,i.height/s);const o=new n.Transform,c=t.width/s,h=t.height/s;!1===this.flipEnabled()?(o.translate(t.x,t.y),o.rotate(t.rotation),o.translate(t.width<0?t.width:0,t.height<0?t.height:0),o.scale(Math.abs(c),Math.abs(h))):(o.translate(t.x,t.y),o.rotate(t.rotation),o.scale(c,h));const l=o.multiply(a.invert());this._nodes.forEach((t=>{var i;const r=t.getParent().getAbsoluteTransform(),s=t.getTransform().copy();s.translate(t.offsetX(),t.offsetY());const a=new n.Transform;a.multiply(r.copy().invert()).multiply(l).multiply(r).multiply(s);const o=a.decompose();t.setAttrs(o),this._fire("transform",{evt:e,target:t}),t._fire("transform",{evt:e,target:t}),null===(i=t.getLayer())||void 0===i||i.batchDraw()})),this.rotation(n.Util._getRotation(t.rotation)),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(t,e){this.findOne(t).setAttrs(e)}update(){var t,e=this._getNodeRect();this.rotation(n.Util._getRotation(e.rotation));var i=e.width,r=e.height,s=this.enabledAnchors(),a=this.resizeEnabled(),o=this.padding(),c=this.anchorSize();const d=this.find("._anchor");d.forEach((t=>{t.setAttrs({width:c,height:c,offsetX:c/2,offsetY:c/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})})),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:c/2+o,offsetY:c/2+o,visible:a&&s.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:i/2,y:0,offsetY:c/2+o,visible:a&&s.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:i,y:0,offsetX:c/2-o,offsetY:c/2+o,visible:a&&s.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:r/2,offsetX:c/2+o,visible:a&&s.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:i,y:r/2,offsetX:c/2-o,visible:a&&s.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:r,offsetX:c/2+o,offsetY:c/2-o,visible:a&&s.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:i/2,y:r,offsetY:c/2-o,visible:a&&s.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:i,y:r,offsetX:c/2-o,offsetY:c/2-o,visible:a&&s.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:i/2,y:-this.rotateAnchorOffset()*n.Util._sign(r)-o,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:i,height:r,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),x:0,y:0});const h=this.anchorStyleFunc();h&&d.forEach((t=>{h(t)})),null===(t=this.getLayer())||void 0===t||t.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();var t=this.findOne("."+this._movingAnchorName);t&&t.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),c.Group.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return s.Node.prototype.toObject.call(this)}clone(t){return s.Node.prototype.clone.call(this,t)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}}e.Transformer=k,k.prototype.className="Transformer",(0,l._registerNode)(k),r.Factory.addGetterSetter(k,"enabledAnchors",y,(function(t){return t instanceof Array||n.Util.warn("enabledAnchors value should be an array"),t instanceof Array&&t.forEach((function(t){-1===y.indexOf(t)&&n.Util.warn("Unknown anchor name: "+t+". Available names are: "+y.join(", "))})),t||[]})),r.Factory.addGetterSetter(k,"flipEnabled",!0,(0,h.getBooleanValidator)()),r.Factory.addGetterSetter(k,"resizeEnabled",!0),r.Factory.addGetterSetter(k,"anchorSize",10,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"rotateEnabled",!0),r.Factory.addGetterSetter(k,"rotationSnaps",[]),r.Factory.addGetterSetter(k,"rotateAnchorOffset",50,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"rotateAnchorCursor","crosshair"),r.Factory.addGetterSetter(k,"rotationSnapTolerance",5,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"borderEnabled",!0),r.Factory.addGetterSetter(k,"anchorStroke","rgb(0, 161, 255)"),r.Factory.addGetterSetter(k,"anchorStrokeWidth",1,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"anchorFill","white"),r.Factory.addGetterSetter(k,"anchorCornerRadius",0,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"borderStroke","rgb(0, 161, 255)"),r.Factory.addGetterSetter(k,"borderStrokeWidth",1,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"borderDash"),r.Factory.addGetterSetter(k,"keepRatio",!0),r.Factory.addGetterSetter(k,"shiftBehavior","default"),r.Factory.addGetterSetter(k,"centeredScaling",!1),r.Factory.addGetterSetter(k,"ignoreStroke",!1),r.Factory.addGetterSetter(k,"padding",0,(0,h.getNumberValidator)()),r.Factory.addGetterSetter(k,"node"),r.Factory.addGetterSetter(k,"nodes"),r.Factory.addGetterSetter(k,"boundBoxFunc"),r.Factory.addGetterSetter(k,"anchorDragBoundFunc"),r.Factory.addGetterSetter(k,"anchorStyleFunc"),r.Factory.addGetterSetter(k,"shouldOverdrawWholeArea",!1),r.Factory.addGetterSetter(k,"useSingleNodeRotation",!0),r.Factory.backCompat(k,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"})},9846:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Wedge=void 0;const n=i(1455),r=i(7955),s=i(4417),a=i(3774),o=i(4417);class c extends r.Shape{_sceneFunc(t){t.beginPath(),t.arc(0,0,this.radius(),0,s.Konva.getAngle(this.angle()),this.clockwise()),t.lineTo(0,0),t.closePath(),t.fillStrokeShape(this)}getWidth(){return 2*this.radius()}getHeight(){return 2*this.radius()}setWidth(t){this.radius(t/2)}setHeight(t){this.radius(t/2)}}e.Wedge=c,c.prototype.className="Wedge",c.prototype._centroid=!0,c.prototype._attrsAffectingSize=["radius"],(0,o._registerNode)(c),n.Factory.addGetterSetter(c,"radius",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"angle",0,(0,a.getNumberValidator)()),n.Factory.addGetterSetter(c,"clockwise",!1),n.Factory.backCompat(c,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"})}},e={};function i(n){var r=e[n];if(void 0!==r)return r.exports;var s=e[n]={exports:{}};return t[n](s,s.exports,i),s.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{i.r(n),i.d(n,{Blackboard:()=>Wa,BrushDefault:()=>c,Cursor:()=>d,Handlers:()=>b,LiveControl:()=>Va,StackManager:()=>m,StackPlayer:()=>Ja});var t=i(185),e=i.n(t),r=function(){return r=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},r.apply(this,arguments)},s={stroke:"#000000",strokeWidth:2,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",tension:.5},a={stroke:"#000000",strokeWidth:4,globalCompositeOperation:"source-over",lineCap:"round",lineJoin:"round",tension:.5,opacity:.5},o={stroke:"#ffffff",strokeWidth:5,globalCompositeOperation:"destination-out",lineCap:"square",lineJoin:"miter",hitStrokeWidth:5};const c=function(){function t(t,e){this.brushes={pen:s,marker:a,eraser:o},this.brushType="pen",this.currentBrush={type:this.brushType,config:this.brushes[this.brushType]},t&&this.setBrushType(t),e&&this.setBrushConfig(e)}return t.prototype.setBrushType=function(t){return this.brushType=t,this.currentBrush={type:this.brushType,config:this.brushes[this.brushType]},this.currentBrush},t.prototype.setBrushConfig=function(t){return this.brushes[this.brushType]=r(r({},this.brushes[this.brushType]),t),this.setBrushType(this.brushType)},t.prototype.getBrushConfig=function(){return this.currentBrush},t}(),d=function(){function t(t){this.cursor=null,this.blackBoard=t,this.initCursor()}return t.prototype.setDefaultCursorStyles=function(t){t&&(t.id="wb-cursor",t.style.position="fixed",t.style.zIndex="99999",t.style.pointerEvents="none",t.style.transform="translate(-50%, -50%)",t.style.border="1px solid #000000",t.style.display="none")},t.prototype.initCursor=function(){document.querySelector("#wb-cursor")?this.cursor=document.querySelector("#wb-cursor"):(this.cursor=document.createElement("div"),this.blackBoard.container.appendChild(this.cursor),this.setDefaultCursorStyles(this.cursor))},t.prototype.hideCursor=function(){this.cursor&&(this.cursor.style.display="none")},t.prototype.drawCursor=function(t,e){if(this.cursor&&this.blackBoard.container&&this.blackBoard.brush)if(t<0||t>this.blackBoard.width||e<0||e>this.blackBoard.height)this.hideCursor();else{var i=this.blackBoard.container,n=this.blackBoard.brush.getBrushConfig(),r=this.blackBoard.mode,s=n.config.strokeWidth,a="eraser"===r||"delete"===r?0:s/2;this.cursor.style.width=s+"px",this.cursor.style.height=s+"px",this.cursor.style.display="block",this.cursor.style.top="".concat(e+i.offsetTop,"px"),this.cursor.style.left="".concat(t-i.offsetLeft,"px"),this.cursor.style.borderRadius=a+"px"}},t}(),h=function(){return Date.now().toString(36)+Math.random().toString(36).slice(2)};var l=function(){return l=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},l.apply(this,arguments)};const u=function(){function t(t){this.type="pen",this.timestamp={start:Date.now(),end:Date.now()},this.config=t,this.userId=t.userId,this.line=new(e().Line)(l({id:t.userType+"-"+t.userId+"-"+h()},t.lineConfig))}return t.prototype.setTimestamp=function(t){this.timestamp=l(l({},this.timestamp),t)},t.prototype.getLine=function(){return this.line},t.prototype.getPoints=function(){return this.line.points()},t}();var p=function(){return p=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},p.apply(this,arguments)};new TextEncoder;const m=function(){function t(t,e){void 0===e&&(e=[]),this.stacks=new Map,this.undoStack=[],this.redoStack=[],this.blackboard=t,this.initStacks(e)}return t.prototype.remoteCallback=function(t){this.blackboard.liveControl.publishData(JSON.stringify(t))},t.prototype.initStacks=function(t){var e=this;t.forEach((function(t){e.runStack(t),e.stacks.set(t.id,t)}))},t.prototype.redrawStacksByClearIndex=function(t){var e=this;this.getStacks().slice(0,t).forEach((function(t){e.runStack(t)}))},t.prototype.addStack=function(t,e,i){void 0===e&&(e=!0),void 0===i&&(i=!0);var n="stack-".concat(h());this.stacks.set(n,t),e&&(this.undoStack.push(t),this.redoStack=[]),i&&this.remoteCallback(t)},t.prototype.reverseStackActionType=function(t){if(t)return"add"===t.action||"remove"===t.action?("add"===t.action?t.action="remove":"remove"===t.action&&(t.action="add"),t):"before"===t.action||"after"===t.action?("before"===t.action?t.action="after":"after"===t.action&&(t.action="before"),t):void 0},t.prototype.runStack=function(t){if(this.isPaintStackType(t)){if("add"===t.action){var e=new u({userType:"local",userId:this.blackboard.user.id,lineConfig:p(p({},t.paint.lineConfig),{id:t.paint.id,points:t.paint.points}),deleteAble:!t.paint.id.includes("eraser")});this.blackboard.layer.add(e.line),e.line.id().includes("eraser")?e.line.moveToTop():e.line.moveToBottom(),this.blackboard.handlers.bindHitLineEvent(e)}else if("remove"===t.action){var i=this.blackboard.layer.findOne("#".concat(t.paint.id));i&&i.remove(),this.blackboard.layer.draw()}}else this.isPanningStackType(t)?"before"===t.action?this.blackboard.stage.position(t.panning.before):"after"===t.action&&this.blackboard.stage.position(t.panning.after):this.isImageStackType(t)?"before"===t.action?this.blackboard.setBackground(t.image.before,!0):"after"===t.action&&this.blackboard.setBackground(t.image.after,!0):this.isClearStackType(t)&&("before"===t.action?this.redrawStacksByClearIndex(t.clearIndex):"after"===t.action&&this.blackboard.clear());this.blackboard.layer.draw()},t.prototype.undo=function(){if(0!==this.undoStack.length){var t=this.undoStack.pop();(t=this.reverseStackActionType(t))&&(this.runStack(t),this.redoStack.push(t),this.blackboard.updated("undo"),this.addStack(t,!1))}},t.prototype.clearRedoStack=function(){this.redoStack=[]},t.prototype.redo=function(){if(0!==this.redoStack.length){var t=this.redoStack.pop();(t=this.reverseStackActionType(t))&&(this.runStack(t),this.undoStack.push(t),this.blackboard.updated("redo"),this.addStack(t,!1))}},t.prototype.removeStack=function(t){this.stacks.delete(t)},t.prototype.removeStacksAfter=function(t){var e=this,i=Array.from(this.stacks.keys()),n=i.findIndex((function(e){return e===t}));-1!==n&&i.splice(n+1).forEach((function(t){e.stacks.delete(t)}))},t.prototype.getStack=function(t){return this.stacks.get(t)},t.prototype.getStacks=function(){return Array.from(this.stacks.values())},t.prototype.getUndoStack=function(){return this.undoStack},t.prototype.getRedoStack=function(){return this.redoStack},t.prototype.clearControlStacks=function(){this.undoStack=[],this.redoStack=[]},t.prototype.clearAllStacks=function(){this.stacks.clear(),this.clearControlStacks()},t.prototype.isPaintStackType=function(t){return void 0!==t.paint},t.prototype.isPanningStackType=function(t){return void 0!==t.panning},t.prototype.isImageStackType=function(t){return void 0!==t.image},t.prototype.isClearStackType=function(t){return void 0!==t.clearIndex},t.prototype.isStackType=function(t){return this.isPaintStackType(t)||this.isPanningStackType(t)||this.isImageStackType(t)||this.isClearStackType(t)},t.prototype.getStackType=function(t){if(this.isPaintStackType(t))return{type:"paint",stack:t};if(this.isPanningStackType(t))return{type:"panning",stack:t};if(this.isImageStackType(t))return{type:"image",stack:t};throw new Error("Invalid StackType")},t}();var f,g=["pen","marker","eraser"];function v(t){return g.includes(t)}!function(t){t[t.EGRESS_STARTING=0]="EGRESS_STARTING",t[t.EGRESS_ACTIVE=1]="EGRESS_ACTIVE",t[t.EGRESS_ENDING=2]="EGRESS_ENDING",t[t.EGRESS_COMPLETE=3]="EGRESS_COMPLETE",t[t.EGRESS_FAILED=4]="EGRESS_FAILED",t[t.EGRESS_ABORTED=5]="EGRESS_ABORTED",t[t.EGRESS_LIMIT_REACHED=6]="EGRESS_LIMIT_REACHED",t[t.UNRECOGNIZED=-1]="UNRECOGNIZED"}(f||(f={}));var y=function(){return y=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},y.apply(this,arguments)};const b=function(){function t(t){var e=this;this.isPaint=!1,this.isPanning=!1,this.isDeleteMode=!1,this.startTime=0,this.endTime=0,this.beforeStagePosition={x:0,y:0},this.afterStagePosition={x:0,y:0},this.stageDown=function(t){e.blackboard&&e.downEventByMode(e.blackboard.mode)},this.stageMove=function(t){e.blackboard&&("panning"===e.blackboard.mode||e.drawCursor(t.evt.offsetX,t.evt.offsetY),e.moveEventByMode(e.blackboard.mode,t))},this.stageUp=function(t){e.blackboard&&(e.isPaint=!1,e.isDeleteMode=!1,e.upEventByMode(e.blackboard.mode))},this.blackboard=t}return t.prototype.deleteLine=function(t){if(t.config.deleteAble){t.line.remove(),this.blackboard.updated("remove");var e=Date.now();this.blackboard.stackManager.addStack({id:"stack-".concat(h()),action:"remove",timeline:{start:e,end:e,duration:0},paint:{id:t.line.id(),type:t.type,lineConfig:t.config.lineConfig,points:t.line.points()}})}},t.prototype.drawCursor=function(t,e){this.blackboard.cursor.drawCursor(t,e)},t.prototype.getDrawable=function(){var t;return null===(t=this.blackboard.userList.get(this.blackboard.user.id))||void 0===t?void 0:t.access.draw},t.prototype.bindHitLineEvent=function(t){var e=this;t.line.on("pointerdown",(function(i){e.getDrawable()&&"delete"===e.blackboard.mode&&t.line&&e.deleteLine(t)})),t.line.on("pointerover",(function(i){e.getDrawable()&&"delete"===e.blackboard.mode&&e.isDeleteMode&&t.line&&e.deleteLine(t)}))},t.prototype.remoteDown=function(t){var e=new u({userType:"remote",userId:t.userId,lineConfig:y({id:"remote-".concat(h()),points:t.line.points()},t.config.lineConfig),deleteAble:!0}),i={type:"remote-down",userType:"remote",userId:this.blackboard.user.id,lineConfig:y({id:e.line.id(),points:e.line.points()},e.config.lineConfig)};this.blackboard.liveControl.publishData(JSON.stringify(i))},t.prototype.addDown=function(t){if(this.getDrawable()){this.isPaint=!0,this.beforeStagePosition=this.blackboard.getStagePosition(),this.afterStagePosition=this.blackboard.getStagePosition();var e=this.blackboard.stage.getPointerPosition(),i=this.blackboard.getStagePosition();if(e){var n=this.blackboard.brush.getBrushConfig(),r=new u({userType:"local",userId:this.blackboard.user.id,lineConfig:y({id:"".concat(t,"-").concat(h()),points:[e.x-i.x,e.y-i.y]},n.config),deleteAble:!0});this.bindHitLineEvent(r),this.blackboard.setNewLine(r),this.remoteDown(r)}}},t.prototype.draggingDown=function(t){"panning"===t&&(this.isPanning=!0,this.beforeStagePosition=this.blackboard.getStagePosition(),this.startTime=Date.now(),this.blackboard.container.style.cursor="grabbing",this.blackboard.updated("dragstart"))},t.prototype.deleteModeDown=function(t){"delete"===t&&(this.isDeleteMode=!0)},t.prototype.downEventByMode=function(t){switch(t){case"panning":this.draggingDown(t);break;case"delete":this.deleteModeDown(t);break;default:v(t)&&this.addDown(t)}},t.prototype.deleteMove=function(t){},t.prototype.draggingMove=function(t){"panning"===t&&this.isPanning&&console.log("this.blackboard.getStagePosition();",this.blackboard.getStagePosition())},t.prototype.remoteMove=function(t,e){var i={type:"remote-move",userType:"remote",userId:t,nextPoints:e};this.blackboard.liveControl.publishData(JSON.stringify(i))},t.prototype.addMove=function(t,e){if(this.getDrawable()&&this.isPaint&&!this.isDeleteMode){e.evt.preventDefault();var i=this.blackboard.stage.getPointerPosition(),n=this.blackboard.getStagePosition();if(i){var r=this.blackboard.getLastLine();if(r){var s=[i.x-n.x,i.y-n.y],a=r.line.points().concat(s);r.line.points(a),this.remoteMove(this.blackboard.user.id,s),this.blackboard.layer.batchDraw()}}}},t.prototype.moveEventByMode=function(t,e){switch(t){case"panning":this.draggingMove(t);break;case"delete":this.deleteMove(t);break;default:v(t)&&this.addMove(t,e)}},t.prototype.remoteUp=function(t){var e={type:"remote-up",userType:"remote",userId:this.blackboard.user.id,lineConfig:y({id:t.line.id(),points:t.line.points()},t.config.lineConfig)};console.log("remoteData",e),this.blackboard.liveControl.publishData(JSON.stringify(e))},t.prototype.addUp=function(t){if(this.getDrawable()){this.isPaint=!1;var e=this.blackboard.getLastLine();e&&(e.setTimestamp({end:Date.now()}),this.blackboard.stackManager.addStack({id:"stack-".concat(h()),action:"add",timeline:{start:e.timestamp.start,end:e.timestamp.end,duration:e.timestamp.end-e.timestamp.start},paint:{id:e.line.id(),type:e.type,lineConfig:e.config.lineConfig,points:e.line.points()}},!0,!1),this.remoteUp(e),this.blackboard.updated("paint up"))}},t.prototype.draggingUp=function(t){"panning"===t&&(this.isPanning=!1,this.afterStagePosition=this.blackboard.getStagePosition(),this.endTime=Date.now(),this.blackboard.container.style.cursor="grab",this.blackboard.stackManager.addStack({id:"".concat(t,"-").concat(h()),action:"after",timeline:{start:this.startTime,end:this.endTime,duration:this.endTime-this.startTime},panning:{before:this.beforeStagePosition,after:this.afterStagePosition}},!0,this.blackboard.isPublisher),this.blackboard.updated("dragend"))},t.prototype.deleteModeUp=function(t){"delete"===t&&(this.isDeleteMode=!1,this.isPaint=!1)},t.prototype.upEventByMode=function(t){switch(t){case"panning":this.draggingUp(t);break;case"delete":this.deleteModeUp(t);break;default:v(t)&&this.addUp(t)}},t}();function k(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(i){if("default"!==i&&!(i in t)){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}}))})),Object.freeze(t)}var S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function T(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var w={exports:{}};!function(t){var e,i;e=S,i=function(){var t=function(){},e="undefined",i=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function r(t,e){var i=t[e];if("function"==typeof i.bind)return i.bind(t);try{return Function.prototype.bind.call(i,t)}catch(e){return function(){return Function.prototype.apply.apply(i,[t,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(e,i){for(var r=0;r<n.length;r++){var s=n[r];this[s]=r<e?t:this.methodFactory(s,e,i)}this.log=this.debug}function o(t,i,n){return function(){typeof console!==e&&(a.call(this,i,n),this[t].apply(this,arguments))}}function c(n,a,c){return function(n){return"debug"===n&&(n="log"),typeof console!==e&&("trace"===n&&i?s:void 0!==console[n]?r(console,n):void 0!==console.log?r(console,"log"):t)}(n)||o.apply(this,arguments)}function d(t,i,r){var s,o=this;i=null==i?"WARN":i;var d="loglevel";function h(){var t;if(typeof window!==e&&d){try{t=window.localStorage[d]}catch(t){}if(typeof t===e)try{var i=window.document.cookie,n=i.indexOf(encodeURIComponent(d)+"=");-1!==n&&(t=/^([^;]+)/.exec(i.slice(n))[1])}catch(t){}return void 0===o.levels[t]&&(t=void 0),t}}"string"==typeof t?d+=":"+t:"symbol"==typeof t&&(d=void 0),o.name=t,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=r||c,o.getLevel=function(){return s},o.setLevel=function(i,r){if("string"==typeof i&&void 0!==o.levels[i.toUpperCase()]&&(i=o.levels[i.toUpperCase()]),!("number"==typeof i&&i>=0&&i<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+i;if(s=i,!1!==r&&function(t){var i=(n[t]||"silent").toUpperCase();if(typeof window!==e&&d){try{return void(window.localStorage[d]=i)}catch(t){}try{window.document.cookie=encodeURIComponent(d)+"="+i+";"}catch(t){}}}(i),a.call(o,i,t),typeof console===e&&i<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(t){i=t,h()||o.setLevel(t,!1)},o.resetLevel=function(){o.setLevel(i,!1),function(){if(typeof window!==e&&d){try{return void window.localStorage.removeItem(d)}catch(t){}try{window.document.cookie=encodeURIComponent(d)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(t){}}}()},o.enableAll=function(t){o.setLevel(o.levels.TRACE,t)},o.disableAll=function(t){o.setLevel(o.levels.SILENT,t)};var l=h();null==l&&(l=i),o.setLevel(l,!1)}var h=new d,l={};h.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=l[t];return e||(e=l[t]=new d(t,h.getLevel(),h.methodFactory)),e};var u=typeof window!==e?window.log:void 0;return h.noConflict=function(){return typeof window!==e&&window.log===h&&(window.log=u),h},h.getLoggers=function(){return l},h.default=h,h},t.exports?t.exports=i():e.log=i()}(w);var C,_=w.exports;!function(t){t[t.trace=0]="trace",t[t.debug=1]="debug",t[t.info=2]="info",t[t.warn=3]="warn",t[t.error=4]="error",t[t.silent=5]="silent"}(C||(C={}));const P=_.getLogger("livekit");function E(t,e){if(!t)throw new Error(e)}P.setDefaultLevel(C.info),_.getLogger("lk-e2ee");const x=34028234663852886e22,R=-34028234663852886e22,I=4294967295,D=2147483647,M=-2147483648;function A(t){if("number"!=typeof t)throw new Error("invalid int 32: "+typeof t);if(!Number.isInteger(t)||t>D||t<M)throw new Error("invalid int 32: "+t)}function N(t){if("number"!=typeof t)throw new Error("invalid uint 32: "+typeof t);if(!Number.isInteger(t)||t>I||t<0)throw new Error("invalid uint 32: "+t)}function L(t){if("number"!=typeof t)throw new Error("invalid float 32: "+typeof t);if(Number.isFinite(t)&&(t>x||t<R))throw new Error("invalid float 32: "+t)}const O=Symbol("@bufbuild/protobuf/enum-type");function U(t,e,i,n){t[O]=F(e,i.map((e=>({no:e.no,name:e.name,localName:t[e.no]}))))}function F(t,e,i){const n=Object.create(null),r=Object.create(null),s=[];for(const t of e){const e=B(t);s.push(e),n[t.name]=e,r[t.no]=e}return{typeName:t,values:s,findName:t=>n[t],findNumber:t=>r[t]}}function B(t){return"localName"in t?t:Object.assign(Object.assign({},t),{localName:t.name})}class G{equals(t){return this.getType().runtime.util.equals(this.getType(),this,t)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(t,e){const i=this.getType().runtime.bin,n=i.makeReadOptions(e);return i.readMessage(this,n.readerFactory(t),t.byteLength,n),this}fromJson(t,e){const i=this.getType(),n=i.runtime.json,r=n.makeReadOptions(e);return n.readMessage(i,t,r,this),this}fromJsonString(t,e){let i;try{i=JSON.parse(t)}catch(t){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(t instanceof Error?t.message:String(t)))}return this.fromJson(i,e)}toBinary(t){const e=this.getType().runtime.bin,i=e.makeWriteOptions(t),n=i.writerFactory();return e.writeMessage(this,n,i),n.finish()}toJson(t){const e=this.getType().runtime.json,i=e.makeWriteOptions(t);return e.writeMessage(this,i)}toJsonString(t){var e;const i=this.toJson(t);return JSON.stringify(i,null,null!==(e=null==t?void 0:t.prettySpaces)&&void 0!==e?e:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}var V,j;function J(){let t=0,e=0;for(let i=0;i<28;i+=7){let n=this.buf[this.pos++];if(t|=(127&n)<<i,0==(128&n))return this.assertBounds(),[t,e]}let i=this.buf[this.pos++];if(t|=(15&i)<<28,e=(112&i)>>4,0==(128&i))return this.assertBounds(),[t,e];for(let i=3;i<=31;i+=7){let n=this.buf[this.pos++];if(e|=(127&n)<<i,0==(128&n))return this.assertBounds(),[t,e]}throw new Error("invalid varint")}function q(t,e,i){for(let n=0;n<28;n+=7){const r=t>>>n,s=!(r>>>7==0&&0==e),a=255&(s?128|r:r);if(i.push(a),!s)return}const n=t>>>28&15|(7&e)<<4,r=!(e>>3==0);if(i.push(255&(r?128|n:n)),r){for(let t=3;t<31;t+=7){const n=e>>>t,r=!(n>>>7==0),s=255&(r?128|n:n);if(i.push(s),!r)return}i.push(e>>>31&1)}}!function(t){t[t.DOUBLE=1]="DOUBLE",t[t.FLOAT=2]="FLOAT",t[t.INT64=3]="INT64",t[t.UINT64=4]="UINT64",t[t.INT32=5]="INT32",t[t.FIXED64=6]="FIXED64",t[t.FIXED32=7]="FIXED32",t[t.BOOL=8]="BOOL",t[t.STRING=9]="STRING",t[t.BYTES=12]="BYTES",t[t.UINT32=13]="UINT32",t[t.SFIXED32=15]="SFIXED32",t[t.SFIXED64=16]="SFIXED64",t[t.SINT32=17]="SINT32",t[t.SINT64=18]="SINT64"}(V||(V={})),function(t){t[t.BIGINT=0]="BIGINT",t[t.STRING=1]="STRING"}(j||(j={}));const W=4294967296;function H(t){const e="-"===t[0];e&&(t=t.slice(1));const i=1e6;let n=0,r=0;function s(e,s){const a=Number(t.slice(e,s));r*=i,n=n*i+a,n>=W&&(r+=n/W|0,n%=W)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?Y(n,r):K(n,r)}function z(t,e){if(({lo:t,hi:e}=function(t,e){return{lo:t>>>0,hi:e>>>0}}(t,e)),e<=2097151)return String(W*e+t);const i=16777215&(t>>>24|e<<8),n=e>>16&65535;let r=(16777215&t)+6777216*i+6710656*n,s=i+8147497*n,a=2*n;const o=1e7;return r>=o&&(s+=Math.floor(r/o),r%=o),s>=o&&(a+=Math.floor(s/o),s%=o),a.toString()+X(s)+X(r)}function K(t,e){return{lo:0|t,hi:0|e}}function Y(t,e){return e=~e,t?t=1+~t:e+=1,K(t,e)}const X=t=>{const e=String(t);return"0000000".slice(e.length)+e};function Q(t,e){if(t>=0){for(;t>127;)e.push(127&t|128),t>>>=7;e.push(t)}else{for(let i=0;i<9;i++)e.push(127&t|128),t>>=7;e.push(1)}}function Z(){let t=this.buf[this.pos++],e=127&t;if(0==(128&t))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(127&t)<<7,0==(128&t))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(127&t)<<14,0==(128&t))return this.assertBounds(),e;if(t=this.buf[this.pos++],e|=(127&t)<<21,0==(128&t))return this.assertBounds(),e;t=this.buf[this.pos++],e|=(15&t)<<28;for(let e=5;0!=(128&t)&&e<10;e++)t=this.buf[this.pos++];if(0!=(128&t))throw new Error("invalid varint");return this.assertBounds(),e>>>0}const $=function(){const t=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof t.getBigInt64&&"function"==typeof t.getBigUint64&&"function"==typeof t.setBigInt64&&"function"==typeof t.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){const e=BigInt("-9223372036854775808"),i=BigInt("9223372036854775807"),n=BigInt("0"),r=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(t){const n="bigint"==typeof t?t:BigInt(t);if(n>i||n<e)throw new Error("int64 invalid: ".concat(t));return n},uParse(t){const e="bigint"==typeof t?t:BigInt(t);if(e>r||e<n)throw new Error("uint64 invalid: ".concat(t));return e},enc(e){return t.setBigInt64(0,this.parse(e),!0),{lo:t.getInt32(0,!0),hi:t.getInt32(4,!0)}},uEnc(e){return t.setBigInt64(0,this.uParse(e),!0),{lo:t.getInt32(0,!0),hi:t.getInt32(4,!0)}},dec:(e,i)=>(t.setInt32(0,e,!0),t.setInt32(4,i,!0),t.getBigInt64(0,!0)),uDec:(e,i)=>(t.setInt32(0,e,!0),t.setInt32(4,i,!0),t.getBigUint64(0,!0))}}const e=t=>E(/^-?[0-9]+$/.test(t),"int64 invalid: ".concat(t)),i=t=>E(/^[0-9]+$/.test(t),"uint64 invalid: ".concat(t));return{zero:"0",supported:!1,parse:t=>("string"!=typeof t&&(t=t.toString()),e(t),t),uParse:t=>("string"!=typeof t&&(t=t.toString()),i(t),t),enc:t=>("string"!=typeof t&&(t=t.toString()),e(t),H(t)),uEnc:t=>("string"!=typeof t&&(t=t.toString()),i(t),H(t)),dec:(t,e)=>function(t,e){let i=K(t,e);const n=2147483648&i.hi;n&&(i=Y(i.lo,i.hi));const r=z(i.lo,i.hi);return n?"-"+r:r}(t,e),uDec:(t,e)=>z(t,e)}}();var tt;!function(t){t[t.Varint=0]="Varint",t[t.Bit64=1]="Bit64",t[t.LengthDelimited=2]="LengthDelimited",t[t.StartGroup=3]="StartGroup",t[t.EndGroup=4]="EndGroup",t[t.Bit32=5]="Bit32"}(tt||(tt={}));class et{constructor(t){this.stack=[],this.textEncoder=null!=t?t:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let e=0;e<this.chunks.length;e++)t+=this.chunks[e].length;let e=new Uint8Array(t),i=0;for(let t=0;t<this.chunks.length;t++)e.set(this.chunks[t],i),i+=this.chunks[t].length;return this.chunks=[],e}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let t=this.finish(),e=this.stack.pop();if(!e)throw new Error("invalid state, fork stack empty");return this.chunks=e.chunks,this.buf=e.buf,this.uint32(t.byteLength),this.raw(t)}tag(t,e){return this.uint32((t<<3|e)>>>0)}raw(t){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(t),this}uint32(t){for(N(t);t>127;)this.buf.push(127&t|128),t>>>=7;return this.buf.push(t),this}int32(t){return A(t),Q(t,this.buf),this}bool(t){return this.buf.push(t?1:0),this}bytes(t){return this.uint32(t.byteLength),this.raw(t)}string(t){let e=this.textEncoder.encode(t);return this.uint32(e.byteLength),this.raw(e)}float(t){L(t);let e=new Uint8Array(4);return new DataView(e.buffer).setFloat32(0,t,!0),this.raw(e)}double(t){let e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,t,!0),this.raw(e)}fixed32(t){N(t);let e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t,!0),this.raw(e)}sfixed32(t){A(t);let e=new Uint8Array(4);return new DataView(e.buffer).setInt32(0,t,!0),this.raw(e)}sint32(t){return A(t),Q(t=(t<<1^t>>31)>>>0,this.buf),this}sfixed64(t){let e=new Uint8Array(8),i=new DataView(e.buffer),n=$.enc(t);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(e)}fixed64(t){let e=new Uint8Array(8),i=new DataView(e.buffer),n=$.uEnc(t);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(e)}int64(t){let e=$.enc(t);return q(e.lo,e.hi,this.buf),this}sint64(t){let e=$.enc(t),i=e.hi>>31;return q(e.lo<<1^i,(e.hi<<1|e.lo>>>31)^i,this.buf),this}uint64(t){let e=$.uEnc(t);return q(e.lo,e.hi,this.buf),this}}class it{constructor(t,e){this.varint64=J,this.uint32=Z,this.buf=t,this.len=t.length,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.textDecoder=null!=e?e:new TextDecoder}tag(){let t=this.uint32(),e=t>>>3,i=7&t;if(e<=0||i<0||i>5)throw new Error("illegal tag: field no "+e+" wire type "+i);return[e,i]}skip(t){let e=this.pos;switch(t){case tt.Varint:for(;128&this.buf[this.pos++];);break;case tt.Bit64:this.pos+=4;case tt.Bit32:this.pos+=4;break;case tt.LengthDelimited:let e=this.uint32();this.pos+=e;break;case tt.StartGroup:let i;for(;(i=this.tag()[1])!==tt.EndGroup;)this.skip(i);break;default:throw new Error("cant skip wire type "+t)}return this.assertBounds(),this.buf.subarray(e,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let t=this.uint32();return t>>>1^-(1&t)}int64(){return $.dec(...this.varint64())}uint64(){return $.uDec(...this.varint64())}sint64(){let[t,e]=this.varint64(),i=-(1&t);return t=(t>>>1|(1&e)<<31)^i,e=e>>>1^i,$.dec(t,e)}bool(){let[t,e]=this.varint64();return 0!==t||0!==e}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return $.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return $.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let t=this.uint32(),e=this.pos;return this.pos+=t,this.assertBounds(),this.buf.subarray(e,e+t)}string(){return this.textDecoder.decode(this.bytes())}}function nt(t,e){return e instanceof G||!t.fieldWrapper?e:t.fieldWrapper.wrapField(e)}function rt(t,e,i){if(e===i)return!0;if(t==V.BYTES){if(!(e instanceof Uint8Array&&i instanceof Uint8Array))return!1;if(e.length!==i.length)return!1;for(let t=0;t<e.length;t++)if(e[t]!==i[t])return!1;return!0}switch(t){case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:return e==i}return!1}function st(t,e){switch(t){case V.BOOL:return!1;case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:return 0==e?$.zero:"0";case V.DOUBLE:case V.FLOAT:return 0;case V.BYTES:return new Uint8Array(0);case V.STRING:return"";default:return 0}}function at(t,e){const i=void 0===e;let n=tt.Varint,r=0===e;switch(t){case V.STRING:r=i||!e.length,n=tt.LengthDelimited;break;case V.BOOL:r=!1===e;break;case V.DOUBLE:n=tt.Bit64;break;case V.FLOAT:n=tt.Bit32;break;case V.INT64:case V.UINT64:r=i||0==e;break;case V.FIXED64:r=i||0==e,n=tt.Bit64;break;case V.BYTES:r=i||!e.byteLength,n=tt.LengthDelimited;break;case V.FIXED32:case V.SFIXED32:n=tt.Bit32;break;case V.SFIXED64:r=i||0==e,n=tt.Bit64;break;case V.SINT64:r=i||0==e}return[n,V[t].toLowerCase(),i||r]}V.DOUBLE,V.FLOAT,V.INT64,V.UINT64,V.INT32,V.UINT32,V.BOOL,V.STRING,V.BYTES;const ot=Symbol("@bufbuild/protobuf/unknown-fields"),ct={readUnknownFields:!0,readerFactory:t=>new it(t)},dt={writeUnknownFields:!0,writerFactory:()=>new et};function ht(t,e,i){return e.getType().runtime.bin.readMessage(e,t,t.uint32(),i),e}function lt(t,e,i){const n=e.uint32(),r=e.pos+n;let s,a;for(;e.pos<r;){let[n]=e.tag();switch(n){case 1:s=pt(e,t.K);break;case 2:switch(t.V.kind){case"scalar":a=pt(e,t.V.T);break;case"enum":a=e.int32();break;case"message":a=ht(e,new t.V.T,i)}}}if(void 0===s){let e=st(t.K,j.BIGINT);s=t.K==V.BOOL?e.toString():e}if("string"!=typeof s&&"number"!=typeof s&&(s=s.toString()),void 0===a)switch(t.V.kind){case"scalar":a=st(t.V.T,j.BIGINT);break;case"enum":a=0;break;case"message":a=new t.V.T}return[s,a]}function ut(t,e){const i=pt(t,e);return"bigint"==typeof i?i.toString():i}function pt(t,e){switch(e){case V.STRING:return t.string();case V.BOOL:return t.bool();case V.DOUBLE:return t.double();case V.FLOAT:return t.float();case V.INT32:return t.int32();case V.INT64:return t.int64();case V.UINT64:return t.uint64();case V.FIXED64:return t.fixed64();case V.BYTES:return t.bytes();case V.FIXED32:return t.fixed32();case V.SFIXED32:return t.sfixed32();case V.SFIXED64:return t.sfixed64();case V.SINT64:return t.sint64();case V.UINT32:return t.uint32();case V.SINT32:return t.sint32()}}function mt(t,e,i,n,r){t.tag(i.no,tt.LengthDelimited),t.fork();let s=n;switch(i.K){case V.INT32:case V.FIXED32:case V.UINT32:case V.SFIXED32:case V.SINT32:s=Number.parseInt(n);break;case V.BOOL:E("true"==n||"false"==n),s="true"==n}switch(gt(t,i.K,1,s,!0),i.V.kind){case"scalar":gt(t,i.V.T,2,r,!0);break;case"enum":gt(t,V.INT32,2,r,!0);break;case"message":ft(t,e,i.V.T,2,r)}t.join()}function ft(t,e,i,n,r){if(void 0!==r){const s=nt(i,r);t.tag(n,tt.LengthDelimited).bytes(s.toBinary(e))}}function gt(t,e,i,n,r){let[s,a,o]=at(e,n);o&&!r||t.tag(i,s)[a](n)}function vt(t,e,i,n){if(!n.length)return;t.tag(i,tt.LengthDelimited).fork();let[,r]=at(e);for(let e=0;e<n.length;e++)t[r](n[e]);t.join()}let yt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),bt=[];for(let t=0;t<yt.length;t++)bt[yt[t].charCodeAt(0)]=t;bt["-".charCodeAt(0)]=yt.indexOf("+"),bt["_".charCodeAt(0)]=yt.indexOf("/");const kt={dec(t){let e=3*t.length/4;"="==t[t.length-2]?e-=2:"="==t[t.length-1]&&(e-=1);let i,n=new Uint8Array(e),r=0,s=0,a=0;for(let e=0;e<t.length;e++){if(i=bt[t.charCodeAt(e)],void 0===i)switch(t[e]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:a=i,s=1;break;case 1:n[r++]=a<<2|(48&i)>>4,a=i,s=2;break;case 2:n[r++]=(15&a)<<4|(60&i)>>2,a=i,s=3;break;case 3:n[r++]=(3&a)<<6|i,s=0}}if(1==s)throw Error("invalid base64 string.");return n.subarray(0,r)},enc(t){let e,i="",n=0,r=0;for(let s=0;s<t.length;s++)switch(e=t[s],n){case 0:i+=yt[e>>2],r=(3&e)<<4,n=1;break;case 1:i+=yt[r|e>>4],r=(15&e)<<2,n=2;break;case 2:i+=yt[r|e>>6],i+=yt[63&e],n=0}return n&&(i+=yt[r],i+="=",1==n&&(i+="=")),i}},St={ignoreUnknownFields:!1},Tt={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function wt(t){return t?Object.assign(Object.assign({},St),t):St}function Ct(t){return t?Object.assign(Object.assign({},Tt),t):Tt}function _t(t){if(null===t)return"null";switch(typeof t){case"object":return Array.isArray(t)?"array":"object";case"string":return t.length>100?"string":'"'.concat(t.split('"').join('\\"'),'"');default:return String(t)}}function Pt(t,e,i){switch(t){case V.DOUBLE:case V.FLOAT:if(null===e)return 0;if("NaN"===e)return Number.NaN;if("Infinity"===e)return Number.POSITIVE_INFINITY;if("-Infinity"===e)return Number.NEGATIVE_INFINITY;if(""===e)break;if("string"==typeof e&&e.trim().length!==e.length)break;if("string"!=typeof e&&"number"!=typeof e)break;const n=Number(e);if(Number.isNaN(n))break;if(!Number.isFinite(n))break;return t==V.FLOAT&&L(n),n;case V.INT32:case V.FIXED32:case V.SFIXED32:case V.SINT32:case V.UINT32:if(null===e)return 0;let r;if("number"==typeof e?r=e:"string"==typeof e&&e.length>0&&e.trim().length===e.length&&(r=Number(e)),void 0===r)break;return t==V.UINT32?N(r):A(r),r;case V.INT64:case V.SFIXED64:case V.SINT64:if(null===e)return $.zero;if("number"!=typeof e&&"string"!=typeof e)break;const s=$.parse(e);return i?s.toString():s;case V.FIXED64:case V.UINT64:if(null===e)return $.zero;if("number"!=typeof e&&"string"!=typeof e)break;const a=$.uParse(e);return i?a.toString():a;case V.BOOL:if(null===e)return!1;if("boolean"!=typeof e)break;return e;case V.STRING:if(null===e)return"";if("string"!=typeof e)break;try{encodeURIComponent(e)}catch(t){throw new Error("invalid UTF8")}return e;case V.BYTES:if(null===e||""===e)return new Uint8Array(0);if("string"!=typeof e)break;return kt.dec(e)}throw new Error}function Et(t,e,i){if(null===e)return 0;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const n=t.findName(e);if(n||i)return null==n?void 0:n.no}throw new Error("cannot decode enum ".concat(t.typeName," from JSON: ").concat(_t(e)))}function xt(t,e,i,n){var r;if(void 0===e)return e;if(0===e&&!i)return;if(n)return e;if("google.protobuf.NullValue"==t.typeName)return null;const s=t.findNumber(e);return null!==(r=null==s?void 0:s.name)&&void 0!==r?r:e}function Rt(t,e,i){if(void 0!==e)switch(t){case V.INT32:case V.SFIXED32:case V.SINT32:case V.FIXED32:case V.UINT32:return E("number"==typeof e),0!=e||i?e:void 0;case V.FLOAT:case V.DOUBLE:return E("number"==typeof e),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":0!==e||i?e:void 0;case V.STRING:return E("string"==typeof e),e.length>0||i?e:void 0;case V.BOOL:return E("boolean"==typeof e),e||i?e:void 0;case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:return E("bigint"==typeof e||"string"==typeof e||"number"==typeof e),i||0!=e?e.toString(10):void 0;case V.BYTES:return E(e instanceof Uint8Array),i||e.byteLength>0?kt.enc(e):void 0}}function It(t){if(void 0===t)return t;if(t instanceof G)return t.clone();if(t instanceof Uint8Array){const e=new Uint8Array(t.byteLength);return e.set(t),e}return t}function Dt(t){return t instanceof Uint8Array?t:new Uint8Array(t)}class Mt{constructor(t,e){this._fields=t,this._normalizer=e}findJsonName(t){if(!this.jsonNames){const t={};for(const e of this.list())t[e.jsonName]=t[e.name]=e;this.jsonNames=t}return this.jsonNames[t]}find(t){if(!this.numbers){const t={};for(const e of this.list())t[e.no]=e;this.numbers=t}return this.numbers[t]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(((t,e)=>t.no-e.no))),this.numbersAsc}byMember(){if(!this.members){this.members=[];const t=this.members;let e;for(const i of this.list())i.oneof?i.oneof!==e&&(e=i.oneof,t.push(e)):t.push(i)}return this.members}}function At(t,e){const i=Lt(t);return e?i:Gt(Bt(i))}const Nt=Lt;function Lt(t){let e=!1;const i=[];for(let n=0;n<t.length;n++){let r=t.charAt(n);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":i.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),i.push(r)}}return i.join("")}const Ot=new Set(["constructor","toString","toJSON","valueOf"]),Ut=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Ft=t=>"".concat(t,"$"),Bt=t=>Ut.has(t)?Ft(t):t,Gt=t=>Ot.has(t)?Ft(t):t;class Vt{constructor(t){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.default=void 0,this.fields=[],this.name=t,this.localName=At(t,!1)}addField(t){E(t.oneof===this,"field ".concat(t.name," not one of ").concat(this.name)),this.fields.push(t)}findField(t){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[t]}}const jt=("proto3",Jt=function(t){const e=((t,e)=>function(i,n,r){if("map"==i.kind){const s={};switch(i.V.kind){case"scalar":for(const[t,r]of Object.entries(n)){const n=e(i.V.T,r,!0);E(void 0!==n),s[t.toString()]=n}break;case"message":for(const[t,e]of Object.entries(n))s[t.toString()]=e.toJson(r);break;case"enum":const a=i.V.T;for(const[e,i]of Object.entries(n)){E(void 0===i||"number"==typeof i);const n=t(a,i,!0,r.enumAsInteger);E(void 0!==n),s[e.toString()]=n}}return r.emitDefaultValues||Object.keys(s).length>0?s:void 0}if(i.repeated){const s=[];switch(i.kind){case"scalar":for(let t=0;t<n.length;t++)s.push(e(i.T,n[t],!0));break;case"enum":for(let e=0;e<n.length;e++)s.push(t(i.T,n[e],!0,r.enumAsInteger));break;case"message":for(let t=0;t<n.length;t++)s.push(nt(i.T,n[t]).toJson(r))}return r.emitDefaultValues||s.length>0?s:void 0}switch(i.kind){case"scalar":return e(i.T,n,!!i.oneof||i.opt||r.emitDefaultValues);case"enum":return t(i.T,n,!!i.oneof||i.opt||r.emitDefaultValues,r.enumAsInteger);case"message":return void 0!==n?nt(i.T,n).toJson(r):void 0}})(xt,Rt);return{makeReadOptions:wt,makeWriteOptions:Ct,readMessage(t,e,i,n){if(null==e||Array.isArray(e)||"object"!=typeof e)throw new Error("cannot decode message ".concat(t.typeName," from JSON: ").concat(this.debug(e)));n=null!=n?n:new t;const r={};for(const[s,a]of Object.entries(e)){const e=t.fields.findJsonName(s);if(!e){if(!i.ignoreUnknownFields)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: key "').concat(s,'" is unknown'));continue}let o=e.localName,c=n;if(e.oneof){if(null===a&&"scalar"==e.kind)continue;const i=r[e.oneof.localName];if(i)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: multiple keys for oneof "').concat(e.oneof.name,'" present: "').concat(i,'", "').concat(s,'"'));r[e.oneof.localName]=s,c=c[e.oneof.localName]={case:o},o="value"}if(e.repeated){if(null===a)continue;if(!Array.isArray(a))throw new Error("cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(a)));const n=c[o];for(const r of a){if(null===r)throw new Error("cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(r)));let s;switch(e.kind){case"message":s=e.T.fromJson(r,i);break;case"enum":if(s=Et(e.T,r,i.ignoreUnknownFields),void 0===s)continue;break;case"scalar":try{s=Pt(e.T,r,e.L)}catch(i){let n="cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(r));throw i instanceof Error&&i.message.length>0&&(n+=": ".concat(i.message)),new Error(n)}}n.push(s)}}else if("map"==e.kind){if(null===a)continue;if(Array.isArray(a)||"object"!=typeof a)throw new Error("cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(a)));const n=c[o];for(const[r,s]of Object.entries(a)){if(null===s)throw new Error("cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: map value null"));let o;switch(e.V.kind){case"message":o=e.V.T.fromJson(s,i);break;case"enum":if(o=Et(e.V.T,s,i.ignoreUnknownFields),void 0===o)continue;break;case"scalar":try{o=Pt(e.V.T,s,j.BIGINT)}catch(i){let n="cannot decode map value for field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(a));throw i instanceof Error&&i.message.length>0&&(n+=": ".concat(i.message)),new Error(n)}}try{n[Pt(e.K,e.K==V.BOOL?"true"==r||"false"!=r&&r:r,j.BIGINT).toString()]=o}catch(i){let n="cannot decode map key for field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(a));throw i instanceof Error&&i.message.length>0&&(n+=": ".concat(i.message)),new Error(n)}}}else switch(e.kind){case"message":const n=e.T;if(null===a&&"google.protobuf.Value"!=n.typeName){if(e.oneof)throw new Error("cannot decode field ".concat(t.typeName,".").concat(e.name,' from JSON: null is invalid for oneof field "').concat(s,'"'));continue}c[o]instanceof G?c[o].fromJson(a,i):(c[o]=n.fromJson(a,i),n.fieldWrapper&&!e.oneof&&(c[o]=n.fieldWrapper.unwrapField(c[o])));break;case"enum":const r=Et(e.T,a,i.ignoreUnknownFields);void 0!==r&&(c[o]=r);break;case"scalar":try{c[o]=Pt(e.T,a,e.L)}catch(i){let n="cannot decode field ".concat(t.typeName,".").concat(e.name," from JSON: ").concat(this.debug(a));throw i instanceof Error&&i.message.length>0&&(n+=": ".concat(i.message)),new Error(n)}}}return n},writeMessage(t,i){const n=t.getType(),r={};let s;try{for(const a of n.fields.byMember()){let n;if("oneof"==a.kind){const r=t[a.localName];if(void 0===r.value)continue;if(s=a.findField(r.case),!s)throw"oneof case not found: "+r.case;n=e(s,r.value,i)}else s=a,n=e(s,t[s.localName],i);void 0!==n&&(r[i.useProtoFieldName?s.name:s.jsonName]=n)}}catch(t){const e=s?"cannot encode field ".concat(n.typeName,".").concat(s.name," to JSON"):"cannot encode message ".concat(n.typeName," to JSON"),i=t instanceof Error?t.message:String(t);throw new Error(e+(i.length>0?": ".concat(i):""))}return r},readScalar:Pt,writeScalar:Rt,debug:_t}}(),qt=Object.assign(Object.assign({},{makeReadOptions:function(t){return t?Object.assign(Object.assign({},ct),t):ct},makeWriteOptions:function(t){return t?Object.assign(Object.assign({},dt),t):dt},listUnknownFields(t){var e;return null!==(e=t[ot])&&void 0!==e?e:[]},discardUnknownFields(t){delete t[ot]},writeUnknownFields(t,e){const i=t[ot];if(i)for(const t of i)e.tag(t.no,t.wireType).raw(t.data)},onUnknownField(t,e,i,n){const r=t;Array.isArray(r[ot])||(r[ot]=[]),r[ot].push({no:e,wireType:i,data:n})},readMessage(t,e,i,n){const r=t.getType(),s=void 0===i?e.len:e.pos+i;for(;e.pos<s;){const[i,s]=e.tag(),a=r.fields.find(i);if(!a){const r=e.skip(s);n.readUnknownFields&&this.onUnknownField(t,i,s,r);continue}let o=t,c=a.repeated,d=a.localName;switch(a.oneof&&(o=o[a.oneof.localName],o.case!=d&&delete o.value,o.case=d,d="value"),a.kind){case"scalar":case"enum":const t="enum"==a.kind?V.INT32:a.T;let i=pt;if("scalar"==a.kind&&a.L>0&&(i=ut),c){let n=o[d];if(s==tt.LengthDelimited&&t!=V.STRING&&t!=V.BYTES){let r=e.uint32()+e.pos;for(;e.pos<r;)n.push(i(e,t))}else n.push(i(e,t))}else o[d]=i(e,t);break;case"message":const r=a.T;c?o[d].push(ht(e,new r,n)):o[d]instanceof G?ht(e,o[d],n):(o[d]=ht(e,new r,n),!r.fieldWrapper||a.oneof||a.repeated||(o[d]=r.fieldWrapper.unwrapField(o[d])));break;case"map":let[h,l]=lt(a,e,n);o[d][h]=l}}}}),{writeMessage(t,e,i){const n=t.getType();for(const r of n.fields.byNumber()){let n,s=r.repeated,a=r.localName;if(r.oneof){const e=t[r.oneof.localName];if(e.case!==a)continue;n=e.value}else n=t[a];switch(r.kind){case"scalar":case"enum":let t="enum"==r.kind?V.INT32:r.T;if(s)if(r.packed)vt(e,t,r.no,n);else for(const i of n)gt(e,t,r.no,i,!0);else void 0!==n&&gt(e,t,r.no,n,!!r.oneof||r.opt);break;case"message":if(s)for(const t of n)ft(e,i,r.T,r.no,t);else ft(e,i,r.T,r.no,n);break;case"map":for(const[t,s]of Object.entries(n))mt(e,i,r,t,s)}}return i.writeUnknownFields&&this.writeUnknownFields(t,e),e}}),{syntax:"proto3",json:Jt,bin:qt,util:Object.assign(Object.assign({},{setEnumType:U,initPartial(t,e){if(void 0===t)return;const i=e.getType();for(const n of i.fields.byMember()){const i=n.localName,r=e,s=t;if(void 0!==s[i])switch(n.kind){case"oneof":const t=s[i].case;if(void 0===t)continue;const e=n.findField(t);let a=s[i].value;!e||"message"!=e.kind||a instanceof e.T?e&&"scalar"===e.kind&&e.T===V.BYTES&&(a=Dt(a)):a=new e.T(a),r[i]={case:t,value:a};break;case"scalar":case"enum":let o=s[i];n.T===V.BYTES&&(o=n.repeated?o.map(Dt):Dt(o)),r[i]=o;break;case"map":switch(n.V.kind){case"scalar":case"enum":if(n.V.T===V.BYTES)for(const[t,e]of Object.entries(s[i]))r[i][t]=Dt(e);else Object.assign(r[i],s[i]);break;case"message":const t=n.V.T;for(const e of Object.keys(s[i])){let n=s[i][e];t.fieldWrapper||(n=new t(n)),r[i][e]=n}}break;case"message":const c=n.T;if(n.repeated)r[i]=s[i].map((t=>t instanceof c?t:new c(t)));else if(void 0!==s[i]){const t=s[i];c.fieldWrapper?"google.protobuf.BytesValue"===c.typeName?r[i]=Dt(t):r[i]=t:r[i]=t instanceof c?t:new c(t)}}}},equals:(t,e,i)=>e===i||!(!e||!i)&&t.fields.byMember().every((t=>{const n=e[t.localName],r=i[t.localName];if(t.repeated){if(n.length!==r.length)return!1;switch(t.kind){case"message":return n.every(((e,i)=>t.T.equals(e,r[i])));case"scalar":return n.every(((e,i)=>rt(t.T,e,r[i])));case"enum":return n.every(((t,e)=>rt(V.INT32,t,r[e])))}throw new Error("repeated cannot contain ".concat(t.kind))}switch(t.kind){case"message":return t.T.equals(n,r);case"enum":return rt(V.INT32,n,r);case"scalar":return rt(t.T,n,r);case"oneof":if(n.case!==r.case)return!1;const e=t.findField(n.case);if(void 0===e)return!0;switch(e.kind){case"message":return e.T.equals(n.value,r.value);case"enum":return rt(V.INT32,n.value,r.value);case"scalar":return rt(e.T,n.value,r.value)}throw new Error("oneof cannot contain ".concat(e.kind));case"map":const i=Object.keys(n).concat(Object.keys(r));switch(t.V.kind){case"message":const e=t.V.T;return i.every((t=>e.equals(n[t],r[t])));case"enum":return i.every((t=>rt(V.INT32,n[t],r[t])));case"scalar":const s=t.V.T;return i.every((t=>rt(s,n[t],r[t])))}}})),clone(t){const e=t.getType(),i=new e,n=i;for(const i of e.fields.byMember()){const e=t[i.localName];let r;if(i.repeated)r=e.map(It);else if("map"==i.kind){r=n[i.localName];for(const[t,i]of Object.entries(e))r[t]=It(i)}else r="oneof"==i.kind?i.findField(e.case)?{case:e.case,value:It(e.value)}:{case:void 0}:It(e);n[i.localName]=r}return i}}),{newFieldList:t=>new Mt(t,ie),initFields(t){for(const e of t.getType().fields.byMember()){if(e.opt)continue;const i=e.localName,n=t;if(e.repeated)n[i]=[];else switch(e.kind){case"oneof":n[i]={case:void 0};break;case"enum":n[i]=0;break;case"map":n[i]={};break;case"scalar":n[i]=st(e.T,e.L)}}}}),makeMessageType(t,e,i){return function(t,e,i,n){var r;const s=null!==(r=null==n?void 0:n.localName)&&void 0!==r?r:e.substring(e.lastIndexOf(".")+1),a={[s]:function(e){t.util.initFields(this),t.util.initPartial(e,this)}}[s];return Object.setPrototypeOf(a.prototype,new G),Object.assign(a,{runtime:t,typeName:e,fields:t.util.newFieldList(i),fromBinary:(t,e)=>(new a).fromBinary(t,e),fromJson:(t,e)=>(new a).fromJson(t,e),fromJsonString:(t,e)=>(new a).fromJsonString(t,e),equals:(e,i)=>t.util.equals(a,e,i)}),a}(this,t,e,i)},makeEnum:function(t,e,i){const n={};for(const t of e){const e=B(t);n[e.localName]=e.no,n[e.no]=e.localName}return U(n,t,e),n},makeEnumType:F,getEnumType:function(t){const e=t[O];return E(e,"missing enum type on enum object"),e}});var Jt,qt,Wt,Ht,zt,Kt,Yt,Xt,Qt,Zt,$t,te,ee;function ie(t){var e,i,n,r;const s=[];let a;for(const o of"function"==typeof t?t():t){const t=o;if(t.localName=At(o.name,void 0!==o.oneof),t.jsonName=null!==(e=o.jsonName)&&void 0!==e?e:Nt(o.name),t.repeated=null!==(i=o.repeated)&&void 0!==i&&i,"scalar"==o.kind&&(t.L=null!==(n=o.L)&&void 0!==n?n:j.BIGINT),t.packed=null!==(r=o.packed)&&void 0!==r?r:"enum"==o.kind||"scalar"==o.kind&&o.T!=V.BYTES&&o.T!=V.STRING,void 0!==o.oneof){const e="string"==typeof o.oneof?o.oneof:o.oneof.name;a&&a.name==e||(a=new Vt(e)),t.oneof=a,a.addField(t)}s.push(t)}return s}class ne extends G{constructor(t){super(),this.seconds=$.zero,this.nanos=0,jt.util.initPartial(t,this)}fromJson(t,e){if("string"!=typeof t)throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(jt.json.debug(t)));const i=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const n=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(n))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(n<Date.parse("0001-01-01T00:00:00Z")||n>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=$.parse(n/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(t){const e=1e3*Number(this.seconds);if(e<Date.parse("0001-01-01T00:00:00Z")||e>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const t=(this.nanos+1e9).toString().substring(1);i="000000"===t.substring(3)?"."+t.substring(0,3)+"Z":"000"===t.substring(6)?"."+t.substring(0,6)+"Z":"."+t+"Z"}return new Date(e).toISOString().replace(".000Z",i)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return ne.fromDate(new Date)}static fromDate(t){const e=t.getTime();return new ne({seconds:$.parse(Math.floor(e/1e3)),nanos:e%1e3*1e6})}static fromBinary(t,e){return(new ne).fromBinary(t,e)}static fromJson(t,e){return(new ne).fromJson(t,e)}static fromJsonString(t,e){return(new ne).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ne,t,e)}}ne.runtime=jt,ne.typeName="google.protobuf.Timestamp",ne.fields=jt.util.newFieldList((()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}])),function(t){t[t.DEFAULT_AC=0]="DEFAULT_AC",t[t.OPUS=1]="OPUS",t[t.AAC=2]="AAC"}(Wt||(Wt={})),jt.util.setEnumType(Wt,"livekit.AudioCodec",[{no:0,name:"DEFAULT_AC"},{no:1,name:"OPUS"},{no:2,name:"AAC"}]),function(t){t[t.DEFAULT_VC=0]="DEFAULT_VC",t[t.H264_BASELINE=1]="H264_BASELINE",t[t.H264_MAIN=2]="H264_MAIN",t[t.H264_HIGH=3]="H264_HIGH",t[t.VP8=4]="VP8"}(Ht||(Ht={})),jt.util.setEnumType(Ht,"livekit.VideoCodec",[{no:0,name:"DEFAULT_VC"},{no:1,name:"H264_BASELINE"},{no:2,name:"H264_MAIN"},{no:3,name:"H264_HIGH"},{no:4,name:"VP8"}]),function(t){t[t.IC_DEFAULT=0]="IC_DEFAULT",t[t.IC_JPEG=1]="IC_JPEG"}(zt||(zt={})),jt.util.setEnumType(zt,"livekit.ImageCodec",[{no:0,name:"IC_DEFAULT"},{no:1,name:"IC_JPEG"}]),function(t){t[t.AUDIO=0]="AUDIO",t[t.VIDEO=1]="VIDEO",t[t.DATA=2]="DATA"}(Kt||(Kt={})),jt.util.setEnumType(Kt,"livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.CAMERA=1]="CAMERA",t[t.MICROPHONE=2]="MICROPHONE",t[t.SCREEN_SHARE=3]="SCREEN_SHARE",t[t.SCREEN_SHARE_AUDIO=4]="SCREEN_SHARE_AUDIO"}(Yt||(Yt={})),jt.util.setEnumType(Yt,"livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),function(t){t[t.LOW=0]="LOW",t[t.MEDIUM=1]="MEDIUM",t[t.HIGH=2]="HIGH",t[t.OFF=3]="OFF"}(Xt||(Xt={})),jt.util.setEnumType(Xt,"livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),function(t){t[t.POOR=0]="POOR",t[t.GOOD=1]="GOOD",t[t.EXCELLENT=2]="EXCELLENT",t[t.LOST=3]="LOST"}(Qt||(Qt={})),jt.util.setEnumType(Qt,"livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),function(t){t[t.UNSET=0]="UNSET",t[t.DISABLED=1]="DISABLED",t[t.ENABLED=2]="ENABLED"}(Zt||(Zt={})),jt.util.setEnumType(Zt,"livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),function(t){t[t.UNKNOWN_REASON=0]="UNKNOWN_REASON",t[t.CLIENT_INITIATED=1]="CLIENT_INITIATED",t[t.DUPLICATE_IDENTITY=2]="DUPLICATE_IDENTITY",t[t.SERVER_SHUTDOWN=3]="SERVER_SHUTDOWN",t[t.PARTICIPANT_REMOVED=4]="PARTICIPANT_REMOVED",t[t.ROOM_DELETED=5]="ROOM_DELETED",t[t.STATE_MISMATCH=6]="STATE_MISMATCH",t[t.JOIN_FAILURE=7]="JOIN_FAILURE"}($t||($t={})),jt.util.setEnumType($t,"livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"}]),function(t){t[t.RR_UNKNOWN=0]="RR_UNKNOWN",t[t.RR_SIGNAL_DISCONNECTED=1]="RR_SIGNAL_DISCONNECTED",t[t.RR_PUBLISHER_FAILED=2]="RR_PUBLISHER_FAILED",t[t.RR_SUBSCRIBER_FAILED=3]="RR_SUBSCRIBER_FAILED",t[t.RR_SWITCH_CANDIDATE=4]="RR_SWITCH_CANDIDATE"}(te||(te={})),jt.util.setEnumType(te,"livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),function(t){t[t.SE_UNKNOWN=0]="SE_UNKNOWN",t[t.SE_CODEC_UNSUPPORTED=1]="SE_CODEC_UNSUPPORTED",t[t.SE_TRACK_NOTFOUND=2]="SE_TRACK_NOTFOUND"}(ee||(ee={})),jt.util.setEnumType(ee,"livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]);let re=class t extends G{constructor(t){super(),this.sid="",this.name="",this.emptyTimeout=0,this.maxParticipants=0,this.creationTime=$.zero,this.turnPassword="",this.enabledCodecs=[],this.metadata="",this.numParticipants=0,this.numPublishers=0,this.activeRecording=!1,jt.util.initPartial(t,this)}static fromBinary(e,i){return(new t).fromBinary(e,i)}static fromJson(e,i){return(new t).fromJson(e,i)}static fromJsonString(e,i){return(new t).fromJsonString(e,i)}static equals(e,i){return jt.util.equals(t,e,i)}};re.runtime=jt,re.typeName="livekit.Room",re.fields=jt.util.newFieldList((()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:se,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8}]));class se extends G{constructor(t){super(),this.mime="",this.fmtpLine="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new se).fromBinary(t,e)}static fromJson(t,e){return(new se).fromJson(t,e)}static fromJsonString(t,e){return(new se).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(se,t,e)}}se.runtime=jt,se.typeName="livekit.Codec",se.fields=jt.util.newFieldList((()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]));class ae extends G{constructor(t){super(),this.enabled=!1,this.min=0,this.max=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ae).fromBinary(t,e)}static fromJson(t,e){return(new ae).fromJson(t,e)}static fromJsonString(t,e){return(new ae).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ae,t,e)}}ae.runtime=jt,ae.typeName="livekit.PlayoutDelay",ae.fields=jt.util.newFieldList((()=>[{no:1,name:"enabled",kind:"scalar",T:8},{no:2,name:"min",kind:"scalar",T:13},{no:3,name:"max",kind:"scalar",T:13}]));class oe extends G{constructor(t){super(),this.canSubscribe=!1,this.canPublish=!1,this.canPublishData=!1,this.canPublishSources=[],this.hidden=!1,this.recorder=!1,this.canUpdateMetadata=!1,this.agent=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new oe).fromBinary(t,e)}static fromJson(t,e){return(new oe).fromJson(t,e)}static fromJsonString(t,e){return(new oe).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(oe,t,e)}}oe.runtime=jt,oe.typeName="livekit.ParticipantPermission",oe.fields=jt.util.newFieldList((()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:jt.getEnumType(Yt),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8}]));class ce extends G{constructor(t){super(),this.sid="",this.identity="",this.state=de.JOINING,this.tracks=[],this.metadata="",this.joinedAt=$.zero,this.name="",this.version=0,this.region="",this.isPublisher=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ce).fromBinary(t,e)}static fromJson(t,e){return(new ce).fromJson(t,e)}static fromJsonString(t,e){return(new ce).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ce,t,e)}}var de,he,le,ue,pe;ce.runtime=jt,ce.typeName="livekit.ParticipantInfo",ce.fields=jt.util.newFieldList((()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:jt.getEnumType(de)},{no:4,name:"tracks",kind:"message",T:ge,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:oe},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8}])),function(t){t[t.JOINING=0]="JOINING",t[t.JOINED=1]="JOINED",t[t.ACTIVE=2]="ACTIVE",t[t.DISCONNECTED=3]="DISCONNECTED"}(de||(de={})),jt.util.setEnumType(de,"livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]);class me extends G{constructor(t){super(),jt.util.initPartial(t,this)}static fromBinary(t,e){return(new me).fromBinary(t,e)}static fromJson(t,e){return(new me).fromJson(t,e)}static fromJsonString(t,e){return(new me).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(me,t,e)}}me.runtime=jt,me.typeName="livekit.Encryption",me.fields=jt.util.newFieldList((()=>[])),function(t){t[t.NONE=0]="NONE",t[t.GCM=1]="GCM",t[t.CUSTOM=2]="CUSTOM"}(he||(he={})),jt.util.setEnumType(he,"livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]);class fe extends G{constructor(t){super(),this.mimeType="",this.mid="",this.cid="",this.layers=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new fe).fromBinary(t,e)}static fromJson(t,e){return(new fe).fromJson(t,e)}static fromJsonString(t,e){return(new fe).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(fe,t,e)}}fe.runtime=jt,fe.typeName="livekit.SimulcastCodecInfo",fe.fields=jt.util.newFieldList((()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:ve,repeated:!0}]));class ge extends G{constructor(t){super(),this.sid="",this.type=Kt.AUDIO,this.name="",this.muted=!1,this.width=0,this.height=0,this.simulcast=!1,this.disableDtx=!1,this.source=Yt.UNKNOWN,this.layers=[],this.mimeType="",this.mid="",this.codecs=[],this.stereo=!1,this.disableRed=!1,this.encryption=he.NONE,this.stream="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ge).fromBinary(t,e)}static fromJson(t,e){return(new ge).fromJson(t,e)}static fromJsonString(t,e){return(new ge).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ge,t,e)}}ge.runtime=jt,ge.typeName="livekit.TrackInfo",ge.fields=jt.util.newFieldList((()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:jt.getEnumType(Kt)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:jt.getEnumType(Yt)},{no:10,name:"layers",kind:"message",T:ve,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:fe,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:jt.getEnumType(he)},{no:17,name:"stream",kind:"scalar",T:9}]));class ve extends G{constructor(t){super(),this.quality=Xt.LOW,this.width=0,this.height=0,this.bitrate=0,this.ssrc=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ve).fromBinary(t,e)}static fromJson(t,e){return(new ve).fromJson(t,e)}static fromJsonString(t,e){return(new ve).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ve,t,e)}}ve.runtime=jt,ve.typeName="livekit.VideoLayer",ve.fields=jt.util.newFieldList((()=>[{no:1,name:"quality",kind:"enum",T:jt.getEnumType(Xt)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]));class ye extends G{constructor(t){super(),this.kind=le.RELIABLE,this.value={case:void 0},jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ye).fromBinary(t,e)}static fromJson(t,e){return(new ye).fromJson(t,e)}static fromJsonString(t,e){return(new ye).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ye,t,e)}}ye.runtime=jt,ye.typeName="livekit.DataPacket",ye.fields=jt.util.newFieldList((()=>[{no:1,name:"kind",kind:"enum",T:jt.getEnumType(le)},{no:2,name:"user",kind:"message",T:Se,oneof:"value"},{no:3,name:"speaker",kind:"message",T:be,oneof:"value"}])),function(t){t[t.RELIABLE=0]="RELIABLE",t[t.LOSSY=1]="LOSSY"}(le||(le={})),jt.util.setEnumType(le,"livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]);class be extends G{constructor(t){super(),this.speakers=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new be).fromBinary(t,e)}static fromJson(t,e){return(new be).fromJson(t,e)}static fromJsonString(t,e){return(new be).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(be,t,e)}}be.runtime=jt,be.typeName="livekit.ActiveSpeakerUpdate",be.fields=jt.util.newFieldList((()=>[{no:1,name:"speakers",kind:"message",T:ke,repeated:!0}]));class ke extends G{constructor(t){super(),this.sid="",this.level=0,this.active=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ke).fromBinary(t,e)}static fromJson(t,e){return(new ke).fromJson(t,e)}static fromJsonString(t,e){return(new ke).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ke,t,e)}}ke.runtime=jt,ke.typeName="livekit.SpeakerInfo",ke.fields=jt.util.newFieldList((()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]));class Se extends G{constructor(t){super(),this.participantSid="",this.participantIdentity="",this.payload=new Uint8Array(0),this.destinationSids=[],this.destinationIdentities=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Se).fromBinary(t,e)}static fromJson(t,e){return(new Se).fromJson(t,e)}static fromJsonString(t,e){return(new Se).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Se,t,e)}}Se.runtime=jt,Se.typeName="livekit.UserPacket",Se.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0}]));class Te extends G{constructor(t){super(),this.participantSid="",this.trackSids=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Te).fromBinary(t,e)}static fromJson(t,e){return(new Te).fromJson(t,e)}static fromJsonString(t,e){return(new Te).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Te,t,e)}}Te.runtime=jt,Te.typeName="livekit.ParticipantTracks",Te.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]));class we extends G{constructor(t){super(),this.edition=ue.Standard,this.version="",this.protocol=0,this.region="",this.nodeId="",this.debugInfo="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new we).fromBinary(t,e)}static fromJson(t,e){return(new we).fromJson(t,e)}static fromJsonString(t,e){return(new we).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(we,t,e)}}we.runtime=jt,we.typeName="livekit.ServerInfo",we.fields=jt.util.newFieldList((()=>[{no:1,name:"edition",kind:"enum",T:jt.getEnumType(ue)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9}])),function(t){t[t.Standard=0]="Standard",t[t.Cloud=1]="Cloud"}(ue||(ue={})),jt.util.setEnumType(ue,"livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]);class Ce extends G{constructor(t){super(),this.sdk=pe.UNKNOWN,this.version="",this.protocol=0,this.os="",this.osVersion="",this.deviceModel="",this.browser="",this.browserVersion="",this.address="",this.network="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Ce).fromBinary(t,e)}static fromJson(t,e){return(new Ce).fromJson(t,e)}static fromJsonString(t,e){return(new Ce).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Ce,t,e)}}Ce.runtime=jt,Ce.typeName="livekit.ClientInfo",Ce.fields=jt.util.newFieldList((()=>[{no:1,name:"sdk",kind:"enum",T:jt.getEnumType(pe)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9}])),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.JS=1]="JS",t[t.SWIFT=2]="SWIFT",t[t.ANDROID=3]="ANDROID",t[t.FLUTTER=4]="FLUTTER",t[t.GO=5]="GO",t[t.UNITY=6]="UNITY",t[t.REACT_NATIVE=7]="REACT_NATIVE",t[t.RUST=8]="RUST",t[t.PYTHON=9]="PYTHON",t[t.CPP=10]="CPP"}(pe||(pe={})),jt.util.setEnumType(pe,"livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"}]);class _e extends G{constructor(t){super(),this.resumeConnection=Zt.UNSET,this.forceRelay=Zt.UNSET,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new _e).fromBinary(t,e)}static fromJson(t,e){return(new _e).fromJson(t,e)}static fromJsonString(t,e){return(new _e).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(_e,t,e)}}_e.runtime=jt,_e.typeName="livekit.ClientConfiguration",_e.fields=jt.util.newFieldList((()=>[{no:1,name:"video",kind:"message",T:Pe},{no:2,name:"screen",kind:"message",T:Pe},{no:3,name:"resume_connection",kind:"enum",T:jt.getEnumType(Zt)},{no:4,name:"disabled_codecs",kind:"message",T:Ee},{no:5,name:"force_relay",kind:"enum",T:jt.getEnumType(Zt)}]));class Pe extends G{constructor(t){super(),this.hardwareEncoder=Zt.UNSET,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Pe).fromBinary(t,e)}static fromJson(t,e){return(new Pe).fromJson(t,e)}static fromJsonString(t,e){return(new Pe).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Pe,t,e)}}Pe.runtime=jt,Pe.typeName="livekit.VideoConfiguration",Pe.fields=jt.util.newFieldList((()=>[{no:1,name:"hardware_encoder",kind:"enum",T:jt.getEnumType(Zt)}]));class Ee extends G{constructor(t){super(),this.codecs=[],this.publish=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Ee).fromBinary(t,e)}static fromJson(t,e){return(new Ee).fromJson(t,e)}static fromJsonString(t,e){return(new Ee).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Ee,t,e)}}Ee.runtime=jt,Ee.typeName="livekit.DisabledCodecs",Ee.fields=jt.util.newFieldList((()=>[{no:1,name:"codecs",kind:"message",T:se,repeated:!0},{no:2,name:"publish",kind:"message",T:se,repeated:!0}]));class xe extends G{constructor(t){super(),this.duration=0,this.startTimestamp=$.zero,this.endTimestamp=$.zero,this.rtpClockTicks=$.zero,this.driftSamples=$.zero,this.driftMs=0,this.clockRate=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new xe).fromBinary(t,e)}static fromJson(t,e){return(new xe).fromJson(t,e)}static fromJsonString(t,e){return(new xe).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(xe,t,e)}}xe.runtime=jt,xe.typeName="livekit.RTPDrift",xe.fields=jt.util.newFieldList((()=>[{no:1,name:"start_time",kind:"message",T:ne},{no:2,name:"end_time",kind:"message",T:ne},{no:3,name:"duration",kind:"scalar",T:1},{no:4,name:"start_timestamp",kind:"scalar",T:4},{no:5,name:"end_timestamp",kind:"scalar",T:4},{no:6,name:"rtp_clock_ticks",kind:"scalar",T:4},{no:7,name:"drift_samples",kind:"scalar",T:3},{no:8,name:"drift_ms",kind:"scalar",T:1},{no:9,name:"clock_rate",kind:"scalar",T:1}]));class Re extends G{constructor(t){super(),this.duration=0,this.packets=0,this.packetRate=0,this.bytes=$.zero,this.headerBytes=$.zero,this.bitrate=0,this.packetsLost=0,this.packetLossRate=0,this.packetLossPercentage=0,this.packetsDuplicate=0,this.packetDuplicateRate=0,this.bytesDuplicate=$.zero,this.headerBytesDuplicate=$.zero,this.bitrateDuplicate=0,this.packetsPadding=0,this.packetPaddingRate=0,this.bytesPadding=$.zero,this.headerBytesPadding=$.zero,this.bitratePadding=0,this.packetsOutOfOrder=0,this.frames=0,this.frameRate=0,this.jitterCurrent=0,this.jitterMax=0,this.gapHistogram={},this.nacks=0,this.nackAcks=0,this.nackMisses=0,this.nackRepeated=0,this.plis=0,this.firs=0,this.rttCurrent=0,this.rttMax=0,this.keyFrames=0,this.layerLockPlis=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Re).fromBinary(t,e)}static fromJson(t,e){return(new Re).fromJson(t,e)}static fromJsonString(t,e){return(new Re).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Re,t,e)}}Re.runtime=jt,Re.typeName="livekit.RTPStats",Re.fields=jt.util.newFieldList((()=>[{no:1,name:"start_time",kind:"message",T:ne},{no:2,name:"end_time",kind:"message",T:ne},{no:3,name:"duration",kind:"scalar",T:1},{no:4,name:"packets",kind:"scalar",T:13},{no:5,name:"packet_rate",kind:"scalar",T:1},{no:6,name:"bytes",kind:"scalar",T:4},{no:39,name:"header_bytes",kind:"scalar",T:4},{no:7,name:"bitrate",kind:"scalar",T:1},{no:8,name:"packets_lost",kind:"scalar",T:13},{no:9,name:"packet_loss_rate",kind:"scalar",T:1},{no:10,name:"packet_loss_percentage",kind:"scalar",T:2},{no:11,name:"packets_duplicate",kind:"scalar",T:13},{no:12,name:"packet_duplicate_rate",kind:"scalar",T:1},{no:13,name:"bytes_duplicate",kind:"scalar",T:4},{no:40,name:"header_bytes_duplicate",kind:"scalar",T:4},{no:14,name:"bitrate_duplicate",kind:"scalar",T:1},{no:15,name:"packets_padding",kind:"scalar",T:13},{no:16,name:"packet_padding_rate",kind:"scalar",T:1},{no:17,name:"bytes_padding",kind:"scalar",T:4},{no:41,name:"header_bytes_padding",kind:"scalar",T:4},{no:18,name:"bitrate_padding",kind:"scalar",T:1},{no:19,name:"packets_out_of_order",kind:"scalar",T:13},{no:20,name:"frames",kind:"scalar",T:13},{no:21,name:"frame_rate",kind:"scalar",T:1},{no:22,name:"jitter_current",kind:"scalar",T:1},{no:23,name:"jitter_max",kind:"scalar",T:1},{no:24,name:"gap_histogram",kind:"map",K:5,V:{kind:"scalar",T:13}},{no:25,name:"nacks",kind:"scalar",T:13},{no:37,name:"nack_acks",kind:"scalar",T:13},{no:26,name:"nack_misses",kind:"scalar",T:13},{no:38,name:"nack_repeated",kind:"scalar",T:13},{no:27,name:"plis",kind:"scalar",T:13},{no:28,name:"last_pli",kind:"message",T:ne},{no:29,name:"firs",kind:"scalar",T:13},{no:30,name:"last_fir",kind:"message",T:ne},{no:31,name:"rtt_current",kind:"scalar",T:13},{no:32,name:"rtt_max",kind:"scalar",T:13},{no:33,name:"key_frames",kind:"scalar",T:13},{no:34,name:"last_key_frame",kind:"message",T:ne},{no:35,name:"layer_lock_plis",kind:"scalar",T:13},{no:36,name:"last_layer_lock_pli",kind:"message",T:ne},{no:44,name:"packet_drift",kind:"message",T:xe},{no:45,name:"report_drift",kind:"message",T:xe}]));class Ie extends G{constructor(t){super(),this.unixMicro=$.zero,this.ticks=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Ie).fromBinary(t,e)}static fromJson(t,e){return(new Ie).fromJson(t,e)}static fromJsonString(t,e){return(new Ie).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Ie,t,e)}}Ie.runtime=jt,Ie.typeName="livekit.TimedVersion",Ie.fields=jt.util.newFieldList((()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]));const De=7e3,Me=[0,300,1200,2700,4800,De,De,De,De,De];function Ae(t,e,i,n){return new(i||(i=Promise))((function(r,s){function a(t){try{c(n.next(t))}catch(t){s(t)}}function o(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}c((n=n.apply(t,e||[])).next())}))}function Ne(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t=function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(t),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(i){e[i]=t[i]&&function(e){return new Promise((function(n,r){!function(t,e,i,n){Promise.resolve(n).then((function(e){t({value:e,done:i})}),e)}(n,r,(e=t[i](e)).done,e.value)}))}}}"function"==typeof SuppressedError&&SuppressedError;var Le,Oe={exports:{}},Ue="object"==typeof Reflect?Reflect:null,Fe=Ue&&"function"==typeof Ue.apply?Ue.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};Le=Ue&&"function"==typeof Ue.ownKeys?Ue.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var Be=Number.isNaN||function(t){return t!=t};function Ge(){Ge.init.call(this)}Oe.exports=Ge,Oe.exports.once=function(t,e){return new Promise((function(i,n){function r(i){t.removeListener(e,s),n(i)}function s(){"function"==typeof t.removeListener&&t.removeListener("error",r),i([].slice.call(arguments))}Xe(t,e,s,{once:!0}),"error"!==e&&function(t,e,i){"function"==typeof t.on&&Xe(t,"error",e,{once:!0})}(t,r)}))},Ge.EventEmitter=Ge,Ge.prototype._events=void 0,Ge.prototype._eventsCount=0,Ge.prototype._maxListeners=void 0;var Ve=10;function je(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function Je(t){return void 0===t._maxListeners?Ge.defaultMaxListeners:t._maxListeners}function qe(t,e,i,n){var r,s,a,o;if(je(i),void 0===(s=t._events)?(s=t._events=Object.create(null),t._eventsCount=0):(void 0!==s.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),s=t._events),a=s[e]),void 0===a)a=s[e]=i,++t._eventsCount;else if("function"==typeof a?a=s[e]=n?[i,a]:[a,i]:n?a.unshift(i):a.push(i),(r=Je(t))>0&&a.length>r&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=e,c.count=a.length,o=c,console&&console.warn&&console.warn(o)}return t}function We(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function He(t,e,i){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},r=We.bind(n);return r.listener=i,n.wrapFn=r,r}function ze(t,e,i){var n=t._events;if(void 0===n)return[];var r=n[e];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(r):Ye(r,r.length)}function Ke(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function Ye(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t[n];return i}function Xe(t,e,i,n){if("function"==typeof t.on)n.once?t.once(e,i):t.on(e,i);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function r(s){n.once&&t.removeEventListener(e,r),i(s)}))}}Object.defineProperty(Ge,"defaultMaxListeners",{enumerable:!0,get:function(){return Ve},set:function(t){if("number"!=typeof t||t<0||Be(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");Ve=t}}),Ge.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Ge.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||Be(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},Ge.prototype.getMaxListeners=function(){return Je(this)},Ge.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var n="error"===t,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var s;if(e.length>0&&(s=e[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var o=r[t];if(void 0===o)return!1;if("function"==typeof o)Fe(o,this,e);else{var c=o.length,d=Ye(o,c);for(i=0;i<c;++i)Fe(d[i],this,e)}return!0},Ge.prototype.addListener=function(t,e){return qe(this,t,e,!1)},Ge.prototype.on=Ge.prototype.addListener,Ge.prototype.prependListener=function(t,e){return qe(this,t,e,!0)},Ge.prototype.once=function(t,e){return je(e),this.on(t,He(this,t,e)),this},Ge.prototype.prependOnceListener=function(t,e){return je(e),this.prependListener(t,He(this,t,e)),this},Ge.prototype.removeListener=function(t,e){var i,n,r,s,a;if(je(e),void 0===(n=this._events))return this;if(void 0===(i=n[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(r=-1,s=i.length-1;s>=0;s--)if(i[s]===e||i[s].listener===e){a=i[s].listener,r=s;break}if(r<0)return this;0===r?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,r),1===i.length&&(n[t]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",t,a||e)}return this},Ge.prototype.off=Ge.prototype.removeListener,Ge.prototype.removeAllListeners=function(t){var e,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var r,s=Object.keys(i);for(n=0;n<s.length;++n)"removeListener"!==(r=s[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},Ge.prototype.listeners=function(t){return ze(this,t,!0)},Ge.prototype.rawListeners=function(t){return ze(this,t,!1)},Ge.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):Ke.call(t,e)},Ge.prototype.listenerCount=Ke,Ge.prototype.eventNames=function(){return this._eventsCount>0?Le(this._events):[]};var Qe=Oe.exports;let Ze=!0,$e=!0;function ti(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function ei(t,e,i){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(t,n){if(t!==e)return r.apply(this,arguments);const s=t=>{const e=i(t);e&&(n.handleEvent?n.handleEvent(e):n(e))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(n,s),r.apply(this,[t,s])};const s=n.removeEventListener;n.removeEventListener=function(t,i){if(t!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(i))return s.apply(this,arguments);const n=this._eventMap[e].get(i);return this._eventMap[e].delete(i),0===this._eventMap[e].size&&delete this._eventMap[e],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[t,n])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(t){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),t&&this.addEventListener(e,this["_on"+e]=t)},enumerable:!0,configurable:!0})}function ii(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Ze=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function ni(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):($e=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function ri(){if("object"==typeof window){if(Ze)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function si(t,e){$e&&console.warn(t+" is deprecated, please use "+e+" instead.")}function ai(t){return"[object Object]"===Object.prototype.toString.call(t)}function oi(t){return ai(t)?Object.keys(t).reduce((function(e,i){const n=ai(t[i]),r=n?oi(t[i]):t[i],s=n&&!Object.keys(r).length;return void 0===r||s?e:Object.assign(e,{[i]:r})}),{}):t}function ci(t,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach((n=>{n.endsWith("Id")?ci(t,t.get(e[n]),i):n.endsWith("Ids")&&e[n].forEach((e=>{ci(t,t.get(e),i)}))})))}function di(t,e,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===e)return r;const s=[];return t.forEach((t=>{"track"===t.type&&t.trackIdentifier===e.id&&s.push(t)})),s.forEach((e=>{t.forEach((i=>{i.type===n&&i.trackId===e.id&&ci(t,i,r)}))})),r}const hi=ri;function li(t,e){const i=t&&t.navigator;if(!i.mediaDevices)return;const n=function(t){if("object"!=typeof t||t.mandatory||t.optional)return t;const e={};return Object.keys(t).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof t[i]?t[i]:{ideal:t[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const r=function(t,e){return t?t+e.charAt(0).toUpperCase()+e.slice(1):"deviceId"===e?"sourceId":e};if(void 0!==n.ideal){e.optional=e.optional||[];let t={};"number"==typeof n.ideal?(t[r("min",i)]=n.ideal,e.optional.push(t),t={},t[r("max",i)]=n.ideal,e.optional.push(t)):(t[r("",i)]=n.ideal,e.optional.push(t))}void 0!==n.exact&&"number"!=typeof n.exact?(e.mandatory=e.mandatory||{},e.mandatory[r("",i)]=n.exact):["min","max"].forEach((t=>{void 0!==n[t]&&(e.mandatory=e.mandatory||{},e.mandatory[r(t,i)]=n[t])}))})),t.advanced&&(e.optional=(e.optional||[]).concat(t.advanced)),e},r=function(t,r){if(e.version>=61)return r(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"==typeof t.audio){const e=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])};e((t=JSON.parse(JSON.stringify(t))).audio,"autoGainControl","googAutoGainControl"),e(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=n(t.audio)}if(t&&"object"==typeof t.video){let s=t.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const a=e.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||a)){let e;if(delete t.video.facingMode,"environment"===s.exact||"environment"===s.ideal?e=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(e=["front"]),e)return i.mediaDevices.enumerateDevices().then((i=>{let a=(i=i.filter((t=>"videoinput"===t.kind))).find((t=>e.some((e=>t.label.toLowerCase().includes(e)))));return!a&&i.length&&e.includes("back")&&(a=i[i.length-1]),a&&(t.video.deviceId=s.exact?{exact:a.deviceId}:{ideal:a.deviceId}),t.video=n(t.video),hi("chrome: "+JSON.stringify(t)),r(t)}))}t.video=n(t.video)}return hi("chrome: "+JSON.stringify(t)),r(t)},s=function(t){return e.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(t,e,n){r(t,(t=>{i.webkitGetUserMedia(t,e,(t=>{n&&n(s(t))}))}))}.bind(i),i.mediaDevices.getUserMedia){const t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return r(e,(e=>t(e).then((t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((t=>{t.stop()})),new DOMException("","NotFoundError");return t}),(t=>Promise.reject(s(t))))))}}}function ui(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function pi(t){if("object"==typeof t&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",(i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.track.id)):{track:i.track};const r=new Event("track");r.track=i.track,r.receiver=n,r.transceiver={receiver:n},r.streams=[e.stream],this.dispatchEvent(r)})),e.stream.getTracks().forEach((i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.id)):{track:i};const r=new Event("track");r.track=i,r.receiver=n,r.transceiver={receiver:n},r.streams=[e.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else ei(t,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function mi(t){if("object"==typeof t&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(t,e){return{track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=t.createDTMFSender(e):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,n){let r=i.apply(this,arguments);return r||(r=e(this,t),this._senders.push(r)),r};const n=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){n.apply(this,arguments);const e=this._senders.indexOf(t);-1!==e&&this._senders.splice(e,1)}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._senders=this._senders||[],i.apply(this,[t]),t.getTracks().forEach((t=>{this._senders.push(e(this,t))}))};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._senders=this._senders||[],n.apply(this,[t]),t.getTracks().forEach((t=>{const e=this._senders.find((e=>e.track===t));e&&this._senders.splice(this._senders.indexOf(e),1)}))}}else if("object"==typeof t&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function fi(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,i,n]=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length&&(0===arguments.length||"function"!=typeof t))return e.apply(this,[]);const r=function(t){const e={};return t.result().forEach((t=>{const i={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach((e=>{i[e]=t.stat(e)})),e[i.id]=i})),e},s=function(t){return new Map(Object.keys(t).map((e=>[e,t[e]])))};if(arguments.length>=2){const n=function(t){i(s(r(t)))};return e.apply(this,[n,t])}return new Promise(((t,i)=>{e.apply(this,[function(e){t(s(r(e)))},i])})).then(i,n)}}function gi(t){if(!("object"==typeof t&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>di(e,t.track,!0)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),ei(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>di(e,t.track,!1)))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const t=arguments[0];let e,i,n;return this.getSenders().forEach((i=>{i.track===t&&(e?n=!0:e=i)})),this.getReceivers().forEach((e=>(e.track===t&&(i?n=!0:i=e),e.track===t))),n||e&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):e?e.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function vi(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((t=>this._shimmedLocalStreams[t][0]))};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){if(!i)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=e.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")}));const e=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((t=>-1===e.indexOf(t)));this._shimmedLocalStreams[t.id]=[t].concat(n)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],n.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach((e=>{const i=this._shimmedLocalStreams[e].indexOf(t);-1!==i&&this._shimmedLocalStreams[e].splice(i,1),1===this._shimmedLocalStreams[e].length&&delete this._shimmedLocalStreams[e]})),r.apply(this,arguments)}}function yi(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return vi(t);const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const t=i.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((t=>this._reverseStreams[t.id]))};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(e){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[e.id]){const i=new t.MediaStream(e.getTracks());this._streams[e.id]=i,this._reverseStreams[i.id]=e,e=i}n.apply(this,[e])};const r=t.RTCPeerConnection.prototype.removeStream;function s(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],r=t._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:e.type,sdp:i})}t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(e,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((t=>t===e)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(e),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new t.MediaStream([e]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((t=>t.track===e))},["createOffer","createAnswer"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){const t=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[e=>{const i=s(this,e);t[0].apply(null,[i])},e=>{t[1]&&t[1].apply(null,e)},arguments[2]]):i.apply(this,arguments).then((t=>s(this,t)))}};t.RTCPeerConnection.prototype[e]=n[e]}));const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],r=t._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:e.type,sdp:i})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const o=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const t=o.get.apply(this);return""===t.type?t:s(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(t._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let e;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((e=>t.track===e))&&(e=this._streams[i])})),e&&(1===e.getTracks().length?this.removeStream(this._reverseStreams[e.id]):e.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function bi(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}))}function ki(t,e){ei(t,"negotiationneeded",(t=>{const i=t.target;if(!(e.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return t}))}var Si=Object.freeze({__proto__:null,fixNegotiationNeeded:ki,shimAddTrackRemoveTrack:yi,shimAddTrackRemoveTrackWithNative:vi,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof e?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then((e=>{const n=i.video&&i.video.width,r=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxFrameRate:s||3}},n&&(i.video.mandatory.maxWidth=n),r&&(i.video.mandatory.maxHeight=r),t.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:mi,shimGetStats:fi,shimGetUserMedia:li,shimMediaStream:ui,shimOnTrack:pi,shimPeerConnection:bi,shimSenderReceiverGetStats:gi});function Ti(t,e){const i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(t,e,n){si("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(t).then(e,n)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const t=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])},e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),t(i.audio,"autoGainControl","mozAutoGainControl"),t(i.audio,"noiseSuppression","mozNoiseSuppression")),e(i)},n&&n.prototype.getSettings){const e=n.prototype.getSettings;n.prototype.getSettings=function(){const i=e.apply(this,arguments);return t(i,"mozAutoGainControl","autoGainControl"),t(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const e=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),t(i,"autoGainControl","mozAutoGainControl"),t(i,"noiseSuppression","mozNoiseSuppression")),e.apply(this,[i])}}}}function wi(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ci(t,e){if("object"!=typeof t||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,r,s]=arguments;return n.apply(this,[t||null]).then((t=>{if(e.version<53&&!r)try{t.forEach((t=>{t.type=i[t.type]||t.type}))}catch(e){if("TypeError"!==e.name)throw e;t.forEach(((e,n)=>{t.set(n,Object.assign({},e,{type:i[e.type]||e.type}))}))}return t})).then(r,s)}}function _i(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Pi(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),ei(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Ei(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(t){si("removeStream","removeTrack"),this.getSenders().forEach((e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)}))})}function xi(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Ri(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;void 0===t&&(t=[]),t=[...t];const i=t.length>0;i&&t.forEach((t=>{if("rid"in t&&!/^[a-z0-9]{0,16}$/i.test(t.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in t&&!(parseFloat(t.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in t&&!(parseFloat(t.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=e.apply(this,arguments);if(i){const{sender:e}=n,i=e.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=t,e.sendEncodings=t,this.setParametersPromises.push(e.setParameters(i).then((()=>{delete e.sendEncodings})).catch((()=>{delete e.sendEncodings}))))}return n})}function Ii(t){if("object"!=typeof t||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function Di(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}function Mi(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}var Ai=Object.freeze({__proto__:null,shimAddTransceiver:Ri,shimCreateAnswer:Mi,shimCreateOffer:Di,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const t=new DOMException("getDisplayMedia without video constraints is undefined");return t.name="NotFoundError",t.code=8,Promise.reject(t)}return!0===i.video?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:Ii,shimGetUserMedia:Ti,shimOnTrack:wi,shimPeerConnection:Ci,shimRTCDataChannel:xi,shimReceiverGetStats:Pi,shimRemoveStream:Ei,shimSenderGetStats:_i});function Ni(t){if("object"==typeof t&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getAudioTracks().forEach((i=>e.call(this,i,t))),t.getVideoTracks().forEach((i=>e.call(this,i,t)))},t.RTCPeerConnection.prototype.addTrack=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return n&&n.forEach((t=>{this._localStreams?this._localStreams.includes(t)||this._localStreams.push(t):this._localStreams=[t]})),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(t);if(-1===e)return;this._localStreams.splice(e,1);const i=t.getTracks();this.getSenders().forEach((t=>{i.includes(t.track)&&this.removeTrack(t)}))})}}function Li(t){if("object"==typeof t&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=t=>{t.streams.forEach((t=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(t))return;this._remoteStreams.push(t);const e=new Event("addstream");e.stream=t,this.dispatchEvent(e)}))})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((e=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(e)>=0)return;t._remoteStreams.push(e);const i=new Event("addstream");i.stream=e,t.dispatchEvent(i)}))}),e.apply(t,arguments)}}}function Oi(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,a=e.addIceCandidate;e.createOffer=function(t,e){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return e?(r.then(t,e),Promise.resolve()):r},e.createAnswer=function(t,e){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return e?(r.then(t,e),Promise.resolve()):r};let o=function(t,e,i){const n=r.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n};e.setLocalDescription=o,o=function(t,e,i){const n=s.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.setRemoteDescription=o,o=function(t,e,i){const n=a.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.addIceCandidate=o}function Ui(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=t=>i(Fi(t))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(t,i,n){e.mediaDevices.getUserMedia(t).then(i,n)}.bind(e))}function Fi(t){return t&&void 0!==t.video?Object.assign({},t,{video:oi(t.video)}):t}function Bi(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(t,i){if(t&&t.iceServers){const e=[];for(let i=0;i<t.iceServers.length;i++){let n=t.iceServers[i];void 0===n.urls&&n.url?(si("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,e.push(n)):e.push(t.iceServers[i])}t.iceServers=e}return new e(t,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function Gi(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Vi(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){void 0!==t.offerToReceiveAudio&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);const e=this.getTransceivers().find((t=>"audio"===t.receiver.track.kind));!1===t.offerToReceiveAudio&&e?"sendrecv"===e.direction?e.setDirection?e.setDirection("sendonly"):e.direction="sendonly":"recvonly"===e.direction&&(e.setDirection?e.setDirection("inactive"):e.direction="inactive"):!0!==t.offerToReceiveAudio||e||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==t.offerToReceiveVideo&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);const i=this.getTransceivers().find((t=>"video"===t.receiver.track.kind));!1===t.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==t.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function ji(t){"object"!=typeof t||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var Ji=Object.freeze({__proto__:null,shimAudioContext:ji,shimCallbacksAPI:Oi,shimConstraints:Fi,shimCreateOfferLegacy:Vi,shimGetUserMedia:Ui,shimLocalStreamsAPI:Ni,shimRTCIceServerUrls:Bi,shimRemoteStreamsAPI:Li,shimTrackEventTransceiver:Gi}),qi={exports:{}};!function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split("\n").map((t=>t.trim()))},e.splitSections=function(t){return t.split("\nm=").map(((t,e)=>(e>0?"m="+t:t).trim()+"\r\n"))},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter((t=>0===t.indexOf(i)))},e.parseCandidate=function(t){let e;e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" ");const i={foundation:e[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2)switch(e[t]){case"raddr":i.relatedAddress=e[t+1];break;case"rport":i.relatedPort=parseInt(e[t+1],10);break;case"tcptype":i.tcpType=e[t+1];break;case"ufrag":i.ufrag=e[t+1],i.usernameFragment=e[t+1];break;default:void 0===i[e[t]]&&(i[e[t]]=e[t+1])}return i},e.writeCandidate=function(t){const e=[];e.push(t.foundation);const i=t.component;"rtp"===i?e.push(1):"rtcp"===i?e.push(2):e.push(i),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);const n=t.type;return e.push("typ"),e.push(n),"host"!==n&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let e=t.substring(9).split(" ");const i={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),i.name=e[0],i.clockRate=parseInt(e[1],10),i.channels=3===e.length?parseInt(e[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(t){let e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);const i=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==i?"/"+i:"")+"\r\n"},e.parseExtmap=function(t){const e=t.substring(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1],attributes:e.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+"\r\n"},e.parseFmtp=function(t){const e={};let i;const n=t.substring(t.indexOf(" ")+1).split(";");for(let t=0;t<n.length;t++)i=n[t].trim().split("="),e[i[0].trim()]=i[1];return e},e.writeFmtp=function(t){let e="",i=t.payloadType;if(void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const n=[];Object.keys(t.parameters).forEach((e=>{void 0!==t.parameters[e]?n.push(e+"="+t.parameters[e]):n.push(e)})),e+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return e},e.parseRtcpFb=function(t){const e=t.substring(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},e.writeRtcpFb=function(t){let e="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach((t=>{e+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"})),e},e.parseSsrcMedia=function(t){const e=t.indexOf(" "),i={ssrc:parseInt(t.substring(7,e),10)},n=t.indexOf(":",e);return n>-1?(i.attribute=t.substring(e+1,n),i.value=t.substring(n+1)):i.attribute=t.substring(e+1),i},e.parseSsrcGroup=function(t){const e=t.substring(13).split(" ");return{semantics:e.shift(),ssrcs:e.map((t=>parseInt(t,10)))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const e=t.substring(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,e){let i="a=setup:"+e+"\r\n";return t.fingerprints.forEach((t=>{i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"})),i},e.parseCryptoLine=function(t){const e=t.substring(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+("object"==typeof t.keyParams?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"},e.parseCryptoKeyParams=function(t){if(0!==t.indexOf("inline:"))return null;const e=t.substring(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const n=e.matchPrefix(t+i,"a=ice-ufrag:")[0],r=e.matchPrefix(t+i,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substring(12),password:r.substring(10)}:null},e.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n";return t.iceLite&&(e+="a=ice-lite\r\n"),e},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=e.splitLines(t)[0].split(" ");i.profile=n[2];for(let r=3;r<n.length;r++){const s=n[r],a=e.matchPrefix(t,"a=rtpmap:"+s+" ")[0];if(a){const n=e.parseRtpMap(a),r=e.matchPrefix(t,"a=fmtp:"+s+" ");switch(n.parameters=r.length?e.parseFmtp(r[0]):{},n.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+s+" ").map(e.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}e.matchPrefix(t,"a=extmap:").forEach((t=>{i.headerExtensions.push(e.parseExtmap(t))}));const r=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach((t=>{r.forEach((e=>{t.rtcpFeedback.find((t=>t.type===e.type&&t.parameter===e.parameter))||t.rtcpFeedback.push(e)}))})),i},e.writeRtpDescription=function(t,i){let n="";n+="m="+t+" ",n+=i.codecs.length>0?"9":"0",n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=i.codecs.map((t=>void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((t=>{n+=e.writeRtpMap(t),n+=e.writeFmtp(t),n+=e.writeRtcpFb(t)}));let r=0;return i.codecs.forEach((t=>{t.maxptime>r&&(r=t.maxptime)})),r>0&&(n+="a=maxptime:"+r+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((t=>{n+=e.writeExtmap(t)})),n},e.parseRtpEncodingParameters=function(t){const i=[],n=e.parseRtpParameters(t),r=-1!==n.fecMechanisms.indexOf("RED"),s=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute)),o=a.length>0&&a[0].ssrc;let c;const d=e.matchPrefix(t,"a=ssrc-group:FID").map((t=>t.substring(17).split(" ").map((t=>parseInt(t,10)))));d.length>0&&d[0].length>1&&d[0][0]===o&&(c=d[0][1]),n.codecs.forEach((t=>{if("RTX"===t.name.toUpperCase()&&t.parameters.apt){let e={ssrc:o,codecPayloadType:parseInt(t.parameters.apt,10)};o&&c&&(e.rtx={ssrc:c}),i.push(e),r&&(e=JSON.parse(JSON.stringify(e)),e.fec={ssrc:o,mechanism:s?"red+ulpfec":"red"},i.push(e))}})),0===i.length&&o&&i.push({ssrc:o});let h=e.matchPrefix(t,"b=");return h.length&&(h=0===h[0].indexOf("b=TIAS:")?parseInt(h[0].substring(7),10):0===h[0].indexOf("b=AS:")?1e3*parseInt(h[0].substring(5),10)*.95-16e3:void 0,i.forEach((t=>{t.maxBitrate=h}))),i},e.parseRtcpParameters=function(t){const i={},n=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const r=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=r.length>0,i.compound=0===r.length;const s=e.matchPrefix(t,"a=rtcp-mux");return i.mux=s.length>0,i},e.writeRtcpParameters=function(t){let e="";return t.reducedSize&&(e+="a=rtcp-rsize\r\n"),t.mux&&(e+="a=rtcp-mux\r\n"),void 0!==t.ssrc&&t.cname&&(e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"),e},e.parseMsid=function(t){let i;const n=e.matchPrefix(t,"a=msid:");if(1===n.length)return i=n[0].substring(7).split(" "),{stream:i[0],track:i[1]};const r=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"msid"===t.attribute));return r.length>0?(i=r[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(t){const i=e.parseMLine(t),n=e.matchPrefix(t,"a=max-message-size:");let r;n.length>0&&(r=parseInt(n[0].substring(19),10)),isNaN(r)&&(r=65536);const s=e.matchPrefix(t,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:r};const a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){const t=a[0].substring(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:r}}},e.writeSctpDescription=function(t,e){let i=[];return i="DTLS/SCTP"!==t.protocol?["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]:["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"],void 0!==e.maxMessageSize&&i.push("a=max-message-size:"+e.maxMessageSize+"\r\n"),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,n){let r;const s=void 0!==i?i:2;return r=t||e.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+r+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getDirection=function(t,i){const n=e.splitLines(t);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return"0"===t.split(" ",2)[1]},e.parseMLine=function(t){const i=e.splitLines(t)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(t){const i=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;const i=e.splitLines(t);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},t.exports=e}(qi);var Wi=qi.exports,Hi=T(Wi),zi=k({__proto__:null,default:Hi},[Wi]);function Ki(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"==typeof t&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substring(2)),t.candidate&&t.candidate.length){const i=new e(t),n=Hi.parseCandidate(t.candidate);for(const t in n)t in i||Object.defineProperty(i,t,{value:n[t]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,ei(t,"icecandidate",(e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e)))}function Yi(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||ei(t,"icecandidate",(t=>{if(t.candidate){const e=Hi.parseCandidate(t.candidate.candidate);"relay"===e.type&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t}))}function Xi(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===e.browser&&e.version>=76){const{sdpSemantics:t}=this.getConfiguration();"plan-b"===t&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(t){if(!t||!t.sdp)return!1;const e=Hi.splitSections(t.sdp);return e.shift(),e.some((t=>{const e=Hi.parseMLine(t);return e&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")}))}(arguments[0])){const t=function(t){const e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===e||e.length<2)return-1;const i=parseInt(e[1],10);return i!=i?-1:i}(arguments[0]),i=function(t){let i=65536;return"firefox"===e.browser&&(i=e.version<57?-1===t?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),i}(t),n=function(t,i){let n=65536;"firefox"===e.browser&&57===e.version&&(n=65535);const r=Hi.matchPrefix(t.sdp,"a=max-message-size:");return r.length>0?n=parseInt(r[0].substring(19),10):"firefox"===e.browser&&-1!==i&&(n=2147483637),n}(arguments[0],t);let r;r=0===i&&0===n?Number.POSITIVE_INFINITY:0===i||0===n?Math.max(i,n):Math.min(i,n);const s={};Object.defineProperty(s,"maxMessageSize",{get:()=>r}),this._sctp=s}return i.apply(this,arguments)}}function Qi(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(t,e){const i=t.send;t.send=function(){const n=arguments[0],r=n.length||n.size||n.byteLength;if("open"===t.readyState&&e.sctp&&r>e.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)");return i.apply(t,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const t=i.apply(this,arguments);return e(t,this),t},ei(t,"datachannel",(t=>(e(t.channel,t.target),t)))}function Zi(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=t=>{const e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;const i=new Event("connectionstatechange",t);e.dispatchEvent(i)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function $i(t,e){if(!t.RTCPeerConnection)return;if("chrome"===e.browser&&e.version>=71)return;if("safari"===e.browser&&e.version>=605)return;const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(e){if(e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")){const i=e.sdp.split("\n").filter((t=>"a=extmap-allow-mixed"!==t.trim())).join("\n");t.RTCSessionDescription&&e instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:e.type,sdp:i}):e.sdp=i}return i.apply(this,arguments)}}function tn(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===e.browser&&e.version<78||"firefox"===e.browser&&e.version<68||"safari"===e.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function en(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let t=arguments[0]||{};if("object"!=typeof t||t.type&&t.sdp)return i.apply(this,arguments);if(t={type:t.type,sdp:t.sdp},!t.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?i.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((t=>i.apply(this,[t])))})}var nn=Object.freeze({__proto__:null,removeExtmapAllowMixed:$i,shimAddIceCandidateNullOrEmpty:tn,shimConnectionState:Zi,shimMaxMessageSize:Xi,shimParameterlessSetLocalDescription:en,shimRTCIceCandidate:Ki,shimRTCIceCandidateRelayProtocol:Yi,shimSendThrowTypeError:Qi});!function(){let{window:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=ri,n=function(t){const e={browser:null,version:null};if(void 0===t||!t.navigator||!t.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:i}=t;if(i.mozGetUserMedia)e.browser="firefox",e.version=ti(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=ti(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=ti(i.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}return e}(t),r={browserDetails:n,commonShim:nn,extractVersion:ti,disableLog:ii,disableWarnings:ni,sdp:zi};switch(n.browser){case"chrome":if(!Si||!bi||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=Si,tn(t,n),en(t),li(t,n),ui(t),bi(t,n),pi(t),yi(t,n),mi(t),fi(t),gi(t),ki(t,n),Ki(t),Yi(t),Zi(t),Xi(t,n),Qi(t),$i(t,n);break;case"firefox":if(!Ai||!Ci||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=Ai,tn(t,n),en(t),Ti(t,n),Ci(t,n),wi(t),Ei(t),_i(t),Pi(t),xi(t),Ri(t),Ii(t),Di(t),Mi(t),Ki(t),Zi(t),Xi(t,n),Qi(t);break;case"safari":if(!Ji||!e.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=Ji,tn(t,n),en(t),Bi(t),Vi(t),Oi(t),Ni(t),Li(t),Gi(t),Ui(t),ji(t),Ki(t),Yi(t),Xi(t,n),Qi(t),$i(t,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});const rn="lk_e2ee";var sn,an,on,cn,dn,hn,ln,un,pn;function mn(){return void 0!==window.RTCRtpScriptTransform}!function(t){t.SetKey="setKey",t.RatchetRequest="ratchetRequest",t.KeyRatcheted="keyRatcheted"}(sn||(sn={})),function(t){t.KeyRatcheted="keyRatcheted"}(an||(an={})),function(t){t.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",t.EncryptionError="encryptionError"}(on||(on={})),function(t){t.Error="cryptorError"}(cn||(cn={})),Qe.EventEmitter;class fn extends Error{constructor(t,e){super(e||"an error has occured"),this.code=t}}class gn extends fn{constructor(t,e,i){super(1,t),this.status=i,this.reason=e}}class vn extends fn{constructor(t){super(21,null!=t?t:"device is unsupported")}}class yn extends fn{constructor(t){super(20,null!=t?t:"track is invalid")}}class bn extends fn{constructor(t){super(10,null!=t?t:"unsupported server")}}class kn extends fn{constructor(t){super(12,null!=t?t:"unexpected connection state")}}class Sn extends fn{constructor(t){super(13,null!=t?t:"unable to negotiate")}}function Tn(t,e,i){var n,r,s;void 0===e&&(e=50),void 0===i&&(i={});var a=null!=(n=i.isImmediate)&&n,o=null!=(r=i.callback)&&r,c=i.maxWait,d=Date.now(),h=[];function l(){if(void 0!==c){var t=Date.now()-d;if(t+e>=c)return c-t}return e}var u=function(){var e=[].slice.call(arguments),i=this;return new Promise((function(n,r){var c=a&&void 0===s;if(void 0!==s&&clearTimeout(s),s=setTimeout((function(){if(s=void 0,d=Date.now(),!a){var n=t.apply(i,e);o&&o(n),h.forEach((function(t){return(0,t.resolve)(n)})),h=[]}}),l()),c){var u=t.apply(i,e);return o&&o(u),n(u)}h.push({resolve:n,reject:r})}))};return u.cancel=function(t){void 0!==s&&clearTimeout(s),h.forEach((function(e){return(0,e.reject)(t)})),h=[]},u}!function(t){t.PermissionDenied="PermissionDenied",t.NotFound="NotFound",t.DeviceInUse="DeviceInUse",t.Other="Other"}(dn||(dn={})),function(t){t.getFailure=function(e){if(e&&"name"in e)return"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?t.NotFound:"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?t.PermissionDenied:"NotReadableError"===e.name||"TrackStartError"===e.name?t.DeviceInUse:t.Other}}(dn||(dn={})),function(t){t.Connected="connected",t.Reconnecting="reconnecting",t.Reconnected="reconnected",t.Disconnected="disconnected",t.ConnectionStateChanged="connectionStateChanged",t.StateChanged="connectionStateChanged",t.MediaDevicesChanged="mediaDevicesChanged",t.ParticipantConnected="participantConnected",t.ParticipantDisconnected="participantDisconnected",t.TrackPublished="trackPublished",t.TrackSubscribed="trackSubscribed",t.TrackSubscriptionFailed="trackSubscriptionFailed",t.TrackUnpublished="trackUnpublished",t.TrackUnsubscribed="trackUnsubscribed",t.TrackMuted="trackMuted",t.TrackUnmuted="trackUnmuted",t.LocalTrackPublished="localTrackPublished",t.LocalTrackUnpublished="localTrackUnpublished",t.LocalAudioSilenceDetected="localAudioSilenceDetected",t.ActiveSpeakersChanged="activeSpeakersChanged",t.ParticipantMetadataChanged="participantMetadataChanged",t.ParticipantNameChanged="participantNameChanged",t.RoomMetadataChanged="roomMetadataChanged",t.DataReceived="dataReceived",t.ConnectionQualityChanged="connectionQualityChanged",t.TrackStreamStateChanged="trackStreamStateChanged",t.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",t.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",t.AudioPlaybackStatusChanged="audioPlaybackChanged",t.VideoPlaybackStatusChanged="videoPlaybackChanged",t.MediaDevicesError="mediaDevicesError",t.ParticipantPermissionsChanged="participantPermissionsChanged",t.SignalConnected="signalConnected",t.RecordingStatusChanged="recordingStatusChanged",t.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",t.EncryptionError="encryptionError",t.DCBufferStatusChanged="dcBufferStatusChanged",t.ActiveDeviceChanged="activeDeviceChanged"}(hn||(hn={})),function(t){t.TrackPublished="trackPublished",t.TrackSubscribed="trackSubscribed",t.TrackSubscriptionFailed="trackSubscriptionFailed",t.TrackUnpublished="trackUnpublished",t.TrackUnsubscribed="trackUnsubscribed",t.TrackMuted="trackMuted",t.TrackUnmuted="trackUnmuted",t.LocalTrackPublished="localTrackPublished",t.LocalTrackUnpublished="localTrackUnpublished",t.ParticipantMetadataChanged="participantMetadataChanged",t.ParticipantNameChanged="participantNameChanged",t.DataReceived="dataReceived",t.IsSpeakingChanged="isSpeakingChanged",t.ConnectionQualityChanged="connectionQualityChanged",t.TrackStreamStateChanged="trackStreamStateChanged",t.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",t.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",t.MediaDevicesError="mediaDevicesError",t.AudioStreamAcquired="audioStreamAcquired",t.ParticipantPermissionsChanged="participantPermissionsChanged",t.PCTrackAdded="pcTrackAdded"}(ln||(ln={})),function(t){t.TransportsCreated="transportsCreated",t.Connected="connected",t.Disconnected="disconnected",t.Resuming="resuming",t.Resumed="resumed",t.Restarting="restarting",t.Restarted="restarted",t.SignalResumed="signalResumed",t.SignalRestarted="signalRestarted",t.Closing="closing",t.MediaTrackAdded="mediaTrackAdded",t.ActiveSpeakersUpdate="activeSpeakersUpdate",t.DataPacketReceived="dataPacketReceived",t.RTPVideoMapUpdate="rtpVideoMapUpdate",t.DCBufferStatusChanged="dcBufferStatusChanged",t.ParticipantUpdate="participantUpdate",t.RoomUpdate="roomUpdate",t.SpeakersChanged="speakersChanged",t.StreamStateChanged="streamStateChanged",t.ConnectionQualityUpdate="connectionQualityUpdate",t.SubscriptionError="subscriptionError",t.SubscriptionPermissionUpdate="subscriptionPermissionUpdate"}(un||(un={})),function(t){t.Message="message",t.Muted="muted",t.Unmuted="unmuted",t.Restarted="restarted",t.Ended="ended",t.Subscribed="subscribed",t.Unsubscribed="unsubscribed",t.UpdateSettings="updateSettings",t.UpdateSubscription="updateSubscription",t.AudioPlaybackStarted="audioPlaybackStarted",t.AudioPlaybackFailed="audioPlaybackFailed",t.AudioSilenceDetected="audioSilenceDetected",t.VisibilityChanged="visibilityChanged",t.VideoDimensionsChanged="videoDimensionsChanged",t.VideoPlaybackStarted="videoPlaybackStarted",t.VideoPlaybackFailed="videoPlaybackFailed",t.ElementAttached="elementAttached",t.ElementDetached="elementDetached",t.UpstreamPaused="upstreamPaused",t.UpstreamResumed="upstreamResumed",t.SubscriptionPermissionChanged="subscriptionPermissionChanged",t.SubscriptionStatusChanged="subscriptionStatusChanged",t.SubscriptionFailed="subscriptionFailed"}(pn||(pn={}));const wn=/version\/(\d+(\.?_?\d+)+)/i;let Cn;function _n(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(void 0===t&&"undefined"==typeof navigator)return;const i=(null!=t?t:navigator.userAgent).toLowerCase();if(void 0===Cn||e){const t=Pn.find((t=>{let{test:e}=t;return e.test(i)}));Cn=null==t?void 0:t.describe(i)}return Cn}const Pn=[{test:/firefox|iceweasel|fxios/i,describe:t=>({name:"Firefox",version:En(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("fxios")?"iOS":void 0})},{test:/chrom|crios|crmo/i,describe:t=>({name:"Chrome",version:En(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("crios")?"iOS":void 0})},{test:/safari|applewebkit/i,describe:t=>({name:"Safari",version:En(wn,t),os:t.includes("mobile/")?"iOS":"macOS"})}];function En(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const n=e.match(t);return n&&n.length>=i&&n[i]||""}class xn{}xn.setTimeout=function(){return setTimeout(...arguments)},xn.setInterval=function(){return setInterval(...arguments)},xn.clearTimeout=function(){return clearTimeout(...arguments)},xn.clearInterval=function(){return clearInterval(...arguments)};class Rn{constructor(t,e,i,n,r){this.width=t,this.height=e,this.encoding={maxBitrate:i,maxFramerate:n,priority:r}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.width/this.height}}}const In=["vp8","h264"],Dn=["vp8","h264","vp9","av1"];function Mn(t){return!!In.find((e=>e===t))}var An;!function(t){t.telephone={maxBitrate:12e3},t.speech={maxBitrate:2e4},t.music={maxBitrate:32e3},t.musicStereo={maxBitrate:48e3},t.musicHighQuality={maxBitrate:64e3},t.musicHighQualityStereo={maxBitrate:96e3}}(An||(An={}));const Nn={h90:new Rn(160,90,9e4,20),h180:new Rn(320,180,16e4,20),h216:new Rn(384,216,18e4,20),h360:new Rn(640,360,45e4,20),h540:new Rn(960,540,8e5,25),h720:new Rn(1280,720,17e5,30),h1080:new Rn(1920,1080,3e6,30),h1440:new Rn(2560,1440,5e6,30),h2160:new Rn(3840,2160,8e6,30)},Ln={h120:new Rn(160,120,7e4,20),h180:new Rn(240,180,125e3,20),h240:new Rn(320,240,14e4,20),h360:new Rn(480,360,33e4,20),h480:new Rn(640,480,5e5,20),h540:new Rn(720,540,6e5,25),h720:new Rn(960,720,13e5,30),h1080:new Rn(1440,1080,23e5,30),h1440:new Rn(1920,1440,38e5,30)},On={h360fps3:new Rn(640,360,2e5,3,"medium"),h720fps5:new Rn(1280,720,4e5,5,"medium"),h720fps15:new Rn(1280,720,15e5,15,"medium"),h720fps30:new Rn(1280,720,2e6,30,"medium"),h1080fps15:new Rn(1920,1080,25e5,15,"medium"),h1080fps30:new Rn(1920,1080,4e6,30,"medium")};var Un,Fn,Bn;!function(t){t[t.PUBLISHER=0]="PUBLISHER",t[t.SUBSCRIBER=1]="SUBSCRIBER"}(Un||(Un={})),jt.util.setEnumType(Un,"livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),function(t){t[t.ACTIVE=0]="ACTIVE",t[t.PAUSED=1]="PAUSED"}(Fn||(Fn={})),jt.util.setEnumType(Fn,"livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),function(t){t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.TLS=2]="TLS"}(Bn||(Bn={})),jt.util.setEnumType(Bn,"livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]);class Gn extends G{constructor(t){super(),this.message={case:void 0},jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Gn).fromBinary(t,e)}static fromJson(t,e){return(new Gn).fromJson(t,e)}static fromJsonString(t,e){return(new Gn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Gn,t,e)}}Gn.runtime=jt,Gn.typeName="livekit.SignalRequest",Gn.fields=jt.util.newFieldList((()=>[{no:1,name:"offer",kind:"message",T:Xn,oneof:"message"},{no:2,name:"answer",kind:"message",T:Xn,oneof:"message"},{no:3,name:"trickle",kind:"message",T:qn,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Jn,oneof:"message"},{no:5,name:"mute",kind:"message",T:Wn,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Zn,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:$n,oneof:"message"},{no:8,name:"leave",kind:"message",T:tr,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:er,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:mr,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:gr,oneof:"message"},{no:13,name:"simulate",kind:"message",T:yr,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:ir,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:br,oneof:"message"}]));class Vn extends G{constructor(t){super(),this.message={case:void 0},jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Vn).fromBinary(t,e)}static fromJson(t,e){return(new Vn).fromJson(t,e)}static fromJsonString(t,e){return(new Vn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Vn,t,e)}}Vn.runtime=jt,Vn.typeName="livekit.SignalResponse",Vn.fields=jt.util.newFieldList((()=>[{no:1,name:"join",kind:"message",T:Hn,oneof:"message"},{no:2,name:"answer",kind:"message",T:Xn,oneof:"message"},{no:3,name:"offer",kind:"message",T:Xn,oneof:"message"},{no:4,name:"trickle",kind:"message",T:qn,oneof:"message"},{no:5,name:"update",kind:"message",T:Qn,oneof:"message"},{no:6,name:"track_published",kind:"message",T:Kn,oneof:"message"},{no:8,name:"leave",kind:"message",T:tr,oneof:"message"},{no:9,name:"mute",kind:"message",T:Wn,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:rr,oneof:"message"},{no:11,name:"room_update",kind:"message",T:sr,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:or,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:dr,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:ur,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:fr,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Yn,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:zn,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:kr,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:wr,oneof:"message"}]));class jn extends G{constructor(t){super(),this.codec="",this.cid="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new jn).fromBinary(t,e)}static fromJson(t,e){return(new jn).fromJson(t,e)}static fromJsonString(t,e){return(new jn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(jn,t,e)}}jn.runtime=jt,jn.typeName="livekit.SimulcastCodec",jn.fields=jt.util.newFieldList((()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]));class Jn extends G{constructor(t){super(),this.cid="",this.name="",this.type=Kt.AUDIO,this.width=0,this.height=0,this.muted=!1,this.disableDtx=!1,this.source=Yt.UNKNOWN,this.layers=[],this.simulcastCodecs=[],this.sid="",this.stereo=!1,this.disableRed=!1,this.encryption=he.NONE,this.stream="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Jn).fromBinary(t,e)}static fromJson(t,e){return(new Jn).fromJson(t,e)}static fromJsonString(t,e){return(new Jn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Jn,t,e)}}Jn.runtime=jt,Jn.typeName="livekit.AddTrackRequest",Jn.fields=jt.util.newFieldList((()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:jt.getEnumType(Kt)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:jt.getEnumType(Yt)},{no:9,name:"layers",kind:"message",T:ve,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:jn,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:jt.getEnumType(he)},{no:15,name:"stream",kind:"scalar",T:9}]));class qn extends G{constructor(t){super(),this.candidateInit="",this.target=Un.PUBLISHER,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new qn).fromBinary(t,e)}static fromJson(t,e){return(new qn).fromJson(t,e)}static fromJsonString(t,e){return(new qn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(qn,t,e)}}qn.runtime=jt,qn.typeName="livekit.TrickleRequest",qn.fields=jt.util.newFieldList((()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:jt.getEnumType(Un)}]));class Wn extends G{constructor(t){super(),this.sid="",this.muted=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Wn).fromBinary(t,e)}static fromJson(t,e){return(new Wn).fromJson(t,e)}static fromJsonString(t,e){return(new Wn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Wn,t,e)}}Wn.runtime=jt,Wn.typeName="livekit.MuteTrackRequest",Wn.fields=jt.util.newFieldList((()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]));class Hn extends G{constructor(t){super(),this.otherParticipants=[],this.serverVersion="",this.iceServers=[],this.subscriberPrimary=!1,this.alternativeUrl="",this.serverRegion="",this.pingTimeout=0,this.pingInterval=0,this.sifTrailer=new Uint8Array(0),jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Hn).fromBinary(t,e)}static fromJson(t,e){return(new Hn).fromJson(t,e)}static fromJsonString(t,e){return(new Hn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Hn,t,e)}}Hn.runtime=jt,Hn.typeName="livekit.JoinResponse",Hn.fields=jt.util.newFieldList((()=>[{no:1,name:"room",kind:"message",T:re},{no:2,name:"participant",kind:"message",T:ce},{no:3,name:"other_participants",kind:"message",T:ce,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:nr,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:_e},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:we},{no:13,name:"sif_trailer",kind:"scalar",T:12}]));class zn extends G{constructor(t){super(),this.iceServers=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new zn).fromBinary(t,e)}static fromJson(t,e){return(new zn).fromJson(t,e)}static fromJsonString(t,e){return(new zn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(zn,t,e)}}zn.runtime=jt,zn.typeName="livekit.ReconnectResponse",zn.fields=jt.util.newFieldList((()=>[{no:1,name:"ice_servers",kind:"message",T:nr,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:_e}]));class Kn extends G{constructor(t){super(),this.cid="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Kn).fromBinary(t,e)}static fromJson(t,e){return(new Kn).fromJson(t,e)}static fromJsonString(t,e){return(new Kn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Kn,t,e)}}Kn.runtime=jt,Kn.typeName="livekit.TrackPublishedResponse",Kn.fields=jt.util.newFieldList((()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:ge}]));class Yn extends G{constructor(t){super(),this.trackSid="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Yn).fromBinary(t,e)}static fromJson(t,e){return(new Yn).fromJson(t,e)}static fromJsonString(t,e){return(new Yn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Yn,t,e)}}Yn.runtime=jt,Yn.typeName="livekit.TrackUnpublishedResponse",Yn.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]));class Xn extends G{constructor(t){super(),this.type="",this.sdp="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Xn).fromBinary(t,e)}static fromJson(t,e){return(new Xn).fromJson(t,e)}static fromJsonString(t,e){return(new Xn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Xn,t,e)}}Xn.runtime=jt,Xn.typeName="livekit.SessionDescription",Xn.fields=jt.util.newFieldList((()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]));class Qn extends G{constructor(t){super(),this.participants=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Qn).fromBinary(t,e)}static fromJson(t,e){return(new Qn).fromJson(t,e)}static fromJsonString(t,e){return(new Qn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Qn,t,e)}}Qn.runtime=jt,Qn.typeName="livekit.ParticipantUpdate",Qn.fields=jt.util.newFieldList((()=>[{no:1,name:"participants",kind:"message",T:ce,repeated:!0}]));class Zn extends G{constructor(t){super(),this.trackSids=[],this.subscribe=!1,this.participantTracks=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Zn).fromBinary(t,e)}static fromJson(t,e){return(new Zn).fromJson(t,e)}static fromJsonString(t,e){return(new Zn).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Zn,t,e)}}Zn.runtime=jt,Zn.typeName="livekit.UpdateSubscription",Zn.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:Te,repeated:!0}]));class $n extends G{constructor(t){super(),this.trackSids=[],this.disabled=!1,this.quality=Xt.LOW,this.width=0,this.height=0,this.fps=0,this.priority=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new $n).fromBinary(t,e)}static fromJson(t,e){return(new $n).fromJson(t,e)}static fromJsonString(t,e){return(new $n).fromJsonString(t,e)}static equals(t,e){return jt.util.equals($n,t,e)}}$n.runtime=jt,$n.typeName="livekit.UpdateTrackSettings",$n.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:jt.getEnumType(Xt)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]));class tr extends G{constructor(t){super(),this.canReconnect=!1,this.reason=$t.UNKNOWN_REASON,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new tr).fromBinary(t,e)}static fromJson(t,e){return(new tr).fromJson(t,e)}static fromJsonString(t,e){return(new tr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(tr,t,e)}}tr.runtime=jt,tr.typeName="livekit.LeaveRequest",tr.fields=jt.util.newFieldList((()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:jt.getEnumType($t)}]));class er extends G{constructor(t){super(),this.trackSid="",this.layers=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new er).fromBinary(t,e)}static fromJson(t,e){return(new er).fromJson(t,e)}static fromJsonString(t,e){return(new er).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(er,t,e)}}er.runtime=jt,er.typeName="livekit.UpdateVideoLayers",er.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:ve,repeated:!0}]));class ir extends G{constructor(t){super(),this.metadata="",this.name="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ir).fromBinary(t,e)}static fromJson(t,e){return(new ir).fromJson(t,e)}static fromJsonString(t,e){return(new ir).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ir,t,e)}}ir.runtime=jt,ir.typeName="livekit.UpdateParticipantMetadata",ir.fields=jt.util.newFieldList((()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9}]));class nr extends G{constructor(t){super(),this.urls=[],this.username="",this.credential="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new nr).fromBinary(t,e)}static fromJson(t,e){return(new nr).fromJson(t,e)}static fromJsonString(t,e){return(new nr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(nr,t,e)}}nr.runtime=jt,nr.typeName="livekit.ICEServer",nr.fields=jt.util.newFieldList((()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]));class rr extends G{constructor(t){super(),this.speakers=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new rr).fromBinary(t,e)}static fromJson(t,e){return(new rr).fromJson(t,e)}static fromJsonString(t,e){return(new rr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(rr,t,e)}}rr.runtime=jt,rr.typeName="livekit.SpeakersChanged",rr.fields=jt.util.newFieldList((()=>[{no:1,name:"speakers",kind:"message",T:ke,repeated:!0}]));class sr extends G{constructor(t){super(),jt.util.initPartial(t,this)}static fromBinary(t,e){return(new sr).fromBinary(t,e)}static fromJson(t,e){return(new sr).fromJson(t,e)}static fromJsonString(t,e){return(new sr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(sr,t,e)}}sr.runtime=jt,sr.typeName="livekit.RoomUpdate",sr.fields=jt.util.newFieldList((()=>[{no:1,name:"room",kind:"message",T:re}]));class ar extends G{constructor(t){super(),this.participantSid="",this.quality=Qt.POOR,this.score=0,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ar).fromBinary(t,e)}static fromJson(t,e){return(new ar).fromJson(t,e)}static fromJsonString(t,e){return(new ar).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ar,t,e)}}ar.runtime=jt,ar.typeName="livekit.ConnectionQualityInfo",ar.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:jt.getEnumType(Qt)},{no:3,name:"score",kind:"scalar",T:2}]));class or extends G{constructor(t){super(),this.updates=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new or).fromBinary(t,e)}static fromJson(t,e){return(new or).fromJson(t,e)}static fromJsonString(t,e){return(new or).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(or,t,e)}}or.runtime=jt,or.typeName="livekit.ConnectionQualityUpdate",or.fields=jt.util.newFieldList((()=>[{no:1,name:"updates",kind:"message",T:ar,repeated:!0}]));class cr extends G{constructor(t){super(),this.participantSid="",this.trackSid="",this.state=Fn.ACTIVE,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new cr).fromBinary(t,e)}static fromJson(t,e){return(new cr).fromJson(t,e)}static fromJsonString(t,e){return(new cr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(cr,t,e)}}cr.runtime=jt,cr.typeName="livekit.StreamStateInfo",cr.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:jt.getEnumType(Fn)}]));class dr extends G{constructor(t){super(),this.streamStates=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new dr).fromBinary(t,e)}static fromJson(t,e){return(new dr).fromJson(t,e)}static fromJsonString(t,e){return(new dr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(dr,t,e)}}dr.runtime=jt,dr.typeName="livekit.StreamStateUpdate",dr.fields=jt.util.newFieldList((()=>[{no:1,name:"stream_states",kind:"message",T:cr,repeated:!0}]));class hr extends G{constructor(t){super(),this.quality=Xt.LOW,this.enabled=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new hr).fromBinary(t,e)}static fromJson(t,e){return(new hr).fromJson(t,e)}static fromJsonString(t,e){return(new hr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(hr,t,e)}}hr.runtime=jt,hr.typeName="livekit.SubscribedQuality",hr.fields=jt.util.newFieldList((()=>[{no:1,name:"quality",kind:"enum",T:jt.getEnumType(Xt)},{no:2,name:"enabled",kind:"scalar",T:8}]));class lr extends G{constructor(t){super(),this.codec="",this.qualities=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new lr).fromBinary(t,e)}static fromJson(t,e){return(new lr).fromJson(t,e)}static fromJsonString(t,e){return(new lr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(lr,t,e)}}lr.runtime=jt,lr.typeName="livekit.SubscribedCodec",lr.fields=jt.util.newFieldList((()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:hr,repeated:!0}]));class ur extends G{constructor(t){super(),this.trackSid="",this.subscribedQualities=[],this.subscribedCodecs=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new ur).fromBinary(t,e)}static fromJson(t,e){return(new ur).fromJson(t,e)}static fromJsonString(t,e){return(new ur).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(ur,t,e)}}ur.runtime=jt,ur.typeName="livekit.SubscribedQualityUpdate",ur.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:hr,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:lr,repeated:!0}]));class pr extends G{constructor(t){super(),this.participantSid="",this.allTracks=!1,this.trackSids=[],this.participantIdentity="",jt.util.initPartial(t,this)}static fromBinary(t,e){return(new pr).fromBinary(t,e)}static fromJson(t,e){return(new pr).fromJson(t,e)}static fromJsonString(t,e){return(new pr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(pr,t,e)}}pr.runtime=jt,pr.typeName="livekit.TrackPermission",pr.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]));class mr extends G{constructor(t){super(),this.allParticipants=!1,this.trackPermissions=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new mr).fromBinary(t,e)}static fromJson(t,e){return(new mr).fromJson(t,e)}static fromJsonString(t,e){return(new mr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(mr,t,e)}}mr.runtime=jt,mr.typeName="livekit.SubscriptionPermission",mr.fields=jt.util.newFieldList((()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:pr,repeated:!0}]));class fr extends G{constructor(t){super(),this.participantSid="",this.trackSid="",this.allowed=!1,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new fr).fromBinary(t,e)}static fromJson(t,e){return(new fr).fromJson(t,e)}static fromJsonString(t,e){return(new fr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(fr,t,e)}}fr.runtime=jt,fr.typeName="livekit.SubscriptionPermissionUpdate",fr.fields=jt.util.newFieldList((()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]));class gr extends G{constructor(t){super(),this.publishTracks=[],this.dataChannels=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new gr).fromBinary(t,e)}static fromJson(t,e){return(new gr).fromJson(t,e)}static fromJsonString(t,e){return(new gr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(gr,t,e)}}gr.runtime=jt,gr.typeName="livekit.SyncState",gr.fields=jt.util.newFieldList((()=>[{no:1,name:"answer",kind:"message",T:Xn},{no:2,name:"subscription",kind:"message",T:Zn},{no:3,name:"publish_tracks",kind:"message",T:Kn,repeated:!0},{no:4,name:"data_channels",kind:"message",T:vr,repeated:!0},{no:5,name:"offer",kind:"message",T:Xn}]));class vr extends G{constructor(t){super(),this.label="",this.id=0,this.target=Un.PUBLISHER,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new vr).fromBinary(t,e)}static fromJson(t,e){return(new vr).fromJson(t,e)}static fromJsonString(t,e){return(new vr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(vr,t,e)}}vr.runtime=jt,vr.typeName="livekit.DataChannelInfo",vr.fields=jt.util.newFieldList((()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:jt.getEnumType(Un)}]));class yr extends G{constructor(t){super(),this.scenario={case:void 0},jt.util.initPartial(t,this)}static fromBinary(t,e){return(new yr).fromBinary(t,e)}static fromJson(t,e){return(new yr).fromJson(t,e)}static fromJsonString(t,e){return(new yr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(yr,t,e)}}yr.runtime=jt,yr.typeName="livekit.SimulateScenario",yr.fields=jt.util.newFieldList((()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:jt.getEnumType(Bn),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"}]));class br extends G{constructor(t){super(),this.timestamp=$.zero,this.rtt=$.zero,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new br).fromBinary(t,e)}static fromJson(t,e){return(new br).fromJson(t,e)}static fromJsonString(t,e){return(new br).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(br,t,e)}}br.runtime=jt,br.typeName="livekit.Ping",br.fields=jt.util.newFieldList((()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]));class kr extends G{constructor(t){super(),this.lastPingTimestamp=$.zero,this.timestamp=$.zero,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new kr).fromBinary(t,e)}static fromJson(t,e){return(new kr).fromJson(t,e)}static fromJsonString(t,e){return(new kr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(kr,t,e)}}kr.runtime=jt,kr.typeName="livekit.Pong",kr.fields=jt.util.newFieldList((()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]));class Sr extends G{constructor(t){super(),this.regions=[],jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Sr).fromBinary(t,e)}static fromJson(t,e){return(new Sr).fromJson(t,e)}static fromJsonString(t,e){return(new Sr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Sr,t,e)}}Sr.runtime=jt,Sr.typeName="livekit.RegionSettings",Sr.fields=jt.util.newFieldList((()=>[{no:1,name:"regions",kind:"message",T:Tr,repeated:!0}]));class Tr extends G{constructor(t){super(),this.region="",this.url="",this.distance=$.zero,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new Tr).fromBinary(t,e)}static fromJson(t,e){return(new Tr).fromJson(t,e)}static fromJsonString(t,e){return(new Tr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(Tr,t,e)}}Tr.runtime=jt,Tr.typeName="livekit.RegionInfo",Tr.fields=jt.util.newFieldList((()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]));class wr extends G{constructor(t){super(),this.trackSid="",this.err=ee.SE_UNKNOWN,jt.util.initPartial(t,this)}static fromBinary(t,e){return(new wr).fromBinary(t,e)}static fromJson(t,e){return(new wr).fromJson(t,e)}static fromJsonString(t,e){return(new wr).fromJsonString(t,e)}static equals(t,e){return jt.util.equals(wr,t,e)}}wr.runtime=jt,wr.typeName="livekit.SubscriptionResponse",wr.fields=jt.util.newFieldList((()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:jt.getEnumType(ee)}]));const Cr=[];class _r extends Qe.EventEmitter{constructor(t,e){super(),this.attachedElements=[],this.isMuted=!1,this.streamState=_r.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),"hidden"===document.visibilityState?this.backgroundTimeout=setTimeout((()=>this.handleAppVisibilityChanged()),5e3):this.handleAppVisibilityChanged()},this.setMaxListeners(100),this.kind=e,this._mediaStreamTrack=t,this._mediaStreamID=t.id,this.source=_r.Source.Unknown}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(t){let e="audio";this.kind===_r.Kind.Video&&(e="video"),0===this.attachedElements.length&&_r.Kind.Video&&this.addAppVisibilityListener(),t||("audio"===e&&(Cr.forEach((e=>{null!==e.parentElement||t||(t=e)})),t&&Cr.splice(Cr.indexOf(t),1)),t||(t=document.createElement(e))),this.attachedElements.includes(t)||this.attachedElements.push(t),Pr(this.mediaStreamTrack,t);const i=t.srcObject.getTracks(),n=i.some((t=>"audio"===t.kind));return t.play().then((()=>{this.emit(n?pn.AudioPlaybackStarted:pn.VideoPlaybackStarted)})).catch((e=>{"NotAllowedError"===e.name?this.emit(n?pn.AudioPlaybackFailed:pn.VideoPlaybackFailed,e):"AbortError"===e.name?P.debug("".concat(n?"audio":"video"," playback aborted, likely due to new play request")):P.warn("could not playback ".concat(n?"audio":"video"),e),n&&t&&i.some((t=>"video"===t.kind))&&"NotAllowedError"===e.name&&(t.muted=!0,t.play().catch((()=>{})))})),this.emit(pn.ElementAttached,t),t}detach(t){try{if(t){Er(this.mediaStreamTrack,t);const e=this.attachedElements.indexOf(t);return e>=0&&(this.attachedElements.splice(e,1),this.recycleElement(t),this.emit(pn.ElementDetached,t)),t}const e=[];return this.attachedElements.forEach((t=>{Er(this.mediaStreamTrack,t),e.push(t),this.recycleElement(t),this.emit(pn.ElementDetached,t)})),this.attachedElements=[],e}finally{0===this.attachedElements.length&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval)}recycleElement(t){if(t instanceof HTMLAudioElement){let e=!0;t.pause(),Cr.forEach((t=>{t.parentElement||(e=!1)})),e&&Cr.push(t)}}handleAppVisibilityChanged(){return Ae(this,void 0,void 0,(function*(){this.isInBackground="hidden"===document.visibilityState}))}addAppVisibilityListener(){qr()?(this.isInBackground="hidden"===document.visibilityState,document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){qr()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Pr(t,e){let i,n;i=e.srcObject instanceof MediaStream?e.srcObject:new MediaStream,n="audio"===t.kind?i.getAudioTracks():i.getVideoTracks(),n.includes(t)||(n.forEach((t=>{i.removeTrack(t)})),i.addTrack(t)),jr()&&e instanceof HTMLVideoElement||(e.autoplay=!0),e.muted=0===i.getAudioTracks().length,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==i&&(e.srcObject=i,(jr()||Vr())&&e instanceof HTMLVideoElement&&setTimeout((()=>{e.srcObject=i,e.play().catch((()=>{}))}),0))}function Er(t,e){if(e.srcObject instanceof MediaStream){const i=e.srcObject;i.removeTrack(t),i.getTracks().length>0?e.srcObject=i:e.srcObject=null}}function xr(t,e,i){var n;const r=null!==(n=function(t){if(void 0!==t)return"function"==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t))}(t))&&void 0!==n?n:{};return!0===r.audio&&(r.audio={}),!0===r.video&&(r.video={}),r.audio&&Rr(r.audio,e),r.video&&Rr(r.video,i),r}function Rr(t,e){return Object.keys(e).forEach((i=>{void 0===t[i]&&(t[i]=e[i])})),t}function Ir(t){const e={};if(t.video)if("object"==typeof t.video){const i={},n=i,r=t.video;Object.keys(r).forEach((t=>{"resolution"===t?Rr(n,r.resolution):n[t]=r[t]})),e.video=i}else e.video=t.video;else e.video=!1;return t.audio?"object"==typeof t.audio?e.audio=t.audio:e.audio=!0:e.audio=!1,e}function Dr(){const t="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);if(t)return new t({latencyHint:"interactive"})}function Mr(t){const e=t.split("/")[1].toLowerCase();if(!Dn.includes(e))throw Error("Video codec not supported: ".concat(e));return e}function Ar(t){const e=[];return t.forEach((t=>{void 0!==t.track&&e.push(new Kn({cid:t.track.mediaStreamID,track:t.trackInfo}))})),e}!function(t){let e,i,n;!function(t){t.Audio="audio",t.Video="video",t.Unknown="unknown"}(e=t.Kind||(t.Kind={})),function(t){t.Camera="camera",t.Microphone="microphone",t.ScreenShare="screen_share",t.ScreenShareAudio="screen_share_audio",t.Unknown="unknown"}(i=t.Source||(t.Source={})),function(t){t.Active="active",t.Paused="paused",t.Unknown="unknown"}(n=t.StreamState||(t.StreamState={})),t.kindToProto=function(t){switch(t){case e.Audio:return Kt.AUDIO;case e.Video:return Kt.VIDEO;default:return Kt.DATA}},t.kindFromProto=function(t){switch(t){case Kt.AUDIO:return e.Audio;case Kt.VIDEO:return e.Video;default:return e.Unknown}},t.sourceToProto=function(t){switch(t){case i.Camera:return Yt.CAMERA;case i.Microphone:return Yt.MICROPHONE;case i.ScreenShare:return Yt.SCREEN_SHARE;case i.ScreenShareAudio:return Yt.SCREEN_SHARE_AUDIO;default:return Yt.UNKNOWN}},t.sourceFromProto=function(t){switch(t){case Yt.CAMERA:return i.Camera;case Yt.MICROPHONE:return i.Microphone;case Yt.SCREEN_SHARE:return i.ScreenShare;case Yt.SCREEN_SHARE_AUDIO:return i.ScreenShareAudio;default:return i.Unknown}},t.streamStateFromProto=function(t){switch(t){case Fn.ACTIVE:return n.Active;case Fn.PAUSED:return n.Paused;default:return n.Unknown}}}(_r||(_r={}));const Nr="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Lr(t){return Ae(this,void 0,void 0,(function*(){return new Promise((e=>xn.setTimeout(e,t)))}))}function Or(){return"addTransceiver"in RTCPeerConnection.prototype}function Ur(){return"addTrack"in RTCPeerConnection.prototype}function Fr(t){return"av1"===t||"vp9"===t}function Br(t){return!!document&&(t||(t=document.createElement("audio")),"setSinkId"in t)}const Gr={Chrome:"100",Safari:"15",Firefox:"100"};function Vr(){var t;return"Firefox"===(null===(t=_n())||void 0===t?void 0:t.name)}function jr(){var t;return"Safari"===(null===(t=_n())||void 0===t?void 0:t.name)}function Jr(){return!!qr()&&/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent)}function qr(){return"undefined"!=typeof document}function Wr(){return"ReactNative"==navigator.product}function Hr(t){return t.hostname.endsWith(".livekit.cloud")||t.hostname.endsWith(".livekit.run")}function zr(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function Kr(){if(!Wr())return;let t=zr();return t?t.platform:void 0}function Yr(){if(qr())return window.devicePixelRatio;if(Wr()){let t=zr();if(t)return t.devicePixelRatio}return 1}function Xr(t,e){const i=t.split("."),n=e.split("."),r=Math.min(i.length,n.length);for(let t=0;t<r;++t){const e=parseInt(i[t],10),s=parseInt(n[t],10);if(e>s)return 1;if(e<s)return-1;if(t===r-1&&e===s)return 0}return""===t&&""!==e?-1:""===e?1:i.length==n.length?0:i.length<n.length?-1:1}function Qr(t){for(const e of t)e.target.handleResize(e)}function Zr(t){for(const e of t)e.target.handleVisibilityChanged(e)}let $r=null;const ts=()=>($r||($r=new ResizeObserver(Qr)),$r);let es=null;const is=()=>(es||(es=new IntersectionObserver(Zr,{root:null,rootMargin:"0px"})),es);let ns;function rs(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=document.createElement("canvas");r.width=t,r.height=e;const s=r.getContext("2d");null==s||s.fillRect(0,0,r.width,r.height),n&&s&&(s.beginPath(),s.arc(t/2,e/2,50,0,2*Math.PI,!0),s.closePath(),s.fillStyle="grey",s.fill());const a=r.captureStream(),[o]=a.getTracks();if(!o)throw Error("Could not get empty media stream video track");return o.enabled=i,o}function ss(){if(!ns){const t=new AudioContext,e=t.createOscillator(),i=t.createGain();i.gain.setValueAtTime(0,0);const n=t.createMediaStreamDestination();if(e.connect(i),i.connect(n),e.start(),[ns]=n.stream.getAudioTracks(),!ns)throw Error("Could not get empty media stream audio track");ns.enabled=!1}return ns.clone()}class as{constructor(t,e){this.onFinally=e,this.promise=new Promise(((e,i)=>Ae(this,void 0,void 0,(function*(){this.resolve=e,this.reject=i,t&&(yield t(e,i))})))).finally((()=>{var t;return null===(t=this.onFinally)||void 0===t?void 0:t.call(this)}))}}class os{constructor(){this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let t;this._locks+=1;const e=new Promise((e=>t=()=>{this._locks-=1,e()})),i=this._locking.then((()=>t));return this._locking=this._locking.then((()=>e)),i}}function cs(t){if("string"==typeof t)return t;if(Array.isArray(t))return t[0];if(t.exact)return Array.isArray(t.exact)?t.exact[0]:t.exact;if(t.ideal)return Array.isArray(t.ideal)?t.ideal[0]:t.ideal;throw Error("could not unwrap constraint")}function ds(t){return t.startsWith("ws")?t.replace(/^(ws)/,"http"):t}const hs="default";class ls{static getInstance(){return void 0===this.instance&&(this.instance=new ls),this.instance}getDevices(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var i;return Ae(this,void 0,void 0,(function*(){if((null===(i=ls.userMediaPromiseMap)||void 0===i?void 0:i.size)>0){P.debug("awaiting getUserMedia promise");try{t?yield ls.userMediaPromiseMap.get(t):yield Promise.all(ls.userMediaPromiseMap.values())}catch(t){P.warn("error waiting for media permissons")}}let n=yield navigator.mediaDevices.enumerateDevices();if(e&&(!jr()||!this.hasDeviceInUse(t))&&(0===n.length||n.some((e=>{const i=""===e.label,n=!t||e.kind===t;return i&&n})))){const e={video:"audioinput"!==t&&"audiooutput"!==t,audio:"videoinput"!==t},i=yield navigator.mediaDevices.getUserMedia(e);n=yield navigator.mediaDevices.enumerateDevices(),i.getTracks().forEach((t=>{t.stop()}))}return t&&(n=n.filter((e=>e.kind===t))),n}))}normalizeDeviceId(t,e,i){return Ae(this,void 0,void 0,(function*(){if(e!==hs)return e;const n=(yield this.getDevices(t)).find((t=>t.groupId===i&&t.deviceId!==hs));return null==n?void 0:n.deviceId}))}hasDeviceInUse(t){return t?ls.userMediaPromiseMap.has(t):ls.userMediaPromiseMap.size>0}}ls.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],ls.userMediaPromiseMap=new Map;class us extends _r{get constraints(){return this._constraints}constructor(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(t,e),this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch((()=>P.debug("track mute bounce got cancelled by an unmute event"))),this.debouncedTrackMuteHandler=Tn((()=>Ae(this,void 0,void 0,(function*(){yield this.pauseUpstream()}))),5e3),this.handleTrackUnmuteEvent=()=>Ae(this,void 0,void 0,(function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()})),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(pn.Ended,this)},this.reacquireTrack=!1,this.providedByUser=n,this.muteLock=new os,this.pauseUpstreamLock=new os,this.processorLock=new os,this.setMediaStreamTrack(t,!0),this._constraints=t.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==_r.Kind.Video)return;const{width:t,height:e}=this._mediaStreamTrack.getSettings();return t&&e?{width:t,height:e}:void 0}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var t,e;return null!==(e=null===(t=this.processor)||void 0===t?void 0:t.processedTrack)&&void 0!==e?e:this._mediaStreamTrack}setMediaStreamTrack(t,e){return Ae(this,void 0,void 0,(function*(){if(t===this._mediaStreamTrack&&!e)return;let i;if(this._mediaStreamTrack&&(this.attachedElements.forEach((t=>{Er(this._mediaStreamTrack,t)})),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.providedByUser||this._mediaStreamTrack===t||this._mediaStreamTrack.stop()),this.mediaStream=new MediaStream([t]),t&&(t.addEventListener("ended",this.handleEnded),t.addEventListener("mute",this.handleTrackMuteEvent),t.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=t.getConstraints()),this.processor&&t&&this.processorElement){if(P.debug("restarting processor"),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");Pr(t,this.processorElement),yield this.processor.restart({track:t,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}this.sender&&(yield this.sender.replaceTrack(null!=i?i:t)),this._mediaStreamTrack=t,t&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach((e=>{Pr(null!=i?i:t,e)})))}))}waitForDimensions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;var e;return Ae(this,void 0,void 0,(function*(){if(this.kind===_r.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");"iOS"===(null===(e=_n())||void 0===e?void 0:e.os)&&(yield Lr(10));const i=Date.now();for(;Date.now()-i<t;){const t=this.dimensions;if(t)return t;yield Lr(50)}throw new yn("unable to get track dimensions after timeout")}))}getDeviceId(){return Ae(this,void 0,void 0,(function*(){if(this.source===_r.Source.ScreenShare)return;const{deviceId:t,groupId:e}=this._mediaStreamTrack.getSettings(),i=this.kind===_r.Kind.Audio?"audioinput":"videoinput";return ls.getInstance().normalizeDeviceId(i,t,e)}))}mute(){return Ae(this,void 0,void 0,(function*(){return this.setTrackMuted(!0),this}))}unmute(){return Ae(this,void 0,void 0,(function*(){return this.setTrackMuted(!1),this}))}replaceTrack(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Ae(this,void 0,void 0,(function*(){if(!this.sender)throw new yn("unable to replace an unpublished track");return P.debug("replace MediaStreamTrack"),yield this.setMediaStreamTrack(t),this.providedByUser=e,this.processor&&(yield this.stopProcessor()),this}))}restart(t){return Ae(this,void 0,void 0,(function*(){t||(t=this._constraints),P.debug("restarting track with constraints",t);const e={audio:!1,video:!1};this.kind===_r.Kind.Video?e.video=t:e.audio=t,this.attachedElements.forEach((t=>{Er(this.mediaStreamTrack,t)})),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const i=(yield navigator.mediaDevices.getUserMedia(e)).getTracks()[0];return i.addEventListener("ended",this.handleEnded),P.debug("re-acquired MediaStreamTrack"),yield this.setMediaStreamTrack(i),this._constraints=t,this.emit(pn.Restarted,this),this}))}setTrackMuted(t){P.debug("setting ".concat(this.kind," track ").concat(t?"muted":"unmuted")),this.isMuted===t&&this._mediaStreamTrack.enabled!==t||(this.isMuted=t,this._mediaStreamTrack.enabled=!t,this.emit(t?pn.Muted:pn.Unmuted,this))}get needsReAcquisition(){return"live"!==this._mediaStreamTrack.readyState||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Ae(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this),Jr()&&(P.debug("visibility changed, is in Background: ".concat(this.isInBackground)),this.isInBackground||!this.needsReAcquisition||this.isUserProvided||this.isMuted||(P.debug("track needs to be reacquired, restarting ".concat(this.source)),yield this.restart(),this.reacquireTrack=!1))}))}stop(){var t;super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),null===(t=this.processor)||void 0===t||t.destroy(),this.processor=void 0}pauseUpstream(){return Ae(this,void 0,void 0,(function*(){const t=yield this.pauseUpstreamLock.lock();try{if(!0===this._isUpstreamPaused)return;if(!this.sender)return void P.warn("unable to pause upstream for an unpublished track");this._isUpstreamPaused=!0,this.emit(pn.UpstreamPaused,this);const t=_n();if("Safari"===(null==t?void 0:t.name)&&Xr(t.version,"12.0")<0)throw new vn("pauseUpstream is not supported on Safari < 12.");yield this.sender.replaceTrack(null)}finally{t()}}))}resumeUpstream(){return Ae(this,void 0,void 0,(function*(){const t=yield this.pauseUpstreamLock.lock();try{if(!1===this._isUpstreamPaused)return;if(!this.sender)return void P.warn("unable to resume upstream for an unpublished track");this._isUpstreamPaused=!1,this.emit(pn.UpstreamResumed,this),yield this.sender.replaceTrack(this._mediaStreamTrack)}finally{t()}}))}getRTCStatsReport(){var t;return Ae(this,void 0,void 0,(function*(){if(null===(t=this.sender)||void 0===t?void 0:t.getStats)return yield this.sender.getStats()}))}setProcessor(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var i,n;return Ae(this,void 0,void 0,(function*(){const r=yield this.processorLock.lock();try{if(P.debug("setting up processor"),this.processor&&(yield this.stopProcessor()),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");this.processorElement=null!==(i=this.processorElement)&&void 0!==i?i:document.createElement(this.kind),this.processorElement.muted=!0,Pr(this._mediaStreamTrack,this.processorElement),this.processorElement.play().catch((t=>P.error("failed to play processor element",{error:t})));const r={kind:this.kind,track:this._mediaStreamTrack,element:this.processorElement};if(yield t.init(r),this.processor=t,this.processor.processedTrack){for(const t of this.attachedElements)t!==this.processorElement&&e&&(Er(this._mediaStreamTrack,t),Pr(this.processor.processedTrack,t));yield null===(n=this.sender)||void 0===n?void 0:n.replaceTrack(this.processor.processedTrack)}}finally{r()}}))}getProcessor(){return this.processor}stopProcessor(){var t,e;return Ae(this,void 0,void 0,(function*(){this.processor&&(P.debug("stopping processor"),null===(t=this.processor.processedTrack)||void 0===t||t.stop(),yield this.processor.destroy(),this.processor=void 0,null===(e=this.processorElement)||void 0===e||e.remove(),this.processorElement=void 0,yield this.restart())}))}}class ps extends Qe.EventEmitter{constructor(t){super(),this.onWorkerMessage=t=>{var e,i;const{kind:n,data:r}=t.data;switch(n){case"error":P.error(r.error.message),this.emit(on.EncryptionError,r.error);break;case"initAck":r.enabled&&this.keyProvider.getKeys().forEach((t=>{this.postKey(t)}));break;case"enable":if(this.encryptionEnabled!==r.enabled&&r.participantIdentity===(null===(e=this.room)||void 0===e?void 0:e.localParticipant.identity))this.emit(on.ParticipantEncryptionStatusChanged,r.enabled,this.room.localParticipant),this.encryptionEnabled=r.enabled;else if(r.participantIdentity){const t=null===(i=this.room)||void 0===i?void 0:i.getParticipantByIdentity(r.participantIdentity);if(!t)throw TypeError("couldn't set encryption status, participant not found".concat(r.participantIdentity));this.emit(on.ParticipantEncryptionStatusChanged,r.enabled,t)}this.encryptionEnabled&&this.keyProvider.getKeys().forEach((t=>{this.postKey(t)}));break;case"ratchetKey":this.keyProvider.emit(sn.KeyRatcheted,r.material,r.keyIndex)}},this.onWorkerError=t=>{P.error("e2ee worker encountered an error:",{error:t.error}),this.emit(on.EncryptionError,t.error)},this.keyProvider=t.keyProvider,this.worker=t.worker,this.encryptionEnabled=!1}setup(t){if(!(void 0!==window.RTCRtpSender&&void 0!==window.RTCRtpSender.prototype.createEncodedStreams||mn()))throw new vn("tried to setup end-to-end encryption on an unsupported browser");if(P.info("setting up e2ee"),t!==this.room){this.room=t,this.setupEventListeners(t,this.keyProvider);const e={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions()}};this.worker&&(P.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(e))}}setParticipantCryptorEnabled(t,e){P.debug("set e2ee to ".concat(t," for participant ").concat(e)),this.postEnable(t,e)}setSifTrailer(t){t&&0!==t.length?this.postSifTrailer(t):P.warn("ignoring server sent trailer as it's empty")}setupEngine(t){t.on(un.RTPVideoMapUpdate,(t=>{this.postRTPMap(t)}))}setupEventListeners(t,e){t.on(hn.TrackPublished,((t,e)=>this.setParticipantCryptorEnabled(t.trackInfo.encryption!==he.NONE,e.identity))),t.on(hn.ConnectionStateChanged,(e=>{e===Ea.Connected&&t.participants.forEach((t=>{t.tracks.forEach((e=>{this.setParticipantCryptorEnabled(e.trackInfo.encryption!==he.NONE,t.identity)}))}))})).on(hn.TrackUnsubscribed,((t,e,i)=>{var n;const r={kind:"removeTransform",data:{participantIdentity:i.identity,trackId:t.mediaStreamID}};null===(n=this.worker)||void 0===n||n.postMessage(r)})).on(hn.TrackSubscribed,((t,e,i)=>{this.setupE2EEReceiver(t,i.identity,e.trackInfo)})).on(hn.SignalConnected,(()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity),e.getKeys().forEach((t=>{this.postKey(t)}))})),t.localParticipant.on(ln.LocalTrackPublished,(t=>Ae(this,void 0,void 0,(function*(){this.setupE2EESender(t.track,t.track.sender)})))),e.on(sn.SetKey,(t=>this.postKey(t))).on(sn.RatchetRequest,((t,e)=>this.postRatchetRequest(t,e)))}postRatchetRequest(t,e){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:t,keyIndex:e}};this.worker.postMessage(i)}postKey(t){let{key:e,participantIdentity:i,keyIndex:n}=t;var r;if(!this.worker)throw Error("could not set key, worker is missing");const s={kind:"setKey",data:{participantIdentity:i,isPublisher:i===(null===(r=this.room)||void 0===r?void 0:r.localParticipant.identity),key:e,keyIndex:n}};this.worker.postMessage(s)}postEnable(t,e){if(!this.worker)throw new ReferenceError("failed to enable e2ee, worker is not ready");{const i={kind:"enable",data:{enabled:t,participantIdentity:e}};this.worker.postMessage(i)}}postRTPMap(t){var e;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(null===(e=this.room)||void 0===e?void 0:e.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:t,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(t){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const e={kind:"setSifTrailer",data:{trailer:t}};this.worker.postMessage(e)}setupE2EEReceiver(t,e,i){if(t.receiver){if(!(null==i?void 0:i.mimeType)||""===i.mimeType)throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(t.receiver,t.mediaStreamID,e,"video"===t.kind?Mr(i.mimeType):void 0)}}setupE2EESender(t,e){t instanceof us&&e?this.handleSender(e,t.mediaStreamID,void 0):e||P.warn("early return because sender is not ready")}handleReceiver(t,e,i,n){return Ae(this,void 0,void 0,(function*(){if(this.worker){if(mn()){const r={kind:"decode",participantIdentity:i,trackId:e,codec:n};t.transform=new RTCRtpScriptTransform(this.worker,r)}else{if(rn in t&&n){const t={kind:"updateCodec",data:{trackId:e,codec:n,participantIdentity:i}};return void this.worker.postMessage(t)}let r=t.writableStream,s=t.readableStream;if(!r||!s){const e=t.createEncodedStreams();t.writableStream=e.writable,r=e.writable,t.readableStream=e.readable,s=e.readable}const a={kind:"decode",data:{readableStream:s,writableStream:r,trackId:e,codec:n,participantIdentity:i}};this.worker.postMessage(a,[s,r])}t[rn]=!0}}))}handleSender(t,e,i){var n;if(!(rn in t)&&this.worker){if(!(null===(n=this.room)||void 0===n?void 0:n.localParticipant.identity)||""===this.room.localParticipant.identity)throw TypeError("local identity needs to be known in order to set up encrypted sender");if(mn()){P.info("initialize script transform");const n={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:e,codec:i};t.transform=new RTCRtpScriptTransform(this.worker,n)}else{P.info("initialize encoded streams");const n=t.createEncodedStreams(),r={kind:"encode",data:{readableStream:n.readable,writableStream:n.writable,codec:i,trackId:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r,[n.readable,n.writable])}t[rn]=!0}}}var ms;!function(t){t[t.WAITING=0]="WAITING",t[t.RUNNING=1]="RUNNING",t[t.COMPLETED=2]="COMPLETED"}(ms||(ms={}));class fs{constructor(){this.pendingTasks=new Map,this.taskMutex=new os,this.nextTaskIndex=0}run(t){return Ae(this,void 0,void 0,(function*(){const e={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:ms.WAITING};this.pendingTasks.set(e.id,e);const i=yield this.taskMutex.lock();try{return e.executedAt=Date.now(),e.status=ms.RUNNING,yield t()}finally{e.status=ms.COMPLETED,this.pendingTasks.delete(e.id),i()}}))}flush(){return Ae(this,void 0,void 0,(function*(){return this.run((()=>Ae(this,void 0,void 0,(function*(){}))))}))}snapshot(){return Array.from(this.pendingTasks.values())}}const gs=["syncState","trickle","offer","answer","simulate","leave"];var vs;!function(t){t[t.CONNECTING=0]="CONNECTING",t[t.CONNECTED=1]="CONNECTED",t[t.RECONNECTING=2]="RECONNECTING",t[t.DISCONNECTING=3]="DISCONNECTING",t[t.DISCONNECTED=4]="DISCONNECTED"}(vs||(vs={}));class ys{get currentState(){return this.state}get isDisconnected(){return this.state===vs.DISCONNECTING||this.state===vs.DISCONNECTED}constructor(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.rtt=0,this.state=vs.DISCONNECTED,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.useJSON=t,this.requestQueue=new fs,this.queuedRequests=[],this.closingLock=new os,this.connectionLock=new os,this.state=vs.DISCONNECTED}join(t,e,i,n){return Ae(this,void 0,void 0,(function*(){return this.state=vs.CONNECTING,this.options=i,yield this.connect(t,e,i,n)}))}reconnect(t,e,i,n){return Ae(this,void 0,void 0,(function*(){if(this.options)return this.state=vs.RECONNECTING,this.clearPingInterval(),yield this.connect(t,e,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:n}));P.warn("attempted to reconnect without signal options being set, ignoring")}))}connect(t,e,i,n){this.connectOptions=i,t=(t=function(t){return t.startsWith("http")?t.replace(/^(http)/,"ws"):t}(t)).replace(/\/$/,""),t+="/rtc";const r=function(t,e,i){var n;const r=new URLSearchParams;return r.set("access_token",t),i.reconnect&&(r.set("reconnect","1"),i.sid&&r.set("sid",i.sid)),r.set("auto_subscribe",i.autoSubscribe?"1":"0"),r.set("sdk",Wr()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),void 0!==i.publishOnly&&r.set("publish",i.publishOnly),i.adaptiveStream&&r.set("adaptive_stream","1"),i.reconnectReason&&r.set("reconnect_reason",i.reconnectReason.toString()),(null===(n=navigator.connection)||void 0===n?void 0:n.type)&&r.set("network",navigator.connection.type),"?".concat(r.toString())}(e,function(){var t;const e=new Ce({sdk:pe.JS,protocol:11,version:"1.15.4"});return Wr()&&(e.os=null!==(t=Kr())&&void 0!==t?t:""),e}(),i);return new Promise(((e,s)=>Ae(this,void 0,void 0,(function*(){const a=yield this.connectionLock.lock();try{const a=()=>Ae(this,void 0,void 0,(function*(){this.close(),clearTimeout(o),s(new gn("room connection has been cancelled (signal)"))})),o=setTimeout((()=>{this.close(),s(new gn("room connection has timed out (signal)"))}),i.websocketTimeout);(null==n?void 0:n.aborted)&&a(),null==n||n.addEventListener("abort",a),P.debug("connecting to ".concat(t+r)),this.ws&&(yield this.close()),this.ws=new WebSocket(t+r),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(o)},this.ws.onerror=e=>Ae(this,void 0,void 0,(function*(){if(this.state===vs.CONNECTED)this.handleWSError(e);else{clearTimeout(o);try{const e=yield fetch("http".concat(t.substring(2),"/validate").concat(r));if(e.status.toFixed(0).startsWith("4")){const t=yield e.text();s(new gn(t,0,e.status))}else s(new gn("Internal error",2,e.status))}catch(t){s(new gn("server was not reachable",1))}}})),this.ws.onmessage=t=>Ae(this,void 0,void 0,(function*(){var r,o,c,d;let h;if("string"==typeof t.data){const e=JSON.parse(t.data);h=Vn.fromJson(e)}else{if(!(t.data instanceof ArrayBuffer))return void P.error("could not decode websocket message: ".concat(typeof t.data));h=Vn.fromBinary(new Uint8Array(t.data))}if(this.state!==vs.CONNECTED){let t=!1;if("join"===(null===(r=h.message)||void 0===r?void 0:r.case)?(this.state=vs.CONNECTED,null==n||n.removeEventListener("abort",a),this.pingTimeoutDuration=h.message.value.pingTimeout,this.pingIntervalDuration=h.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(P.debug("ping config",{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration}),this.startPingInterval()),e(h.message.value)):this.state===vs.RECONNECTING?(this.state=vs.CONNECTED,null==n||n.removeEventListener("abort",a),this.startPingInterval(),"reconnect"===(null===(o=h.message)||void 0===o?void 0:o.case)?e(null===(c=h.message)||void 0===c?void 0:c.value):(e(),t=!0)):i.reconnect||s(new gn("did not receive join response, got ".concat(null===(d=h.message)||void 0===d?void 0:d.case," instead"))),!t)return}this.signalLatency&&(yield Lr(this.signalLatency)),this.handleSignalResponse(h)})),this.ws.onclose=t=>{P.warn("websocket closed",{ev:t}),this.handleOnClose(t.reason)}}finally{a()}}))))}close(){return Ae(this,void 0,void 0,(function*(){const t=yield this.closingLock.lock();try{if(this.state=vs.DISCONNECTING,this.ws){this.ws.onmessage=null,this.ws.onopen=null,this.ws.onclose=null;const t=new Promise((t=>{this.ws?this.ws.onclose=()=>{t()}:t()}));this.ws.readyState<this.ws.CLOSING&&(this.ws.close(),yield Promise.race([t,Lr(250)])),this.ws=void 0}}finally{this.state=vs.DISCONNECTED,this.clearPingInterval(),t()}}))}sendOffer(t){P.debug("sending offer",t),this.sendRequest({case:"offer",value:ks(t)})}sendAnswer(t){return P.debug("sending answer"),this.sendRequest({case:"answer",value:ks(t)})}sendIceCandidate(t,e){return P.trace("sending ice candidate",t),this.sendRequest({case:"trickle",value:new qn({candidateInit:JSON.stringify(t),target:e})})}sendMuteTrack(t,e){return this.sendRequest({case:"mute",value:new Wn({sid:t,muted:e})})}sendAddTrack(t){return this.sendRequest({case:"addTrack",value:t})}sendUpdateLocalMetadata(t,e){return this.sendRequest({case:"updateMetadata",value:new ir({metadata:t,name:e})})}sendUpdateTrackSettings(t){this.sendRequest({case:"trackSetting",value:t})}sendUpdateSubscription(t){return this.sendRequest({case:"subscription",value:t})}sendSyncState(t){return this.sendRequest({case:"syncState",value:t})}sendUpdateVideoLayers(t,e){return this.sendRequest({case:"updateLayers",value:new er({trackSid:t,layers:e})})}sendUpdateSubscriptionPermissions(t,e){return this.sendRequest({case:"subscriptionPermission",value:new mr({allParticipants:t,trackPermissions:e})})}sendSimulateScenario(t){return this.sendRequest({case:"simulate",value:t})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:$.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new br({timestamp:$.parse(Date.now()),rtt:$.parse(this.rtt)})})])}sendLeave(){return this.sendRequest({case:"leave",value:new tr({canReconnect:!1,reason:$t.CLIENT_INITIATED})})}sendRequest(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Ae(this,void 0,void 0,(function*(){const i=!e&&!function(t){const e=gs.indexOf(t.case)>=0;return P.trace("request allowed to bypass queue:",{canPass:e,req:t}),e}(t);if(i&&this.state===vs.RECONNECTING)return void this.queuedRequests.push((()=>Ae(this,void 0,void 0,(function*(){yield this.sendRequest(t,!0)}))));if(e||(yield this.requestQueue.flush()),this.signalLatency&&(yield Lr(this.signalLatency)),!this.ws||this.ws.readyState!==this.ws.OPEN)return void P.error("cannot send signal request before connected, type: ".concat(null==t?void 0:t.case));const n=new Gn({message:t});try{this.useJSON?this.ws.send(n.toJsonString()):this.ws.send(n.toBinary())}catch(t){P.error("error sending signal message",{error:t})}}))}handleSignalResponse(t){var e,i;const n=t.message;if(null==n)return void P.debug("received unsupported message");let r=!1;if("answer"===n.case){const t=bs(n.value);this.onAnswer&&this.onAnswer(t)}else if("offer"===n.case){const t=bs(n.value);this.onOffer&&this.onOffer(t)}else if("trickle"===n.case){const t=JSON.parse(n.value.candidateInit);this.onTrickle&&this.onTrickle(t,n.value.target)}else"update"===n.case?this.onParticipantUpdate&&this.onParticipantUpdate(null!==(e=n.value.participants)&&void 0!==e?e:[]):"trackPublished"===n.case?this.onLocalTrackPublished&&this.onLocalTrackPublished(n.value):"speakersChanged"===n.case?this.onSpeakersChanged&&this.onSpeakersChanged(null!==(i=n.value.speakers)&&void 0!==i?i:[]):"leave"===n.case?this.onLeave&&this.onLeave(n.value):"mute"===n.case?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(n.value.sid,n.value.muted):"roomUpdate"===n.case?this.onRoomUpdate&&n.value.room&&this.onRoomUpdate(n.value.room):"connectionQuality"===n.case?this.onConnectionQuality&&this.onConnectionQuality(n.value):"streamStateUpdate"===n.case?this.onStreamStateUpdate&&this.onStreamStateUpdate(n.value):"subscribedQualityUpdate"===n.case?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(n.value):"subscriptionPermissionUpdate"===n.case?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(n.value):"refreshToken"===n.case?this.onTokenRefresh&&this.onTokenRefresh(n.value):"trackUnpublished"===n.case?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(n.value):"subscriptionResponse"===n.case?this.onSubscriptionError&&this.onSubscriptionError(n.value):"pong"===n.case||("pongResp"===n.case?(this.rtt=Date.now()-Number.parseInt(n.value.lastPingTimestamp.toString()),this.resetPingTimeout(),r=!0):P.debug("unsupported message",n));r||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const t=this.queuedRequests.shift();t&&this.requestQueue.run(t)}}handleOnClose(t){return Ae(this,void 0,void 0,(function*(){if(this.state===vs.DISCONNECTED)return;const e=this.onClose;yield this.close(),P.debug("websocket connection closed: ".concat(t)),e&&e(t)}))}handleWSError(t){P.error("websocket error",t)}resetPingTimeout(){this.clearPingTimeout(),this.pingTimeoutDuration?this.pingTimeout=xn.setTimeout((()=>{P.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-1e3*this.pingTimeoutDuration).toUTCString())),this.handleOnClose("ping timeout")}),1e3*this.pingTimeoutDuration):P.warn("ping timeout duration not set")}clearPingTimeout(){this.pingTimeout&&xn.clearTimeout(this.pingTimeout)}startPingInterval(){this.clearPingInterval(),this.resetPingTimeout(),this.pingIntervalDuration?(P.debug("start ping interval"),this.pingInterval=xn.setInterval((()=>{this.sendPing()}),1e3*this.pingIntervalDuration)):P.warn("ping interval duration not set")}clearPingInterval(){P.debug("clearing ping interval"),this.clearPingTimeout(),this.pingInterval&&xn.clearInterval(this.pingInterval)}}function bs(t){const e={type:"offer",sdp:t.sdp};switch(t.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=t.type}return e}function ks(t){return new Xn({sdp:t.sdp,type:t.type})}var Ss={},Ts={exports:{}},ws=Ts.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(t){return t.encoding?"rtpmap:%d %s/%s/%s":t.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(t){return null!=t.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(t){return null!=t.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(t){return"extmap:%d"+(t.direction?"/%s":"%v")+(t["encrypt-uri"]?" %s":"%v")+" %s"+(t.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(t){return null!=t.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(t){var e="candidate:%s %d %s %d %s %d typ %s";return e+=null!=t.raddr?" raddr %s rport %d":"%v%v",e+=null!=t.tcptype?" tcptype %s":"%v",null!=t.generation&&(e+=" generation %d"),(e+=null!=t["network-id"]?" network-id %d":"%v")+(null!=t["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(t){var e="ssrc:%d";return null!=t.attribute&&(e+=" %s",null!=t.value&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(t){return null!=t.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(t){return t.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(t){return"imageattr:%s %s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(t){return"simulcast:%s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(t){return"ts-refclk:%s"+(null!=t.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(t){var e="mediaclk:";return e+=null!=t.id?"id=%s %s":"%v%s",e+=null!=t.mediaClockValue?"=%s":"",(e+=null!=t.rateNumerator?" rate=%s":"")+(null!=t.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(ws).forEach((function(t){ws[t].forEach((function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")}))}));var Cs=Ts.exports;!function(t){var e=function(t){return String(Number(t))===t?Number(t):t},i=function(t,i,n){var r=t.name&&t.names;t.push&&!i[t.push]?i[t.push]=[]:r&&!i[t.name]&&(i[t.name]={});var s=t.push?{}:r?i[t.name]:i;!function(t,i,n,r){if(r&&!n)i[r]=e(t[1]);else for(var s=0;s<n.length;s+=1)null!=t[s+1]&&(i[n[s]]=e(t[s+1]))}(n.match(t.reg),s,t.names,t.name),t.push&&i[t.push].push(s)},n=Cs,r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(t){var e={},s=[],a=e;return t.split(/(\r\n|\r|\n)/).filter(r).forEach((function(t){var e=t[0],r=t.slice(2);"m"===e&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var o=0;o<(n[e]||[]).length;o+=1){var c=n[e][o];if(c.reg.test(r))return i(c,a,r)}})),e.media=s,e};var s=function(t,i){var n=i.split(/=(.+)/,2);return 2===n.length?t[n[0]]=e(n[1]):1===n.length&&i.length>1&&(t[n[0]]=void 0),t};t.parseParams=function(t){return t.split(/;\s?/).reduce(s,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(t){return t.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(t){for(var i=[],n=t.split(" ").map(e),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},t.parseImageAttributes=function(t){return t.split(" ").map((function(t){return t.substring(1,t.length-1).split(",").reduce(s,{})}))},t.parseSimulcastStreamList=function(t){return t.split(";").map((function(t){return t.split(",").map((function(t){var i,n=!1;return"~"!==t[0]?i=e(t):(i=e(t.substring(1,t.length)),n=!0),{scid:i,paused:n}}))}))}}(Ss);var _s=Cs,Ps=/%[sdv%]/g,Es=function(t){var e=1,i=arguments,n=i.length;return t.replace(Ps,(function(t){if(e>=n)return t;var r=i[e];switch(e+=1,t){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}}))},xs=function(t,e,i){var n=[t+"="+(e.format instanceof Function?e.format(e.push?i:i[e.name]):e.format)];if(e.names)for(var r=0;r<e.names.length;r+=1){var s=e.names[r];e.name?n.push(i[e.name][s]):n.push(i[e.names[r]])}else n.push(i[e.name]);return Es.apply(null,n)},Rs=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Is=["i","c","b","a"],Ds=function(t,e){e=e||{},null==t.version&&(t.version=0),null==t.name&&(t.name=" "),t.media.forEach((function(t){null==t.payloads&&(t.payloads="")}));var i=e.outerOrder||Rs,n=e.innerOrder||Is,r=[];return i.forEach((function(e){_s[e].forEach((function(i){i.name in t&&null!=t[i.name]?r.push(xs(e,i,t)):i.push in t&&null!=t[i.push]&&t[i.push].forEach((function(t){r.push(xs(e,i,t))}))}))})),t.media.forEach((function(t){r.push(xs("m",_s.m[0],t)),n.forEach((function(e){_s[e].forEach((function(i){i.name in t&&null!=t[i.name]?r.push(xs(e,i,t)):i.push in t&&null!=t[i.push]&&t[i.push].forEach((function(t){r.push(xs(e,i,t))}))}))}))})),r.join("\r\n")+"\r\n"},Ms=Ss.parse;const As="negotiationStarted",Ns="negotiationComplete",Ls="rtpVideoPayloadTypes";class Os extends Qe.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Tn((t=>Ae(this,void 0,void 0,(function*(){this.emit(As);try{yield this.createAndSendOffer()}catch(e){if(!t)throw e;t(e)}}))),100),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.config=t,this.mediaConstraints=e,this._pc=this.createPC()}createPC(){const t="Chrome"===(null===(e=_n())||void 0===e?void 0:e.name)?new RTCPeerConnection(this.config,this.mediaConstraints):new RTCPeerConnection(this.config);var e;return t.onicecandidate=t=>{var e;t.candidate&&(null===(e=this.onIceCandidate)||void 0===e||e.call(this,t.candidate))},t.onicecandidateerror=t=>{var e;null===(e=this.onIceCandidateError)||void 0===e||e.call(this,t)},t.oniceconnectionstatechange=()=>{var e;null===(e=this.onIceConnectionStateChange)||void 0===e||e.call(this,t.iceConnectionState)},t.onsignalingstatechange=()=>{var e;null===(e=this.onSignalingStatechange)||void 0===e||e.call(this,t.signalingState)},t.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,t.connectionState)},t.ondatachannel=t=>{var e;null===(e=this.onDataChannel)||void 0===e||e.call(this,t)},t.ontrack=t=>{var e;null===(e=this.onTrack)||void 0===e||e.call(this,t)},t}get isICEConnected(){return null!==this._pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}addIceCandidate(t){return Ae(this,void 0,void 0,(function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(t);this.pendingCandidates.push(t)}))}setRemoteDescription(t){var e;return Ae(this,void 0,void 0,(function*(){let i;if("offer"===t.type){let{stereoMids:e,nackMids:i}=function(t){var e;const i=[],n=[],r=Ms(null!==(e=t.sdp)&&void 0!==e?e:"");let s=0;return r.media.forEach((t=>{var e;"audio"===t.type&&(t.rtp.some((t=>"opus"===t.codec&&(s=t.payload,!0))),(null===(e=t.rtcpFb)||void 0===e?void 0:e.some((t=>t.payload===s&&"nack"===t.type)))&&n.push(t.mid),t.fmtp.some((e=>e.payload===s&&(e.config.includes("sprop-stereo=1")&&i.push(t.mid),!0))))})),{stereoMids:i,nackMids:n}}(t);this.remoteStereoMids=e,this.remoteNackMids=i}else if("answer"===t.type){const n=Ms(null!==(e=t.sdp)&&void 0!==e?e:"");n.media.forEach((t=>{"audio"===t.type&&this.trackBitrates.some((e=>{if(!e.transceiver||t.mid!=e.transceiver.mid)return!1;let i=0;if(t.rtp.some((t=>t.codec.toUpperCase()===e.codec.toUpperCase()&&(i=t.payload,!0))),0===i)return!0;let n=!1;for(const r of t.fmtp)if(r.payload===i){r.config=r.config.split(";").filter((t=>!t.includes("maxaveragebitrate"))).join(";"),e.maxbr>0&&(r.config+=";maxaveragebitrate=".concat(1e3*e.maxbr)),n=!0;break}return n||e.maxbr>0&&t.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(1e3*e.maxbr)}),!0}))})),i=Ds(n)}yield this.setMungedSDP(t,i,!0),this.pendingCandidates.forEach((t=>{this.pc.addIceCandidate(t)})),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):"answer"===t.type&&(this.emit(Ns),t.sdp)&&Ms(t.sdp).media.forEach((t=>{"video"===t.type&&this.emit(Ls,t.rtp)}))}))}createAndSendOffer(t){var e;return Ae(this,void 0,void 0,(function*(){if(void 0===this.onOffer)return;if((null==t?void 0:t.iceRestart)&&(P.debug("restarting ICE"),this.restartingIce=!0),this._pc&&"have-local-offer"===this._pc.signalingState){const e=this._pc.remoteDescription;if(!(null==t?void 0:t.iceRestart)||!e)return void(this.renegotiate=!0);yield this._pc.setRemoteDescription(e)}else if(!this._pc||"closed"===this._pc.signalingState)return void P.warn("could not createOffer with closed peer connection");P.debug("starting to negotiate");const i=yield this.pc.createOffer(t),n=Ms(null!==(e=i.sdp)&&void 0!==e?e:"");n.media.forEach((t=>{"audio"===t.type?Us(t,[],[]):"video"===t.type&&(function(t){var e,i,n,r;if(!Fr(null===(i=null===(e=t.rtp[0])||void 0===e?void 0:e.codec)||void 0===i?void 0:i.toLowerCase()))return;let s=0;(null===(n=t.ext)||void 0===n?void 0:n.some((t=>t.uri===Nr||(t.value>s&&(s=t.value),!1))))||null===(r=t.ext)||void 0===r||r.push({value:s+1,uri:Nr})}(t),this.trackBitrates.some((e=>{if(!t.msid||!e.cid||!t.msid.includes(e.cid))return!1;let i=0;if(t.rtp.some((t=>t.codec.toUpperCase()===e.codec.toUpperCase()&&(i=t.payload,!0))),0===i)return!0;let n=!1;for(const r of t.fmtp)if(r.payload===i){r.config.includes("x-google-start-bitrate")||(r.config+=";x-google-start-bitrate=".concat(Math.round(.7*e.maxbr))),r.config.includes("x-google-max-bitrate")||(r.config+=";x-google-max-bitrate=".concat(e.maxbr)),n=!0;break}return n||t.fmtp.push({payload:i,config:"x-google-start-bitrate=".concat(Math.round(.7*e.maxbr),";x-google-max-bitrate=").concat(e.maxbr)}),!0})))})),yield this.setMungedSDP(i,Ds(n)),this.onOffer(i)}))}createAndSetAnswer(){var t;return Ae(this,void 0,void 0,(function*(){const e=yield this.pc.createAnswer(),i=Ms(null!==(t=e.sdp)&&void 0!==t?t:"");return i.media.forEach((t=>{"audio"===t.type&&Us(t,this.remoteStereoMids,this.remoteNackMids)})),yield this.setMungedSDP(e,Ds(i)),e}))}createDataChannel(t,e){return this.pc.createDataChannel(t,e)}addTransceiver(t,e){return this.pc.addTransceiver(t,e)}addTrack(t){if(!this._pc)throw new kn("PC closed, cannot add track");return this._pc.addTrack(t)}setTrackCodecBitrate(t){this.trackBitrates.push(t)}setConfiguration(t){var e;if(!this._pc)throw new kn("PC closed, cannot configure");return null===(e=this._pc)||void 0===e?void 0:e.setConfiguration(t)}canRemoveTrack(){var t;return!!(null===(t=this._pc)||void 0===t?void 0:t.removeTrack)}removeTrack(t){var e;return null===(e=this._pc)||void 0===e?void 0:e.removeTrack(t)}getConnectionState(){var t,e;return null!==(e=null===(t=this._pc)||void 0===t?void 0:t.connectionState)&&void 0!==e?e:"closed"}getICEConnectionState(){var t,e;return null!==(e=null===(t=this._pc)||void 0===t?void 0:t.iceConnectionState)&&void 0!==e?e:"closed"}getSignallingState(){var t,e;return null!==(e=null===(t=this._pc)||void 0===t?void 0:t.signalingState)&&void 0!==e?e:"closed"}getTransceivers(){var t,e;return null!==(e=null===(t=this._pc)||void 0===t?void 0:t.getTransceivers())&&void 0!==e?e:[]}getSenders(){var t,e;return null!==(e=null===(t=this._pc)||void 0===t?void 0:t.getSenders())&&void 0!==e?e:[]}getLocalDescription(){var t;return null===(t=this._pc)||void 0===t?void 0:t.localDescription}getRemoteDescription(){var t;return null===(t=this.pc)||void 0===t?void 0:t.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){var t;return Ae(this,void 0,void 0,(function*(){if(!this._pc)return;let e="";const i=new Map,n=new Map;if((yield this._pc.getStats()).forEach((t=>{switch(t.type){case"transport":e=t.selectedCandidatePairId;break;case"candidate-pair":""===e&&t.selected&&(e=t.id),i.set(t.id,t);break;case"remote-candidate":n.set(t.id,"".concat(t.address,":").concat(t.port))}})),""===e)return;const r=null===(t=i.get(e))||void 0===t?void 0:t.remoteCandidateId;return void 0!==r?n.get(r):void 0}))}setMungedSDP(t,e,i){return Ae(this,void 0,void 0,(function*(){if(e){const n=t.sdp;t.sdp=e;try{return P.debug("setting munged ".concat(i?"remote":"local"," description")),void(i?yield this.pc.setRemoteDescription(t):yield this.pc.setLocalDescription(t))}catch(i){P.warn("not able to set ".concat(t.type,", falling back to unmodified sdp"),{error:i,sdp:e}),t.sdp=n}}try{i?yield this.pc.setRemoteDescription(t):yield this.pc.setLocalDescription(t)}catch(e){let n="unknown error";e instanceof Error?n=e.message:"string"==typeof e&&(n=e);const r={error:n,sdp:t.sdp};throw!i&&this.pc.remoteDescription&&(r.remoteSdp=this.pc.remoteDescription),P.error("unable to set ".concat(t.type),r),new Sn(n)}}))}}function Us(t,e,i){let n=0;t.rtp.some((t=>"opus"===t.codec&&(n=t.payload,!0))),n>0&&(t.rtcpFb||(t.rtcpFb=[]),i.includes(t.mid)&&!t.rtcpFb.some((t=>t.payload===n&&"nack"===t.type))&&t.rtcpFb.push({payload:n,type:"nack"}),e.includes(t.mid)&&t.fmtp.some((t=>t.payload===n&&(t.config.includes("stereo=1")||(t.config+=";stereo=1"),!0))))}const Fs="vp8",Bs={audioBitrate:An.music.maxBitrate,audioPreset:An.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:On.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Fs,backupCodec:!0},Gs={autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},Vs={resolution:Nn.h720.resolution},js={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new class{constructor(t){this._retryDelays=void 0!==t?[...t]:Me}nextRetryDelayInMs(t){if(t.retryCount>=this._retryDelays.length)return null;const e=this._retryDelays[t.retryCount];return t.retryCount<=1?e:e+1e3*Math.random()}},disconnectOnPageLeave:!0,expWebAudioMix:!1},Js={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var qs;!function(t){t[t.NEW=0]="NEW",t[t.CONNECTING=1]="CONNECTING",t[t.CONNECTED=2]="CONNECTED",t[t.FAILED=3]="FAILED",t[t.CLOSING=4]="CLOSING",t[t.CLOSED=5]="CLOSED"}(qs||(qs={}));class Ws{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(t,e){this.peerConnectionTimeout=Js.peerConnectionTimeout,this.updateState=()=>{var t;const e=this.state,i=this.requiredTransports.map((t=>t.getConnectionState()));i.every((t=>"connected"===t))?this.state=qs.CONNECTED:i.some((t=>"failed"===t))?this.state=qs.FAILED:i.some((t=>"connecting"===t))?this.state=qs.CONNECTING:i.every((t=>"closed"===t))?this.state=qs.CLOSED:i.some((t=>"closed"===t))?this.state=qs.CLOSING:i.every((t=>"new"===t))&&(this.state=qs.NEW),e!==this.state&&(P.debug("pc state change: from ".concat(qs[e]," to ").concat(qs[this.state])),null===(t=this.onStateChange)||void 0===t||t.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.isPublisherConnectionRequired=!e,this.isSubscriberConnectionRequired=e,this.publisher=new Os(t,{optional:[{googDscp:!0}]}),this.subscriber=new Os(t),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=t=>{var e;null===(e=this.onIceCandidate)||void 0===e||e.call(this,t,Un.PUBLISHER)},this.subscriber.onIceCandidate=t=>{var e;null===(e=this.onIceCandidate)||void 0===e||e.call(this,t,Un.SUBSCRIBER)},this.subscriber.onDataChannel=t=>{var e;null===(e=this.onDataChannel)||void 0===e||e.call(this,t)},this.subscriber.onTrack=t=>{var e;null===(e=this.onTrack)||void 0===e||e.call(this,t)},this.publisher.onOffer=t=>{var e;null===(e=this.onPublisherOffer)||void 0===e||e.call(this,t)},this.state=qs.NEW,this.connectionLock=new os}requirePublisher(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isPublisherConnectionRequired=t,this.updateState()}requireSubscriber(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isSubscriberConnectionRequired=t,this.updateState()}createAndSendPublisherOffer(t){return this.publisher.createAndSendOffer(t)}setPublisherAnswer(t){return this.publisher.setRemoteDescription(t)}removeTrack(t){return this.publisher.removeTrack(t)}close(){return Ae(this,void 0,void 0,(function*(){if(this.publisher&&"closed"!==this.publisher.getSignallingState()){const t=this.publisher;for(const e of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(e)}catch(t){P.warn("could not removeTrack",{error:t})}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()}))}triggerIceRestart(){return Ae(this,void 0,void 0,(function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))}))}addIceCandidate(t,e){return Ae(this,void 0,void 0,(function*(){e===Un.PUBLISHER?yield this.publisher.addIceCandidate(t):yield this.subscriber.addIceCandidate(t)}))}createSubscriberAnswerFromOffer(t){return Ae(this,void 0,void 0,(function*(){return P.debug("received server offer",{RTCSdpType:t.type,signalingState:this.subscriber.getSignallingState().toString()}),yield this.subscriber.setRemoteDescription(t),yield this.subscriber.createAndSetAnswer()}))}updateConfiguration(t,e){this.publisher.setConfiguration(t),this.subscriber.setConfiguration(t),e&&this.triggerIceRestart()}ensurePCTransportConnection(t,e){var i;return Ae(this,void 0,void 0,(function*(){const n=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&"connected"!==this.publisher.getConnectionState()&&"connecting"!==this.publisher.getConnectionState()&&(P.debug("negotiation required, start negotiating"),this.publisher.negotiate()),yield Promise.all(null===(i=this.requiredTransports)||void 0===i?void 0:i.map((i=>this.ensureTransportConnected(i,t,e))))}finally{n()}}))}negotiate(t){return Ae(this,void 0,void 0,(function*(){return new Promise(((e,i)=>Ae(this,void 0,void 0,(function*(){const n=setTimeout((()=>{i("negotiation timed out")}),this.peerConnectionTimeout);t.signal.addEventListener("abort",(()=>{clearTimeout(n),i("negotiation aborted")})),this.publisher.once(As,(()=>{t.signal.aborted||this.publisher.once(Ns,(()=>{clearTimeout(n),e()}))})),yield this.publisher.negotiate((t=>{clearTimeout(n),i(t)}))}))))}))}addPublisherTransceiver(t,e){return this.publisher.addTransceiver(t,e)}addPublisherTrack(t){return this.publisher.addTrack(t)}createPublisherDataChannel(t,e){return this.publisher.createDataChannel(t,e)}getConnectedAddress(t){return t===Un.PUBLISHER||t===Un.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const t=[];return this.isPublisherConnectionRequired&&t.push(this.publisher),this.isSubscriberConnectionRequired&&t.push(this.subscriber),t}ensureTransportConnected(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.peerConnectionTimeout;return Ae(this,void 0,void 0,(function*(){if("connected"!==t.getConnectionState())return new Promise(((t,n)=>Ae(this,void 0,void 0,(function*(){const r=()=>{P.warn("abort transport connection"),xn.clearTimeout(s),n(new gn("room connection has been cancelled",3))};(null==e?void 0:e.signal.aborted)&&r(),null==e||e.signal.addEventListener("abort",r);const s=xn.setTimeout((()=>{null==e||e.signal.removeEventListener("abort",r),n(new gn("could not establish pc connection"))}),i);for(;this.state!==qs.CONNECTED;)if(yield Lr(50),null==e?void 0:e.signal.aborted)return void n(new gn("room connection has been cancelled",3));xn.clearTimeout(s),null==e||e.signal.removeEventListener("abort",r),t()}))))}))}}const Hs="_lossy",zs="_reliable",Ks="leave-reconnect";var Ys;!function(t){t[t.New=0]="New",t[t.Connected=1]="Connected",t[t.Disconnected=2]="Disconnected",t[t.Reconnecting=3]="Reconnecting",t[t.Closed=4]="Closed"}(Ys||(Ys={}));class Xs extends Qe.EventEmitter{get isClosed(){return this._isClosed}constructor(t){super(),this.options=t,this.rtcConfig={},this.peerConnectionTimeout=Js.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=Ys.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.handleDataChannel=t=>{let{channel:e}=t;return Ae(this,void 0,void 0,(function*(){if(e){if(e.label===zs)this.reliableDCSub=e;else{if(e.label!==Hs)return;this.lossyDCSub=e}P.debug("on data channel ".concat(e.id,", ").concat(e.label)),e.onmessage=this.handleDataMessage}}))},this.handleDataMessage=t=>Ae(this,void 0,void 0,(function*(){var e,i;const n=yield this.dataProcessLock.lock();try{let n;if(t.data instanceof ArrayBuffer)n=t.data;else{if(!(t.data instanceof Blob))return void P.error("unsupported data type",t.data);n=yield t.data.arrayBuffer()}const r=ye.fromBinary(new Uint8Array(n));"speaker"===(null===(e=r.value)||void 0===e?void 0:e.case)?this.emit(un.ActiveSpeakersUpdate,r.value.value.speakers):"user"===(null===(i=r.value)||void 0===i?void 0:i.case)&&this.emit(un.DataPacketReceived,r.value.value,r.kind)}finally{n()}})),this.handleDataError=t=>{const e=0===t.currentTarget.maxRetransmits?"lossy":"reliable";if(t instanceof ErrorEvent&&t.error){const{error:i}=t.error;P.error("DataChannel error on ".concat(e,": ").concat(t.message),i)}else P.error("Unknown DataChannel error on ".concat(e),t)},this.handleBufferedAmountLow=t=>{const e=0===t.currentTarget.maxRetransmits?le.LOSSY:le.RELIABLE;this.updateAndEmitDCBufferStatus(e)},this.handleDisconnect=(t,e)=>{if(this._isClosed)return;P.warn("".concat(t," disconnected")),0===this.reconnectAttempts&&(this.reconnectStart=Date.now());const i=Date.now()-this.reconnectStart;let n=this.getNextRetryDelay({elapsedMs:i,retryCount:this.reconnectAttempts});null!==n?(t===Ks&&(n=0),P.debug("reconnecting in ".concat(n,"ms")),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=xn.setTimeout((()=>this.attemptReconnect(e)),n)):(t=>{P.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(t,"ms. giving up")),this.emit(un.Disconnected),this.close()})(i)},this.waitForRestarted=()=>new Promise(((t,e)=>{this.pcState===Ys.Connected&&t();const i=()=>{this.off(un.Disconnected,n),t()},n=()=>{this.off(un.Restarted,i),e()};this.once(un.Restarted,i),this.once(un.Disconnected,n)})),this.updateAndEmitDCBufferStatus=t=>{const e=this.isBufferStatusLow(t);void 0!==e&&e!==this.dcBufferStatus.get(t)&&(this.dcBufferStatus.set(t,e),this.emit(un.DCBufferStatusChanged,e,t))},this.isBufferStatusLow=t=>{const e=this.dataChannelForKind(t);if(e)return e.bufferedAmount<=e.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===vs.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(te.RR_SIGNAL_DISCONNECTED))},this.client=new ys,this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new os,this.dataProcessLock=new os,this.dcBufferStatus=new Map([[le.LOSSY,!0],[le.RELIABLE,!0]]),this.client.onParticipantUpdate=t=>this.emit(un.ParticipantUpdate,t),this.client.onConnectionQuality=t=>this.emit(un.ConnectionQualityUpdate,t),this.client.onRoomUpdate=t=>this.emit(un.RoomUpdate,t),this.client.onSubscriptionError=t=>this.emit(un.SubscriptionError,t),this.client.onSubscriptionPermissionUpdate=t=>this.emit(un.SubscriptionPermissionUpdate,t),this.client.onSpeakersChanged=t=>this.emit(un.SpeakersChanged,t),this.client.onStreamStateUpdate=t=>this.emit(un.StreamStateChanged,t)}join(t,e,i,n){return Ae(this,void 0,void 0,(function*(){this.url=t,this.token=e,this.signalOpts=i,this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const r=yield this.client.join(t,e,i,n);return this._isClosed=!1,this.latestJoinResponse=r,this.subscriberPrimary=r.subscriberPrimary,this.pcManager||(yield this.configure(r)),this.subscriberPrimary||this.negotiate(),this.clientConfiguration=r.clientConfiguration,r}catch(r){if(r instanceof gn&&1===r.reason&&(P.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts)),this.joinAttempts<this.maxJoinAttempts))return this.join(t,e,i,n);throw r}}))}close(){return Ae(this,void 0,void 0,(function*(){const t=yield this.closingLock.lock();if(this.isClosed)t();else try{this._isClosed=!0,this.emit(un.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{t()}}))}cleanupPeerConnections(){var t;return Ae(this,void 0,void 0,(function*(){yield null===(t=this.pcManager)||void 0===t?void 0:t.close(),this.pcManager=void 0;const e=t=>{t&&(t.close(),t.onbufferedamountlow=null,t.onclose=null,t.onclosing=null,t.onerror=null,t.onmessage=null,t.onopen=null)};e(this.lossyDC),e(this.lossyDCSub),e(this.reliableDC),e(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0}))}cleanupClient(){return Ae(this,void 0,void 0,(function*(){yield this.client.close(),this.client.resetCallbacks()}))}addTrack(t){if(this.pendingTrackResolvers[t.cid])throw new yn("a track with the same ID has already been published");return new Promise(((e,i)=>{const n=setTimeout((()=>{delete this.pendingTrackResolvers[t.cid],i(new gn("publication of local track timed out, no response from server"))}),1e4);this.pendingTrackResolvers[t.cid]={resolve:t=>{clearTimeout(n),e(t)},reject:()=>{clearTimeout(n),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(t)}))}removeTrack(t){if(t.track&&this.pendingTrackResolvers[t.track.id]){const{reject:e}=this.pendingTrackResolvers[t.track.id];e&&e(),delete this.pendingTrackResolvers[t.track.id]}try{return this.pcManager.removeTrack(t),!0}catch(t){P.warn("failed to remove track",{error:t,method:"removeTrack"})}return!1}updateMuteStatus(t,e){this.client.sendMuteTrack(t,e)}get dataSubscriberReadyState(){var t;return null===(t=this.reliableDCSub)||void 0===t?void 0:t.readyState}getConnectedServerAddress(){var t;return Ae(this,void 0,void 0,(function*(){return null===(t=this.pcManager)||void 0===t?void 0:t.getConnectedAddress()}))}setRegionUrlProvider(t){this.regionUrlProvider=t}configure(t){var e;return Ae(this,void 0,void 0,(function*(){if(this.pcManager&&this.pcManager.currentState!==qs.NEW)return;this.participantSid=null===(e=t.participant)||void 0===e?void 0:e.sid;const i=this.makeRTCConfiguration(t);this.pcManager=new Ws(i,t.subscriberPrimary),this.emit(un.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(t,e)=>{this.client.sendIceCandidate(t,e)},this.pcManager.onPublisherOffer=t=>{this.client.sendOffer(t)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(e,i,n)=>Ae(this,void 0,void 0,(function*(){if(P.debug("primary PC state changed ".concat(e)),e===qs.CONNECTED){const e=this.pcState===Ys.New;this.pcState=Ys.Connected,e&&this.emit(un.Connected,t)}else e===qs.FAILED&&this.pcState===Ys.Connected&&(this.pcState=Ys.Disconnected,this.handleDisconnect("peerconnection failed","failed"===n?te.RR_SUBSCRIBER_FAILED:te.RR_PUBLISHER_FAILED))})),this.pcManager.onTrack=t=>{this.emit(un.MediaTrackAdded,t.track,t.streams[0],t.receiver)},this.createDataChannels()}))}setupSignalClientCallbacks(){this.client.onAnswer=t=>Ae(this,void 0,void 0,(function*(){this.pcManager&&(P.debug("received server answer",{RTCSdpType:t.type}),yield this.pcManager.setPublisherAnswer(t))})),this.client.onTrickle=(t,e)=>{this.pcManager&&(P.trace("got ICE candidate from peer",{candidate:t,target:e}),this.pcManager.addIceCandidate(t,e))},this.client.onOffer=t=>Ae(this,void 0,void 0,(function*(){if(!this.pcManager)return;const e=yield this.pcManager.createSubscriberAnswerFromOffer(t);this.client.sendAnswer(e)})),this.client.onLocalTrackPublished=t=>{if(P.debug("received trackPublishedResponse",t),!this.pendingTrackResolvers[t.cid])return void P.error("missing track resolver for ".concat(t.cid));const{resolve:e}=this.pendingTrackResolvers[t.cid];delete this.pendingTrackResolvers[t.cid],e(t.track)},this.client.onTokenRefresh=t=>{this.token=t},this.client.onClose=()=>{this.handleDisconnect("signal",te.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=t=>{(null==t?void 0:t.canReconnect)?(this.fullReconnectOnNext=!0,this.handleDisconnect(Ks)):(this.emit(un.Disconnected,null==t?void 0:t.reason),this.close()),P.trace("leave request",{leave:t})}}makeRTCConfiguration(t){var e;const i=Object.assign({},this.rtcConfig);if((null===(e=this.signalOpts)||void 0===e?void 0:e.e2eeEnabled)&&(P.debug("E2EE - setting up transports with insertable streams"),i.encodedInsertableStreams=!0),t.iceServers&&!i.iceServers){const e=[];t.iceServers.forEach((t=>{const i={urls:t.urls};t.username&&(i.username=t.username),t.credential&&(i.credential=t.credential),e.push(i)})),i.iceServers=e}return t.clientConfiguration&&t.clientConfiguration.forceRelay===Zt.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(Hs,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(zs,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}setPreferredCodec(t,e,i){if(!("getCapabilities"in RTCRtpSender))return;const n=RTCRtpSender.getCapabilities(e);if(!n)return;P.debug("get capabilities",n);const r=[],s=[],a=[];n.codecs.forEach((t=>{const e=t.mimeType.toLowerCase();"audio/opus"!==e?e==="video/".concat(i)?"h264"!==i||t.sdpFmtpLine&&t.sdpFmtpLine.includes("profile-level-id=42e01f")?r.push(t):s.push(t):a.push(t):r.push(t)})),function(t){if(!qr())return!1;if(!("setCodecPreferences"in t))return!1;const e=_n();if(!(null==e?void 0:e.name)||!e.version)return!1;const i=Gr[e.name];return!!i&&Xr(e.version,i)>=0}(t)&&t.setCodecPreferences(r.concat(s,a))}createSender(t,e,i){return Ae(this,void 0,void 0,(function*(){if(Or())return yield this.createTransceiverRTCRtpSender(t,e,i);if(Ur())return P.warn("using add-track fallback"),yield this.createRTCRtpSender(t.mediaStreamTrack);throw new kn("Required webRTC APIs not supported on this device")}))}createSimulcastSender(t,e,i,n){return Ae(this,void 0,void 0,(function*(){if(Or())return this.createSimulcastTransceiverSender(t,e,i,n);if(Ur())return P.debug("using add-track fallback"),this.createRTCRtpSender(t.mediaStreamTrack);throw new kn("Cannot stream on this device")}))}createTransceiverRTCRtpSender(t,e,i){return Ae(this,void 0,void 0,(function*(){if(!this.pcManager)throw new kn("publisher is closed");const n=[];t.mediaStream&&n.push(t.mediaStream);const r={direction:"sendonly",streams:n};i&&(r.sendEncodings=i);const s=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,r);return t.kind===_r.Kind.Video&&e.videoCodec&&(this.setPreferredCodec(s,t.kind,e.videoCodec),t.codec=e.videoCodec),s.sender}))}createSimulcastTransceiverSender(t,e,i,n){return Ae(this,void 0,void 0,(function*(){if(!this.pcManager)throw new kn("publisher is closed");const r={direction:"sendonly"};n&&(r.sendEncodings=n);const s=yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,r);if(i.videoCodec)return this.setPreferredCodec(s,t.kind,i.videoCodec),t.setSimulcastTrackSender(i.videoCodec,s.sender),s.sender}))}createRTCRtpSender(t){return Ae(this,void 0,void 0,(function*(){if(!this.pcManager)throw new kn("publisher is closed");return this.pcManager.addPublisherTrack(t)}))}attemptReconnect(t){var e,i,n;return Ae(this,void 0,void 0,(function*(){if(!this._isClosed&&!this.attemptingReconnect){(null===(e=this.clientConfiguration)||void 0===e?void 0:e.resumeConnection)!==Zt.DISABLED&&(null!==(n=null===(i=this.pcManager)||void 0===i?void 0:i.currentState)&&void 0!==n?n:qs.NEW)!==qs.NEW||(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(t),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(t){this.reconnectAttempts+=1;let e=!0;t instanceof kn?(P.debug("received unrecoverable error",{error:t}),e=!1):t instanceof Qs||(this.fullReconnectOnNext=!0),e?this.handleDisconnect("reconnect",te.RR_UNKNOWN):(P.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up")),this.emit(un.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}}))}getNextRetryDelay(t){try{return this.reconnectPolicy.nextRetryDelayInMs(t)}catch(t){P.warn("encountered error in reconnect policy",{error:t})}return null}restartConnection(t){var e,i,n;return Ae(this,void 0,void 0,(function*(){try{if(!this.url||!this.token)throw new kn("could not reconnect, url or token not saved");let i;P.info("reconnecting, attempt: ".concat(this.reconnectAttempts)),this.emit(un.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();try{if(!this.signalOpts)throw P.warn("attempted connection restart, without signal options present"),new Qs;i=yield this.join(null!=t?t:this.url,this.token,this.signalOpts)}catch(t){if(t instanceof gn&&0===t.reason)throw new kn("could not reconnect, token might be expired");throw new Qs}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");this.client.setReconnected(),this.emit(un.SignalRestarted,i),yield this.waitForPCReconnected(),null===(e=this.regionUrlProvider)||void 0===e||e.resetAttempts(),this.emit(un.Restarted)}catch(t){const e=yield null===(i=this.regionUrlProvider)||void 0===i?void 0:i.getNextBestRegionUrl();if(e)return void(yield this.restartConnection(e));throw null===(n=this.regionUrlProvider)||void 0===n||n.resetAttempts(),t}}))}resumeConnection(t){var e;return Ae(this,void 0,void 0,(function*(){if(!this.url||!this.token)throw new kn("could not reconnect, url or token not saved");if(!this.pcManager)throw new kn("publisher and subscriber connections unset");P.info("resuming signal connection, attempt ".concat(this.reconnectAttempts)),this.emit(un.Resuming);try{this.setupSignalClientCallbacks();const e=yield this.client.reconnect(this.url,this.token,this.participantSid,t);if(e){const t=this.makeRTCConfiguration(e);this.pcManager.updateConfiguration(t)}}catch(t){let e="";if(t instanceof Error&&(e=t.message,P.error(t.message)),t instanceof gn&&0===t.reason)throw new kn("could not reconnect, token might be expired");throw new Qs(e)}if(this.emit(un.SignalResumed),this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.setReconnected(),"open"===(null===(e=this.reliableDC)||void 0===e?void 0:e.readyState)&&null===this.reliableDC.id&&this.createDataChannels(),this.emit(un.Resumed)}))}waitForPCInitialConnection(t,e){return Ae(this,void 0,void 0,(function*(){if(!this.pcManager)throw new kn("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(e,t)}))}waitForPCReconnected(){return Ae(this,void 0,void 0,(function*(){this.pcState=Ys.Reconnecting,P.debug("waiting for peer connection to reconnect");try{if(yield Lr(2e3),!this.pcManager)throw new kn("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Ys.Connected}catch(t){throw this.pcState=Ys.Disconnected,new gn("could not establish PC connection, ".concat(t.message))}}))}sendDataPacket(t,e){return Ae(this,void 0,void 0,(function*(){const i=t.toBinary();yield this.ensurePublisherConnected(e);const n=this.dataChannelForKind(e);n&&n.send(i),this.updateAndEmitDCBufferStatus(e)}))}ensureDataTransportConnected(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscriberPrimary;var i;return Ae(this,void 0,void 0,(function*(){if(!this.pcManager)throw new kn("PC manager is closed");const n=e?this.pcManager.subscriber:this.pcManager.publisher,r=e?"Subscriber":"Publisher";if(!n)throw new gn("".concat(r," connection not set"));e||this.pcManager.publisher.isICEConnected||"checking"===this.pcManager.publisher.getICEConnectionState()||this.negotiate();const s=this.dataChannelForKind(t,e);if("open"===(null==s?void 0:s.readyState))return;const a=(new Date).getTime()+this.peerConnectionTimeout;for(;(new Date).getTime()<a;){if(n.isICEConnected&&"open"===(null===(i=this.dataChannelForKind(t,e))||void 0===i?void 0:i.readyState))return;yield Lr(50)}throw new gn("could not establish ".concat(r," connection, state: ").concat(n.getICEConnectionState()))}))}ensurePublisherConnected(t){return Ae(this,void 0,void 0,(function*(){yield this.ensureDataTransportConnected(t,!1)}))}verifyTransport(){return!!this.pcManager&&this.pcManager.currentState===qs.CONNECTED&&!(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return Ae(this,void 0,void 0,(function*(){return new Promise(((t,e)=>Ae(this,void 0,void 0,(function*(){if(!this.pcManager)return void e(new Sn("PC manager is closed"));this.pcManager.requirePublisher();const i=new AbortController,n=()=>{i.abort(),P.debug("engine disconnected while negotiation was ongoing"),t()};this.isClosed&&e("cannot negotiate on closed engine"),this.on(un.Closing,n),this.pcManager.publisher.once(Ls,(t=>{const e=new Map;t.forEach((t=>{const i=t.codec.toLowerCase();var n;n=i,Dn.includes(n)&&e.set(t.payload,i)})),this.emit(un.RTPVideoMapUpdate,e)}));try{yield this.pcManager.negotiate(i),t()}catch(t){t instanceof Sn&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",te.RR_UNKNOWN),e(t)}finally{this.off(un.Closing,n)}}))))}))}dataChannelForKind(t,e){if(e){if(t===le.LOSSY)return this.lossyDCSub;if(t===le.RELIABLE)return this.reliableDCSub}else{if(t===le.LOSSY)return this.lossyDC;if(t===le.RELIABLE)return this.reliableDC}}sendSyncState(t,e){var i,n;if(!this.pcManager)return void P.warn("sync state cannot be sent without peer connection setup");const r=this.pcManager.subscriber.getLocalDescription(),s=this.pcManager.subscriber.getRemoteDescription(),a=null===(n=null===(i=this.signalOpts)||void 0===i?void 0:i.autoSubscribe)||void 0===n||n,o=new Array;t.forEach((t=>{t.isDesired!==a&&o.push(t.trackSid)})),this.client.sendSyncState(new gr({answer:r?ks({sdp:r.sdp,type:r.type}):void 0,offer:s?ks({sdp:s.sdp,type:s.type}):void 0,subscription:new Zn({trackSids:o,subscribe:!a,participantTracks:[]}),publishTracks:Ar(e),dataChannels:this.dataChannelsInfo()}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const t=[],e=(e,i)=>{void 0!==(null==e?void 0:e.id)&&null!==e.id&&t.push(new vr({label:e.label,id:e.id,target:i}))};return e(this.dataChannelForKind(le.LOSSY),Un.PUBLISHER),e(this.dataChannelForKind(le.RELIABLE),Un.PUBLISHER),e(this.dataChannelForKind(le.LOSSY,!0),Un.SUBSCRIBER),e(this.dataChannelForKind(le.RELIABLE,!0),Un.SUBSCRIBER),t}clearReconnectTimeout(){this.reconnectTimeout&&xn.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){qr()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){qr()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class Qs extends Error{}class Zs{constructor(t,e){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(t),this.token=e}updateToken(t){this.token=t}isCloud(){return Hr(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(t){return Ae(this,void 0,void 0,(function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(t));const e=this.regionSettings.regions.filter((t=>!this.attemptedRegions.find((e=>e.url===t.url))));if(e.length>0){const t=e[0];return this.attemptedRegions.push(t),P.debug("next region: ".concat(t.region)),t.url}return null}))}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(t){return Ae(this,void 0,void 0,(function*(){const e=yield fetch("".concat((i=this.serverUrl,"".concat(i.protocol.replace("ws","http"),"//").concat(i.host,"/settings")),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:t});var i;if(e.ok){const t=yield e.json();return this.lastUpdateAt=Date.now(),t}throw new gn("Could not fetch region settings: ".concat(e.statusText),401===e.status?0:void 0,e.status)}))}}const $s=2e3;function ta(t,e){if(!e)return 0;let i,n;return"bytesReceived"in t?(i=t.bytesReceived,n=e.bytesReceived):"bytesSent"in t&&(i=t.bytesSent,n=e.bytesSent),void 0===i||void 0===n||void 0===t.timestamp||void 0===e.timestamp?0:8*(i-n)*1e3/(t.timestamp-e.timestamp)}class ea extends us{constructor(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3?arguments[3]:void 0;super(t,_r.Kind.Audio,e,i),this.stopOnMute=!1,this.monitorSender=()=>Ae(this,void 0,void 0,(function*(){if(!this.sender)return void(this._currentBitrate=0);let t;try{t=yield this.getSenderStats()}catch(t){return void P.error("could not get audio sender stats",{error:t})}t&&this.prevStats&&(this._currentBitrate=ta(t,this.prevStats)),this.prevStats=t})),this.audioContext=n,this.checkForSilence()}setDeviceId(t){return Ae(this,void 0,void 0,(function*(){return this._constraints.deviceId===t||(this._constraints.deviceId=t,this.isMuted||(yield this.restartTrack()),this.isMuted||cs(t)===this.mediaStreamTrack.getSettings().deviceId)}))}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return Ae(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{return this.source===_r.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(P.debug("stopping mic track"),this._mediaStreamTrack.stop()),yield t.mute.call(this),this}finally{e()}}))}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return Ae(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{const e=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==cs(this._constraints.deviceId);return this.source!==_r.Source.Microphone||!this.stopOnMute&&"ended"!==this._mediaStreamTrack.readyState&&!e||this.isUserProvided||(P.debug("reacquiring mic track"),yield this.restartTrack()),yield t.unmute.call(this),this}finally{e()}}))}restartTrack(t){return Ae(this,void 0,void 0,(function*(){let e;if(t){const i=Ir({audio:t});"boolean"!=typeof i.audio&&(e=i.audio)}yield this.restart(e)}))}restart(t){const e=Object.create(null,{restart:{get:()=>super.restart}});return Ae(this,void 0,void 0,(function*(){const i=yield e.restart.call(this,t);return this.checkForSilence(),i}))}startMonitor(){qr()&&(this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),$s)))}setProcessor(t){var e;return Ae(this,void 0,void 0,(function*(){const i=yield this.processorLock.lock();try{if(!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");if(this.processor&&(yield this.stopProcessor()),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");const i={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};P.debug("setting up audio processor ".concat(t.name)),yield t.init(i),this.processor=t,this.processor.processedTrack&&(yield null===(e=this.sender)||void 0===e?void 0:e.replaceTrack(this.processor.processedTrack))}finally{i()}}))}setAudioContext(t){this.audioContext=t}getSenderStats(){var t;return Ae(this,void 0,void 0,(function*(){if(!(null===(t=this.sender)||void 0===t?void 0:t.getStats))return;let e;return(yield this.sender.getStats()).forEach((t=>{"outbound-rtp"===t.type&&(e={type:"audio",streamId:t.id,packetsSent:t.packetsSent,packetsLost:t.packetsLost,bytesSent:t.bytesSent,timestamp:t.timestamp,roundTripTime:t.roundTripTime,jitter:t.jitter})})),e}))}checkForSilence(){return Ae(this,void 0,void 0,(function*(){const t=yield function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return Ae(this,void 0,void 0,(function*(){const i=Dr();if(i){const n=i.createAnalyser();n.fftSize=2048;const r=n.frequencyBinCount,s=new Uint8Array(r);i.createMediaStreamSource(new MediaStream([t.mediaStreamTrack])).connect(n),yield Lr(e),n.getByteTimeDomainData(s);const a=s.some((t=>128!==t&&0!==t));return i.close(),!a}return!1}))}(this);return t&&(this.isMuted||P.warn("silence detected on local audio track"),this.emit(pn.AudioSilenceDetected)),t}))}}function ia(t,e){switch(t.kind){case"audio":return new ea(t,e,!1);case"video":return new fa(t,e,!1);default:throw new yn("unsupported track type: ".concat(t.kind))}}const na=Object.values(Nn),ra=Object.values(Ln),sa=Object.values(On),aa=[Nn.h180,Nn.h360],oa=[Ln.h180,Ln.h360],ca=t=>[{scaleResolutionDownBy:2,fps:3}].map((e=>{var i;return new Rn(Math.floor(t.width/e.scaleResolutionDownBy),Math.floor(t.height/e.scaleResolutionDownBy),Math.max(15e4,Math.floor(t.encoding.maxBitrate/(Math.pow(e.scaleResolutionDownBy,2)*((null!==(i=t.encoding.maxFramerate)&&void 0!==i?i:30)/e.fps)))),e.fps,t.encoding.priority)})),da=["q","h","f"];function ha(t,e,i,n){var r,s;let a=null==n?void 0:n.videoEncoding;t&&(a=null==n?void 0:n.screenShareEncoding);const o=null==n?void 0:n.simulcast,c=null==n?void 0:n.scalabilityMode,d=null==n?void 0:n.videoCodec;if(!a&&!o&&!c||!e||!i)return[{}];a||(a=function(t,e,i,n){const r=function(t,e,i){if(t)return sa;const n=e>i?e/i:i/e;return Math.abs(n-16/9)<Math.abs(n-4/3)?na:ra}(t,e,i);let{encoding:s}=r[0];const a=Math.max(e,i);for(let t=0;t<r.length;t+=1){const e=r[t];if(s=e.encoding,e.width>=a)break}if(n)switch(n){case"av1":s=Object.assign({},s),s.maxBitrate=.7*s.maxBitrate;break;case"vp9":s=Object.assign({},s),s.maxBitrate=.85*s.maxBitrate}return s}(t,e,i,d),P.debug("using video encoding",a));const h=new Rn(e,i,a.maxBitrate,a.maxFramerate,a.priority);if(c&&Fr(d)){P.debug("using svc with scalabilityMode ".concat(c));const t=new ma(c),e=[];if(t.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));for(let i=0;i<t.spatial;i+=1)e.push({rid:da[2-i],maxBitrate:a.maxBitrate/Math.pow(3,i),maxFramerate:h.encoding.maxFramerate});return e[0].scalabilityMode=c,P.debug("encodings",e),e}if(!o)return[a];let l,u=[];if(u=t?null!==(r=pa(null==n?void 0:n.screenShareSimulcastLayers))&&void 0!==r?r:la(t,h):null!==(s=pa(null==n?void 0:n.videoSimulcastLayers))&&void 0!==s?s:la(t,h),u.length>0){const t=u[0];u.length>1&&([,l]=u);const n=Math.max(e,i);if(n>=960&&l)return ua(e,i,[t,l,h]);if(n>=480)return ua(e,i,[t,h])}return ua(e,i,[h])}function la(t,e){if(t)return ca(e);const{width:i,height:n}=e,r=i>n?i/n:n/i;return Math.abs(r-16/9)<Math.abs(r-4/3)?aa:oa}function ua(t,e,i){const n=[];if(i.forEach(((i,r)=>{if(r>=da.length)return;const s=Math.min(t,e),a={rid:da[r],scaleResolutionDownBy:Math.max(1,s/Math.min(i.width,i.height)),maxBitrate:i.encoding.maxBitrate};i.encoding.maxFramerate&&(a.maxFramerate=i.encoding.maxFramerate);const o=Vr()||0===r;i.encoding.priority&&o&&(a.priority=i.encoding.priority,a.networkPriority=i.encoding.priority),n.push(a)})),Wr()&&"ios"===Kr()){let t;n.forEach((e=>{t?e.maxFramerate&&e.maxFramerate>t&&(t=e.maxFramerate):t=e.maxFramerate}));let e=!0;n.forEach((i=>{var n;i.maxFramerate!=t&&(e&&(e=!1,P.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),P.info('Setting framerate of encoding "'.concat(null!==(n=i.rid)&&void 0!==n?n:"",'" to ').concat(t)),i.maxFramerate=t)}))}return n}function pa(t){if(t)return t.sort(((t,e)=>{const{encoding:i}=t,{encoding:n}=e;return i.maxBitrate>n.maxBitrate?1:i.maxBitrate<n.maxBitrate?-1:i.maxBitrate===n.maxBitrate&&i.maxFramerate&&n.maxFramerate?i.maxFramerate>n.maxFramerate?1:-1:0}))}class ma{constructor(t){const e=t.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!e)throw new Error("invalid scalability mode");if(this.spatial=parseInt(e[1]),this.temporal=parseInt(e[2]),e.length>3)switch(e[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=e[3]}}toString(){var t;return"L".concat(this.spatial,"T").concat(this.temporal).concat(null!==(t=this.suffix)&&void 0!==t?t:"")}}class fa extends us{constructor(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super(t,_r.Kind.Video,e,i),this.simulcastCodecs=new Map,this.monitorSender=()=>Ae(this,void 0,void 0,(function*(){if(!this.sender)return void(this._currentBitrate=0);let t;try{t=yield this.getSenderStats()}catch(t){return void P.error("could not get audio sender stats",{error:t})}const e=new Map(t.map((t=>[t.rid,t])));if(this.prevStats){let t=0;e.forEach(((e,i)=>{var n;const r=null===(n=this.prevStats)||void 0===n?void 0:n.get(i);t+=ta(e,r)})),this._currentBitrate=t}this.prevStats=e})),this.senderLock=new os}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(t){var e;if(this.signalClient=t,!qr())return;const i=null===(e=this.sender)||void 0===e?void 0:e.getParameters();i&&(this.encodings=i.encodings),this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),$s))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach((t=>{t.mediaStreamTrack.stop()})),super.stop()}pauseUpstream(){const t=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});var e,i,n,r,s;return Ae(this,void 0,void 0,(function*(){yield t.pauseUpstream.call(this);try{for(var a,o=!0,c=Ne(this.simulcastCodecs.values());a=yield c.next(),!(e=a.done);o=!0){r=a.value,o=!1;const t=r;yield null===(s=t.sender)||void 0===s?void 0:s.replaceTrack(null)}}catch(t){i={error:t}}finally{try{o||e||!(n=c.return)||(yield n.call(c))}finally{if(i)throw i.error}}}))}resumeUpstream(){const t=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});var e,i,n,r,s;return Ae(this,void 0,void 0,(function*(){yield t.resumeUpstream.call(this);try{for(var a,o=!0,c=Ne(this.simulcastCodecs.values());a=yield c.next(),!(e=a.done);o=!0){r=a.value,o=!1;const t=r;yield null===(s=t.sender)||void 0===s?void 0:s.replaceTrack(t.mediaStreamTrack)}}catch(t){i={error:t}}finally{try{o||e||!(n=c.return)||(yield n.call(c))}finally{if(i)throw i.error}}}))}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return Ae(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{return this.source!==_r.Source.Camera||this.isUserProvided||(P.debug("stopping camera track"),this._mediaStreamTrack.stop()),yield t.mute.call(this),this}finally{e()}}))}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return Ae(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{return this.source!==_r.Source.Camera||this.isUserProvided||(P.debug("reacquiring camera track"),yield this.restartTrack()),yield t.unmute.call(this),this}finally{e()}}))}setTrackMuted(t){super.setTrackMuted(t);for(const e of this.simulcastCodecs.values())e.mediaStreamTrack.enabled=!t}getSenderStats(){var t;return Ae(this,void 0,void 0,(function*(){if(!(null===(t=this.sender)||void 0===t?void 0:t.getStats))return[];const e=[],i=yield this.sender.getStats();return i.forEach((t=>{var n;if("outbound-rtp"===t.type){const r={type:"video",streamId:t.id,frameHeight:t.frameHeight,frameWidth:t.frameWidth,firCount:t.firCount,pliCount:t.pliCount,nackCount:t.nackCount,packetsSent:t.packetsSent,bytesSent:t.bytesSent,framesSent:t.framesSent,timestamp:t.timestamp,rid:null!==(n=t.rid)&&void 0!==n?n:t.id,retransmittedPacketsSent:t.retransmittedPacketsSent,qualityLimitationReason:t.qualityLimitationReason,qualityLimitationResolutionChanges:t.qualityLimitationResolutionChanges},s=i.get(t.remoteId);s&&(r.jitter=s.jitter,r.packetsLost=s.packetsLost,r.roundTripTime=s.roundTripTime),e.push(r)}})),e}))}setPublishingQuality(t){const e=[];for(let i=Xt.LOW;i<=Xt.HIGH;i+=1)e.push(new hr({quality:i,enabled:i<=t}));P.debug("setting publishing quality. max quality ".concat(t)),this.setPublishingLayers(e)}setDeviceId(t){return Ae(this,void 0,void 0,(function*(){return this._constraints.deviceId===t&&this._mediaStreamTrack.getSettings().deviceId===cs(t)||(this._constraints.deviceId=t,this.isMuted||(yield this.restartTrack()),this.isMuted||cs(t)===this._mediaStreamTrack.getSettings().deviceId)}))}restartTrack(t){var e,i,n,r;return Ae(this,void 0,void 0,(function*(){let s;if(t){const e=Ir({video:t});"boolean"!=typeof e.video&&(s=e.video)}yield this.restart(s);try{for(var a,o=!0,c=Ne(this.simulcastCodecs.values());a=yield c.next(),!(e=a.done);o=!0){r=a.value,o=!1;const t=r;t.sender&&(t.mediaStreamTrack=this.mediaStreamTrack.clone(),yield t.sender.replaceTrack(t.mediaStreamTrack))}}catch(t){i={error:t}}finally{try{o||e||!(n=c.return)||(yield n.call(c))}finally{if(i)throw i.error}}}))}setProcessor(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});var n,r,s,a,o,c;return Ae(this,void 0,void 0,(function*(){if(yield i.setProcessor.call(this,t,e),null===(o=this.processor)||void 0===o?void 0:o.processedTrack)try{for(var d,h=!0,l=Ne(this.simulcastCodecs.values());d=yield l.next(),!(n=d.done);h=!0){a=d.value,h=!1;const t=a;yield null===(c=t.sender)||void 0===c?void 0:c.replaceTrack(this.processor.processedTrack)}}catch(t){r={error:t}}finally{try{h||n||!(s=l.return)||(yield s.call(l))}finally{if(r)throw r.error}}}))}addSimulcastTrack(t,e){if(this.simulcastCodecs.has(t))throw new Error("".concat(t," already added"));const i={codec:t,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:e};return this.simulcastCodecs.set(t,i),i}setSimulcastTrackSender(t,e){const i=this.simulcastCodecs.get(t);i&&(i.sender=e,setTimeout((()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)}),5e3))}setPublishingCodecs(t){var e,i,n,r,s,a,o;return Ae(this,void 0,void 0,(function*(){if(P.debug("setting publishing codecs",{codecs:t,currentCodec:this.codec}),!this.codec&&t.length>0)return yield this.setPublishingLayers(t[0].qualities),[];this.subscribedCodecs=t;const c=[];try{for(e=!0,i=Ne(t);n=yield i.next(),!(r=n.done);e=!0){o=n.value,e=!1;const t=o;if(this.codec&&this.codec!==t.codec){const e=this.simulcastCodecs.get(t.codec);if(P.debug("try setPublishingCodec for ".concat(t.codec),e),e&&e.sender)e.encodings&&(P.debug("try setPublishingLayersForSender ".concat(t.codec)),yield ga(e.sender,e.encodings,t.qualities,this.senderLock));else for(const e of t.qualities)if(e.enabled){c.push(t.codec);break}}else yield this.setPublishingLayers(t.qualities)}}catch(t){s={error:t}}finally{try{e||r||!(a=i.return)||(yield a.call(i))}finally{if(s)throw s.error}}return c}))}setPublishingLayers(t){return Ae(this,void 0,void 0,(function*(){P.debug("setting publishing layers",t),this.sender&&this.encodings&&(yield ga(this.sender,this.encodings,t,this.senderLock))}))}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Ae(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this),Jr()&&this.isInBackground&&this.source===_r.Source.Camera&&(this._mediaStreamTrack.enabled=!1)}))}}function ga(t,e,i,n){return Ae(this,void 0,void 0,(function*(){const r=yield n.lock();P.debug("setPublishingLayersForSender",{sender:t,qualities:i,senderEncodings:e});try{const n=t.getParameters(),{encodings:r}=n;if(!r)return;if(r.length!==e.length)return void P.warn("cannot set publishing layers, encodings mismatch");let s=!1;r.forEach(((t,n)=>{var r;let a=null!==(r=t.rid)&&void 0!==r?r:"";""===a&&(a="q");const o=va(a),c=i.find((t=>t.quality===o));c&&t.active!==c.enabled&&(s=!0,t.active=c.enabled,P.debug("setting layer ".concat(c.quality," to ").concat(t.active?"enabled":"disabled")),Vr()&&(c.enabled?(t.scaleResolutionDownBy=e[n].scaleResolutionDownBy,t.maxBitrate=e[n].maxBitrate,t.maxFrameRate=e[n].maxFrameRate):(t.scaleResolutionDownBy=4,t.maxBitrate=10,t.maxFrameRate=2)))})),s&&(n.encodings=r,P.debug("setting encodings",n.encodings),yield t.setParameters(n))}finally{r()}}))}function va(t){switch(t){case"f":default:return Xt.HIGH;case"h":return Xt.MEDIUM;case"q":return Xt.LOW}}function ya(t,e,i,n){if(!i)return[new ve({quality:Xt.HIGH,width:t,height:e,bitrate:0,ssrc:0})];if(n){const n=i[0].scalabilityMode,r=new ma(n),s=[];for(let n=0;n<r.spatial;n+=1)s.push(new ve({quality:Xt.HIGH-n,width:Math.ceil(t/Math.pow(2,n)),height:Math.ceil(e/Math.pow(2,n)),bitrate:i[0].maxBitrate?Math.ceil(i[0].maxBitrate/Math.pow(3,n)):0,ssrc:0}));return s}return i.map((i=>{var n,r,s;const a=null!==(n=i.scaleResolutionDownBy)&&void 0!==n?n:1;let o=va(null!==(r=i.rid)&&void 0!==r?r:"");return new ve({quality:o,width:Math.ceil(t/a),height:Math.ceil(e/a),bitrate:null!==(s=i.maxBitrate)&&void 0!==s?s:0,ssrc:0})}))}class ba extends _r{constructor(t,e,i,n){super(t,i),this.sid=e,this.receiver=n}setMuted(t){this.isMuted!==t&&(this.isMuted=t,this._mediaStreamTrack.enabled=!t,this.emit(t?pn.Muted:pn.Unmuted,this))}setMediaStream(t){this.mediaStream=t;const e=i=>{i.track===this._mediaStreamTrack&&(t.removeEventListener("removetrack",e),this.receiver=void 0,this._currentBitrate=0,this.emit(pn.Ended,this))};t.addEventListener("removetrack",e)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){var t;return Ae(this,void 0,void 0,(function*(){if(null===(t=this.receiver)||void 0===t?void 0:t.getStats)return yield this.receiver.getStats()}))}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval((()=>this.monitorReceiver()),$s))}}class ka extends ba{constructor(t,e,i,n,r){super(t,e,_r.Kind.Audio,i),this.monitorReceiver=()=>Ae(this,void 0,void 0,(function*(){if(!this.receiver)return void(this._currentBitrate=0);const t=yield this.getReceiverStats();t&&this.prevStats&&this.receiver&&(this._currentBitrate=ta(t,this.prevStats)),this.prevStats=t})),this.audioContext=n,this.webAudioPluginNodes=[],r&&(this.sinkId=r.deviceId)}setVolume(t){var e;for(const i of this.attachedElements)this.audioContext?null===(e=this.gainNode)||void 0===e||e.gain.setTargetAtTime(t,0,.1):i.volume=t;Wr()&&this._mediaStreamTrack._setVolume(t),this.elementVolume=t}getVolume(){if(this.elementVolume)return this.elementVolume;if(Wr())return 1;let t=0;return this.attachedElements.forEach((e=>{e.volume>t&&(t=e.volume)})),t}setSinkId(t){return Ae(this,void 0,void 0,(function*(){this.sinkId=t,yield Promise.all(this.attachedElements.map((e=>{if(Br(e))return e.setSinkId(t)})))}))}attach(t){const e=0===this.attachedElements.length;return t?super.attach(t):t=super.attach(),this.sinkId&&Br(t)&&t.setSinkId(this.sinkId),this.audioContext&&e&&(P.debug("using audio context mapping"),this.connectWebAudio(this.audioContext,t),t.volume=0,t.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),t}detach(t){let e;return t?(e=super.detach(t),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(e=super.detach(),this.disconnectWebAudio()),e}setAudioContext(t){this.audioContext=t,t&&this.attachedElements.length>0?this.connectWebAudio(t,this.attachedElements[0]):t||this.disconnectWebAudio()}setWebAudioPlugins(t){this.webAudioPluginNodes=t,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(t,e){this.disconnectWebAudio(),this.sourceNode=t.createMediaStreamSource(e.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach((t=>{i.connect(t),i=t})),this.gainNode=t.createGain(),i.connect(this.gainNode),this.gainNode.connect(t.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),"running"!==t.state&&t.resume().then((()=>{"running"!==t.state&&this.emit(pn.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))})).catch((t=>{this.emit(pn.AudioPlaybackFailed,t)}))}disconnectWebAudio(){var t,e;null===(t=this.gainNode)||void 0===t||t.disconnect(),null===(e=this.sourceNode)||void 0===e||e.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return Ae(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;let t;return(yield this.receiver.getStats()).forEach((e=>{"inbound-rtp"===e.type&&(t={type:"audio",timestamp:e.timestamp,jitter:e.jitter,bytesReceived:e.bytesReceived,concealedSamples:e.concealedSamples,concealmentEvents:e.concealmentEvents,silentConcealedSamples:e.silentConcealedSamples,silentConcealmentEvents:e.silentConcealmentEvents,totalAudioEnergy:e.totalAudioEnergy,totalSamplesDuration:e.totalSamplesDuration})})),t}))}}class Sa extends ba{constructor(t,e,i,n){super(t,e,_r.Kind.Video,i),this.elementInfos=[],this.monitorReceiver=()=>Ae(this,void 0,void 0,(function*(){if(!this.receiver)return void(this._currentBitrate=0);const t=yield this.getReceiverStats();t&&this.prevStats&&this.receiver&&(this._currentBitrate=ta(t,this.prevStats)),this.prevStats=t})),this.debouncedHandleResize=Tn((()=>{this.updateDimensions()}),100),this.adaptiveStreamSettings=n}get isAdaptiveStream(){return void 0!==this.adaptiveStreamSettings}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(t){super.setMuted(t),this.attachedElements.forEach((e=>{t?Er(this._mediaStreamTrack,e):Pr(this._mediaStreamTrack,e)}))}attach(t){if(t?super.attach(t):t=super.attach(),this.adaptiveStreamSettings&&void 0===this.elementInfos.find((e=>e.element===t))){const e=new Ta(t);this.observeElementInfo(e)}return t}observeElementInfo(t){this.adaptiveStreamSettings&&void 0===this.elementInfos.find((e=>e===t))?(t.handleResize=()=>{this.debouncedHandleResize()},t.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(t),t.observe(),this.debouncedHandleResize(),this.updateVisibility()):P.warn("visibility resize observer not triggered")}stopObservingElementInfo(t){if(!this.isAdaptiveStream)return void P.warn("stopObservingElementInfo ignored");const e=this.elementInfos.filter((e=>e===t));for(const t of e)t.stopObserving();this.elementInfos=this.elementInfos.filter((e=>e!==t)),this.updateVisibility(),this.debouncedHandleResize()}detach(t){let e=[];if(t)return this.stopObservingElement(t),super.detach(t);e=super.detach();for(const t of e)this.stopObservingElement(t);return e}getDecoderImplementation(){var t;return null===(t=this.prevStats)||void 0===t?void 0:t.decoderImplementation}getReceiverStats(){return Ae(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;let t;return(yield this.receiver.getStats()).forEach((e=>{"inbound-rtp"===e.type&&(t={type:"video",framesDecoded:e.framesDecoded,framesDropped:e.framesDropped,framesReceived:e.framesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,frameWidth:e.frameWidth,frameHeight:e.frameHeight,pliCount:e.pliCount,firCount:e.firCount,nackCount:e.nackCount,jitter:e.jitter,timestamp:e.timestamp,bytesReceived:e.bytesReceived,decoderImplementation:e.decoderImplementation})})),t}))}stopObservingElement(t){const e=this.elementInfos.filter((e=>e.element===t));for(const t of e)this.stopObservingElementInfo(t)}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Ae(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()}))}updateVisibility(){var t,e;const i=this.elementInfos.reduce(((t,e)=>Math.max(t,e.visibilityChangedAt||0)),0),n=!(null!==(e=null===(t=this.adaptiveStreamSettings)||void 0===t?void 0:t.pauseVideoInBackground)&&void 0!==e&&!e)&&this.isInBackground,r=this.elementInfos.some((t=>t.pictureInPicture)),s=this.elementInfos.some((t=>t.visible))&&!n||r;this.lastVisible!==s&&(!s&&Date.now()-i<100?xn.setTimeout((()=>{this.updateVisibility()}),100):(this.lastVisible=s,this.emit(pn.VisibilityChanged,s,this)))}updateDimensions(){var t,e;let i=0,n=0;const r=this.getPixelDensity();for(const t of this.elementInfos){const e=t.width()*r,s=t.height()*r;e+s>i+n&&(i=e,n=s)}(null===(t=this.lastDimensions)||void 0===t?void 0:t.width)===i&&(null===(e=this.lastDimensions)||void 0===e?void 0:e.height)===n||(this.lastDimensions={width:i,height:n},this.emit(pn.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var t;const e=null===(t=this.adaptiveStreamSettings)||void 0===t?void 0:t.pixelDensity;return"screen"===e?Yr():e||(Yr()>2?2:1)}}class Ta{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(t,e){this.onVisibilityChanged=t=>{var e;const{target:i,isIntersecting:n}=t;i===this.element&&(this.isIntersecting=n,this.visibilityChangedAt=Date.now(),null===(e=this.handleVisibilityChanged)||void 0===e||e.call(this))},this.onEnterPiP=()=>{var t;this.isPiP=!0,null===(t=this.handleVisibilityChanged)||void 0===t||t.call(this)},this.onLeavePiP=()=>{var t;this.isPiP=!1,null===(t=this.handleVisibilityChanged)||void 0===t||t.call(this)},this.element=t,this.isIntersecting=null!=e?e:wa(t),this.isPiP=qr()&&document.pictureInPictureElement===t,this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){this.isIntersecting=wa(this.element),this.isPiP=document.pictureInPictureElement===this.element,this.element.handleResize=()=>{var t;null===(t=this.handleResize)||void 0===t||t.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,is().observe(this.element),ts().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP)}stopObserving(){var t,e;null===(t=is())||void 0===t||t.unobserve(this.element),null===(e=ts())||void 0===e||e.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP)}}function wa(t){let e=t.offsetTop,i=t.offsetLeft;const n=t.offsetWidth,r=t.offsetHeight,{hidden:s}=t,{opacity:a,display:o}=getComputedStyle(t);for(;t.offsetParent;)e+=(t=t.offsetParent).offsetTop,i+=t.offsetLeft;return e<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&e+r>window.pageYOffset&&i+n>window.pageXOffset&&!s&&(""===a||parseFloat(a)>0)&&"none"!==o}class Ca extends Qe.EventEmitter{constructor(t,e,i){super(),this.metadataMuted=!1,this.encryption=he.NONE,this.handleMuted=()=>{this.emit(pn.Muted)},this.handleUnmuted=()=>{this.emit(pn.Unmuted)},this.setMaxListeners(100),this.kind=t,this.trackSid=e,this.trackName=i,this.source=_r.Source.Unknown}setTrack(t){this.track&&(this.track.off(pn.Muted,this.handleMuted),this.track.off(pn.Unmuted,this.handleUnmuted)),this.track=t,t&&(t.on(pn.Muted,this.handleMuted),t.on(pn.Unmuted,this.handleUnmuted))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return void 0!==this.track}get isEncrypted(){return this.encryption!==he.NONE}get audioTrack(){if(this.track instanceof ea||this.track instanceof ka)return this.track}get videoTrack(){if(this.track instanceof fa||this.track instanceof Sa)return this.track}updateInfo(t){this.trackSid=t.sid,this.trackName=t.name,this.source=_r.sourceFromProto(t.source),this.mimeType=t.mimeType,this.kind===_r.Kind.Video&&t.width>0&&(this.dimensions={width:t.width,height:t.height},this.simulcasted=t.simulcast),this.encryption=t.encryption,this.trackInfo=t,P.debug("update publication info",{info:t})}}!function(t){var e,i;(e=t.SubscriptionStatus||(t.SubscriptionStatus={})).Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed",(i=t.PermissionStatus||(t.PermissionStatus={})).Allowed="allowed",i.NotAllowed="not_allowed"}(Ca||(Ca={}));class _a extends Ca{get isUpstreamPaused(){var t;return null===(t=this.track)||void 0===t?void 0:t.isUpstreamPaused}constructor(t,e,i){super(t,e.sid,e.name),this.track=void 0,this.handleTrackEnded=()=>{this.emit(pn.Ended)},this.updateInfo(e),this.setTrack(i)}setTrack(t){this.track&&this.track.off(pn.Ended,this.handleTrackEnded),super.setTrack(t),t&&t.on(pn.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}mute(){var t;return Ae(this,void 0,void 0,(function*(){return null===(t=this.track)||void 0===t?void 0:t.mute()}))}unmute(){var t;return Ae(this,void 0,void 0,(function*(){return null===(t=this.track)||void 0===t?void 0:t.unmute()}))}pauseUpstream(){var t;return Ae(this,void 0,void 0,(function*(){yield null===(t=this.track)||void 0===t?void 0:t.pauseUpstream()}))}resumeUpstream(){var t;return Ae(this,void 0,void 0,(function*(){yield null===(t=this.track)||void 0===t?void 0:t.resumeUpstream()}))}}var Pa,Ea,xa;!function(t){t.Excellent="excellent",t.Good="good",t.Poor="poor",t.Lost="lost",t.Unknown="unknown"}(Pa||(Pa={}));class Ra extends Qe.EventEmitter{get isEncrypted(){return this.tracks.size>0&&Array.from(this.tracks.values()).every((t=>t.isEncrypted))}get isAgent(){var t,e;return null!==(e=null===(t=this.permissions)||void 0===t?void 0:t.agent)&&void 0!==e&&e}constructor(t,e,i,n){super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Pa.Unknown,this.setMaxListeners(100),this.sid=t,this.identity=e,this.name=i,this.metadata=n,this.audioTracks=new Map,this.videoTracks=new Map,this.tracks=new Map}getTracks(){return Array.from(this.tracks.values())}getTrack(t){for(const[,e]of this.tracks)if(e.source===t)return e}getTrackByName(t){for(const[,e]of this.tracks)if(e.trackName===t)return e}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var t;const e=this.getTrack(_r.Source.Camera);return!(null===(t=null==e?void 0:e.isMuted)||void 0===t||t)}get isMicrophoneEnabled(){var t;const e=this.getTrack(_r.Source.Microphone);return!(null===(t=null==e?void 0:e.isMuted)||void 0===t||t)}get isScreenShareEnabled(){return!!this.getTrack(_r.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(1e3*Number.parseInt(this.participantInfo.joinedAt.toString())):new Date}updateInfo(t){return!(this.participantInfo&&this.participantInfo.sid===t.sid&&this.participantInfo.version>t.version||(this.identity=t.identity,this.sid=t.sid,this._setName(t.name),this._setMetadata(t.metadata),t.permission&&this.setPermissions(t.permission),this.participantInfo=t,P.trace("update participant info",{info:t}),0))}_setMetadata(t){const e=this.metadata!==t,i=this.metadata;this.metadata=t,e&&this.emit(ln.ParticipantMetadataChanged,i)}_setName(t){const e=this.name!==t;this.name=t,e&&this.emit(ln.ParticipantNameChanged,t)}setPermissions(t){var e,i,n,r,s;const a=this.permissions,o=t.canPublish!==(null===(e=this.permissions)||void 0===e?void 0:e.canPublish)||t.canSubscribe!==(null===(i=this.permissions)||void 0===i?void 0:i.canSubscribe)||t.canPublishData!==(null===(n=this.permissions)||void 0===n?void 0:n.canPublishData)||t.hidden!==(null===(r=this.permissions)||void 0===r?void 0:r.hidden)||t.recorder!==(null===(s=this.permissions)||void 0===s?void 0:s.recorder)||t.canPublishSources.length!==this.permissions.canPublishSources.length||t.canPublishSources.some(((t,e)=>{var i;return t!==(null===(i=this.permissions)||void 0===i?void 0:i.canPublishSources[e])}));return this.permissions=t,o&&this.emit(ln.ParticipantPermissionsChanged,a),o}setIsSpeaking(t){t!==this.isSpeaking&&(this.isSpeaking=t,t&&(this.lastSpokeAt=new Date),this.emit(ln.IsSpeakingChanged,t))}setConnectionQuality(t){const e=this._connectionQuality;this._connectionQuality=function(t){switch(t){case Qt.EXCELLENT:return Pa.Excellent;case Qt.GOOD:return Pa.Good;case Qt.POOR:return Pa.Poor;case Qt.LOST:return Pa.Lost;default:return Pa.Unknown}}(t),e!==this._connectionQuality&&this.emit(ln.ConnectionQualityChanged,this._connectionQuality)}setAudioContext(t){this.audioContext=t,this.audioTracks.forEach((e=>(e.track instanceof ka||e.track instanceof ea)&&e.track.setAudioContext(t)))}addTrackPublication(t){t.on(pn.Muted,(()=>{this.emit(ln.TrackMuted,t)})),t.on(pn.Unmuted,(()=>{this.emit(ln.TrackUnmuted,t)}));const e=t;switch(e.track&&(e.track.sid=t.trackSid),this.tracks.set(t.trackSid,t),t.kind){case _r.Kind.Audio:this.audioTracks.set(t.trackSid,t);break;case _r.Kind.Video:this.videoTracks.set(t.trackSid,t)}}}class Ia extends Ca{constructor(t,e,i){super(t,e.sid,e.name),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=Xt.HIGH,this.handleEnded=t=>{this.setTrack(void 0),this.emit(pn.Ended,t)},this.handleVisibilityChange=t=>{P.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(t),{trackSid:this.trackSid}),this.disabled=!t,this.emitTrackUpdate()},this.handleVideoDimensionsChange=t=>{P.debug("adaptivestream video dimensions ".concat(t.width,"x").concat(t.height),{trackSid:this.trackSid}),this.videoDimensions=t,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(e)}setSubscribed(t){const e=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=t,t&&(this.allowed=!0);const n=new Zn({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new Te({participantSid:"",trackSids:[this.trackSid]})]});this.emit(pn.UpdateSubscription,n),this.emitSubscriptionUpdateIfChanged(e),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return!1===this.subscribed?Ca.SubscriptionStatus.Unsubscribed:super.isSubscribed?Ca.SubscriptionStatus.Subscribed:Ca.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?Ca.PermissionStatus.Allowed:Ca.PermissionStatus.NotAllowed}get isSubscribed(){return!1!==this.subscribed&&super.isSubscribed}get isDesired(){return!1!==this.subscribed}get isEnabled(){return!this.disabled}setEnabled(t){this.isManualOperationAllowed()&&this.disabled!==!t&&(this.disabled=!t,this.emitTrackUpdate())}setVideoQuality(t){this.isManualOperationAllowed()&&this.currentVideoQuality!==t&&(this.currentVideoQuality=t,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(t){var e,i;this.isManualOperationAllowed()&&((null===(e=this.videoDimensions)||void 0===e?void 0:e.width)===t.width&&(null===(i=this.videoDimensions)||void 0===i?void 0:i.height)===t.height||(this.track instanceof Sa&&(this.videoDimensions=t),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(t){this.isManualOperationAllowed()&&this.track instanceof Sa&&this.fps!==t&&(this.fps=t,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(t){const e=this.subscriptionStatus,i=this.permissionStatus,n=this.track;n!==t&&(n&&(n.off(pn.VideoDimensionsChanged,this.handleVideoDimensionsChange),n.off(pn.VisibilityChanged,this.handleVisibilityChange),n.off(pn.Ended,this.handleEnded),n.detach(),n.stopMonitor(),this.emit(pn.Unsubscribed,n)),super.setTrack(t),t&&(t.sid=this.trackSid,t.on(pn.VideoDimensionsChanged,this.handleVideoDimensionsChange),t.on(pn.VisibilityChanged,this.handleVisibilityChange),t.on(pn.Ended,this.handleEnded),this.emit(pn.Subscribed,t)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(e))}setAllowed(t){const e=this.subscriptionStatus,i=this.permissionStatus;this.allowed=t,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(e)}setSubscriptionError(t){this.emit(pn.SubscriptionFailed,t)}updateInfo(t){super.updateInfo(t);const e=this.metadataMuted;this.metadataMuted=t.muted,this.track?this.track.setMuted(t.muted):e!==t.muted&&this.emit(t.muted?pn.Muted:pn.Unmuted)}emitSubscriptionUpdateIfChanged(t){const e=this.subscriptionStatus;t!==e&&this.emit(pn.SubscriptionStatusChanged,e,t)}emitPermissionUpdateIfChanged(t){this.permissionStatus!==t&&this.emit(pn.SubscriptionPermissionChanged,this.permissionStatus,t)}isManualOperationAllowed(){return this.kind===_r.Kind.Video&&this.isAdaptiveStream?(P.warn("adaptive stream is enabled, cannot change video track settings",{trackSid:this.trackSid}),!1):!!this.isDesired||(P.warn("cannot update track settings when not subscribed",{trackSid:this.trackSid}),!1)}get isAdaptiveStream(){return this.track instanceof Sa&&this.track.isAdaptiveStream}emitTrackUpdate(){const t=new $n({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(t.width=Math.ceil(this.videoDimensions.width),t.height=Math.ceil(this.videoDimensions.height)):void 0!==this.currentVideoQuality?t.quality=this.currentVideoQuality:t.quality=Xt.HIGH,this.emit(pn.UpdateSettings,t)}}class Da extends Ra{static fromParticipantInfo(t,e){return new Da(t,e.sid,e.identity,e.name,e.metadata)}constructor(t,e,i,n,r){super(e,i||"",n,r),this.signalClient=t,this.tracks=new Map,this.audioTracks=new Map,this.videoTracks=new Map,this.volumeMap=new Map}addTrackPublication(t){super.addTrackPublication(t),t.on(pn.UpdateSettings,(t=>{P.debug("send update settings",t),this.signalClient.sendUpdateTrackSettings(t)})),t.on(pn.UpdateSubscription,(t=>{t.participantTracks.forEach((t=>{t.participantSid=this.sid})),this.signalClient.sendUpdateSubscription(t)})),t.on(pn.SubscriptionPermissionChanged,(e=>{this.emit(ln.TrackSubscriptionPermissionChanged,t,e)})),t.on(pn.SubscriptionStatusChanged,(e=>{this.emit(ln.TrackSubscriptionStatusChanged,t,e)})),t.on(pn.Subscribed,(e=>{this.emit(ln.TrackSubscribed,e,t)})),t.on(pn.Unsubscribed,(e=>{this.emit(ln.TrackUnsubscribed,e,t)})),t.on(pn.SubscriptionFailed,(e=>{this.emit(ln.TrackSubscriptionFailed,t.trackSid,e)}))}getTrack(t){const e=super.getTrack(t);if(e)return e}getTrackByName(t){const e=super.getTrackByName(t);if(e)return e}setVolume(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_r.Source.Microphone;this.volumeMap.set(e,t);const i=this.getTrack(e);i&&i.track&&i.track.setVolume(t)}getVolume(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_r.Source.Microphone;const e=this.getTrack(t);return e&&e.track?e.track.getVolume():this.volumeMap.get(t)}addSubscribedMediaTrack(t,e,i,n,r,s){let a,o=this.getTrackPublication(e);return o||e.startsWith("TR")||this.tracks.forEach((e=>{o||t.kind!==e.kind.toString()||(o=e)})),o?"ended"===t.readyState?(P.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",{participant:this.sid,trackSid:e}),void this.emit(ln.TrackSubscriptionFailed,e)):(a="video"===t.kind?new Sa(t,e,n,r):new ka(t,e,n,this.audioContext,this.audioOutput),a.source=o.source,a.isMuted=o.isMuted,a.setMediaStream(i),a.start(),o.setTrack(a),this.volumeMap.has(o.source)&&a instanceof ka&&a.setVolume(this.volumeMap.get(o.source)),o):0===s?(P.error("could not find published track",{participant:this.sid,trackSid:e}),void this.emit(ln.TrackSubscriptionFailed,e)):(void 0===s&&(s=20),void setTimeout((()=>{this.addSubscribedMediaTrack(t,e,i,n,r,s-1)}),150))}get hasMetadata(){return!!this.participantInfo}getTrackPublication(t){return this.tracks.get(t)}updateInfo(t){if(!super.updateInfo(t))return!1;const e=new Map,i=new Map;return t.tracks.forEach((n=>{var r;let s=this.getTrackPublication(n.sid);if(s)s.updateInfo(n);else{const e=_r.kindFromProto(n.type);if(!e)return;s=new Ia(e,n,null===(r=this.signalClient.connectOptions)||void 0===r?void 0:r.autoSubscribe),s.updateInfo(n),i.set(n.sid,s);const a=Array.from(this.tracks.values()).find((t=>t.source===(null==s?void 0:s.source)));a&&s.source!==_r.Source.Unknown&&P.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(s.source),{oldTrack:a,newTrack:s,participant:this,participantInfo:t}),this.addTrackPublication(s)}e.set(n.sid,s)})),this.tracks.forEach((t=>{e.has(t.trackSid)||(P.trace("detected removed track on remote participant, unpublishing",{publication:t,participantSid:this.sid}),this.unpublishTrack(t.trackSid,!0))})),i.forEach((t=>{this.emit(ln.TrackPublished,t)})),!0}unpublishTrack(t,e){const i=this.tracks.get(t);if(!i)return;const{track:n}=i;switch(n&&(n.stop(),i.setTrack(void 0)),this.tracks.delete(t),i.kind){case _r.Kind.Audio:this.audioTracks.delete(t);break;case _r.Kind.Video:this.videoTracks.delete(t)}e&&this.emit(ln.TrackUnpublished,i)}setAudioOutput(t){return Ae(this,void 0,void 0,(function*(){this.audioOutput=t;const e=[];this.audioTracks.forEach((i=>{var n;i.track instanceof ka&&e.push(i.track.setSinkId(null!==(n=t.deviceId)&&void 0!==n?n:"default"))})),yield Promise.all(e)}))}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return P.trace("participant event",{participant:this.sid,event:t,args:i}),super.emit(t,...i)}}class Ma extends Ra{constructor(t,e,i,n){super(t,e),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=he.NONE,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new as)},this.handleReconnected=()=>{var t,e;null===(e=null===(t=this.reconnectFuture)||void 0===t?void 0:t.resolve)||void 0===e||e.call(t),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var t,e;this.reconnectFuture&&(this.reconnectFuture.promise.catch((t=>P.warn(t))),null===(e=null===(t=this.reconnectFuture)||void 0===t?void 0:t.reject)||void 0===e||e.call(t,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.updateTrackSubscriptionPermissions=()=>{P.debug("updating track subscription permissions",{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions}),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map((t=>function(t){var e,i,n;if(!t.participantSid&&!t.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new pr({participantIdentity:null!==(e=t.participantIdentity)&&void 0!==e?e:"",participantSid:null!==(i=t.participantSid)&&void 0!==i?i:"",allTracks:null!==(n=t.allowAll)&&void 0!==n&&n,trackSids:t.allowedTrackSids||[]})}(t))))},this.onTrackUnmuted=t=>{this.onTrackMuted(t,t.isUpstreamPaused)},this.onTrackMuted=(t,e)=>{void 0===e&&(e=!0),t.sid?this.engine.updateMuteStatus(t.sid,e):P.error("could not update mute status for unpublished track",t)},this.onTrackUpstreamPaused=t=>{P.debug("upstream paused"),this.onTrackMuted(t,!0)},this.onTrackUpstreamResumed=t=>{P.debug("upstream resumed"),this.onTrackMuted(t,t.isMuted)},this.handleSubscribedQualityUpdate=t=>Ae(this,void 0,void 0,(function*(){var e,i,n,r,s,a;if(!(null===(s=this.roomOptions)||void 0===s?void 0:s.dynacast))return;const o=this.videoTracks.get(t.trackSid);if(o)if(t.subscribedCodecs.length>0){if(!o.videoTrack)return;const s=yield o.videoTrack.setPublishingCodecs(t.subscribedCodecs);try{for(var c,d=!0,h=Ne(s);!(e=(c=yield h.next()).done);d=!0){r=c.value,d=!1;const t=r;Mn(t)&&(P.debug("publish ".concat(t," for ").concat(o.videoTrack.sid)),yield this.publishAdditionalCodecForTrack(o.videoTrack,t,o.options))}}catch(t){i={error:t}}finally{try{d||e||!(n=h.return)||(yield n.call(h))}finally{if(i)throw i.error}}}else t.subscribedQualities.length>0&&(yield null===(a=o.videoTrack)||void 0===a?void 0:a.setPublishingLayers(t.subscribedQualities));else P.warn("received subscribed quality update for unknown track",{method:"handleSubscribedQualityUpdate",sid:t.trackSid})})),this.handleLocalTrackUnpublished=t=>{const e=this.tracks.get(t.trackSid);e?this.unpublishTrack(e.track):P.warn("received unpublished event for unknown track",{method:"handleLocalTrackUnpublished",trackSid:t.trackSid})},this.handleTrackEnded=t=>Ae(this,void 0,void 0,(function*(){if(t.source===_r.Source.ScreenShare||t.source===_r.Source.ScreenShareAudio)P.debug("unpublishing local track due to TrackEnded",{track:t.sid}),this.unpublishTrack(t);else if(t.isUserProvided)yield t.mute();else if(t instanceof ea||t instanceof fa)try{if(qr())try{const e=yield null===navigator||void 0===navigator?void 0:navigator.permissions.query({name:t.source===_r.Source.Camera?"camera":"microphone"});if(e&&"denied"===e.state)throw P.warn("user has revoked access to ".concat(t.source)),e.onchange=()=>{"denied"!==e.state&&(t.isMuted||t.restartTrack(),e.onchange=null)},new Error("GetUserMedia Permission denied")}catch(t){}t.isMuted||(P.debug("track ended, attempting to use a different device"),yield t.restartTrack())}catch(e){P.warn("could not restart track, muting instead"),yield t.mute()}})),this.audioTracks=new Map,this.videoTracks=new Map,this.tracks=new Map,this.engine=i,this.roomOptions=n,this.setupEngine(i),this.activeDeviceMap=new Map}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==he.NONE}getTrack(t){const e=super.getTrack(t);if(e)return e}getTrackByName(t){const e=super.getTrackByName(t);if(e)return e}setupEngine(t){this.engine=t,this.engine.client.onRemoteMuteChanged=(t,e)=>{const i=this.tracks.get(t);i&&i.track&&(e?i.mute():i.unmute())},this.engine.client.onSubscribedQualityUpdate=this.handleSubscribedQualityUpdate,this.engine.client.onLocalTrackUnpublished=this.handleLocalTrackUnpublished,this.engine.on(un.Connected,this.handleReconnected).on(un.SignalRestarted,this.handleReconnected).on(un.SignalResumed,this.handleReconnected).on(un.Restarting,this.handleReconnecting).on(un.Resuming,this.handleReconnecting).on(un.Disconnected,this.handleDisconnected)}setMetadata(t){var e;this.engine.client.sendUpdateLocalMetadata(t,null!==(e=this.name)&&void 0!==e?e:"")}setName(t){var e;this.engine.client.sendUpdateLocalMetadata(null!==(e=this.metadata)&&void 0!==e?e:"",t)}setCameraEnabled(t,e,i){return this.setTrackEnabled(_r.Source.Camera,t,e,i)}setMicrophoneEnabled(t,e,i){return this.setTrackEnabled(_r.Source.Microphone,t,e,i)}setScreenShareEnabled(t,e,i){return this.setTrackEnabled(_r.Source.ScreenShare,t,e,i)}setPermissions(t){const e=this.permissions,i=super.setPermissions(t);return i&&e&&this.emit(ln.ParticipantPermissionsChanged,e),i}setE2EEEnabled(t){return Ae(this,void 0,void 0,(function*(){this.encryptionType=t?he.GCM:he.NONE,yield this.republishAllTracks(void 0,!1)}))}setTrackEnabled(t,e,i,n){var r,s;return Ae(this,void 0,void 0,(function*(){P.debug("setTrackEnabled",{source:t,enabled:e});let a=this.getTrack(t);if(e)if(a)yield a.unmute();else{let e;if(this.pendingPublishing.has(t))return void P.info("skipping duplicate published source",{source:t});this.pendingPublishing.add(t);try{switch(t){case _r.Source.Camera:e=yield this.createTracks({video:null===(r=i)||void 0===r||r});break;case _r.Source.Microphone:e=yield this.createTracks({audio:null===(s=i)||void 0===s||s});break;case _r.Source.ScreenShare:e=yield this.createScreenTracks(Object.assign({},i));break;default:throw new yn(t)}const o=[];for(const t of e)P.info("publishing track",{localTrack:t}),o.push(this.publishTrack(t,n));const c=yield Promise.all(o);[a]=c}catch(t){throw null==e||e.forEach((t=>{t.stop()})),t instanceof Error&&!(t instanceof yn)&&this.emit(ln.MediaDevicesError,t),t}finally{this.pendingPublishing.delete(t)}}else if(a&&a.track)if(t===_r.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const t=this.getTrack(_r.Source.ScreenShareAudio);t&&t.track&&this.unpublishTrack(t.track)}else yield a.mute();return a}))}enableCameraAndMicrophone(){return Ae(this,void 0,void 0,(function*(){if(!this.pendingPublishing.has(_r.Source.Camera)&&!this.pendingPublishing.has(_r.Source.Microphone)){this.pendingPublishing.add(_r.Source.Camera),this.pendingPublishing.add(_r.Source.Microphone);try{const t=yield this.createTracks({audio:!0,video:!0});yield Promise.all(t.map((t=>this.publishTrack(t))))}finally{this.pendingPublishing.delete(_r.Source.Camera),this.pendingPublishing.delete(_r.Source.Microphone)}}}))}createTracks(t){var e,i;return Ae(this,void 0,void 0,(function*(){const n=Ir(xr(t,null===(e=this.roomOptions)||void 0===e?void 0:e.audioCaptureDefaults,null===(i=this.roomOptions)||void 0===i?void 0:i.videoCaptureDefaults));let r;try{r=yield navigator.mediaDevices.getUserMedia(n)}catch(t){throw t instanceof Error&&(n.audio&&(this.microphoneError=t),n.video&&(this.cameraError=t)),t}return n.audio&&(this.microphoneError=void 0,this.emit(ln.AudioStreamAcquired)),n.video&&(this.cameraError=void 0),r.getTracks().map((e=>{const i="audio"===e.kind;let s;i?t.audio:t.video;const a=i?n.audio:n.video;"boolean"!=typeof a&&(s=a);const o=ia(e,s);return o.kind===_r.Kind.Video?o.source=_r.Source.Camera:o.kind===_r.Kind.Audio&&(o.source=_r.Source.Microphone),o.mediaStream=r,o}))}))}createScreenTracks(t){return Ae(this,void 0,void 0,(function*(){if(void 0===t&&(t={}),void 0===navigator.mediaDevices.getDisplayMedia)throw new vn("getDisplayMedia not supported");const e=function(t){var e,i;let n=null===(e=t.video)||void 0===e||e;return t.resolution&&(n="boolean"==typeof n?{}:n,n=jr()?Object.assign(Object.assign({},n),{width:{max:t.resolution.width},height:{max:t.resolution.height},frameRate:t.resolution.frameRate}):Object.assign(Object.assign({},n),{width:{ideal:t.resolution.width},height:{ideal:t.resolution.height},frameRate:t.resolution.frameRate})),{audio:null!==(i=t.audio)&&void 0!==i&&i,video:n,controller:t.controller,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio}}(t),i=yield navigator.mediaDevices.getDisplayMedia(e),n=i.getVideoTracks();if(0===n.length)throw new yn("no video track found");const r=new fa(n[0],void 0,!1);r.source=_r.Source.ScreenShare;const s=[r];if(i.getAudioTracks().length>0){this.emit(ln.AudioStreamAcquired);const t=new ea(i.getAudioTracks()[0],void 0,!1,this.audioContext);t.source=_r.Source.ScreenShareAudio,s.push(t)}return s}))}publishTrack(t,e){var i,n,r,s;return Ae(this,void 0,void 0,(function*(){let a,o;if(yield null===(i=this.reconnectFuture)||void 0===i?void 0:i.promise,t instanceof us&&this.pendingPublishPromises.has(t)&&(yield this.pendingPublishPromises.get(t)),t instanceof MediaStreamTrack)a=t.getConstraints();else{let e;switch(a=t.constraints,t.source){case _r.Source.Microphone:e="audioinput";break;case _r.Source.Camera:e="videoinput"}e&&this.activeDeviceMap.has(e)&&(a=Object.assign(Object.assign({},a),{deviceId:this.activeDeviceMap.get(e)}))}if(t instanceof MediaStreamTrack)switch(t.kind){case"audio":t=new ea(t,a,!0,this.audioContext);break;case"video":t=new fa(t,a,!0);break;default:throw new yn("unsupported MediaStreamTrack kind ".concat(t.kind))}if(t instanceof ea&&t.setAudioContext(this.audioContext),this.tracks.forEach((e=>{e.track&&e.track===t&&(o=e)})),o)return P.warn("track has already been published, skipping"),o;const c="channelCount"in t.mediaStreamTrack.getSettings()&&2===t.mediaStreamTrack.getSettings().channelCount||2===t.mediaStreamTrack.getConstraints().channelCount,d=null!==(n=null==e?void 0:e.forceStereo)&&void 0!==n?n:c;d&&(e||(e={}),void 0===e.dtx&&P.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work."),void 0===e.red&&P.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),null!==(r=e.dtx)&&void 0!==r||(e.dtx=!1),null!==(s=e.red)&&void 0!==s||(e.red=!1));const h=Object.assign(Object.assign({},this.roomOptions.publishDefaults),e);jr()&&this.roomOptions.e2ee&&(P.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari"),h.simulcast=!1),h.source&&(t.source=h.source);const l=this.publish(t,h,d);this.pendingPublishPromises.set(t,l);try{return yield l}catch(t){throw t}finally{this.pendingPublishPromises.delete(t)}}))}publish(t,e,i){var n,r,s,a,o,c,d,h,l,u,p,m,f;return Ae(this,void 0,void 0,(function*(){Array.from(this.tracks.values()).find((e=>t instanceof us&&e.source===t.source))&&t.source!==_r.Source.Unknown&&P.info("publishing a second track with the same source: ".concat(t.source)),e.stopMicTrackOnMute&&t instanceof ea&&(t.stopOnMute=!0),t.source===_r.Source.ScreenShare&&Vr()&&(e.simulcast=!1),"av1"!==e.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(jr())return!1;const t=RTCRtpSender.getCapabilities("video");let e=!1;if(t)for(const i of t.codecs)if("video/AV1"===i.mimeType){e=!0;break}return e}()||(e.videoCodec=void 0),"vp9"!==e.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(Vr())return!1;if(jr()){const t=_n();if((null==t?void 0:t.version)&&Xr(t.version,"16")<0)return!1}const t=RTCRtpSender.getCapabilities("video");let e=!1;if(t)for(const i of t.codecs)if("video/VP9"===i.mimeType){e=!0;break}return e}()||(e.videoCodec=void 0),void 0===e.videoCodec&&(e.videoCodec=Fs);const g=e.videoCodec;t.on(pn.Muted,this.onTrackMuted),t.on(pn.Unmuted,this.onTrackUnmuted),t.on(pn.Ended,this.handleTrackEnded),t.on(pn.UpstreamPaused,this.onTrackUpstreamPaused),t.on(pn.UpstreamResumed,this.onTrackUpstreamResumed);const v=new Jn({cid:t.mediaStreamTrack.id,name:e.name,type:_r.kindToProto(t.kind),muted:t.isMuted,source:_r.sourceToProto(t.source),disableDtx:!(null===(n=e.dtx)||void 0===n||n),encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(null===(r=e.red)||void 0===r||r),stream:null==e?void 0:e.stream});let y;if(t.kind===_r.Kind.Video){let i={width:0,height:0};try{i=yield t.waitForDimensions()}catch(t){const e=null!==(a=null===(s=this.roomOptions.videoCaptureDefaults)||void 0===s?void 0:s.resolution)&&void 0!==a?a:Nn.h720.resolution;i={width:e.width,height:e.height},P.error("could not determine track dimensions, using defaults",i)}v.width=i.width,v.height=i.height,t instanceof fa&&(Fr(g)&&(t.source===_r.Source.ScreenShare&&"vp9"===g&&(e.scalabilityMode="L1T3"),e.scalabilityMode=null!==(o=e.scalabilityMode)&&void 0!==o?o:"L3T3_KEY"),v.simulcastCodecs=[new jn({codec:g,cid:t.mediaStreamTrack.id})],!0===e.backupCodec&&(e.backupCodec={codec:Fs}),e.backupCodec&&g!==e.backupCodec.codec&&v.encryption===he.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),v.simulcastCodecs.push(new jn({codec:e.backupCodec.codec,cid:""})))),y=ha(t.source===_r.Source.ScreenShare,v.width,v.height,e),v.layers=ya(v.width,v.height,y,Fr(e.videoCodec))}else t.kind===_r.Kind.Audio&&(y=[{maxBitrate:null!==(d=null===(c=e.audioPreset)||void 0===c?void 0:c.maxBitrate)&&void 0!==d?d:e.audioBitrate,priority:null!==(l=null===(h=e.audioPreset)||void 0===h?void 0:h.priority)&&void 0!==l?l:"high",networkPriority:null!==(p=null===(u=e.audioPreset)||void 0===u?void 0:u.priority)&&void 0!==p?p:"high"}]);if(!this.engine||this.engine.isClosed)throw new kn("cannot publish track when not connected");const b=yield this.engine.addTrack(v);let k;if(b.codecs.forEach((t=>{void 0===k&&(k=t.mimeType)})),k&&t.kind===_r.Kind.Video){const i=Mr(k);i!==g&&(P.debug("falling back to server selected codec",{codec:i}),e.videoCodec=i,y=ha(t.source===_r.Source.ScreenShare,v.width,v.height,e))}const S=new _a(t.kind,b,t);if(S.options=e,t.sid=b.sid,!this.engine.pcManager)throw new kn("pcManager is not ready");if(P.debug("publishing ".concat(t.kind," with encodings"),{encodings:y,trackInfo:b}),t.sender=yield this.engine.createSender(t,e,y),y)if(Vr()&&t.kind===_r.Kind.Audio){let e;for(const i of this.engine.pcManager.publisher.getTransceivers())if(i.sender===t.sender){e=i;break}e&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:e,codec:"opus",maxbr:(null===(m=y[0])||void 0===m?void 0:m.maxBitrate)?y[0].maxBitrate/1e3:0})}else t.codec&&Fr(t.codec)&&(null===(f=y[0])||void 0===f?void 0:f.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:v.cid,codec:t.codec,maxbr:y[0].maxBitrate/1e3});return yield this.engine.negotiate(),t instanceof fa?t.startMonitor(this.engine.client):t instanceof ea&&t.startMonitor(),this.addTrackPublication(S),this.emit(ln.LocalTrackPublished,S),S}))}get isLocal(){return!0}publishAdditionalCodecForTrack(t,e,i){var n;return Ae(this,void 0,void 0,(function*(){if(this.encryptionType!==he.NONE)return;let r;if(this.tracks.forEach((e=>{e.track&&e.track===t&&(r=e)})),!r)throw new yn("track is not published");if(!(t instanceof fa))throw new yn("track is not a video track");const s=Object.assign(Object.assign({},null===(n=this.roomOptions)||void 0===n?void 0:n.publishDefaults),i),a=function(t,e,i){var n,r,s,a;if(!i.backupCodec||!0===i.backupCodec||i.backupCodec.codec===i.videoCodec)return;e!==i.backupCodec.codec&&P.warn("requested a different codec than specified as backup",{serverRequested:e,backup:i.backupCodec.codec}),i.videoCodec=e,i.videoEncoding=i.backupCodec.encoding;const o=t.mediaStreamTrack.getSettings(),c=null!==(n=o.width)&&void 0!==n?n:null===(r=t.dimensions)||void 0===r?void 0:r.width,d=null!==(s=o.height)&&void 0!==s?s:null===(a=t.dimensions)||void 0===a?void 0:a.height;return ha(t.source===_r.Source.ScreenShare,c,d,i)}(t,e,s);if(!a)return void P.info("backup codec has been disabled, ignoring request to add additional codec for track");const o=t.addSimulcastTrack(e,a),c=new Jn({cid:o.mediaStreamTrack.id,type:_r.kindToProto(t.kind),muted:t.isMuted,source:_r.sourceToProto(t.source),sid:t.sid,simulcastCodecs:[{codec:s.videoCodec,cid:o.mediaStreamTrack.id}]});if(c.layers=ya(c.width,c.height,a),!this.engine||this.engine.isClosed)throw new kn("cannot publish track when not connected");const d=yield this.engine.addTrack(c);yield this.engine.createSimulcastSender(t,o,s,a),yield this.engine.negotiate(),P.debug("published ".concat(e," for track ").concat(t.sid),{encodings:a,trackInfo:d})}))}unpublishTrack(t,e){var i,n;return Ae(this,void 0,void 0,(function*(){const r=this.getPublicationForTrack(t);if(P.debug("unpublishing track",{track:t,method:"unpublishTrack"}),!r||!r.track)return void P.warn("track was not unpublished because no publication was found",{track:t,method:"unpublishTrack"});(t=r.track).off(pn.Muted,this.onTrackMuted),t.off(pn.Unmuted,this.onTrackUnmuted),t.off(pn.Ended,this.handleTrackEnded),t.off(pn.UpstreamPaused,this.onTrackUpstreamPaused),t.off(pn.UpstreamResumed,this.onTrackUpstreamResumed),void 0===e&&(e=null===(n=null===(i=this.roomOptions)||void 0===i?void 0:i.stopLocalTrackOnUnpublish)||void 0===n||n),e&&t.stop();let s=!1;const a=t.sender;if(t.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<qs.FAILED&&a)try{for(const t of this.engine.pcManager.publisher.getTransceivers())t.sender===a&&(t.direction="inactive",s=!0);if(this.engine.removeTrack(a)&&(s=!0),t instanceof fa){for(const[,e]of t.simulcastCodecs)e.sender&&(this.engine.removeTrack(e.sender)&&(s=!0),e.sender=void 0);t.simulcastCodecs.clear()}}catch(t){P.warn("failed to unpublish track",{error:t,method:"unpublishTrack"})}switch(this.tracks.delete(r.trackSid),r.kind){case _r.Kind.Audio:this.audioTracks.delete(r.trackSid);break;case _r.Kind.Video:this.videoTracks.delete(r.trackSid)}return this.emit(ln.LocalTrackUnpublished,r),r.setTrack(void 0),s&&(yield this.engine.negotiate()),r}))}unpublishTracks(t){return Ae(this,void 0,void 0,(function*(){return(yield Promise.all(t.map((t=>this.unpublishTrack(t))))).filter((t=>t instanceof _a))}))}republishAllTracks(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Ae(this,void 0,void 0,(function*(){const i=[];this.tracks.forEach((e=>{e.track&&(t&&(e.options=Object.assign(Object.assign({},e.options),t)),i.push(e))})),yield Promise.all(i.map((t=>Ae(this,void 0,void 0,(function*(){const i=t.track;yield this.unpublishTrack(i,!1),e&&!i.isMuted&&(i instanceof ea||i instanceof fa)&&!i.isUserProvided&&(P.debug("restarting existing track",{track:t.trackSid}),yield i.restartTrack()),yield this.publishTrack(i,t.options)})))))}))}publishData(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Ae(this,void 0,void 0,(function*(){const n=Array.isArray(i)?i:null==i?void 0:i.destination,r=[],s=Array.isArray(i)?void 0:i.topic;void 0!==n&&n.forEach((t=>{t instanceof Da?r.push(t.sid):r.push(t)}));const a=new ye({kind:e,value:{case:"user",value:new Se({participantSid:this.sid,payload:t,destinationSids:r,topic:s})}});yield this.engine.sendDataPacket(a,e)}))}setTrackSubscriptionPermissions(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.participantTrackPermissions=e,this.allParticipantsAllowedToSubscribe=t,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}updateInfo(t){return t.sid===this.sid&&!!super.updateInfo(t)&&(t.tracks.forEach((t=>{var e,i;const n=this.tracks.get(t.sid);if(n){const r=n.isMuted||null!==(i=null===(e=n.track)||void 0===e?void 0:e.isUpstreamPaused)&&void 0!==i&&i;r!==t.muted&&(P.debug("updating server mute state after reconcile",{sid:t.sid,muted:r}),this.engine.client.sendMuteTrack(t.sid,r))}})),!0)}getPublicationForTrack(t){let e;return this.tracks.forEach((i=>{const n=i.track;n&&(t instanceof MediaStreamTrack?(n instanceof ea||n instanceof fa)&&n.mediaStreamTrack===t&&(e=i):t===n&&(e=i))})),e}}!function(t){t.Disconnected="disconnected",t.Connecting="connecting",t.Connected="connected",t.Reconnecting="reconnecting"}(Ea||(Ea={}));class Aa extends Qe.EventEmitter{constructor(t){var e,i;super(),e=this,this.state=Ea.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.connect=(t,e,i)=>Ae(this,void 0,void 0,(function*(){var n;const r=yield this.disconnectLock.lock();if(this.state===Ea.Connected)return P.info("already connected to room ".concat(this.name)),r(),Promise.resolve();if(this.connectFuture)return r(),this.connectFuture.promise;this.setAndEmitConnectionState(Ea.Connecting),(null===(n=this.regionUrlProvider)||void 0===n?void 0:n.getServerUrl().toString())!==t&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),Hr(new URL(t))&&(void 0===this.regionUrlProvider?this.regionUrlProvider=new Zs(t,e):this.regionUrlProvider.updateToken(e),this.regionUrlProvider.fetchRegionSettings().catch((t=>{P.warn("could not fetch region settings",{error:t})})));const s=(n,a,o)=>Ae(this,void 0,void 0,(function*(){var c;this.abortController&&this.abortController.abort();const d=new AbortController;this.abortController=d,null==r||r();try{yield this.attemptConnection(null!=o?o:t,e,i,d),this.abortController=void 0,n()}catch(t){if(this.regionUrlProvider&&t instanceof gn&&3!==t.reason&&0!==t.reason){let e=null;try{e=yield this.regionUrlProvider.getNextBestRegionUrl(null===(c=this.abortController)||void 0===c?void 0:c.signal)}catch(t){if(t instanceof gn&&(401===t.status||3===t.reason))return this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),void a(t)}e?(P.info("Initial connection failed with ConnectionError: ".concat(t.message,". Retrying with another region: ").concat(e)),yield s(n,a,e)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),a(t))}else this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),a(t)}})),a=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new as(((t,e)=>{s(t,e,a)}),(()=>{this.clearConnectionFutures()})),this.connectFuture.promise})),this.connectSignal=(t,e,i,n,r,s)=>Ae(this,void 0,void 0,(function*(){const a=yield i.join(t,e,{autoSubscribe:n.autoSubscribe,publishOnly:n.publishOnly,adaptiveStream:"object"==typeof r.adaptiveStream||r.adaptiveStream,maxRetries:n.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:n.websocketTimeout},s.signal);let o=a.serverInfo;if(o||(o={version:a.serverVersion,region:a.serverRegion}),P.debug("connected to Livekit Server ".concat(Object.entries(o).map((t=>{let[e,i]=t;return"".concat(e,": ").concat(i)})).join(", "))),!a.serverVersion)throw new bn("unknown server version");return"0.15.1"===a.serverVersion&&this.options.dynacast&&(P.debug("disabling dynacast due to server version"),r.dynacast=!1),a})),this.applyJoinResponse=t=>{const e=t.participant;this.localParticipant.sid=e.sid,this.localParticipant.identity=e.identity,this.handleParticipantUpdates([e,...t.otherParticipants]),t.room&&this.handleRoomUpdate(t.room),this.options.e2ee&&this.e2eeManager&&this.e2eeManager.setSifTrailer(t.sifTrailer)},this.attemptConnection=(t,e,i,n)=>Ae(this,void 0,void 0,(function*(){var r,s;this.state===Ea.Reconnecting?(P.info("Reconnection attempt replaced by new connection attempt"),this.recreateEngine()):this.maybeCreateEngine(),(null===(r=this.regionUrlProvider)||void 0===r?void 0:r.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},Js),i),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const i=yield this.connectSignal(t,e,this.engine,this.connOptions,this.options,n);this.applyJoinResponse(i),this.setupLocalParticipantEvents(),this.emit(hn.SignalConnected)}catch(t){yield this.engine.close(),this.recreateEngine();const e=new gn("could not establish signal connection");throw t instanceof Error&&(e.message="".concat(e.message,": ").concat(t.message)),t instanceof gn&&(e.reason=t.reason,e.status=t.status),P.debug("error trying to establish signal connection",{error:t}),e}if(n.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new gn("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,n)}catch(t){throw yield this.engine.close(),this.recreateEngine(),t}qr()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),qr()&&(document.addEventListener("freeze",this.onPageLeave),null===(s=navigator.mediaDevices)||void 0===s||s.addEventListener("devicechange",this.handleDeviceChange)),this.setAndEmitConnectionState(Ea.Connected),this.emit(hn.Connected),this.registerConnectionReconcile()})),this.disconnect=function(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return Ae(e,void 0,void 0,(function*(){var e,i,n,r;const s=yield this.disconnectLock.lock();try{if(this.state===Ea.Disconnected)return void P.debug("already disconnected");P.info("disconnect from room",{identity:this.localParticipant.identity}),this.state!==Ea.Connecting&&this.state!==Ea.Reconnecting||(P.warn("abort connection attempt"),null===(e=this.abortController)||void 0===e||e.abort(),null===(n=null===(i=this.connectFuture)||void 0===i?void 0:i.reject)||void 0===n||n.call(i,new gn("Client initiated disconnect")),this.connectFuture=void 0),(null===(r=this.engine)||void 0===r?void 0:r.client.isDisconnected)||(yield this.engine.client.sendLeave()),this.engine&&(yield this.engine.close()),this.handleDisconnect(t,$t.CLIENT_INITIATED),this.engine=void 0}finally{s()}}))},this.onPageLeave=()=>Ae(this,void 0,void 0,(function*(){yield this.disconnect()})),this.startAudio=()=>Ae(this,void 0,void 0,(function*(){const t=[],e=_n();if(e&&"iOS"===e.os){const e="livekit-dummy-audio-el";let i=document.getElementById(e);if(!i){i=document.createElement("audio"),i.id=e,i.autoplay=!0,i.hidden=!0;const t=ss();t.enabled=!0;const n=new MediaStream([t]);i.srcObject=n,document.addEventListener("visibilitychange",(()=>{i&&(i.srcObject=document.hidden?null:n)})),document.body.append(i),this.once(hn.Disconnected,(()=>{null==i||i.remove()}))}t.push(i)}this.participants.forEach((e=>{e.audioTracks.forEach((e=>{e.track&&e.track.attachedElements.forEach((e=>{t.push(e)}))}))}));try{yield Promise.all([this.acquireAudioContext(),...t.map((t=>(t.muted=!1,t.play())))]),this.handleAudioPlaybackStarted()}catch(t){throw this.handleAudioPlaybackFailed(t),t}})),this.startVideo=()=>Ae(this,void 0,void 0,(function*(){const t=[];for(const e of this.participants.values())e.videoTracks.forEach((e=>{var i;null===(i=e.track)||void 0===i||i.attachedElements.forEach((e=>{t.includes(e)||t.push(e)}))}));yield Promise.all(t.map((t=>t.play()))).then((()=>{this.handleVideoPlaybackStarted()})).catch((t=>{"NotAllowedError"===t.name?this.handleVideoPlaybackFailed():P.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler")}))})),this.handleRestarting=()=>{this.clearConnectionReconcile();for(const t of this.participants.values())this.handleParticipantDisconnected(t.sid,t);this.setAndEmitConnectionState(Ea.Reconnecting)&&this.emit(hn.Reconnecting)},this.handleSignalRestarted=t=>Ae(this,void 0,void 0,(function*(){P.debug("signal reconnected to server",{region:t.serverRegion}),this.cachedParticipantSids=[],this.applyJoinResponse(t);try{const t=[];this.localParticipant.tracks.forEach((e=>{e.track&&t.push(e)})),yield Promise.all(t.map((t=>Ae(this,void 0,void 0,(function*(){const e=t.track;this.localParticipant.unpublishTrack(e,!1),e.isMuted||((e instanceof ea||e instanceof fa)&&e.source!==_r.Source.ScreenShare&&e.source!==_r.Source.ScreenShareAudio&&!e.isUserProvided&&(P.debug("restarting existing track",{track:t.trackSid}),yield e.restartTrack()),P.debug("publishing new track",{track:t.trackSid}),yield this.localParticipant.publishTrack(e,t.options))})))))}catch(t){P.error("error trying to re-publish tracks after reconnection",{error:t})}try{yield this.engine.waitForRestarted(),P.debug("fully reconnected to server",{region:t.serverRegion})}catch(t){return}this.setAndEmitConnectionState(Ea.Connected),this.emit(hn.Reconnected),this.registerConnectionReconcile(),this.participants.forEach((t=>{this.emit(hn.ParticipantConnected,t)}))})),this.handleParticipantUpdates=t=>{t.forEach((t=>{if(t.identity===this.localParticipant.identity)return void this.localParticipant.updateInfo(t);const e=this.identityToSid.get(t.identity);e&&e!==t.sid&&this.handleParticipantDisconnected(e,this.participants.get(e));let i=this.participants.get(t.sid);const n=!i;t.state===de.DISCONNECTED?this.handleParticipantDisconnected(t.sid,i):(i=this.getOrCreateParticipant(t.sid,t),n||i.updateInfo(t))}))},this.handleActiveSpeakersUpdate=t=>{const e=[],i={};t.forEach((t=>{if(i[t.sid]=!0,t.sid===this.localParticipant.sid)this.localParticipant.audioLevel=t.level,this.localParticipant.setIsSpeaking(!0),e.push(this.localParticipant);else{const i=this.participants.get(t.sid);i&&(i.audioLevel=t.level,i.setIsSpeaking(!0),e.push(i))}})),i[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.participants.forEach((t=>{i[t.sid]||(t.audioLevel=0,t.setIsSpeaking(!1))})),this.activeSpeakers=e,this.emitWhenConnected(hn.ActiveSpeakersChanged,e)},this.handleSpeakersChanged=t=>{const e=new Map;this.activeSpeakers.forEach((t=>{e.set(t.sid,t)})),t.forEach((t=>{let i=this.participants.get(t.sid);t.sid===this.localParticipant.sid&&(i=this.localParticipant),i&&(i.audioLevel=t.level,i.setIsSpeaking(t.active),t.active?e.set(t.sid,i):e.delete(t.sid))}));const i=Array.from(e.values());i.sort(((t,e)=>e.audioLevel-t.audioLevel)),this.activeSpeakers=i,this.emitWhenConnected(hn.ActiveSpeakersChanged,i)},this.handleStreamStateUpdate=t=>{t.streamStates.forEach((t=>{const e=this.participants.get(t.participantSid);if(!e)return;const i=e.getTrackPublication(t.trackSid);i&&i.track&&(i.track.streamState=_r.streamStateFromProto(t.state),e.emit(ln.TrackStreamStateChanged,i,i.track.streamState),this.emitWhenConnected(hn.TrackStreamStateChanged,i,i.track.streamState,e))}))},this.handleSubscriptionPermissionUpdate=t=>{const e=this.participants.get(t.participantSid);if(!e)return;const i=e.getTrackPublication(t.trackSid);i&&i.setAllowed(t.allowed)},this.handleSubscriptionError=t=>{const e=Array.from(this.participants.values()).find((e=>e.tracks.has(t.trackSid)));if(!e)return;const i=e.getTrackPublication(t.trackSid);i&&i.setSubscriptionError(t.err)},this.handleDataPacket=(t,e)=>{const i=this.participants.get(t.participantSid);this.emit(hn.DataReceived,t.payload,i,e,t.topic),null==i||i.emit(ln.DataReceived,t.payload,e)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(hn.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=t=>{P.warn("could not playback audio",t),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(hn.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(hn.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(hn.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>Ae(this,void 0,void 0,(function*(){this.emit(hn.MediaDevicesChanged)})),this.handleRoomUpdate=t=>{const e=this.roomInfo;this.roomInfo=t,e&&e.metadata!==t.metadata&&this.emitWhenConnected(hn.RoomMetadataChanged,t.metadata),(null==e?void 0:e.activeRecording)!==t.activeRecording&&this.emitWhenConnected(hn.RecordingStatusChanged,t.activeRecording)},this.handleConnectionQualityUpdate=t=>{t.updates.forEach((t=>{if(t.participantSid===this.localParticipant.sid)return void this.localParticipant.setConnectionQuality(t.quality);const e=this.participants.get(t.participantSid);e&&e.setConnectionQuality(t.quality)}))},this.onLocalParticipantMetadataChanged=t=>{this.emit(hn.ParticipantMetadataChanged,t,this.localParticipant)},this.onLocalParticipantNameChanged=t=>{this.emit(hn.ParticipantNameChanged,t,this.localParticipant)},this.onLocalTrackMuted=t=>{this.emit(hn.TrackMuted,t,this.localParticipant)},this.onLocalTrackUnmuted=t=>{this.emit(hn.TrackUnmuted,t,this.localParticipant)},this.onLocalTrackPublished=t=>Ae(this,void 0,void 0,(function*(){var e;this.emit(hn.LocalTrackPublished,t,this.localParticipant),t.track instanceof ea&&(yield t.track.checkForSilence())&&this.emit(hn.LocalAudioSilenceDetected,t);const i=yield null===(e=t.track)||void 0===e?void 0:e.getDeviceId(),n=(r=t.source)===_r.Source.Microphone?"audioinput":r===_r.Source.Camera?"videoinput":void 0;var r;n&&i&&i!==this.localParticipant.activeDeviceMap.get(n)&&(this.localParticipant.activeDeviceMap.set(n,i),this.emit(hn.ActiveDeviceChanged,n,i))})),this.onLocalTrackUnpublished=t=>{this.emit(hn.LocalTrackUnpublished,t,this.localParticipant)},this.onLocalConnectionQualityChanged=t=>{this.emit(hn.ConnectionQualityChanged,t,this.localParticipant)},this.onMediaDevicesError=t=>{this.emit(hn.MediaDevicesError,t)},this.onLocalParticipantPermissionsChanged=t=>{this.emit(hn.ParticipantPermissionsChanged,t,this.localParticipant)},this.setMaxListeners(100),this.participants=new Map,this.cachedParticipantSids=[],this.identityToSid=new Map,this.options=Object.assign(Object.assign({},js),t),this.options.audioCaptureDefaults=Object.assign(Object.assign({},Gs),null==t?void 0:t.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},Vs),null==t?void 0:t.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Bs),null==t?void 0:t.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new os,this.localParticipant=new Ma("","",this.engine,this.options),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",cs(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",cs(this.options.audioCaptureDefaults.deviceId)),(null===(i=this.options.audioOutput)||void 0===i?void 0:i.deviceId)&&this.switchActiveDevice("audiooutput",cs(this.options.audioOutput.deviceId)),this.options.e2ee&&this.setupE2EE()}setE2EEEnabled(t){return Ae(this,void 0,void 0,(function*(){if(!this.e2eeManager)throw Error("e2ee not configured, please set e2ee settings within the room options");yield Promise.all([this.localParticipant.setE2EEEnabled(t)]),""!==this.localParticipant.identity&&this.e2eeManager.setParticipantCryptorEnabled(t,this.localParticipant.identity)}))}setupE2EE(){var t;this.options.e2ee&&(this.e2eeManager=new ps(this.options.e2ee),this.e2eeManager.on(on.ParticipantEncryptionStatusChanged,((t,e)=>{e instanceof Ma&&(this.isE2EEEnabled=t),this.emit(hn.ParticipantEncryptionStatusChanged,t,e)})),this.e2eeManager.on(on.EncryptionError,(t=>this.emit(hn.EncryptionError,t))),null===(t=this.e2eeManager)||void 0===t||t.setup(this))}get isRecording(){var t,e;return null!==(e=null===(t=this.roomInfo)||void 0===t?void 0:t.activeRecording)&&void 0!==e&&e}get sid(){var t,e;return null!==(e=null===(t=this.roomInfo)||void 0===t?void 0:t.sid)&&void 0!==e?e:""}get name(){var t,e;return null!==(e=null===(t=this.roomInfo)||void 0===t?void 0:t.name)&&void 0!==e?e:""}get metadata(){var t;return null===(t=this.roomInfo)||void 0===t?void 0:t.metadata}get numParticipants(){var t,e;return null!==(e=null===(t=this.roomInfo)||void 0===t?void 0:t.numParticipants)&&void 0!==e?e:0}get numPublishers(){var t,e;return null!==(e=null===(t=this.roomInfo)||void 0===t?void 0:t.numPublishers)&&void 0!==e?e:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Xs(this.options),this.engine.on(un.ParticipantUpdate,this.handleParticipantUpdates).on(un.RoomUpdate,this.handleRoomUpdate).on(un.SpeakersChanged,this.handleSpeakersChanged).on(un.StreamStateChanged,this.handleStreamStateUpdate).on(un.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(un.SubscriptionError,this.handleSubscriptionError).on(un.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(un.MediaTrackAdded,((t,e,i)=>{this.onTrackAdded(t,e,i)})).on(un.Disconnected,(t=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t)})).on(un.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(un.DataPacketReceived,this.handleDataPacket).on(un.Resuming,(()=>{this.clearConnectionReconcile(),this.setAndEmitConnectionState(Ea.Reconnecting)&&this.emit(hn.Reconnecting),this.cachedParticipantSids=Array.from(this.participants.keys())})).on(un.Resumed,(()=>{this.setAndEmitConnectionState(Ea.Connected),this.emit(hn.Reconnected),this.registerConnectionReconcile(),this.updateSubscriptions(),Array.from(this.participants.values()).filter((t=>!this.cachedParticipantSids.includes(t.sid))).forEach((t=>this.emit(hn.ParticipantConnected,t))),this.cachedParticipantSids=[]})).on(un.SignalResumed,(()=>{this.state===Ea.Reconnecting&&this.sendSyncState()})).on(un.Restarting,this.handleRestarting).on(un.SignalRestarted,this.handleSignalRestarted).on(un.DCBufferStatusChanged,((t,e)=>{this.emit(hn.DCBufferStatusChanged,t,e)})),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return ls.getInstance().getDevices(t,e)}prepareConnection(t,e){return Ae(this,void 0,void 0,(function*(){if(this.state===Ea.Disconnected){P.debug("prepareConnection to ".concat(t));try{if(Hr(new URL(t))&&e){this.regionUrlProvider=new Zs(t,e);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===Ea.Disconnected&&(this.regionUrl=i,yield fetch(ds(i),{method:"HEAD"}),P.debug("prepared connection to ".concat(i)))}else yield fetch(ds(t),{method:"HEAD"})}catch(t){P.warn("could not prepare connection",{error:t})}}}))}getParticipantByIdentity(t){if(this.localParticipant.identity===t)return this.localParticipant;const e=this.identityToSid.get(t);return e?this.participants.get(e):void 0}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(t,e){return Ae(this,void 0,void 0,(function*(){let i,n=()=>{};switch(t){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":i=new yr({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":i=new yr({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":i=new yr({scenario:{case:"serverLeave",value:!0}});break;case"migration":i=new yr({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":i=new yr({scenario:{case:"switchCandidateProtocol",value:"force-tls"===t?2:1}}),n=()=>Ae(this,void 0,void 0,(function*(){const t=this.engine.client.onLeave;t&&t(new tr({reason:$t.CLIENT_INITIATED,canReconnect:!0}))}));break;case"subscriber-bandwidth":if(void 0===e||"number"!=typeof e)throw new Error("subscriber-bandwidth requires a number as argument");i=new yr({scenario:{case:"subscriberBandwidth",value:BigInt(e)}})}i&&(this.engine.client.sendSimulateScenario(i),n())}))}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveAudioOutputDevice(){var t,e;return null!==(e=null===(t=this.options.audioOutput)||void 0===t?void 0:t.deviceId)&&void 0!==e?e:""}getActiveDevice(t){return this.localParticipant.activeDeviceMap.get(t)}switchActiveDevice(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,r,s;return Ae(this,void 0,void 0,(function*(){let a=!1,o=!0;const c=i?{exact:e}:e;if("audioinput"===t){const t=this.options.audioCaptureDefaults.deviceId;this.options.audioCaptureDefaults.deviceId=c,a=t!==c;const e=Array.from(this.localParticipant.audioTracks.values()).filter((t=>t.source===_r.Source.Microphone));try{o=(yield Promise.all(e.map((t=>{var e;return null===(e=t.audioTrack)||void 0===e?void 0:e.setDeviceId(c)})))).every((t=>!0===t))}catch(e){throw this.options.audioCaptureDefaults.deviceId=t,e}}else if("videoinput"===t){const t=this.options.videoCaptureDefaults.deviceId;this.options.videoCaptureDefaults.deviceId=c,a=t!==c;const e=Array.from(this.localParticipant.videoTracks.values()).filter((t=>t.source===_r.Source.Camera));try{o=(yield Promise.all(e.map((t=>{var e;return null===(e=t.videoTrack)||void 0===e?void 0:e.setDeviceId(c)})))).every((t=>!0===t))}catch(e){throw this.options.videoCaptureDefaults.deviceId=t,e}}else if("audiooutput"===t){if(!Br()&&!this.options.expWebAudioMix||this.options.expWebAudioMix&&this.audioContext&&!("setSinkId"in this.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");null!==(n=(s=this.options).audioOutput)&&void 0!==n||(s.audioOutput={});const t=this.options.audioOutput.deviceId;this.options.audioOutput.deviceId=e,a=t!==c;try{this.options.expWebAudioMix?null===(r=this.audioContext)||void 0===r||r.setSinkId(e):yield Promise.all(Array.from(this.participants.values()).map((t=>t.setAudioOutput({deviceId:e}))))}catch(e){throw this.options.audioOutput.deviceId=t,e}}return a&&o&&(this.localParticipant.activeDeviceMap.set(t,e),this.emit(hn.ActiveDeviceChanged,t,e)),o}))}setupLocalParticipantEvents(){this.localParticipant.on(ln.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ln.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ln.TrackMuted,this.onLocalTrackMuted).on(ln.TrackUnmuted,this.onLocalTrackUnmuted).on(ln.LocalTrackPublished,this.onLocalTrackPublished).on(ln.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ln.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ln.MediaDevicesError,this.onMediaDevicesError).on(ln.AudioStreamAcquired,this.startAudio).on(ln.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var t;null===(t=this.engine)||void 0===t||t.close(),this.engine=void 0,this.participants.clear(),this.maybeCreateEngine()}onTrackAdded(t,e,i){if(this.state===Ea.Connecting||this.state===Ea.Reconnecting){const n=()=>{this.onTrackAdded(t,e,i),r()},r=()=>{this.off(hn.Reconnected,n),this.off(hn.Connected,n),this.off(hn.Disconnected,r)};return this.once(hn.Reconnected,n),this.once(hn.Connected,n),void this.once(hn.Disconnected,r)}if(this.state===Ea.Disconnected)return void P.warn("skipping incoming track after Room disconnected");const n=function(t){const e=t.split("|");return e.length>1?[e[0],t.substr(e[0].length+1)]:[t,""]}(e.id),r=n[0];let s=n[1],a=t.id;if(s&&s.startsWith("TR")&&(a=s),r===this.localParticipant.sid)return void P.warn("tried to create RemoteParticipant for local participant");const o=this.participants.get(r);if(!o)return void P.error("Tried to add a track for a participant, that's not present. Sid: ".concat(r));let c;this.options.adaptiveStream&&(c="object"==typeof this.options.adaptiveStream?this.options.adaptiveStream:{}),o.addSubscribedMediaTrack(t,a,e,i,c)}handleDisconnect(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1?arguments[1]:void 0;var i;if(this.clearConnectionReconcile(),this.state!==Ea.Disconnected){this.regionUrl=void 0;try{this.participants.forEach((t=>{t.tracks.forEach((e=>{t.unpublishTrack(e.trackSid)}))})),this.localParticipant.tracks.forEach((e=>{var i,n;e.track&&this.localParticipant.unpublishTrack(e.track,t),t&&(null===(i=e.track)||void 0===i||i.detach(),null===(n=e.track)||void 0===n||n.stop())})),this.localParticipant.off(ln.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ln.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ln.TrackMuted,this.onLocalTrackMuted).off(ln.TrackUnmuted,this.onLocalTrackUnmuted).off(ln.LocalTrackPublished,this.onLocalTrackPublished).off(ln.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ln.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ln.MediaDevicesError,this.onMediaDevicesError).off(ln.AudioStreamAcquired,this.startAudio).off(ln.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.tracks.clear(),this.localParticipant.videoTracks.clear(),this.localParticipant.audioTracks.clear(),this.participants.clear(),this.activeSpeakers=[],this.audioContext&&"boolean"==typeof this.options.expWebAudioMix&&(this.audioContext.close(),this.audioContext=void 0),qr()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),null===(i=navigator.mediaDevices)||void 0===i||i.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(Ea.Disconnected),this.emit(hn.Disconnected,e)}}}handleParticipantDisconnected(t,e){this.participants.delete(t),e&&(this.identityToSid.delete(e.identity),e.tracks.forEach((t=>{e.unpublishTrack(t.trackSid,!0)})),this.emit(hn.ParticipantDisconnected,e))}acquireAudioContext(){var t,e;return Ae(this,void 0,void 0,(function*(){if("boolean"!=typeof this.options.expWebAudioMix&&this.options.expWebAudioMix.audioContext?this.audioContext=this.options.expWebAudioMix.audioContext:this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=null!==(t=Dr())&&void 0!==t?t:void 0),this.audioContext&&"suspended"===this.audioContext.state)try{yield this.audioContext.resume()}catch(t){P.warn(t)}this.options.expWebAudioMix&&this.participants.forEach((t=>t.setAudioContext(this.audioContext))),this.localParticipant.setAudioContext(this.audioContext);const i="running"===(null===(e=this.audioContext)||void 0===e?void 0:e.state);i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(hn.AudioPlaybackStatusChanged,i))}))}createParticipant(t,e){let i;return i=e?Da.fromParticipantInfo(this.engine.client,e):new Da(this.engine.client,t,"",void 0,void 0),this.options.expWebAudioMix&&i.setAudioContext(this.audioContext),i}getOrCreateParticipant(t,e){if(this.participants.has(t))return this.participants.get(t);const i=this.createParticipant(t,e);return this.participants.set(t,i),this.identityToSid.set(e.identity,e.sid),this.emitWhenConnected(hn.ParticipantConnected,i),i.on(ln.TrackPublished,(t=>{this.emitWhenConnected(hn.TrackPublished,t,i)})).on(ln.TrackSubscribed,((t,e)=>{t.kind===_r.Kind.Audio?(t.on(pn.AudioPlaybackStarted,this.handleAudioPlaybackStarted),t.on(pn.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):t.kind===_r.Kind.Video&&(t.on(pn.VideoPlaybackFailed,this.handleVideoPlaybackFailed),t.on(pn.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(hn.TrackSubscribed,t,e,i)})).on(ln.TrackUnpublished,(t=>{this.emit(hn.TrackUnpublished,t,i)})).on(ln.TrackUnsubscribed,((t,e)=>{this.emit(hn.TrackUnsubscribed,t,e,i)})).on(ln.TrackSubscriptionFailed,(t=>{this.emit(hn.TrackSubscriptionFailed,t,i)})).on(ln.TrackMuted,(t=>{this.emitWhenConnected(hn.TrackMuted,t,i)})).on(ln.TrackUnmuted,(t=>{this.emitWhenConnected(hn.TrackUnmuted,t,i)})).on(ln.ParticipantMetadataChanged,(t=>{this.emitWhenConnected(hn.ParticipantMetadataChanged,t,i)})).on(ln.ParticipantNameChanged,(t=>{this.emitWhenConnected(hn.ParticipantNameChanged,t,i)})).on(ln.ConnectionQualityChanged,(t=>{this.emitWhenConnected(hn.ConnectionQualityChanged,t,i)})).on(ln.ParticipantPermissionsChanged,(t=>{this.emitWhenConnected(hn.ParticipantPermissionsChanged,t,i)})).on(ln.TrackSubscriptionStatusChanged,((t,e)=>{this.emitWhenConnected(hn.TrackSubscriptionStatusChanged,t,e,i)})).on(ln.TrackSubscriptionFailed,((t,e)=>{this.emit(hn.TrackSubscriptionFailed,t,i,e)})).on(ln.TrackSubscriptionPermissionChanged,((t,e)=>{this.emitWhenConnected(hn.TrackSubscriptionPermissionChanged,t,e,i)})),e&&i.updateInfo(e),i}sendSyncState(){const t=Array.from(this.participants.values()).reduce(((t,e)=>(t.push(...e.getTracks()),t)),[]),e=this.localParticipant.getTracks();this.engine.sendSyncState(t,e)}updateSubscriptions(){for(const t of this.participants.values())for(const e of t.videoTracks.values())e.isSubscribed&&e instanceof Ia&&e.emitTrackUpdate()}registerConnectionReconcile(){this.clearConnectionReconcile();let t=0;this.connectionReconcileInterval=xn.setInterval((()=>{this.engine&&!this.engine.isClosed&&this.engine.verifyTransport()?t=0:(t++,P.warn("detected connection state mismatch",{numFailures:t}),t>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,$t.STATE_MISMATCH)))}),2e3)}clearConnectionReconcile(){this.connectionReconcileInterval&&xn.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(t){return t!==this.state&&(this.state=t,this.emit(hn.ConnectionStateChanged,this.state),!0)}emitWhenConnected(t){if(this.state===Ea.Connected){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return this.emit(t,...i)}return!1}simulateParticipants(t){var e,i;return Ae(this,void 0,void 0,(function*(){const n=Object.assign({audio:!0,video:!0,useRealTracks:!1},t.publish),r=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},t.participants);if(this.handleDisconnect(),this.roomInfo=new re({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:$.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ce({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(hn.SignalConnected),this.emit(hn.Connected),this.setAndEmitConnectionState(Ea.Connected),n.video){const t=new _a(_r.Kind.Video,new ge({source:Yt.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Kt.AUDIO,name:"video-dummy"}),new fa(n.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:rs(null!==(e=160*r.aspectRatios[0])&&void 0!==e?e:1,160,!0,!0)));this.localParticipant.addTrackPublication(t),this.localParticipant.emit(ln.LocalTrackPublished,t)}if(n.audio){const t=new _a(_r.Kind.Audio,new ge({source:Yt.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Kt.AUDIO}),new ea(n.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:ss()));this.localParticipant.addTrackPublication(t),this.localParticipant.emit(ln.LocalTrackPublished,t)}for(let t=0;t<r.count-1;t+=1){let e=new ce({sid:Math.floor(1e4*Math.random()).toString(),identity:"simulated-".concat(t),state:de.ACTIVE,tracks:[],joinedAt:$.parse(Date.now())});const n=this.getOrCreateParticipant(e.identity,e);if(r.video){const s=rs(null!==(i=160*r.aspectRatios[t%r.aspectRatios.length])&&void 0!==i?i:1,160,!1,!0),a=new ge({source:Yt.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Kt.AUDIO});n.addSubscribedMediaTrack(s,a.sid,new MediaStream([s])),e.tracks=[...e.tracks,a]}if(r.audio){const t=ss(),i=new ge({source:Yt.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Kt.AUDIO});n.addSubscribedMediaTrack(t,i.sid,new MediaStream([t])),e.tracks=[...e.tracks,i]}n.updateInfo(e)}}))}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return t!==hn.ActiveSpeakersChanged&&P.debug("room event ".concat(t),{event:t,args:i}),super.emit(t,...i)}}function Na(t){return Ae(this,void 0,void 0,(function*(){return(yield function(t){var e,i;return Ae(this,void 0,void 0,(function*(){null!=t||(t={}),null!==(e=t.audio)&&void 0!==e||(t.audio=!0),null!==(i=t.video)&&void 0!==i||(t.video=!0);const n=Ir(xr(t,Gs,Vs)),r=navigator.mediaDevices.getUserMedia(n);t.audio&&(ls.userMediaPromiseMap.set("audioinput",r),r.catch((()=>ls.userMediaPromiseMap.delete("audioinput")))),t.video&&(ls.userMediaPromiseMap.set("videoinput",r),r.catch((()=>ls.userMediaPromiseMap.delete("videoinput"))));const s=yield r;return s.getTracks().map((e=>{const i="audio"===e.kind;let r;i?t.audio:t.video;const a=i?n.audio:n.video;"boolean"!=typeof a&&(r=a),r?r.deviceId=e.getSettings().deviceId:r={deviceId:e.getSettings().deviceId};const o=ia(e,r);return o.kind===_r.Kind.Video?o.source=_r.Source.Camera:o.kind===_r.Kind.Audio&&(o.source=_r.Source.Microphone),o.mediaStream=s,o}))}))}({audio:t,video:!1}))[0]}))}!function(t){t[t.IDLE=0]="IDLE",t[t.RUNNING=1]="RUNNING",t[t.SKIPPED=2]="SKIPPED",t[t.SUCCESS=3]="SUCCESS",t[t.FAILED=4]="FAILED"}(xa||(xa={})),Qe.EventEmitter,Qe.EventEmitter,new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);var La=function(t){return Math.floor(t/1e6)},Oa=function(){return Oa=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},Oa.apply(this,arguments)},Ua=function(t,e,i,n){return new(i||(i=Promise))((function(r,s){function a(t){try{c(n.next(t))}catch(t){s(t)}}function o(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}c((n=n.apply(t,e||[])).next())}))},Fa=function(t,e){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},Ba=new TextEncoder,Ga=new TextDecoder;const Va=function(){function t(t){this.wsURL="",this.wsToken="",this.recordThreshold=1e3,this.recordLimit=12e5,this.limitTime=0,this.limitTimeout=null,this.publishTrack=null,this.audioElement=null,this.notify=function(){},this.timerCallback=function(){},this.blackboard=t,this.addUser(this.blackboard.user),this.room=new Aa({adaptiveStream:!0,audioCaptureDefaults:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},publishDefaults:{audioPreset:{maxBitrate:16e3}}}),this.setRoomEvent(this.room)}return t.prototype.setTimerCallback=function(t){this.timerCallback=t},t.prototype.clearLimitTime=function(){this.limitTime=0,this.limitTimeout&&clearTimeout(this.limitTimeout)},t.prototype.pauseLimitTime=function(){this.limitTimeout&&clearTimeout(this.limitTimeout)},t.prototype.checkLimitTime=function(){var t=this;this.limitTimeout=setTimeout((function(){if(t.limitTime>=t.recordLimit)return t.disconnect(),void clearTimeout(t.limitTimeout);t.limitTime+=1e3,t.checkLimitTime()}),1e3)},t.prototype.setNotify=function(t){this.notify=t},t.prototype.setRecording=function(t){this.recording=t},t.prototype.setURL=function(t){this.wsURL=t},t.prototype.setToken=function(t){this.wsToken=t},t.prototype.publishData=function(t,e){var i;if("connected"===this.room.state&&0!==this.room.participants.size){var n=Ba.encode(t),r=e&&e.length>0?e:Array.from(this.room.participants).map((function(t){var e=t[0];return t[1],e}));null===(i=this.room.localParticipant)||void 0===i||i.publishData(n,le.RELIABLE,r)}},t.prototype.chat=function(t){var e={type:"chat",data:{message:t,sender:this.blackboard.user.id,nickname:this.blackboard.user.nickname,timestamp:Date.now()}};return this.publishData(JSON.stringify(e)),this.blackboard.chatCallback(e.data),e.data},t.prototype.receiveData=function(t){var e,i,n,r,s=this,a=JSON.parse(t);if(a)if(a.target&&a.target===this.blackboard.user.id&&a.type){if("request-draw"===a.type&&this.notify(a),"request-mic"===a.type&&this.notify(a),"egress_started"===a.type&&setTimeout((function(){s.blackboard.nowRecord=!0,s.blackboard.updated("record start")}),this.recordThreshold),"init"===a.type){var o=a.stacks,c=a.image;this.blackboard.stackManager.initStacks(o),this.blackboard.setBackground(c,!0)}"mute"===a.type&&(null===(e=this.room.localParticipant)||void 0===e||e.audioTracks.forEach((function(t){t.mute()}))),"unmute"===a.type&&(null===(i=this.room.localParticipant)||void 0===i||i.audioTracks.forEach((function(t){t.unmute()}))),"draw-on"===a.type&&(this.blackboard.userList.set(a.target,Oa(Oa({},this.blackboard.userList.get(a.target)),{access:Oa(Oa({},null===(n=this.blackboard.userList.get(a.target))||void 0===n?void 0:n.access),{draw:!0})})),this.blackboard.updated("draw-on")),"draw-off"===a.type&&(this.blackboard.userList.set(a.target,Oa(Oa({},this.blackboard.userList.get(a.target)),{access:Oa(Oa({},null===(r=this.blackboard.userList.get(a.target))||void 0===r?void 0:r.access),{draw:!1})})),this.blackboard.updated("draw-off"))}else if(a.type&&a.type.includes("remote-")){if("remote-down"===a.type)(l=new u({userType:"remote",userId:a.userId,lineConfig:a.lineConfig,deleteAble:!1})).setTimestamp({start:Date.now()}),this.blackboard.setNewLine(l),this.blackboard.handlers.bindHitLineEvent(l);else if("remote-move"===a.type){if(!(l=this.blackboard.getLastLine(a.userId)))return;var d=l.line.points().concat(a.nextPoints);l.line.points(d),this.blackboard.layer.batchDraw()}else if("remote-up"===a.type){var l;if(!(l=this.blackboard.getLastLine(a.userId)))return;l.setTimestamp({end:Date.now()}),this.blackboard.stackManager.addStack({id:"stack-".concat(h()),action:"add",timeline:{start:l.timestamp.start,end:l.timestamp.end,duration:l.timestamp.end-l.timestamp.start},paint:{id:l.line.id(),type:l.type,lineConfig:l.config.lineConfig,points:l.line.points()}},!0,!1);var p=this.blackboard.stackManager.getStacks();console.log("added stack",p[p.length-1]),this.blackboard.layer.batchDraw()}}else{if(this.blackboard.stackManager.isStackType(a)){var m=a;this.blackboard.stackManager.runStack(m),this.blackboard.stackManager.addStack(m,!1,!1)}"chat"===a.type&&this.blackboard.chatCallback(a.data)}},t.prototype.init=function(t,e,i){this.audioElement=t,this.setURL(e),this.setToken(i)},t.prototype.handleTrackSubscribed=function(t,e,i){var n,r=this;this.audioElement||(this.audioElement=document.querySelector("#wb-audio")),t.kind===_r.Kind.Audio&&(i.tracks.forEach((function(t){t.track&&r.audioElement&&t.track.attach(r.audioElement)})),null===(n=e.track)||void 0===n||n.attach(this.audioElement),t.attach(this.audioElement),this.room.startAudio())},t.prototype.setRoomEvent=function(t){var e=this;t.on(hn.TrackSubscribed,this.handleTrackSubscribed.bind(this)),t.on(hn.Connected,(function(){return Ua(e,void 0,void 0,(function(){var e,i;return Fa(this,(function(n){switch(n.label){case 0:return console.log("connected to room"),t.participants.forEach((function(t){console.log("participant",t)})),"presenter"!==this.blackboard.user.role?[3,2]:(null===(i=this.recording)||void 0===i?void 0:i.start)?[4,this.recording.start(t.name)]:[3,2];case 1:e=n.sent(),this.blackboard.egressInfo=e,this.blackboard.updated("egress start"),n.label=2;case 2:return[2]}}))}))})),t.on(hn.TrackMuted,(function(t,i){var n;e.blackboard.userList.set(i.identity,Oa(Oa({},e.blackboard.userList.get(i.identity)),{access:Oa(Oa({},null===(n=e.blackboard.userList.get(i.identity))||void 0===n?void 0:n.access),{mic:!1})})),e.blackboard.updated("mute")})),t.on(hn.TrackUnmuted,(function(t,i){var n;e.blackboard.userList.set(i.identity,Oa(Oa({},e.blackboard.userList.get(i.identity)),{access:Oa(Oa({},null===(n=e.blackboard.userList.get(i.identity))||void 0===n?void 0:n.access),{mic:!0})})),e.blackboard.updated("unmute")})),t.on(hn.DataReceived,(function(t,i,n,r){var s=Ga.decode(t);e.receiveData(s)})),t.on(hn.ParticipantConnected,(function(i){var n,r;i.on(ln.IsSpeakingChanged,(function(t){console.log("".concat(i.identity," is ").concat(t?"now":"no longer"," speaking. audio level: ").concat(i.audioLevel))}));var s=i.metadata;e.addUser({id:i.identity,role:null!=s?s:"audience",nickname:i.identity},i);var a={target:i.identity,type:"init",stacks:e.blackboard.stackManager.getStacks(),image:null===(n=e.blackboard.background)||void 0===n?void 0:n.id()},o=Ba.encode(JSON.stringify(a));null===(r=t.localParticipant)||void 0===r||r.publishData(o,le.RELIABLE,[i.sid])})),t.on(hn.ParticipantDisconnected,(function(t){var i=e.blackboard.userList.get(t.identity);e.removeUser(t.identity),"presenter"===(null==i?void 0:i.role)&&(e.disconnect(),e.blackboard.nowRecord=!1,e.blackboard.updated("record end"))}))},t.prototype.publishTracks=function(t){return Ua(this,void 0,void 0,(function(){var e,i;return Fa(this,(function(n){switch(n.label){case 0:return[4,Na({echoCancellation:!0,noiseSuppression:!0})];case 1:return e=n.sent(),i=this,[4,t.localParticipant.publishTrack(e)];case 2:return i.publishTrack=n.sent(),[2]}}))}))},t.prototype.connect=function(){return Ua(this,void 0,void 0,(function(){var t,e=this;return Fa(this,(function(i){switch(i.label){case 0:if(!this.wsURL)throw new Error("url is not set");if(!this.audioElement)throw new Error("audioElement is not set");if(!this.wsToken)throw new Error("token is not set");return[4,this.room.connect(this.wsURL,this.wsToken,{autoSubscribe:!0})];case 1:return i.sent(),this.room.participants.forEach((function(t){var i;e.addUser({id:t.identity,role:null!==(i=t.metadata)&&void 0!==i?i:"audience",nickname:t.identity},t)})),[4,this.room.localParticipant.setMicrophoneEnabled(!0)];case 2:return t=i.sent(),"presenter"!==this.blackboard.user.role&&(null==t||t.mute()),this.room.localParticipant.setTrackSubscriptionPermissions(!0),[2]}}))}))},t.prototype.groupingPlayingData=function(t,e){var i,n,r,s,a,o,c;if(!t)return null;var d=null===(i=t.fileResults)||void 0===i?void 0:i[0],h=La(null!==(r=null!==(n=null==d?void 0:d.startedAt)&&void 0!==n?n:t.startedAt)&&void 0!==r?r:0),l=La(null!==(a=null!==(s=null==d?void 0:d.endedAt)&&void 0!==s?s:t.endedAt)&&void 0!==a?a:0),u=La(null!==(o=null==d?void 0:d.duration)&&void 0!==o?o:0)/1e3;return{filename:null!==(c=null==d?void 0:d.filename)&&void 0!==c?c:"",firstImage:this.blackboard.firstBackgroundImage,audioInfo:{startTime:h,endTime:l,duration:u,historyStack:e}}},t.prototype.disconnect=function(){var t,e,i;return Ua(this,void 0,void 0,(function(){var n;return Fa(this,(function(r){switch(r.label){case 0:return"presenter"!==this.blackboard.user.role?[3,2]:(null===(t=this.recording)||void 0===t?void 0:t.stop)?[4,this.recording.stop(null!==(i=null===(e=this.blackboard.egressInfo)||void 0===e?void 0:e.egressId)&&void 0!==i?i:"")]:[3,2];case 1:n=r.sent(),this.blackboard.egressInfo=n,this.blackboard.recordData=this.groupingPlayingData(this.blackboard.egressInfo,this.blackboard.stackManager.getStacks()),console.log("this.blackboard.recordData",this.blackboard.recordData),this.blackboard.updated("record done"),r.label=2;case 2:return[4,this.room.disconnect()];case 3:return r.sent(),this.blackboard.onClose(),console.log("disconnected from room"),[2]}}))}))},t.prototype.cancelRecording=function(){var t,e,i;return Ua(this,void 0,void 0,(function(){return Fa(this,(function(n){switch(n.label){case 0:return"presenter"!==this.blackboard.user.role?[3,2]:(null===(t=this.recording)||void 0===t?void 0:t.stop)?[4,this.recording.stop(null!==(i=null===(e=this.blackboard.egressInfo)||void 0===e?void 0:e.egressId)&&void 0!==i?i:"",!0)]:[3,2];case 1:n.sent(),this.blackboard.egressInfo=null,this.blackboard.recordData=null,this.blackboard.nowRecord=!1,this.blackboard.updated("record cancel"),n.label=2;case 2:return[2]}}))}))},t.prototype.addUser=function(t,e){var i;this.blackboard.userList.set(t.id,Oa(Oa({},t),{sid:null!==(i=null==e?void 0:e.sid)&&void 0!==i?i:"",userType:e?"remote":"local",access:{mic:"presenter"===t.role,draw:"presenter"===t.role}})),this.blackboard.updated("addUser")},t.prototype.findParticipantByUserId=function(t){return Array.from(this.room.participants).find((function(e){return e[0],e[1].identity===t}))},t.prototype.requestRemoteDraw=function(t,e){var i,n=null===(i=Array.from(this.blackboard.userList).find((function(t){return t[0],"presenter"===t[1].role})))||void 0===i?void 0:i[0];if(n){var r={type:"request-draw",target:n,requestId:t};this.publishData(JSON.stringify(r),e?[e]:void 0)}},t.prototype.onRemoteDraw=function(t,e){var i,n={type:"draw-on",target:t};this.publishData(JSON.stringify(n),e?[e]:void 0),this.blackboard.userList.set(t,Oa(Oa({},this.blackboard.userList.get(t)),{access:Oa(Oa({},null===(i=this.blackboard.userList.get(t))||void 0===i?void 0:i.access),{draw:!0})}))},t.prototype.offRemoteDraw=function(t,e){var i,n={type:"draw-off",target:t};this.publishData(JSON.stringify(n),e?[e]:void 0),this.blackboard.userList.set(t,Oa(Oa({},this.blackboard.userList.get(t)),{access:Oa(Oa({},null===(i=this.blackboard.userList.get(t))||void 0===i?void 0:i.access),{draw:!1})}))},t.prototype.toggleDrawAble=function(t,e){var i=this.blackboard.userList.get(t);i&&(i.access.draw?this.offRemoteDraw(t,e):this.onRemoteDraw(t,e),this.blackboard.userList.set(t,Oa(Oa({},i),{access:Oa(Oa({},i.access),{draw:!i.access.draw})}))),this.blackboard.updated("toggle draw able")},t.prototype.requestRemoteMic=function(t,e){var i,n=null===(i=Array.from(this.blackboard.userList).find((function(t){return t[0],"presenter"===t[1].role})))||void 0===i?void 0:i[0];if(n){var r={type:"request-mic",target:n,requestId:t};this.publishData(JSON.stringify(r),e?[e]:void 0)}},t.prototype.muteTracks=function(t,e){var i,n={target:t,type:"mute"};this.publishData(JSON.stringify(n),e?[e]:void 0),this.blackboard.userList.set(t,Oa(Oa({},this.blackboard.userList.get(t)),{access:Oa(Oa({},null===(i=this.blackboard.userList.get(t))||void 0===i?void 0:i.access),{mic:!1})}))},t.prototype.unmuteTracks=function(t,e){var i,n={target:t,type:"unmute"};this.publishData(JSON.stringify(n),e?[e]:void 0),this.blackboard.userList.set(t,Oa(Oa({},this.blackboard.userList.get(t)),{access:Oa(Oa({},null===(i=this.blackboard.userList.get(t))||void 0===i?void 0:i.access),{mic:!0})}))},t.prototype.toggleMic=function(t,e){var i=this.blackboard.userList.get(t);if(i){var n=i.access;n&&(n.mic?this.muteTracks(t,e):this.unmuteTracks(t,e))}},t.prototype.removeUser=function(t){this.blackboard.userList.delete(t),this.blackboard.updated("removeUser")},t.prototype.getCurrentUserBy=function(t){return this.blackboard.userList.get(t)},t.prototype.getRoomParticipants=function(){return this.room.participants},t}();var ja=function(){return ja=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},ja.apply(this,arguments)};const Ja=function(){function t(t){var e=this;this.currentStagePosition={before:{x:0,y:0},after:{x:0,y:0}},this.recordInfo=null,this.audio=null,this.seekerElement=null,this.seekerWrapper=null,this.audioPaused=!1,this.timeInfo={currentTime:0,duration:0,percent:0,currentTimeStr:"00:00"},this.startTime=0,this.nextTime=0,this.historyStack=[],this.playedStacks=[],this.notPlayingStacks=[],this.historyMap=new Map,this.playMap=new Map,this.isSeeking=!1,this.movedSeeker=!1,this.isPlaying=!1,this.audioEnded=!1,this.debounceTimeout=null,this.playingTimeouts=new Set,this.animations=new Set,this.audioUpdated=function(){},this.debouncedFunction=this.debounce((function(){e.movedSeeker=!0,e.reRenderDrawingLayer(e.nextTime)}),250,this),this.blackboard=t;var i=this.blackboard.stage.getPosition();this.currentStagePosition={before:i,after:i}}return t.prototype.debounce=function(t,e,i){return function(){for(var n=this,r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];i.debounceTimeout&&clearTimeout(i.debounceTimeout),i.debounceTimeout=setTimeout((function(){return t.apply(n,r)}),e)}},t.prototype.stopAllAnimations=function(){var t=this;this.animations.forEach((function(e){e.stop(),t.animations.delete(e)}))},t.prototype.clearAllTimeouts=function(){this.playingTimeouts.forEach(clearTimeout),this.playingTimeouts.clear()},t.prototype.stopHistoryReplay=function(){this.clearAllTimeouts(),this.stopAllAnimations(),this.blackboard.updated("stop history replay")},t.prototype.setAudioUpdated=function(t){this.audioUpdated=t},t.prototype.updated=function(t,e){this.audioUpdated({message:t,data:{isPlaying:this.isPlaying,timeInfo:this.getTimeInfo(e)}})},t.prototype.getTimeInfo=function(t){return this.audio?(t&&(this.timeInfo={currentTime:t,duration:this.timeInfo.duration,percent:this.parseTimeToPercent(t,this.timeInfo.duration),currentTimeStr:this.parseTimeToHHMMSS(t)}),this.timeInfo):{currentTime:0,duration:0,percent:0,currentTimeStr:"00:00"}},t.prototype.parseTimeToHHMMSS=function(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),n=Math.floor(t-3600*e-60*i),r=e<10?"0".concat(e):"".concat(e),s=i<10?"0".concat(i):"".concat(i),a=n<10?"0".concat(n):"".concat(n);return"".concat(e?r+":":"").concat(s,":").concat(a)},t.prototype.parseTimeToPercent=function(t,e){return t/e*100},t.prototype.millisecondsToSeconds=function(t){return Math.floor(t/1e3)},t.prototype.setStacksBySeekTime=function(t,e){var i=this;e<0&&(e=0),this.playedStacks=t.filter((function(t){return i.millisecondsToSeconds(t.timeline.start)-i.millisecondsToSeconds(e)<0})),console.log("this.playedStacks!",this.playedStacks),this.notPlayingStacks=t.filter((function(t){return i.millisecondsToSeconds(t.timeline.start)-i.millisecondsToSeconds(e)>=0})),this.preRenderPlayedStacks()},t.prototype.preRenderPlayedStacks=function(){var t=this;this.recordInfo&&(this.blackboard.backgroundLayer.destroyChildren(),this.blackboard.stage.position({x:0,y:0}),this.blackboard.setBackground(this.recordInfo.firstImage,!0),console.log("this.playedStacks",this.playedStacks),this.playedStacks.forEach((function(e){t.blackboard.stackManager.runStack(e)})),this.blackboard.stage.draw(),this.blackboard.updated("pre-render-played-stacks"))},t.prototype.disposeActionDirection=function(t,e){return"before"===t?{before:e.after,after:e.before}:e},t.prototype.animateStageMovement=function(t,i,n){var r=this,s=i.before.x,a=i.before.y,o=i.after.x,c=i.after.y,d=new(e().Animation)((function(e){if(e){var i=e.time/n;i>1&&(i=1);var h=s+(o-s)*i,l=a+(c-a)*i;t.position({x:h,y:l}),1===i&&(d.stop(),r.animations.delete(d))}}),t);this.animations.add(d),d.start()},t.prototype.animateLineWithDuration=function(t,i,n,r){var s=this;if(n){var a,o=n.paint.points,c=n.paint.lineConfig;if(o&&!(o.length<2)){var d=new u({userType:"local",userId:this.blackboard.user.id,lineConfig:ja({},c),deleteAble:!0}),h=d.line;this.blackboard.handlers.bindHitLineEvent(d),i.add(h),console.log("drawing!",o);var l=new(e().Animation)((function(e){if(e){a||(a=e.time);var i=e.time-a,n=i/t,c=Math.min(2*Math.floor(n*o.length/2),o.length);h.points(o.slice(0,c)),i>=t&&(l.stop(),s.animations.delete(l),r&&r(h))}}),i);this.animations.add(l),l.start()}}},t.prototype.drawingStack=function(t,e){if(void 0===e&&(e=!1),e&&"remove"!==t.action){var i=this.blackboard.stackManager.isImageStackType(t),n=this.blackboard.stackManager.isPanningStackType(t),r=this.blackboard.stackManager.isClearStackType(t),s=this.blackboard.stackManager.isPaintStackType(t);if(i&&this.blackboard.stackManager.runStack(t),n){var a=this.disposeActionDirection(t.action,{before:t.panning.before,after:t.panning.after});this.animateStageMovement(this.blackboard.stage,a,t.timeline.duration)}r&&this.blackboard.stackManager.runStack(t),s&&"add"===t.action&&this.animateLineWithDuration(t.timeline.end-t.timeline.start,this.blackboard.layer,t)}else this.blackboard.stackManager.runStack(t)},t.prototype.reRenderDrawingLayer=function(t,e){var i=this;if(void 0===e&&(e=!0),console.log("reRenderDrawingLayer",t),this.recordInfo){this.audio&&e&&(this.audio.currentTime=t),this.clearAllTimeouts(),this.stopAllAnimations(),this.blackboard.stage.position({x:0,y:0}),this.blackboard.layer.destroyChildren(),this.playMap=new Map(this.historyMap);for(var n=[],r=0,s=Array.from(this.historyMap.entries());r<s.length;r++){var a=s[r],o=a[0],c=a[1];Number.isInteger(o)&&o<=Math.floor(t)&&0!==t&&(n.push(c),this.playMap.delete(o))}n.flat().forEach((function(t){i.drawingStack(t,!1)})),this.blackboard.updated("reRenderBeforeHistoryStack")}},t.prototype.setRecord=function(t,e){var i=this;this.recordInfo=e,this.audio=t,this.audio.src=this.recordInfo.audioUrl,this.audio.preload="metadata",this.audio.style.display="none",this.startTime=this.recordInfo.audioInfo.startTime,this.historyStack=this.recordInfo.audioInfo.historyStack,this.setStacksBySeekTime(this.historyStack,this.startTime),this.notPlayingStacks.forEach((function(t){var e,n=Math.floor((t.timeline.start-i.startTime)/1e3);i.historyMap.has(n)||i.historyMap.set(n,[]),null===(e=i.historyMap.get(n))||void 0===e||e.push(t)})),this.playMap=new Map(this.historyMap),this.audio.onloadedmetadata=function(t){var n=t.target,r=isFinite(n.duration)?n.duration:e.audioInfo.duration;console.log("current duration",r),i.timeInfo={currentTime:n.currentTime,duration:r,percent:0,currentTimeStr:"00:00"},i.updated("audio-loaded-metadata")},this.audio.onpause=function(t){var e=t.target;i.stopHistoryReplay(),i.isPlaying=!1,i.updated("audio-paused",e.currentTime)},this.audio.onended=function(t){var e=t.target;i.stopHistoryReplay(),i.playMap=new Map(i.historyMap),i.isPlaying=!1,i.audioEnded=!0,i.updated("audio-ended",e.currentTime)},this.audio.onseeked=function(t){var e=t.target;i.isSeeking||i.reRenderDrawingLayer(e.currentTime,!1)},this.audio.ontimeupdate=function(t){if(!i.isSeeking){var e=t.target,n=i.getTimeInfo(e.currentTime),r=Math.floor(e.currentTime);if(0===r&&i.audioEnded&&(i.audioEnded=!1,i.blackboard.layer.destroyChildren()),i.playMap.has(r)){var s=i.playMap.get(r);if(i.playMap.delete(r),!s)return;if(0===s.length)return;s.forEach((function(t){var e=t.timeline.start-i.startTime-1e3*r,n=setTimeout((function(){i.drawingStack(t,!0)}),e);i.playingTimeouts.add(n)})),i.updated("audio-time-update",e.currentTime)}i.updateSeeker(n.percent)}}},t.prototype.toggleAudio=function(){return t=this,e=void 0,n=function(){return function(t,e){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(c){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}(this,(function(t){switch(t.label){case 0:return this.recordInfo&&this.audio?this.audio.paused?[4,this.audio.play()]:[3,2]:[2];case 1:return t.sent(),[3,3];case 2:this.audio.pause(),t.label=3;case 3:return[2,!this.audio.paused]}}))},new((i=void 0)||(i=Promise))((function(r,s){function a(t){try{c(n.next(t))}catch(t){s(t)}}function o(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}c((n=n.apply(t,e||[])).next())}));var t,e,i,n},t.prototype.updateSeeker=function(t){this.seekerElement&&this.seekerWrapper&&(this.seekerElement.style.width=t+"%")},t.prototype.onSeekerDown=function(){this.recordInfo&&this.audio&&this.seekerElement&&this.seekerWrapper&&(this.isSeeking=!0,this.movedSeeker=!1,this.audioPaused=this.audio.paused,this.seekerWrapper.onpointermove=this.onSeekerMove.bind(this),this.seekerWrapper.onpointerup=this.onSeekerUp.bind(this),this.seekerWrapper.onpointerleave=this.onSeekerUp.bind(this))},t.prototype.onSeekerMove=function(t){if(this.isSeeking&&this.audio&&this.seekerWrapper&&this.seekerElement){var e=(t.pageX-this.seekerWrapper.offsetLeft)/this.seekerWrapper.offsetWidth*100;this.seekerElement.style.width=e+"%";var i=this.timeInfo.duration*e/100;i<0&&(i=0),i>this.timeInfo.duration&&(i=this.timeInfo.duration),this.nextTime=i,this.audio.paused||this.audio.pause(),this.debouncedFunction(this)}},t.prototype.onSeekerUp=function(t){if(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.isSeeking&&this.audio&&this.seekerWrapper&&this.seekerElement){var e=(t.pageX-this.seekerWrapper.offsetLeft)/this.seekerWrapper.offsetWidth*100,i=this.timeInfo.duration*e/100;i<0&&(i=0),i>this.timeInfo.duration&&(i=this.timeInfo.duration),console.log("onSeekerUp",this.nextTime,i),this.movedSeeker||(this.nextTime=i,this.seekerElement.style.width=e+"%",this.reRenderDrawingLayer(this.nextTime),console.log("currentTime",i)),!this.audioPaused&&this.audio.paused&&this.audio.play(),this.movedSeeker=!1,this.isSeeking=!1,this.seekerWrapper.onpointermove=null,this.seekerWrapper.onpointerup=null,this.seekerWrapper.onpointerleave=null}},t.prototype.setSeeker=function(t,e){this.seekerElement=t,this.seekerWrapper=e,this.seekerWrapper.onpointerdown=this.onSeekerDown.bind(this)},t.prototype.destroySeeker=function(){this.seekerWrapper&&(this.seekerWrapper.onpointerdown=null,this.seekerWrapper.onpointermove=null,this.seekerWrapper.onpointerup=null,this.seekerWrapper.onpointerleave=null,this.seekerWrapper=null,this.seekerElement=null)},t}();var qa=function(){return qa=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},qa.apply(this,arguments)};const Wa=function(){function t(t,i,n){var r,s=this;this.egressInfo=null,this.nowRecord=!1,this.recordData=null,this.userList=new Map,this.isPublisher=!0,this.width=window.innerWidth,this.height=window.innerHeight,this.mode="pen",this.lines=new Map,this.background=null,this.firstBackgroundImage="",this.callback=function(){},this.chatCallback=function(){},this.onClose=function(){},this.user=t,this.container=i,n&&(this.width=n.width||this.width,this.height=n.height||this.height,n.image&&(this.firstBackgroundImage=n.image,this.setBackground(n.image,!0)),this.isPublisher=null===(r=n.isPublisher)||void 0===r||r),this.stage=new(e().Stage)({container:this.container,width:this.width,height:this.height,x:0,y:0,scaleX:1,scaleY:1}),this.backgroundLayer=new(e().Layer),this.layer=new(e().Layer),this.stage.add(this.backgroundLayer),this.stage.add(this.layer),this.brush=new c,this.cursor=new d(this),this.stackManager=new m(this),this.liveControl=new Va(this),this.handlers=new b(this),this.callback=(null==n?void 0:n.callback)||this.callback,window.addEventListener("resize",(function(){s.width=window.innerWidth,s.height=window.innerHeight,s.stage.width(s.width),s.stage.height(s.height),s.stage.draw()})),this.setStageHandler(this.handlers),"presenter"!==this.user.role&&this.setMode("panning"),this.stackPlayer=new Ja(this)}return t.prototype.setChatCallback=function(t){this.chatCallback=t},t.prototype.setOnClose=function(t){this.onClose=t},t.prototype.clear=function(t){void 0===t&&(t=!1),this.layer.destroyChildren(),this.layer.draw(),t&&this.stackManager.clearControlStacks(),this.stackManager.addStack({id:"stack-".concat(Date.now()),action:"after",timeline:{start:Date.now()},clearIndex:this.stackManager.getStacks().length}),this.updated("clear")},t.prototype.sizeLimit=function(t,e){var i=t.width,n=t.height;return i>(e=null!=e?e:window.innerWidth)&&(n*=e/(i=e)),{width:i,height:n}},t.prototype.setBackground=function(t,i){var n,r,s=this;void 0===i&&(i=!1);var a=null!==(r=null===(n=this.background)||void 0===n?void 0:n.id())&&void 0!==r?r:t,o=new Image;o.onload=function(){var n=o.width,r=o.height;s.background?(s.background.id(t),s.background.image(o),s.background.width(n),s.background.height(r)):(s.background=new(e().Image)({id:t,image:o,width:n,height:r,x:0,y:0,scaleX:1,scaleY:1}),s.backgroundLayer.add(s.background)),s.backgroundLayer.draw(),i||s.stackManager.addStack({id:"stack-".concat(Date.now()),action:"after",timeline:{start:Date.now()},image:{before:a,after:t}}),s.updated("set background")},o.src=t},t.prototype.setStageHandler=function(t){this.stage.on("pointerdown",t.stageDown),this.stage.on("pointerup",t.stageUp),this.stage.on("pointermove",t.stageMove)},t.prototype.setNewLine=function(t){this.lines.set(t.userId,t),this.layer.add(t.line),this.updated("paint down")},t.prototype.getLastLine=function(t){return this.lines.get(t||this.user.id)},t.prototype.getMode=function(){return this.mode},t.prototype.setMode=function(t){this.mode=t;var e=this.brush.getBrushConfig();return"panning"===this.mode?(this.stage.draggable(!0),this.container.style.cursor="grab"):(this.stage.draggable(!1),this.container.style.cursor="none"),v(t)&&(e=this.brush.setBrushType(t)),this.updated("mode changed"),e},t.prototype.updated=function(t,e){var i=this.userList.get(this.user.id);this.callback({message:t,data:qa({mode:this.mode,brush:this.brush.getBrushConfig(),undoStack:this.stackManager.getUndoStack(),redoStack:this.stackManager.getRedoStack(),stacks:this.stackManager.getStacks(),userList:this.userList,access:null==i?void 0:i.access,recordData:this.recordData,egressInfo:this.egressInfo,nowRecord:this.nowRecord},e)})},t.prototype.getUserInfo=function(t){return this.userList.get(t)},t.prototype.getStagePosition=function(){var t=JSON.parse(JSON.stringify(this.stage.getPosition()));return{x:t.x,y:t.y}},t}()})(),n})()));